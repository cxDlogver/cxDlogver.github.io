

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/dog.png">
  <link rel="icon" href="/img/dog.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Xiang Chen">
  <meta name="keywords" content="">
  
    <meta name="description" content="NodeJS简介 &#x2F; 包管理器 &#x2F; 计算机网络 &#x2F; Promise &#x2F; Express &#x2F; Buffer &#x2F; Path &#x2F; 会话控制">
<meta property="og:type" content="article">
<meta property="og:title" content="NodeJS核心总结">
<meta property="og:url" content="http://example.com/2025/12/17/NodeJS/NodeJS%E6%A0%B8%E5%BF%83%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="相">
<meta property="og:description" content="NodeJS简介 &#x2F; 包管理器 &#x2F; 计算机网络 &#x2F; Promise &#x2F; Express &#x2F; Buffer &#x2F; Path &#x2F; 会话控制">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2025/12/17/NodeJS/NodeJS%E6%A0%B8%E5%BF%83%E6%80%BB%E7%BB%93/20220927094943815.png">
<meta property="og:image" content="http://example.com/2025/12/17/NodeJS/NodeJS%E6%A0%B8%E5%BF%83%E6%80%BB%E7%BB%93/20220927095238144.png">
<meta property="og:image" content="http://example.com/2025/12/17/NodeJS/NodeJS%E6%A0%B8%E5%BF%83%E6%80%BB%E7%BB%93/1603965685749-8cc21a1b-4277-42b1-aeed-18978c1cdb95.png">
<meta property="og:image" content="http://example.com/2025/12/17/NodeJS/NodeJS%E6%A0%B8%E5%BF%83%E6%80%BB%E7%BB%93/1603965685769-63a91dae-936d-42d3-8571-577cefa11e33.png">
<meta property="og:image" content="http://example.com/2025/12/17/NodeJS/NodeJS%E6%A0%B8%E5%BF%83%E6%80%BB%E7%BB%93/20221010132511667-1024x574.png">
<meta property="article:published_time" content="2025-12-17T05:34:33.000Z">
<meta property="article:modified_time" content="2026-01-08T13:38:47.358Z">
<meta property="article:author" content="Xiang Chen">
<meta property="article:tag" content="NodeJS">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2025/12/17/NodeJS/NodeJS%E6%A0%B8%E5%BF%83%E6%80%BB%E7%BB%93/20220927094943815.png">
  
  
  
  <title>NodeJS核心总结 - 相</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>相</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="NodeJS核心总结"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-12-17 13:34" pubdate>
          2025年12月17日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          55k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          460 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">NodeJS核心总结</h1>
            
            
              <div class="markdown-body">
                
                <p>NodeJS简介 &#x2F; 包管理器 &#x2F; 计算机网络 &#x2F; Promise &#x2F; Express &#x2F; Buffer &#x2F; Path &#x2F; 会话控制</p>
<span id="more"></span>

<h1 id="Node-js简介"><a href="#Node-js简介" class="headerlink" title="Node.js简介"></a>Node.js简介</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://nodejs.org/en">Node.js — Run JavaScript Everywhere</a></p>
</blockquote>
<p>Node.js 是一个基于 <strong>Chrome V8 引擎</strong> 构建的 <strong>JavaScript 运行环境</strong>，它让你能够在服务器端运行 JavaScript 代码。</p>
<ul>
<li><strong>本质</strong>：Node.js 是一个 JavaScript 运行环境（runtime environment），让 JavaScript 脱离浏览器、在服务器上运行。</li>
<li><strong>核心引擎</strong>：使用 Google 的 V8 JavaScript 引擎。</li>
<li><strong>异步 I&#x2F;O</strong>：采用 <strong>事件驱动、非阻塞（non-blocking）I&#x2F;O 模型</strong>，非常适合处理高并发请求。</li>
</ul>
<h2 id="Node-js-的特点"><a href="#Node-js-的特点" class="headerlink" title="Node.js 的特点"></a>Node.js 的特点</h2><table>
<thead>
<tr>
<th>特点</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>非阻塞 I&#x2F;O</td>
<td>异步处理请求，性能高</td>
</tr>
<tr>
<td>单线程事件循环</td>
<td>用一个线程处理多个请求，通过事件循环实现并发</td>
</tr>
<tr>
<td>跨平台</td>
<td>支持 Windows、Linux、macOS 等操作系统</td>
</tr>
<tr>
<td>使用 JavaScript</td>
<td>前后端统一开发语言（同一API）</td>
</tr>
<tr>
<td>大量模块支持</td>
<td>拥有丰富的 NPM（Node Package Manager）生态系统</td>
</tr>
</tbody></table>
<h2 id="Node-js-常见用途"><a href="#Node-js-常见用途" class="headerlink" title="Node.js 常见用途"></a>Node.js 常见用途</h2><ol>
<li><strong>构建 Web 服务器</strong>（如 Express 框架）</li>
<li><strong>API 接口服务</strong>（RESTful、GraphQL）</li>
<li><strong>实时通信应用</strong>（如聊天室、Socket.io）</li>
<li><strong>命令行工具开发</strong></li>
<li><strong>构建微服务架构</strong></li>
<li><strong>自动化构建工具</strong>（Webpack、Gulp 等）</li>
<li><strong>物联网（IoT）项目</strong></li>
</ol>
<hr>
<h2 id="Node-js-的核心模块"><a href="#Node-js-的核心模块" class="headerlink" title="Node.js 的核心模块"></a>Node.js 的核心模块</h2><table>
<thead>
<tr>
<th>模块名</th>
<th>功能简介</th>
</tr>
</thead>
<tbody><tr>
<td><code>http</code></td>
<td>创建 Web 服务器</td>
</tr>
<tr>
<td><code>fs</code></td>
<td>文件系统操作</td>
</tr>
<tr>
<td><code>path</code></td>
<td>处理文件路径</td>
</tr>
<tr>
<td><code>events</code></td>
<td>事件处理</td>
</tr>
<tr>
<td><code>stream</code></td>
<td>数据流操作</td>
</tr>
<tr>
<td><code>os</code></td>
<td>系统信息获取</td>
</tr>
<tr>
<td><code>process</code></td>
<td>创建子进程</td>
</tr>
</tbody></table>
<h2 id="NVM简介"><a href="#NVM简介" class="headerlink" title="NVM简介"></a>NVM简介</h2><p>NVM（Node Version Manager）是 <strong>Node.js 版本管理工具</strong>，可以方便地在同一台机器上安装和切换多个 Node.js 版本。</p>
<ul>
<li><strong>全称</strong>：Node Version Manager</li>
<li><strong>作用</strong>：帮助你在同一系统中安装、管理和切换多个版本的 Node.js。</li>
<li><strong>使用场景</strong>：<ul>
<li>不同项目需要不同版本的 Node.js。</li>
<li>测试代码在不同 Node.js 版本下的兼容性。</li>
<li>避免全局安装冲突。</li>
</ul>
</li>
</ul>
<p><strong>NVM 的主要功能</strong></p>
<table>
<thead>
<tr>
<th>功能</th>
<th>命令示例</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>安装 Node.js</td>
<td><code>nvm install 16.20.2</code></td>
<td>安装指定版本的 Node</td>
</tr>
<tr>
<td>查看已安装版本</td>
<td><code>nvm ls</code></td>
<td>显示当前安装的所有 Node.js 版本</td>
</tr>
<tr>
<td>查看可安装版本</td>
<td><code>nvm ls-remote</code></td>
<td>查看远程所有可安装版本</td>
</tr>
<tr>
<td>使用某版本</td>
<td><code>nvm use 16.20.2</code></td>
<td>临时切换 Node.js 版本</td>
</tr>
<tr>
<td>设置默认版本</td>
<td><code>nvm alias default 16.20.2</code></td>
<td>设置默认使用的版本</td>
</tr>
<tr>
<td>卸载版本</td>
<td><code>nvm uninstall 14.21.3</code></td>
<td>删除指定版本的 Node</td>
</tr>
</tbody></table>
<h2 id="Node-js-使用"><a href="#Node-js-使用" class="headerlink" title="Node.js 使用"></a>Node.js 使用</h2><p>和之前学习的JavaScript不同，Node.js需要运行在服务器端，说的直白一些我们需要通过命令行来执行JS代码。通过命令行执行js代码有两种方式：</p>
<p>第一种直接在命令行中输入node，会进入到node的REPL界面（交互编程环境），在REPL下和浏览器的控制台类似，我们可以直接输入各种JS代码，REPL会立即执行这些代码并输出结果（.exit用来退出REPL）。</p>
<img src="/2025/12/17/NodeJS/NodeJS%E6%A0%B8%E5%BF%83%E6%80%BB%E7%BB%93/20220927094943815.png" srcset="/img/loading.gif" lazyload class title="img">

<p>第二种也是我们最常使用的一种，就是将js代码编写到一个js文件中，然后通过命令行执行js文件</p>
<img src="/2025/12/17/NodeJS/NodeJS%E6%A0%B8%E5%BF%83%E6%80%BB%E7%BB%93/20220927095238144.png" srcset="/img/loading.gif" lazyload class title="img">

<p>Node.js虽然也属于js，但是它和浏览器中js还是有所区别的。对于ECMAScript标准来说，它们是一致的所以像是原始值、流程控制语句、运算符、函数、对象、数组、内建对象这些东西无论是浏览器环境还是node中都是一样的。对于宿主对象来说浏览器和node是截然不同的，像是DOM、BOM这些对象在node中通通是不存在的，但是一些东西在Node中依然得到了保留，比如console对象、比如定时器之类。</p>
<h2 id="Node-js-的作用"><a href="#Node-js-的作用" class="headerlink" title="Node.js 的作用"></a>Node.js 的作用</h2><ol>
<li><strong>开发服务器应用</strong> —— 因为 Node.js 提供了服务端能力</li>
</ol>
<p><strong>解释：</strong></p>
<p>JavaScript 原本只运行在浏览器中，不能访问磁盘、网络、数据库等“后端功能”。但通过 <strong>Node.js</strong>，JavaScript 拥有了这些底层访问能力：</p>
<ul>
<li>Node.js 提供了 HTTP 模块，可以构建 Web 服务器</li>
<li>提供文件系统（fs）、网络（net）、数据库连接等 API</li>
<li>使用异步非阻塞 I&#x2F;O 机制，非常适合处理<strong>高并发请求</strong></li>
</ul>
<p><strong>举例场景：</strong></p>
<table>
<thead>
<tr>
<th>应用类型</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>API 服务</td>
<td>RESTful 或 GraphQL 接口</td>
</tr>
<tr>
<td>实时服务</td>
<td>聊天服务器、在线协作、弹幕系统</td>
</tr>
<tr>
<td>Web 后端</td>
<td>博客系统、论坛系统、内容管理系统（CMS）</td>
</tr>
</tbody></table>
<p><strong>常用工具</strong>：Express、Koa、NestJS</p>
<ol start="2">
<li><strong>开发工具类应用</strong> —— 因为 Node.js 可直接操作系统资源</li>
</ol>
<p><strong>解释：</strong></p>
<p>Node.js 能读取文件、执行命令、读取环境变量，因此非常适合用来开发 <strong>命令行工具</strong> 或 <strong>项目构建工具</strong>：</p>
<ul>
<li>可以写项目脚手架（自动创建目录结构）</li>
<li>实现自动构建、打包、格式化等工具</li>
<li>可以发布为 npm 包，方便分发与使用</li>
</ul>
<p><strong>举例场景：</strong></p>
<table>
<thead>
<tr>
<th>工具类型</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>前端构建工具</td>
<td>Webpack、Vite、Rollup</td>
</tr>
<tr>
<td>命令行工具</td>
<td>Vue CLI、create-react-app</td>
</tr>
<tr>
<td>自动化工具</td>
<td>ESLint、Prettier、Gulp、Husky</td>
</tr>
</tbody></table>
<p><strong>优势：</strong> 使用 JavaScript 写工具，让前端开发流程更统一、可自动化。</p>
<ol start="3">
<li><strong>开发桌面端应用</strong> —— 因为 JavaScript 可借助 <font color="#409eff">Electron </font>实现跨平台桌面程序</li>
</ol>
<p><strong>解释：</strong></p>
<p>通过 <strong>Electron</strong>（基于 Node.js + Chromium），JavaScript 可以构建完整的桌面应用，支持：</p>
<ul>
<li>系统窗口管理（打开窗口、菜单栏、托盘图标等）</li>
<li>访问系统资源（文件读写、系统通知、硬件接口）</li>
<li>使用 HTML&#x2F;CSS&#x2F;JS 构建 UI，适配所有平台（Windows、macOS、Linux）</li>
</ul>
<p><strong>举例场景：</strong></p>
<table>
<thead>
<tr>
<th>应用类型</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>编辑器类</td>
<td>VS Code、Atom</td>
</tr>
<tr>
<td>聊天类</td>
<td>Slack、Discord（旧版本）</td>
</tr>
<tr>
<td>开发工具</td>
<td>Postman、Insomnia、Figma 桌面版</td>
</tr>
</tbody></table>
<p><strong>为什么可行？</strong></p>
<ul>
<li>Electron 中，<strong>前端页面用浏览器渲染，后端逻辑由 Node.js 支撑</strong></li>
<li>统一语言栈，开发效率高</li>
<li>支持跨平台打包</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><font color="#409eff">面试模板：</font></p>
<p>Node.js 是一个基于 Chrome V8 引擎构建的 JavaScript 运行时环境，它让 JavaScript 不再局限于浏览器中运行，而是可以直接在服务器端执行。Node.js 采用事件驱动、非阻塞 I&#x2F;O 的模型，这种设计使得它在处理高并发、I&#x2F;O 密集型任务时具有非常高的性能和扩展性。所有 I&#x2F;O 操作都通过<strong>事件循环和回调机制</strong>来异步执行，从而避免了线程阻塞的问题。Node.js 提供了丰富的内置模块，比如文件系统、HTTP、网络等，同时也有全球最大的开源包管理生态——npm。总结来说，Node.js 的特点是单线程、事件驱动、异步非阻塞，优势在于高并发处理能力和丰富的生态，缺点是 CPU 密集型任务表现不佳，因为单线程在处理复杂计算时容易阻塞事件循环。</p>
<p>事件驱动就是程序的执行流程由事件来推动，而不是按顺序一行行地死等结果。在 Node.js 里，有一个事件循环机制，所有任务会被注册成事件，当某个事件发生，比如网络请求完成、文件读取结束，就会触发对应的回调函数执行，这样程序不必在原地等待，而是去忙别的事，等事件通知。</p>
<p>非阻塞 I&#x2F;O 是指在执行 I&#x2F;O 操作，比如读文件、查数据库、发网络请求时，不会阻塞代码的继续运行。传统的阻塞模式是必须等 I&#x2F;O 完成才继续执行后面的代码，而 Node.js 的非阻塞 I&#x2F;O 会立即返回，先把操作交给系统后台去处理，当处理完成后通过事件和回调通知程序，这样可以同时发起多个 I&#x2F;O 请求，不浪费等待的时间。</p>
<h1 id="JavaScript模块化"><a href="#JavaScript模块化" class="headerlink" title="JavaScript模块化"></a>JavaScript模块化</h1><blockquote>
<p>知识点总结：尚硅谷\禹神：一小时速通JavaScript模块化</p>
</blockquote>
<p><font color="#409eff">面试模板：</font></p>
<p>JavaScript 模块化是一种将代码按照功能拆分成独立文件的编程方式，每个模块内部定义自己的作用域和功能，并通过特定的导出与导入机制实现复用。模块化的出现主要是为了解决早期 JavaScript 在全局作用域下编写代码所带来的全局变量污染、依赖顺序混乱以及数据暴露不安全等问题。通过模块化，每个模块都有独立的作用域，避免了不同模块之间的变量和函数相互覆盖；同时模块通过显式的 <code>import</code> 和 <code>export</code> 声明依赖关系，不再依赖于手动调整脚本引入顺序，从而解决依赖混乱的问题；此外，模块内部的数据和实现细节如果不导出，外部是无法访问的，这样就实现了数据的封装与安全。早期的模块化方案包括 IIFE 自执行函数封装、CommonJS（主要用于 Node.js）和 AMD（浏览器端异步加载），现代 JavaScript 则通过 ES Module（<code>import</code>&#x2F;<code>export</code>）在语言层面原生支持模块化，并结合构建工具打包，既解决了全局污染和依赖混乱的问题，也让数据访问更可控、更安全。</p>
<h1 id="包管理器"><a href="#包管理器" class="headerlink" title="包管理器"></a>包管理器</h1><h2 id="NPM介绍"><a href="#NPM介绍" class="headerlink" title="NPM介绍"></a>NPM介绍</h2><p>NPM（<strong>Node Package Manager</strong>）是 <strong>Node.js 的包管理工具</strong>，也是<strong>世界上最大的 JavaScript 软件包生态系统</strong>。</p>
<ul>
<li><strong>全称</strong>：Node Package Manager</li>
<li><strong>功能</strong>：用于安装、管理、共享 JavaScript 包（模块&#x2F;库）</li>
<li><strong>作用对象</strong>：主要配合 Node.js 使用，但也适用于前端项目（如 Vue、React）</li>
</ul>
<blockquote>
<p>安装 Node.js 时通常会自动附带安装 NPM。</p>
</blockquote>
<p><strong>三大功能</strong></p>
<table>
<thead>
<tr>
<th>功能</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>安装模块</td>
<td>安装你项目需要的库（如 <code>express</code>、<code>lodash</code>）</td>
</tr>
<tr>
<td>管理依赖</td>
<td></td>
</tr>
<tr>
<td>发布包</td>
<td>将你自己的模块上传到 NPM 仓库，供他人使用</td>
</tr>
</tbody></table>
<p>NPM 常用命令速查表</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>功能说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>npm init</code></td>
<td>初始化项目，创建 <code>package.json</code></td>
<td>会提示填写信息</td>
</tr>
<tr>
<td><code>npm init -y</code></td>
<td>快速初始化项目</td>
<td>使用默认值跳过询问</td>
</tr>
</tbody></table>
<p>安装依赖</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>功能说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>npm install</code> 或 <code>npm i</code></td>
<td>安装所有依赖（根据 <code>package.json</code>）</td>
<td>生成 <code>node_modules</code> 和 <code>package-lock.json</code></td>
</tr>
<tr>
<td><code>npm install &lt;包名&gt;</code></td>
<td>安装指定包，添加到 <code>dependencies</code></td>
<td>默认本地安装</td>
</tr>
<tr>
<td><code>npm install &lt;包名&gt; --save-dev</code> 或 <code>-D</code></td>
<td>安装为开发依赖</td>
<td>添加到 <code>devDependencies</code></td>
</tr>
<tr>
<td><code>npm install -g &lt;包名&gt;</code></td>
<td>全局安装一个包</td>
<td>多用于 CLI 工具（如 nodemon）</td>
</tr>
</tbody></table>
<p>卸载依赖</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>功能说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>npm uninstall &lt;包名&gt;</code></td>
<td>卸载依赖并从 <code>package.json</code> 中移除</td>
<td>支持卸载开发依赖</td>
</tr>
</tbody></table>
<p>更新与查看</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>功能说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>npm update &lt;包名&gt;</code></td>
<td>更新某个依赖包</td>
<td>自动安装符合 semver 的最新版本</td>
</tr>
<tr>
<td><code>npm outdated</code></td>
<td>查看过时的依赖包</td>
<td>显示当前版本、最新版本等</td>
</tr>
<tr>
<td><code>npm list</code></td>
<td>查看当前项目依赖结构</td>
<td>默认显示完整树</td>
</tr>
<tr>
<td><code>npm list --depth=0</code></td>
<td>查看顶级依赖</td>
<td>常用于查看主要依赖版本</td>
</tr>
</tbody></table>
<p>运行脚本</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>功能说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>npm start</code></td>
<td>执行 <code>package.json</code> 中的 <code>start</code> 脚本</td>
<td>如：<code>&quot;start&quot;: &quot;node index.js&quot;</code></td>
</tr>
<tr>
<td><code>npm run &lt;脚本名&gt;</code></td>
<td>执行自定义脚本</td>
<td>如：<code>npm run dev</code></td>
</tr>
<tr>
<td><code>npm test</code></td>
<td>执行 <code>test</code> 脚本</td>
<td>一般用于单元测试</td>
</tr>
</tbody></table>
<p> 镜像源设置（加速）</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>功能说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>npm config set registry &lt;url&gt;</code></td>
<td>设置 NPM 镜像地址</td>
<td>如淘宝源 <code>https://registry.npmmirror.com</code></td>
</tr>
<tr>
<td><code>npm config get registry</code></td>
<td>查看当前镜像源</td>
<td>可用于确认是否设置成功</td>
</tr>
</tbody></table>
<p>其他实用命令</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>功能说明</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td><code>npm cache clean --force</code></td>
<td>清除本地缓存</td>
<td>修复安装错误时常用</td>
</tr>
<tr>
<td><code>npm doctor</code></td>
<td>检查 NPM 环境配置</td>
<td>帮助诊断问题</td>
</tr>
<tr>
<td><code>npm version &lt;type&gt;</code></td>
<td>自动升级版本号</td>
<td><code>type</code>为 <code>patch</code>、<code>minor</code>、<code>major</code> 等</td>
</tr>
<tr>
<td><code>npm publish</code></td>
<td>发布自己的包到 NPM 仓库</td>
<td>需要先登录账户</td>
</tr>
<tr>
<td><code>npm login</code></td>
<td>登录到 NPM 账号</td>
<td>发布包前必须登录</td>
</tr>
</tbody></table>
<h2 id="Yarn和Pnpm"><a href="#Yarn和Pnpm" class="headerlink" title="Yarn和Pnpm"></a>Yarn和Pnpm</h2><p><strong>Yarn</strong></p>
<ul>
<li>安装速度快（比 npm 早期版本快很多）</li>
<li>默认使用 <code>yarn.lock</code> 锁定依赖</li>
<li>支持 <strong>Plug’n’Play（PnP）</strong>，跳过 <code>node_modules</code></li>
</ul>
<p><strong>pnpm</strong></p>
<ul>
<li>采用 <strong>符号链接 + 全局内容寻址存储</strong> 节省磁盘空间</li>
<li>更严格的依赖隔离，防止 <code>npm</code> 和 <code>yarn</code> 容易出现的“幽灵依赖”</li>
<li>支持 monorepo（内置 workspace）</li>
</ul>
<table>
<thead>
<tr>
<th>功能</th>
<th>npm 命令</th>
<th>yarn 命令</th>
<th>pnpm 命令</th>
</tr>
</thead>
<tbody><tr>
<td>初始化项目</td>
<td><code>npm init</code>  <code>npm init -y</code></td>
<td><code>yarn init</code>  <code>yarn init -y</code></td>
<td><code>pnpm init</code>  <code>pnpm init -y</code></td>
</tr>
<tr>
<td>安装依赖（全部）</td>
<td><code>npm install</code>  <code>npm i</code></td>
<td><code>yarn install</code></td>
<td><code>pnpm install</code></td>
</tr>
<tr>
<td>安装依赖（指定）</td>
<td><code>npm install 包名</code></td>
<td><code>yarn add 包名</code></td>
<td><code>pnpm add 包名</code></td>
</tr>
<tr>
<td>安装开发依赖</td>
<td><code>npm install 包名 --save-dev</code>  <code>npm i 包名 -D</code></td>
<td><code>yarn add 包名 --dev</code></td>
<td><code>pnpm add 包名 -D</code></td>
</tr>
<tr>
<td>安装全局包</td>
<td><code>npm install -g 包名</code></td>
<td><code>yarn global add 包名</code></td>
<td><code>pnpm add -g 包名</code></td>
</tr>
<tr>
<td>移除依赖</td>
<td><code>npm uninstall 包名</code>  <code>npm rm 包名</code></td>
<td><code>yarn remove 包名</code></td>
<td><code>pnpm remove 包名</code></td>
</tr>
<tr>
<td>更新依赖</td>
<td><code>npm update 包名</code></td>
<td><code>yarn upgrade 包名</code></td>
<td><code>pnpm update 包名</code></td>
</tr>
<tr>
<td>查看过期依赖</td>
<td><code>npm outdated</code></td>
<td><code>yarn outdated</code></td>
<td><code>pnpm outdated</code></td>
</tr>
<tr>
<td>运行脚本</td>
<td><code>npm run 脚本名</code></td>
<td><code>yarn run 脚本名</code>  <code>yarn 脚本名</code></td>
<td><code>pnpm run 脚本名</code>  <code>pnpm 脚本名</code></td>
</tr>
<tr>
<td>清缓存</td>
<td><code>npm cache clean --force</code></td>
<td><code>yarn cache clean</code></td>
<td><code>pnpm store prune</code></td>
</tr>
<tr>
<td>查看依赖树</td>
<td><code>npm list</code></td>
<td><code>yarn list</code></td>
<td><code>pnpm list</code></td>
</tr>
<tr>
<td>安装指定版本</td>
<td><code>npm install 包名@版本</code></td>
<td><code>yarn add 包名@版本</code></td>
<td><code>pnpm add 包名@版本</code></td>
</tr>
<tr>
<td>安装本地包</td>
<td><code>npm install ./路径</code></td>
<td><code>yarn add ./路径</code></td>
<td><code>pnpm add ./路径</code></td>
</tr>
</tbody></table>
<h2 id="package-json"><a href="#package-json" class="headerlink" title="package.json"></a>package.json</h2><p><code>package.json</code> 是 <strong>Node.js</strong> 和 <strong>前端项目（如使用 npm 或 yarn 管理依赖的项目）</strong> 中的一个核心配置文件。它是一个 <strong>JSON 格式的文件</strong>，主要用来描述项目的基本信息、依赖关系、脚本命令等。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;your-project-name&quot;</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 项目名称</span><br>  <span class="hljs-attr">&quot;version&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1.0.0&quot;</span><span class="hljs-punctuation">,</span>                 <span class="hljs-comment">// 版本号，遵循语义化版本规则</span><br>  <span class="hljs-attr">&quot;description&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;A short description of your project&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 项目描述</span><br>  <span class="hljs-attr">&quot;main&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;index.js&quot;</span><span class="hljs-punctuation">,</span>                 <span class="hljs-comment">// 项目入口文件</span><br>  <span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>                       <span class="hljs-comment">// 脚本命令，可以用 npm run 命令调用</span><br>    <span class="hljs-attr">&quot;start&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;node index.js&quot;</span><span class="hljs-punctuation">,</span>       <span class="hljs-comment">// 启动项目</span><br>    <span class="hljs-attr">&quot;test&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;jest&quot;</span>                  <span class="hljs-comment">// 测试命令</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;keywords&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>                      <span class="hljs-comment">// 关键词，便于搜索</span><br>    <span class="hljs-string">&quot;node&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;express&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-string">&quot;example&quot;</span><br>  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;author&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Your Name&quot;</span><span class="hljs-punctuation">,</span>             <span class="hljs-comment">// 作者</span><br>  <span class="hljs-attr">&quot;license&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;MIT&quot;</span><span class="hljs-punctuation">,</span>                  <span class="hljs-comment">// 许可证类型</span><br>  <span class="hljs-attr">&quot;dependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>                  <span class="hljs-comment">// 生产依赖包</span><br>    <span class="hljs-attr">&quot;express&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^4.17.1&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;lodash&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^4.17.20&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;devDependencies&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>               <span class="hljs-comment">// 开发依赖包，仅在开发环境需要</span><br>    <span class="hljs-attr">&quot;jest&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^26.4.2&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;eslint&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;^7.0.0&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;repository&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>                   <span class="hljs-comment">// 代码仓库信息</span><br>    <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;git&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;url&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;https://github.com/yourname/your-repo.git&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;engines&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>                     <span class="hljs-comment">// 指定 Node.js 或 npm 的版本要求</span><br>    <span class="hljs-attr">&quot;node&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&gt;=14.0.0&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;private&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>                  <span class="hljs-comment">// 是否为私有项目，true 时禁止发布到 npm</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p><strong>常见字段作用：</strong></p>
<ul>
<li><strong>name</strong>：包的名称。</li>
<li><strong>version</strong>：版本号。</li>
<li><strong>description</strong>：项目描述。</li>
<li><strong>main</strong>：入口文件。</li>
<li><strong>scripts</strong>：定义脚本命令，如启动、测试、构建等。</li>
<li><strong>dependencies</strong>：生产环境依赖的包。</li>
<li><strong>devDependencies</strong>：开发环境依赖的包。</li>
<li><strong>repository</strong>：仓库地址。</li>
<li><strong>keywords</strong>：关键字。</li>
<li><strong>author</strong>：作者。</li>
<li><strong>license</strong>：开源协议。</li>
<li><strong>private</strong>：防止发布到 npm（通常私有项目设置为 true）。</li>
</ul>
<p><strong>生产依赖包 (<code>dependencies</code>)</strong></p>
<ul>
<li><strong>用途</strong>：这些依赖是你的项目在 <strong>运行时（生产环境）</strong> 必须依赖的包。也就是说，当你的应用真正上线、给用户使用时，程序依赖的这些包必须存在。</li>
</ul>
<p><strong>开发依赖包 (<code>devDependencies</code>)</strong></p>
<ul>
<li><strong>用途</strong>：这些依赖是你在 <strong>开发阶段</strong> 用来辅助开发、测试、构建、代码检查等的工具包，生产环境不需要它们。最终运行的时候不需要打包。</li>
</ul>
<p><strong>举例</strong>：</p>
<ul>
<li>代码打包工具（如 <code>webpack</code>、<code>rollup</code>）</li>
<li>测试框架（如 <code>jest</code>、<code>mocha</code>）</li>
<li>代码格式检查工具（如 <code>eslint</code>、<code>prettier</code>）</li>
</ul>
<p><strong><code>package-lock.json</code></strong></p>
<ul>
<li><strong>作用</strong>：锁定项目中所有依赖包的<strong>具体版本号</strong>和<strong>依赖树结构</strong>，确保每次安装依赖时，安装的包版本一致，避免因依赖版本变化导致代码不稳定，也不免反复按照多个版本依赖。node自动配置，不需要手动修改。</li>
</ul>
<h2 id="npx"><a href="#npx" class="headerlink" title="npx"></a>npx</h2><p><strong>npx</strong> 是 Node.js 自带的一个命令行工具（从 <strong>npm 5.2.0</strong> 开始内置），它的主要作用是 <strong>执行 Node.js 项目中的可执行包（CLI 工具）</strong>，而不需要你提前全局安装它。</p>
<h3 id="【为什么有-npx】"><a href="#【为什么有-npx】" class="headerlink" title="【为什么有 npx】"></a>【为什么有 npx】</h3><p>在 npx 出现之前：</p>
<ul>
<li>如果想用某个 npm 包的命令行工具（比如 <code>create-react-app</code>），你必须先用 <code>npm install -g create-react-app</code> 全局安装。</li>
<li>全局安装会导致版本管理困难，不同项目可能需要不同版本。</li>
</ul>
<p>npx 解决了这些问题：</p>
<ul>
<li>直接运行包的可执行文件，不必全局安装。</li>
<li>可以运行项目本地 <code>node_modules</code> 里的 CLI 工具。</li>
<li>支持临时安装一次性运行的工具，执行后自动清除。</li>
</ul>
<h3 id="【使用方式】"><a href="#【使用方式】" class="headerlink" title="【使用方式】"></a>【使用方式】</h3><p><strong>运行已安装在项目中的包</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npx eslint src/<br></code></pre></td></tr></table></figure>

<p>等价于：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">./node_modules/.bin/eslint src/<br></code></pre></td></tr></table></figure>

<p>（npx 会自动到 <code>node_modules/.bin</code> 找可执行文件）</p>
<p><strong>运行一次性工具（没安装过）</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npx cowsay <span class="hljs-string">&quot;Hello&quot;</span><br></code></pre></td></tr></table></figure>

<p>npx 会先下载 <code>cowsay</code>（存在临时目录），执行后删除。</p>
<p><strong>指定包版本执行</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npx create-react-app@4.0.0 my-app<br></code></pre></td></tr></table></figure>

<p>可以避免全局安装多个版本冲突。</p>
<p><strong>执行 GitHub &#x2F; Gist 上的包</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">npx github:username/repo<br>npx gist:1234567890abcdef<br></code></pre></td></tr></table></figure>

<h1 id="计算机网络知识"><a href="#计算机网络知识" class="headerlink" title="计算机网络知识"></a>计算机网络知识</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV19E411D78Q/?spm_id_from=333.337.search-card.all.click&vd_source=ff414aaf189e3a685358d2a984fd4742">王道计算机考研 计算机网络_哔哩哔哩_bilibili</a> —— 传输层和应用层部分</p>
<p><a href="./1.6W%E5%AD%97%EF%BC%81%E6%A2%B3%E7%90%8650%E9%81%93%E7%BB%8F%E5%85%B8%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E9%9D%A2%E8%AF%95%E9%A2%98%EF%BC%88%E6%94%B6%E8%97%8F%E7%89%88%EF%BC%89.pdf">1.6W字！梳理50道经典计算机网络面试题（收藏版）</a></p>
<p><a href="./%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C">计算机网络——面试题</a></p>
<p><a target="_blank" rel="noopener" href="https://www.yuque.com/cuggz/feplus/cxuwy0">计算机网络——前端充电宝</a></p>
</blockquote>
<h2 id="一个最常见的面试题"><a href="#一个最常见的面试题" class="headerlink" title="一个最常见的面试题"></a>一个最常见的面试题</h2><blockquote>
<p>当浏览器中输入一行地址以后发生了什么？（例如<a target="_blank" rel="noopener" href="https://www.baidu.com/">https://www.baidu.com</a>)</p>
</blockquote>
<ol>
<li><strong>URL 解析</strong></li>
</ol>
<ul>
<li>浏览器首先解析你输入的地址 <code>https://www.baidu.com</code></li>
<li>分解出：<ul>
<li>协议（<code>https</code>）</li>
<li>主机名（<code>www.baidu.com</code>）</li>
<li>端口（<code>https</code> 默认 443）</li>
<li>路径（<code>/</code>）</li>
<li>查询参数（如果有）</li>
</ul>
</li>
</ul>
<hr>
<ol start="2">
<li><strong>检查缓存</strong></li>
</ol>
<p>浏览器会先看看本地有没有现成的资源，按顺序查找：</p>
<ol>
<li>浏览器缓存（Memory Cache &#x2F; Disk Cache）</li>
<li>操作系统缓存（DNS 缓存）</li>
<li>路由器缓存</li>
<li>ISP DNS 缓存<br>如果缓存命中，就直接用缓存返回数据，不再走后续步骤。</li>
</ol>
<hr>
<ol start="3">
<li><strong>DNS 解析</strong></li>
</ol>
<p>如果缓存中没找到域名的 IP，需要向 DNS 服务器查询：</p>
<ol>
<li>浏览器调用操作系统的 <strong>DNS 解析库</strong></li>
<li>OS 向本地配置的 DNS 服务器发起请求</li>
<li>如果是多级域名，DNS 会从根域名服务器开始逐级解析：<ul>
<li>根 DNS → <code>.com</code> 顶级域 DNS → <code>baidu.com</code> 权威 DNS</li>
</ul>
</li>
<li>最终得到目标服务器的 <strong>IP 地址</strong>（比如 <code>220.181.38.150</code>）</li>
</ol>
<hr>
<ol start="4">
<li><strong>浏览器与服务器建立连接（TCP&#x2F;IP）</strong></li>
</ol>
<p>浏览器使用 IP 与服务器建立 TCP 连接：</p>
<ol>
<li><strong>SYN</strong>（浏览器 → 服务器，请求建立连接）</li>
<li><strong>SYN-ACK</strong>（服务器 → 浏览器，同意建立连接）</li>
<li><strong>ACK</strong>（浏览器 → 服务器，确认）<br>连接建立后，浏览器和服务器之间可以可靠地收发数据。</li>
</ol>
<p>HTTPS 会在 TCP 基础上进行 <strong>TLS 握手</strong>，确保数据加密传输：</p>
<ol>
<li>浏览器发送支持的加密算法和随机数</li>
<li>服务器返回证书和公钥</li>
<li>浏览器验证证书合法性</li>
<li>双方协商会话密钥<br>握手完成后，所有 HTTP 数据会被加密传输。</li>
</ol>
<hr>
<ol start="5">
<li><strong>浏览器发送HTTP请求</strong></li>
</ol>
<p>浏览器构造请求报文：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs makefile">GET / HTTP/1.1<br><span class="hljs-section">Host: www.baidu.com</span><br><span class="hljs-section">User-Agent: ...</span><br><span class="hljs-section">Accept: ...</span><br></code></pre></td></tr></table></figure>

<p>通过 TCP 连接发送到服务器</p>
<hr>
<ol start="6">
<li><strong>服务器处理请求</strong></li>
</ol>
<p>服务器（比如 Nginx + 应用层）：</p>
<ol>
<li>接收请求数据</li>
<li>根据 URL 路径匹配资源或调用后端程序</li>
<li>查询数据库 &#x2F; 缓存</li>
<li>生成 HTTP 响应（包含 HTML &#x2F; JSON &#x2F; 图片等）</li>
</ol>
<hr>
<ol start="7">
<li><strong>返回 HTTP 响应</strong></li>
</ol>
<ul>
<li><p>服务器把响应通过 TCP 发送给浏览器</p>
</li>
<li><p>响应报文可能是：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">HTTP/1.1</span> <span class="hljs-number">200</span> <span class="hljs-string">OK</span><br><span class="hljs-attr">Content-Type:</span> <span class="hljs-string">text/html</span><br><span class="hljs-attr">Content-Length:</span> <span class="hljs-number">1024</span><br><br><span class="hljs-string">&lt;html&gt;...&lt;/html&gt;</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>如果有 <strong>压缩（gzip&#x2F;br）</strong>，浏览器需要解压</p>
</li>
</ul>
<hr>
<ol start="8">
<li><strong>浏览器渲染页面</strong></li>
</ol>
<p>浏览器渲染引擎（如 Blink &#x2F; WebKit）执行：</p>
<ol>
<li><strong>解析 HTML</strong> → 生成 DOM 树</li>
<li><strong>解析 CSS</strong> → 生成 CSSOM 树</li>
<li><strong>合并 DOM + CSSOM</strong> → 生成渲染树</li>
<li><strong>布局（Layout）</strong>：计算元素位置和大小</li>
<li><strong>绘制（Paint）</strong>：将像素绘制到屏幕</li>
<li><strong>执行 JavaScript</strong>（如果遇到 <code>&lt;script&gt;</code> 标签，可能阻塞解析）</li>
<li>如果页面有图片、CSS、JS 等资源，会<strong>并行发起请求</strong>（重复上述流程）</li>
</ol>
<hr>
<ol start="10">
<li><strong>连接关闭</strong></li>
</ol>
<ul>
<li>如果使用 HTTP&#x2F;1.1 且有 <code>Connection: keep-alive</code>，TCP 连接会复用</li>
<li>HTTP&#x2F;2 &#x2F; HTTP&#x2F;3 会多路复用一个连接</li>
</ul>
<h2 id="体系结构"><a href="#体系结构" class="headerlink" title="体系结构"></a>体系结构</h2><p>客户端与服务器之间进行通信，需要确定三个地址：<code>MAC地址</code>、<code>IP地址</code>、<code>端口号</code>。</p>
<ul>
<li><strong>MAC 地址</strong>（物理地址）：定位 <strong>同一局域网中</strong> 的设备</li>
<li><strong>IP 地址</strong>（网络地址）：在 <strong>整个互联网范围</strong> 唯一定位一台设备（或者网络节点）</li>
<li><strong>端口号</strong>（进程地址）：在一台设备上区分不同的应用程序</li>
</ul>
<p>根据 IP地址 + 端口号， 可以确定整个互联网中唯一一台设备的唯一进程。IP就好比快递传输中的通讯地址，进程好比收件人。那么MAC地址呢？如果需要跨省传输，那么快递会经过中转站，MAC地址也会改变。也就是<font color="#409eff">IP地址不变，MAC地址每跳改变，端口号唯一定位进程</font>。</p>
<ul>
<li>源IP和目的IP地址不会变。始终表示【发货地 -&gt; 目的地】</li>
<li>源MAC地址和目的MAC地址可能改变。【发货地 -&gt; A省中转站】 -&gt; 【A省中转站 -&gt; B省中转站】 -&gt; 【B省中转站 -&gt; 目的地】</li>
</ul>
<p>其中</p>
<ul>
<li>端口号是默认或者手动配置的，在传输层添加。</li>
<li>IP地址通过DNS解析域名得到，在网络层添加。</li>
<li>MAC地址通过ARP协议，利用IP地址获取，在数据链路层添加。</li>
</ul>
<blockquote>
<p>假设客户端向服务器发送一个 HTTP 请求，整个过程从应用层开始，依次经过传输层、网络层、数据链路层，到物理层发送出去，服务器再反向解析，完成通信。</p>
</blockquote>
<ol>
<li>应用层（Application Layer）</li>
</ol>
<ul>
<li><strong>作用</strong>：提供用户直接使用的服务，处理具体应用协议，比如 HTTP、FTP、SMTP、DNS 等。</li>
<li><strong>过程</strong>：<ul>
<li>用户在浏览器输入 URL 发起 HTTP 请求。</li>
<li>应用层生成符合 HTTP 协议格式的数据（请求报文），准备发送。</li>
<li>调用下一层（传输层）接口发送数据。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>传输层（Transport Layer）</li>
</ol>
<ul>
<li><strong>作用</strong>：实现端到端的通信管理，提供可靠（TCP）或不可靠（UDP）的传输服务，负责分段、重传、流量控制、端口管理。</li>
<li><strong>过程</strong>：<ul>
<li>应用层数据被切分成传输层的数据段（TCP 段或 UDP 数据报）。</li>
<li>为数据段添加<strong>源端口和目的端口号</strong>，确定通信的进程。</li>
<li>如果是 TCP，会建立连接（三次握手），保证可靠传输。</li>
<li>数据段传给下一层（网络层）。</li>
</ul>
</li>
</ul>
<ol start="3">
<li>网络层（Network Layer）</li>
</ol>
<ul>
<li><strong>作用</strong>：负责数据包<strong>从源主机到目标主机的路由选择和转发，主要协议是 IP</strong>。</li>
<li><strong>过程</strong>：<ul>
<li>传输层传过来的数据段被封装成数据包（IP 包）。</li>
<li>添加源 IP 和目的 IP 地址。</li>
<li>网络层根据目标 IP 寻找路由路径，决定发送到哪个下一跳。</li>
<li>发送给数据链路层。</li>
</ul>
</li>
</ul>
<ol start="4">
<li>数据链路层（Data Link Layer）</li>
</ol>
<ul>
<li><strong>作用</strong>：负责相邻节点之间的可靠传输，处理物理地址（MAC）、帧的封装和差错检测。</li>
<li><strong>过程</strong>：<ul>
<li>将网络层传来的数据包封装成帧（Frame）。</li>
<li><strong>添加源 MAC 和目的 MAC 地址</strong>。</li>
<li>通过帧校验序列（FCS）实现差错检测。</li>
<li>发送到物理层。</li>
</ul>
</li>
</ul>
<ol start="5">
<li>物理层（Physical Layer）</li>
</ol>
<ul>
<li><strong>作用</strong>：负责物理传输媒体上的比特流传输，如电信号、光信号等。</li>
<li><strong>过程</strong>：<ul>
<li>把数据链路层的帧转化成适合传输的电信号或光信号。</li>
<li>通过网线、光纤、无线信道等物理媒介发送给目标设备。</li>
</ul>
</li>
</ul>
<p>传输到目标服务器后，接收端的流程是反向的：</p>
<ol>
<li><strong>物理层</strong>接收信号，转成比特流交给数据链路层。</li>
<li><strong>数据链路层</strong>解析帧，校验数据，提取数据包。</li>
<li><strong>网络层</strong>检查 IP 地址，进行路由处理，将数据包交给传输层。</li>
<li><strong>传输层</strong>重组数据段，校验完整性，确认端口，组装成应用层数据。</li>
<li><strong>应用层</strong>根据协议解析数据，完成请求处理（如 HTTP 请求被 Web 服务器解析），返回响应。</li>
</ol>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs scss">客户端（发送端）<br>应用层 (HTTP请求)<br>    ↓<br>传输层 (TCP段，加端口)<br>    ↓<br>网络层 (IP包，加IP地址)<br>    ↓<br>数据链路层 (帧，加MAC地址)<br>    ↓<br>物理层 (电信号/光信号)<br><br>--------------------网络传输--------------------<br><br>服务器端（接收端）<br>物理层 (接收信号)<br>    ↑<br>数据链路层 (帧解包，MAC地址校验)<br>    ↑<br>网络层 (IP解包，路由处理)<br>    ↑<br>传输层 (TCP重组，端口校验)<br>    ↑<br>应用层 (HTTP请求解析)<br></code></pre></td></tr></table></figure>

<p><font color="#409eff">为什么同时需要IP地址和MAC地址：</font></p>
<p><strong>MAC 地址（物理地址 &#x2F; 硬件地址）</strong></p>
<ul>
<li><p>作用：<br>用来标识 <strong>同一局域网内</strong> 的网络设备，在数据链路层用于点对点传输。</p>
</li>
<li><p>特性：</p>
<ul>
<li>唯一性：理论上全球唯一。</li>
<li>不可更改（可以通过软件伪造）。</li>
<li>只在局域网范围内有效，跨网络传输时会被替换（由路由器处理）。</li>
</ul>
</li>
</ul>
<p><strong>IP 地址（逻辑地址）</strong></p>
<ul>
<li><p><strong>作用</strong>：<br>用于在 <strong>不同网络之间</strong> 定位主机，实现数据包的路由转发。</p>
</li>
<li><p><strong>特性</strong>：</p>
<ul>
<li>逻辑性：可以手动配置，也可以自动分配（DHCP）。</li>
<li>会变化（设备换网络、换运营商，IP就可能变）。</li>
<li>在跨网通信时必须依赖IP进行寻址。</li>
</ul>
<blockquote>
<p>MAC地址跨网络传输时会被更新，起到中转的作用。</p>
</blockquote>
<p>示例：你的电脑（Client）要访问 <strong><code>www.example.com</code></strong> 服务器（Server）。</p>
</li>
</ul>
<p><strong>步骤 1：DNS 解析</strong></p>
<ol>
<li>你在浏览器输入 <code>www.example.com</code>。</li>
<li>浏览器向 <strong>DNS 服务器</strong> 查询，获取目标服务器的 <strong>IP 地址</strong>（假设是 <code>93.184.216.34</code>）。</li>
<li>现在你的电脑知道了对方的 IP 地址，但还不知道对方的 <strong>MAC 地址</strong>。</li>
</ol>
<p><strong>步骤 2：ARP 获取 MAC 地址（局域网内通信）</strong></p>
<ol>
<li>如果目标 IP 在<strong>同一个局域网</strong>：<ul>
<li>电脑发出 <strong>ARP 广播</strong>（”谁是 93.184.216.34，请告诉我你的 MAC 地址”）。</li>
<li>目标主机返回自己的 MAC 地址。</li>
</ul>
</li>
<li>如果目标 IP 不在同一个局域网（大多数访问互联网的情况）：<ul>
<li>电脑会先查本地路由表，发现目标 IP 要通过<strong>网关（路由器）</strong>转发。</li>
<li>电脑用 ARP 请求获取 <strong>网关的 MAC 地址</strong>（因为第一跳是网关，而不是服务器）。</li>
</ul>
</li>
</ol>
<p><strong>步骤 3：封装并发送数据</strong></p>
<ol>
<li>电脑把数据封装成 <strong>IP 包</strong>（源 IP &#x3D; 你的电脑，目标 IP &#x3D; 服务器）。</li>
<li>在 IP 包外面再封装一层 <strong>以太网帧</strong>（源 MAC &#x3D; 你的电脑，目标 MAC &#x3D; 网关的 MAC）。</li>
<li>数据从你的电脑发到网关。</li>
</ol>
<p><strong>步骤 4：跨网络传输（路由器处理）</strong></p>
<ol>
<li>网关收到帧后，解封装，读取 IP 头，发现目标 IP 在外网。</li>
<li>根据路由表，把数据转发给下一个路由器：<ul>
<li><font color="#409eff">修改以太网帧的 <strong>源 MAC</strong> &#x3D; 自己的 MAC，<strong>目标 MAC</strong> &#x3D; 下一跳路由器的 MAC。</font></li>
<li><strong>IP 地址保持不变</strong>（源 IP 依旧是你的电脑，目标 IP 依旧是服务器）。</li>
</ul>
</li>
<li>经过多个路由器，这个过程不断重复。</li>
</ol>
<p><strong>步骤 5：目标服务器接收</strong></p>
<ol>
<li>数据到达服务器所在的局域网后，最后一个路由器通过 ARP 找到服务器的 MAC 地址。</li>
<li>以太网帧（目标 MAC &#x3D; 服务器 MAC）送到服务器。</li>
<li>服务器解封装，以 IP 为依据确认是发给自己的，然后交给 TCP&#x2F;应用层处理。</li>
</ol>
<p><strong>核心要点</strong></p>
<ul>
<li><strong>IP 地址</strong>：跨网络定位主机（类似全球地址系统）。</li>
<li><strong>MAC 地址</strong>：在局域网内唯一标识设备（类似局域网内门牌号）。</li>
<li><strong>ARP 协议</strong>：IP ↔ MAC 之间的翻译员。</li>
<li>在跨网通信中，<strong>IP 地址不变</strong>，<strong>MAC 地址每一跳都会改变</strong>（因为每一跳的物理链路是不同的）。</li>
</ul>
<h2 id="DNS解析"><a href="#DNS解析" class="headerlink" title="DNS解析"></a>DNS解析</h2><h3 id="1-DNS-协议的概念"><a href="#1-DNS-协议的概念" class="headerlink" title="1. DNS 协议的概念"></a>1. DNS 协议的概念</h3><p><strong>概念</strong>： DNS 是域名系统 (Domain Name System) 的缩写，提供的是一种主机名到 IP 地址的转换服务，就是我们常说的域名系统。它是一个由分层的 DNS 服务器组成的分布式数据库，是定义了主机如何查询这个分布式数据库的方式的应用层协议。能够使人更方便的访问互联网，而不用去记住能够被机器直接读取的IP数串。</p>
<p><strong>作用</strong>： 将域名解析为IP地址，客户端向DNS服务器（DNS服务器有自己的IP地址）发送域名查询请求，DNS服务器告知客户机Web服务器的IP 地址。</p>
<h3 id="2-DNS同时使用TCP和UDP协议"><a href="#2-DNS同时使用TCP和UDP协议" class="headerlink" title="2. DNS同时使用TCP和UDP协议"></a>2. DNS同时使用TCP和UDP协议</h3><p><strong>DNS占用53号端口，同时使用TCP和UDP协议。</strong></p>
<p>（1）在区域传输的时候使用TCP协议</p>
<ul>
<li>辅域名服务器会定时（一般3小时）向主域名服务器进行查询以便了解数据是否有变动。如有变动，会执行一次区域传送，进行数据同步。区域传送使用TCP而不是UDP，因为数据同步传送的数据量比一个请求应答的数据量要多得多。</li>
<li>TCP是一种可靠连接，保证了数据的准确性。</li>
</ul>
<p>（2）在域名解析的时候使用UDP协议</p>
<ul>
<li>客户端向DNS服务器查询域名，一般返回的内容都不超过512字节，用UDP传输即可。不用经过三次握手，这样DNS服务器负载更低，响应更快。理论上说，客户端也可以指定向DNS服务器查询时用TCP，但事实上，很多DNS服务器进行配置的时候，仅支持UDP查询包。</li>
</ul>
<h3 id="3-DNS完整的查询过程"><a href="#3-DNS完整的查询过程" class="headerlink" title="3. DNS完整的查询过程"></a>3. DNS完整的查询过程</h3><p>DNS服务器解析域名的过程：</p>
<ul>
<li>首先会在<strong>浏览器的缓存</strong>中查找对应的IP地址，如果查找到直接返回，若找不到继续下一步</li>
<li>将请求发送给<strong>本地DNS服务器</strong>，在本地域名服务器缓存中查询，如果查找到，就直接将查找结果返回，若找不到继续下一步</li>
<li>本地DNS服务器向<strong>根域名服务器</strong>发送请求，根域名服务器会返回一个所查询域的顶级域名服务器地址</li>
<li>本地DNS服务器向<strong>顶级域名服务器</strong>发送请求，接受请求的服务器查询自己的缓存，如果有记录，就返回查询结果，如果没有就返回相关的下一级的权威域名服务器的地址</li>
<li>本地DNS服务器向<strong>权威域名服务器</strong>发送请求，域名服务器返回对应的结果</li>
<li>本地DNS服务器将返回结果保存在缓存中，便于下次使用</li>
<li>本地DNS服务器将返回结果返回给浏览器</li>
</ul>
<p>比如我们如果想要查询 <a target="_blank" rel="noopener" href="http://www.baidu.com/">www.baidu.com</a> 的 IP 地址，我们首先会在浏览器的缓存中查找是否有该域名的缓存，如果不存在就将请求发送到本地的 DNS 服务器中，本地DNS服务器会判断是否存在该域名的缓存，如果不存在，则向根域名服务器发送一个请求，根域名服务器返回负责 .com 的顶级域名服务器的 IP 地址的列表。然后本地 DNS 服务器再向其中一个负责 .com 的顶级域名服务器发送一个请求，负责 .com 的顶级域名服务器返回负责 .baidu 的权威域名服务器的 IP 地址列表。然后本地 DNS 服务器再向其中一个权威域名服务器发送一个请求，最后权威域名服务器返回一个对应的主机名的 IP 地址列表。</p>
<h3 id="4-迭代查询与递归查询"><a href="#4-迭代查询与递归查询" class="headerlink" title="4.迭代查询与递归查询"></a>4.迭代查询与递归查询</h3><p>实际上，DNS解析是一个包含迭代查询和递归查询的过程。</p>
<ul>
<li><strong>递归查询</strong>指的是查询请求发出后，域名服务器代为向下一级域名服务器发出请求，最后向用户返回查询的最终结果。使用递归 查询，用户只需要发出一次查询请求。</li>
<li><strong>迭代查询</strong>指的是查询请求后，域名服务器返回单次查询的结果。下一级的查询由用户自己请求。使用迭代查询，用户需要发出 多次的查询请求。</li>
</ul>
<p>一般我们向本地 DNS 服务器发送请求的方式就是递归查询，因为我们只需要发出一次请求，然后本地 DNS 服务器返回给我 们最终的请求结果。而本地 DNS 服务器向其他域名服务器请求的过程是迭代查询的过程，因为每一次域名服务器只返回单次 查询的结果，下一级的查询由本地 DNS 服务器自己进行。</p>
<h3 id="5-DNS-记录和报文"><a href="#5-DNS-记录和报文" class="headerlink" title="5. DNS 记录和报文"></a>5. DNS 记录和报文</h3><p>DNS 服务器中以资源记录的形式存储信息，每一个 DNS 响应报文一般包含多条资源记录。一条资源记录的具体的格式为</p>
<p><code>（Name，Value，Type，TTL）</code></p>
<p>其中 TTL 是资源记录的生存时间，它定义了资源记录能够被其他的 DNS 服务器缓存多长时间。</p>
<p>常用的一共有四种 Type 的值，分别是 A、NS、CNAME 和 MX ，不同 Type 的值，对应资源记录代表的意义不同。</p>
<ol>
<li>如果 Type &#x3D; A，则 Name 是主机名，Value 是主机名对应的 IP 地址。因此一条记录为 A 的资源记录，提供了标 准的主机名到 IP 地址的映射。</li>
<li>如果 Type &#x3D; NS，则 Name 是个域名，Value 是负责该域名的 DNS 服务器的主机名。这个记录主要用于 DNS 链式 查询时，返回下一级需要查询的 DNS 服务器的信息。</li>
<li>如果 Type &#x3D; CNAME，则 Name 为别名，Value 为该主机的规范主机名。该条记录用于向查询的主机返回一个主机名 对应的规范主机名，从而告诉查询主机去查询这个主机名的 IP 地址。主机别名主要是为了通过给一些复杂的主机名提供 一个便于记忆的简单的别名。</li>
<li>如果 Type &#x3D; MX，则 Name 为一个邮件服务器的别名，Value 为邮件服务器的规范主机名。它的作用和 CNAME 是一 样的，都是为了解决规范主机名不利于记忆的缺点。</li>
</ol>
<h2 id="TCP和UDP协议"><a href="#TCP和UDP协议" class="headerlink" title="TCP和UDP协议"></a>TCP和UDP协议</h2><h3 id="【TCP与UDP协议特点】"><a href="#【TCP与UDP协议特点】" class="headerlink" title="【TCP与UDP协议特点】"></a>【TCP与UDP协议特点】</h3><p><strong>TCP 协议特点</strong></p>
<ul>
<li><strong>面向连接</strong>：通信前需要建立连接（三次握手）。</li>
<li><strong>可靠传输</strong>：通过<strong>确认应答、重传机制</strong>保证数据不丢失、不乱序。</li>
<li><strong>面向字节流</strong>：数据被看作连续的字节流，没有明确边界。</li>
<li><strong>流量控制</strong>：通过滑动窗口控制发送速率，避免接收方处理不过来。</li>
<li><strong>拥塞控制</strong>：慢启动、拥塞避免、快速重传等算法，避免网络拥堵。</li>
<li><strong>开销相对大</strong>：头部20字节起。</li>
</ul>
<p><strong>UDP 协议特点</strong></p>
<ul>
<li><strong>无连接</strong>：发送数据前不建立连接，直接发送。</li>
<li><strong>不保证可靠性</strong>：不确认、不重传，可能丢包、乱序。</li>
<li><strong>面向报文</strong>：发送方一次发送的数据作为一个整体接收，保留数据边界。</li>
<li><strong>速度快</strong>：无握手和复杂控制，延迟低。</li>
<li><strong>开销小</strong>：头部只有8字节。</li>
<li><strong>常用于</strong>：实时通信（视频、语音）、广播、多播、DNS查询等。</li>
</ul>
<p><strong>TCP vs UDP 对比表</strong></p>
<table>
<thead>
<tr>
<th>特性</th>
<th>TCP</th>
<th>UDP</th>
</tr>
</thead>
<tbody><tr>
<td>是否连接</td>
<td>面向连接</td>
<td>无连接</td>
</tr>
<tr>
<td>可靠性</td>
<td>可靠</td>
<td>不可靠</td>
</tr>
<tr>
<td>数据顺序</td>
<td>保证顺序</td>
<td>不保证</td>
</tr>
<tr>
<td>传输形式</td>
<td>字节流</td>
<td>报文</td>
</tr>
<tr>
<td>速度</td>
<td>较慢</td>
<td>快</td>
</tr>
<tr>
<td>开销</td>
<td>大（20字节以上）</td>
<td>小（8字节）</td>
</tr>
<tr>
<td>场景</td>
<td>HTTP、FTP、SMTP</td>
<td>视频、语音、DNS</td>
</tr>
</tbody></table>
<p><strong>应用场景</strong></p>
<ul>
<li><strong>TCP</strong>：需要可靠性和顺序的传输（如网页、文件、邮件）。</li>
<li><strong>UDP</strong>：追求速度、容忍少量丢包的应用（如直播、游戏、DNS）。</li>
</ul>
<h3 id="【面试考点】"><a href="#【面试考点】" class="headerlink" title="【面试考点】"></a>【面试考点】</h3><ul>
<li>UDP协议特点</li>
<li>TPC协议特点</li>
<li>TPC三次握手（为什么不采用二次握手）</li>
<li>TPC四次挥手（为什么不采用三次挥手）</li>
<li>TPC拥塞控制（慢开始，拥塞控制，快开始，快重传）</li>
<li>TPC流量控制（根据返回窗口和拥塞窗口计算）</li>
<li>TPC可靠传输（校验（不是重点）—— 序号 —— 确认 —— 重传（超时重传和快重传）</li>
</ul>
<p><font color="#409eff">具体内容见标题下方PDF笔记链接</font></p>
<h2 id="HTTP协议"><a href="#HTTP协议" class="headerlink" title="HTTP协议"></a>HTTP协议</h2><h3 id="【HTTP协议概述】"><a href="#【HTTP协议概述】" class="headerlink" title="【HTTP协议概述】"></a>【HTTP协议概述】</h3><p>HTTP 是超文本传输协议，它定义了客户端和服务器之间交换报文的格式和方式，默认使用 80 端口。它使用 TCP 作为传输层协议，保证了数据传输的可靠性。</p>
<p>HTTP协议具有以下<strong>优点</strong>：</p>
<ul>
<li>支持客户端&#x2F;服务器模式</li>
<li><strong>简单快速</strong>：客户向服务器请求服务时，只需传送请求方法和路径。由于 HTTP 协议简单，使得 HTTP 服务器的程序规模小，因而通信速度很快。</li>
<li><strong>无连接</strong>：无连接的含义是限制每次链接只处理一个请求。服务器处理完客户的请求，并收到客户的应答后，即断开链接，采用这种方式可以节省传输时间。</li>
<li><strong>无状态</strong>：HTTP 协议是无状态协议，这里的状态是指通信过程的上下文信息。缺少状态意味着如果后续处理需要前面的信息，则它必须重传，这样可能会导致每次连接传送的数据量增大。另一方面，在服务器不需要先前信息时它的应答就比较快。</li>
<li><strong>灵活</strong>：HTTP 允许传输任意类型的数据对象。正在传输的类型由 Content-Type 加以标记。</li>
</ul>
<p>HTTP协议具有以下<strong>缺点</strong>：</p>
<ul>
<li><strong>无状态：</strong>HTTP 是一个无状态的协议，HTTP 服务器不会保存关于客户的任何信息。</li>
<li><strong>明文传输：</strong>协议中的报文使用的是文本形式，这就直接暴露给外界，不安全。</li>
<li><strong>不安全</strong></li>
</ul>
<p>（1）通信使用明文（不加密），内容可能会被窃听</p>
<p>（2）不验证通信方的身份，因此有可能遭遇伪装</p>
<p>（3）无法证明报文的完整性，所以有可能已遭篡改</p>
<h3 id="【HTTP连接方式】"><a href="#【HTTP连接方式】" class="headerlink" title="【HTTP连接方式】"></a>【HTTP连接方式】</h3><p>HTTP 协议是基于 TCP&#x2F;IP，并且使用了<strong>请求-应答</strong>的通信模式，所以性能的关键就在这两点里。</p>
<ul>
<li><strong>长连接</strong></li>
</ul>
<p>HTTP协议有两种连接模式，一种是持续连接，一种非持续连接。</p>
<p>（1）非持续连接指的是服务器必须为每一个请求的对象建立和维护一个全新的连接。</p>
<p>（2）持续连接下，TCP 连接默认不关闭，可以被多个请求复用。采用持续连接的好处是可以避免每次建立 TCP 连接三次握手时所花费的时间。</p>
<p>对于不同版本的采用不同的连接方式：</p>
<ul>
<li><p>在HTTP&#x2F;1.0 每发起一个请求，都要新建一次 TCP 连接（三次握手），而且是串行请求，做了无畏的 TCP 连接建立和断开，增加了通信开销。该版本使用的非持续的连接，但是可以在请求时，加上 Connection: keep-a live 来要求服务器不要关闭 TCP 连接。</p>
</li>
<li><p>在HTTP&#x2F;1.1 提出了<strong>长连接</strong>的通信方式，也叫持久连接。这种方式的好处在于减少了 TCP 连接的重复建立和断开所造成的额外开销，减轻了服务器端的负载。该版本及以后版本默认采用的是持续的连接。目前对于同一个域，大多数浏览器支持同时建立 6 个持久连接。</p>
</li>
<li><p><strong>管道网络传输</strong></p>
</li>
</ul>
<p>HTTP&#x2F;1.1 采用了长连接的方式，这使得管道（pipeline）网络传输成为了可能。</p>
<p>管道（pipeline）网络传输是指：可以在同一个 TCP 连接里面，客户端可以发起多个请求，只要第一个请求发出去了，不必等其回来，就可以发第二个请求出去，可以减少整体的响应时间。但是服务器还是按照顺序回应请求。要是前面的回应特别慢，后面就会有许多请求排队等着。这称为队头堵塞。<font color="#409eff">也就是流水线式连接</font>。</p>
<h3 id="【HTTP无连接含义】"><a href="#【HTTP无连接含义】" class="headerlink" title="【HTTP无连接含义】"></a>【HTTP无连接含义】</h3><ol>
<li>“无连接”指的是<strong>应用层的逻辑连接</strong></li>
</ol>
<ul>
<li>HTTP是<strong>应用层协议</strong>，设计时的“无连接”是指：<ul>
<li><strong>每个请求&#x2F;响应完成后，应用层不会保留连接状态</strong></li>
<li>一次请求处理完毕，双方不会保存这次会话的信息</li>
</ul>
</li>
<li>换句话说，HTTP协议本身不管理连接的持续，也不维持会话状态</li>
</ul>
<ol start="2">
<li>HTTP与传输层TCP的关系</li>
</ol>
<ul>
<li>HTTP协议基于<strong>传输层TCP协议</strong></li>
<li>TCP是<strong>面向连接的协议</strong>，会建立并维护连接（如三次握手、四次挥手）</li>
<li>但HTTP层面，在一次请求-响应完成后，默认关闭TCP连接（HTTP&#x2F;1.0短连接）</li>
</ul>
<ol start="3">
<li>什么叫无连接</li>
</ol>
<ul>
<li>请求和响应是<strong>独立的</strong></li>
<li>不需要也不保持之前请求的状态</li>
<li>每次请求都必须携带完成该请求所需的全部信息（例如cookies、认证信息等）</li>
</ul>
<ol start="4">
<li>现代HTTP的持久连接</li>
</ol>
<ul>
<li>HTTP&#x2F;1.1引入持久连接，允许复用底层TCP连接，但仍然保持HTTP层的无状态特性</li>
<li>即使连接保持，HTTP仍然是无连接协议，因为它不维护会话信息，状态由应用管理</li>
</ul>
<p><font color="#409eff">HTTP的无连接也使得HTTP是无状态的</font>。</p>
<h3 id="【HTTP无状态含义】"><a href="#【HTTP无状态含义】" class="headerlink" title="【HTTP无状态含义】"></a>【HTTP无状态含义】</h3><p><strong>1. 定义</strong></p>
<ul>
<li><strong>HTTP是无状态协议</strong>，意味着<strong>服务器不会自动保留客户端之前请求的任何信息</strong>。</li>
<li>每一次HTTP请求都是<strong>独立的、互不关联</strong>的。</li>
</ul>
<ol start="2">
<li><strong>具体表现</strong></li>
</ol>
<ul>
<li>当客户端向服务器发送请求时，服务器仅根据当前请求来处理，并不依赖之前的请求。</li>
<li>请求处理完毕后，服务器不会保存任何会话信息（状态）。</li>
<li>下一次请求服务器不会“记得”之前的任何事情。</li>
</ul>
<ol start="3">
<li><strong>举例说明</strong></li>
</ol>
<ul>
<li>你第一次访问一个购物网站，添加商品到购物车后关闭页面。</li>
<li>第二次访问时，如果没有额外机制，服务器不知道你之前放了什么商品，因为HTTP本身不保存状态。</li>
</ul>
<ol start="4">
<li><strong>无状态带来的问题</strong></li>
</ol>
<ul>
<li>不能自动跟踪用户会话</li>
<li>需要通过其他机制实现状态管理（例如：Cookie、Session、Token）</li>
</ul>
<ol start="5">
<li><strong>如何解决无状态？</strong></li>
</ol>
<ul>
<li><strong>Cookie</strong>：浏览器保存少量信息，随请求发送给服务器</li>
<li><strong>Session</strong>：服务器存储用户状态，客户端通过Cookie保存会话ID</li>
<li><strong>Token</strong>：如JWT，包含用户身份信息，客户端每次请求携带</li>
</ul>
<ol start="6">
<li><strong>为什么设计为无状态？</strong></li>
</ol>
<ul>
<li>简化服务器设计，提高性能和可伸缩性</li>
<li>服务器无需保存大量状态信息，方便分布式部署</li>
</ul>
<h3 id="【HTTP1-1】"><a href="#【HTTP1-1】" class="headerlink" title="【HTTP1.1】"></a>【HTTP1.1】</h3><p><strong>HTTP 1.1版本</strong>较之前的1.0版本又有了更大的更新，它进一步完善了HTTP协议，现在仍然有在使用，它主要有以下更新：</p>
<ul>
<li><strong>持久连接（长连接）</strong><br>该版本之前的版本所建立的都是短连接，该版本引入了持久连接的概念，就是TCP连接默认是不关闭的，建立一个TCP连接，就可以发送多个请求，减少了建立和关闭连接的消耗和延迟。<br>在请求头设置一个非标准的Connection字段:<code>Connection: keep-alive</code>就可以进行长连接，这个字段要求服务器不要关闭TCP连接，服务器同样会回应这个字段。如果想要关闭TCP连接，就要在请求中设置字段：<code>Connection: false</code></li>
<li><strong>管道机制(流水线式）</strong>：该版本还引入了管道机制，即在一个TCP连接里，客户端可以同时发送多个请求，不需要等收到上一个请求回应，就可以发送新的请求，但是请求的响应还是按照请求发送的顺序返回的，这样就进一步提高了HTTP协议的效率</li>
<li><strong>分块传输编码</strong>：在HTTP1.0版本中，如果在服务器端遇到较为耗费时间的操作，那么需要等到这一操作全部完成后，才会向客户端发送数据，这段等待时间很影响性能和客户体验。多以使用<strong>分块传输编码</strong>，只要请求或者回应的头部信息有<code>Transfer-Encoding</code>字段：<code>Transfer-Encoding: chunked</code>，就表明回应将由数量未定的数据块组成。每个非空的数据块之前，会有一个16进制的数值，表示这个块的长度。最后是一个大小为0的块，就表示本次回应的数据发送完了</li>
<li>加入了新的<strong>请求方法</strong>：<strong>PUT、PATCH、HEAD、 OPTIONS、DELETE</strong></li>
<li>优化了<strong>缓存机制</strong>：<strong>强缓存</strong>和<strong>协商缓存</strong></li>
<li>客户端请求的头部信息<strong>加入了</strong><code>Host</code><strong>字段</strong>，用来指定服务器的域名，这样就可以区分同一个物理主机中的不同虚拟主机的域名</li>
</ul>
<h3 id="【HTTPS】"><a href="#【HTTPS】" class="headerlink" title="【HTTPS】"></a>【HTTPS】</h3><h4 id="1-什么是HTTPS协议？"><a href="#1-什么是HTTPS协议？" class="headerlink" title="1. 什么是HTTPS协议？"></a>1. 什么是HTTPS协议？</h4><p>超文本传输安全协议（Hypertext Transfer Protocol Secure，简称：HTTPS）是一种通过计算机网络进行安全通信的传输协议。HTTPS经由HTTP进行通信，但利用SSL&#x2F;TLS来加密数据包。HTTPS开发的主要目的，是提供对网站服务器的身份认证，保护交换数据的隐私与完整性。</p>
<img src="/2025/12/17/NodeJS/NodeJS%E6%A0%B8%E5%BF%83%E6%80%BB%E7%BB%93/1603965685749-8cc21a1b-4277-42b1-aeed-18978c1cdb95.png" srcset="/img/loading.gif" lazyload class title="img">

<p>HTTP协议采用<strong>明文传输</strong>信息，存在<strong>信息窃听</strong>、<strong>信息篡改</strong>和<strong>信息劫持</strong>的风险，而协议TLS&#x2F;SSL具有<strong>身份验证</strong>、<strong>信息加密</strong>和<strong>完整性校验</strong>的功能，可以避免此类问题发生。</p>
<p>安全层的主要职责就是<strong>对发起的HTTP请求的数据进行加密操作</strong> 和 <strong>对接收到的HTTP的内容进行解密操作</strong>。</p>
<h4 id="2-TLS-SSL的工作原理"><a href="#2-TLS-SSL的工作原理" class="headerlink" title="2. TLS&#x2F;SSL的工作原理"></a>2. TLS&#x2F;SSL的工作原理</h4><p><strong>TLS&#x2F;SSL</strong>全称安全传输层协议（Transport Layer Security）, 是介于TCP和HTTP之间的一层安全协议，不影响原有的TCP协议和HTTP协议，所以使用HTTPS基本上不需要对HTTP页面进行太多的改造。</p>
<p>TLS&#x2F;SSL的功能实现主要依赖三类基本算法：<strong>散列函数hash</strong>、<strong>对称加密</strong>、<strong>非对称加密</strong>。这三类算法的作用如下：</p>
<ul>
<li>基于散列函数验证信息的完整性</li>
<li>对称加密算法采用协商的秘钥对数据加密</li>
<li>非对称加密实现身份认证和秘钥协商<img src="/2025/12/17/NodeJS/NodeJS%E6%A0%B8%E5%BF%83%E6%80%BB%E7%BB%93/1603965685769-63a91dae-936d-42d3-8571-577cefa11e33.png" srcset="/img/loading.gif" lazyload class title="img"></li>
</ul>
<p><strong>2.1 散列函数hash</strong></p>
<p>常见的散列函数有MD5、SHA1、SHA256。该函数的特点是单向不可逆，对输入数据非常敏感，输出的长度固定，任何数据的修改都会改变散列函数的结果，可以用于防止信息篡改并验证数据的完整性。</p>
<p><strong>特点：</strong> 在信息传输过程中，散列函数不能三都实现信息防篡改，由于传输是明文传输，中间人可以修改信息后重新计算信息的摘要，所以需要对传输的信息和信息摘要进行加密。</p>
<p><strong>2.2 对称加密</strong></p>
<p>对称加密的方法是，双方使用同一个秘钥对数据进行加密和解密。但是对称加密的存在一个问题，就 是如何保证秘钥传输的安全性，因为秘钥还是会通过网络传输的，一旦秘钥被其他人获取到，那么整个加密过程就毫无作用了。 这就要用到非对称加密的方法。</p>
<p>常见的对称加密算法有AES-CBC、DES、3DES、AES-GCM等。相同的秘钥可以用于信息的加密和解密。掌握秘钥才能获取信息，防止信息窃听，其通讯方式是一对一。</p>
<p><strong>特点：</strong> 对称加密的优势就是信息传输使用一对一，需要共享相同的密码，密码的安全是保证信息安全的基础，服务器和N个客户端通信，需要维持N个密码记录且不能修改密码。</p>
<p><strong>2.3 非对称加密</strong></p>
<p>非对称加密的方法是，我们拥有两个秘钥，一个是公钥，一个是私钥。公钥是公开的，私钥是保密的。用私钥加密的数据，只 有对应的公钥才能解密，用公钥加密的数据，只有对应的私钥才能解密。我们可以将公钥公布出去，任何想和我们通信的客户， 都可以使用我们提供的公钥对数据进行加密，这样我们就可以使用私钥进行解密，这样就能保证数据的安全了。但是非对称加 密有一个缺点就是加密的过程很慢，因此如果每次通信都使用非对称加密的方式的话，反而会造成等待时间过长的问题。</p>
<p>常见的非对称加密算法有RSA、ECC、DH等。秘钥成对出现，一般称为公钥（公开）和私钥（保密）。公钥加密的信息只有私钥可以解开，私钥加密的信息只能公钥解开，因此掌握公钥的不同客户端之间不能相互解密信息，只能和服务器进行加密通信，服务器可以实现一对多的的通信，客户端也可以用来验证掌握私钥的服务器的身份。</p>
<p><strong>特点：</strong> 非对称加密的特点就是信息一对多，服务器只需要维持一个私钥就可以和多个客户端进行通信，但服务器发出的信息能够被所有的客户端解密，且该算法的计算复杂，加密的速度慢。</p>
<p>综合上述算法特点，TLS&#x2F;SSL的工作方式就是客户端使用非对称加密与服务器进行通信，实现身份的验证并协商对称加密使用的秘钥。对称加密算法采用协商秘钥对信息以及信息摘要进行加密通信，不同节点之间采用的对称秘钥不同，从而保证信息只能通信双方获取。这样就解决了两个方法各自存在的问题。</p>
<h4 id="3-数字证书"><a href="#3-数字证书" class="headerlink" title="3. 数字证书"></a>3. 数字证书</h4><p>现在的方法也不一定是安全的，因为我们没有办法确定我们得到的公钥就一定是安全的公钥。可能存在一个中间人，截取 了对方发给我们的公钥，然后将他自己的公钥发送给我们，当我们使用他的公钥加密后发送的信息，就可以被他用自己的私钥 解密。然后他伪装成我们以同样的方法向对方发送信息，这样我们的信息就被窃取了，然而我们自己还不知道。</p>
<p>为了解决这样的问题，我们可以使用数字证书的方式，首先我们使用一种 Hash 算法来对我们的公钥和其他信息进行加密生成 一个信息摘要，然后让有公信力的认证中心（简称 CA ）用它的私钥对消息摘要加密，形成签名。最后将原始的信息和签名合 在一起，称为数字证书。当接收方收到数字证书的时候，先根据原始信息使用同样的 Hash 算法生成一个摘要，然后使用公证处的公钥来对数字证书中的摘要进行解密，最后将解密的摘要和我们生成的摘要进行对比，就能发现我们得到的信息是否被更改 了。这个方法最要的是认证中心的可靠性，一般浏览器里会内置一些顶层的认证中心的证书，相当于我们自动信任了他们，只有 这样我们才能保证数据的安全。</p>
<h4 id="4-TLS握手"><a href="#4-TLS握手" class="headerlink" title="4. TLS握手"></a>4. TLS握手</h4><p>HTTPS通信过程</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs markdown">浏览器（客户端）<br><span class="hljs-code">     |</span><br><span class="hljs-code">TCP三次握手</span><br><span class="hljs-code">     |</span><br><span class="hljs-code">TLS握手（客户端Hello → 服务器Hello +证书 → 密钥协商）</span><br><span class="hljs-code">     |</span><br><span class="hljs-code">对称加密的HTTP通信</span><br><span class="hljs-code">     |</span><br><span class="hljs-code">连接关闭</span><br></code></pre></td></tr></table></figure>

<p>假设你用浏览器访问 <code>https://www.example.com</code>，进行TLS握手，具体过程如下：</p>
<ol>
<li>客户端发送 ClientHello</li>
</ol>
<ul>
<li>浏览器发送 ClientHello 消息，包含：<ul>
<li>支持的 TLS 协议版本（比如 TLS 1.2）</li>
<li>支持的加密套件列表（如 AES256-GCM-SHA384、ECDHE-RSA-AES128-SHA256 等）</li>
<li>一个随机数（ClientRandom），用于后续生成密钥</li>
<li>支持的压缩方法等扩展信息</li>
</ul>
</li>
</ul>
<ol start="2">
<li>服务器响应 ServerHello</li>
</ol>
<ul>
<li>服务器选择使用的 TLS 版本和加密套件，比如 TLS 1.2 和 ECDHE-RSA-AES128-SHA256</li>
<li>服务器生成自己的随机数（ServerRandom）</li>
<li>发送 ServerHello 消息给客户端，包含：<ul>
<li>选定的协议版本和加密套件</li>
<li>ServerRandom</li>
</ul>
</li>
<li><strong>发送服务器数字证书</strong>，证书里包含服务器的公钥（如RSA公钥）和证书链</li>
<li>服务器可能还会发送 ServerHelloDone，表示握手消息发送完毕</li>
</ul>
<ol start="3">
<li>客户端验证服务器证书</li>
</ol>
<ul>
<li>客户端验证服务器证书是否合法：<ul>
<li>是否被受信任的证书颁发机构（CA）签发</li>
<li>证书是否过期</li>
<li>证书的域名是否与访问域名匹配</li>
</ul>
</li>
<li>如果证书合法，客户端继续握手；否则，浏览器会提示安全警告</li>
</ul>
<ol start="4">
<li>客户端生成预主密钥（Pre-Master Secret）</li>
</ol>
<ul>
<li>客户端生成一个随机数，称为 <strong>预主密钥</strong></li>
<li>使用服务器公钥加密这个预主密钥（保证只有服务器能解密）</li>
<li>将加密后的预主密钥发送给服务器</li>
</ul>
<ol start="5">
<li>服务器用私钥解密预主密钥</li>
</ol>
<ul>
<li>服务器用自己的私钥解密出预主密钥</li>
</ul>
<ol start="6">
<li>双方生成对称加密密钥</li>
</ol>
<ul>
<li>客户端和服务器分别使用<strong>预主密钥</strong>和之前交换的两个随机数（ClientRandom 和 ServerRandom）</li>
<li>通过预定义的密钥派生函数生成一组对称密钥（用于加密和MAC验证）</li>
</ul>
<ol start="7">
<li>握手完成（ChangeCipherSpec &amp; Finished）</li>
</ol>
<ul>
<li>客户端发送 ChangeCipherSpec 消息，告诉服务器后续消息将用协商好的密钥加密</li>
<li>客户端发送 Finished 消息，内容被加密，包含之前所有握手消息的摘要，用于验证握手完整性</li>
<li>服务器响应 ChangeCipherSpec 和 Finished 消息，完成握手</li>
</ul>
<ol start="8">
<li>加密通信开始</li>
</ol>
<ul>
<li>后续客户端和服务器之间的HTTP数据都用对称密钥加密传输，保证机密性和完整性</li>
</ul>
<p><strong>随机数保证每次会话密钥唯一，确保每次密钥都独特且不可预测，随机数是明文传输。</strong></p>
<ul>
<li>随机数（ClientRandom 和 ServerRandom）与预主密钥一起参与<strong>会话密钥的生成</strong></li>
<li>通过这两个随机数，即使预主密钥相同，每次生成的对称密钥也会不同</li>
<li>避免重放攻击和密钥重复使用，提高安全性</li>
</ul>
<h3 id="【HTTP状态码】"><a href="#【HTTP状态码】" class="headerlink" title="【HTTP状态码】"></a>【HTTP状态码】</h3><p>应用通常就是客户端向服务器发出请求，服务器做出响应。状态码就是让我们知道 HTTP 请求是成功、失败还是其他。HTTP状态码通常分为五类：</p>
<table>
<thead>
<tr>
<th><strong>类别</strong></th>
<th><strong>定义</strong></th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td>1xx</td>
<td>Informational(信息性状态码)</td>
<td>接受的请求正在处理</td>
</tr>
<tr>
<td>2xx</td>
<td>Success(成功状态码)</td>
<td>请求正常处理完毕</td>
</tr>
<tr>
<td>3xx</td>
<td>Redirection(重定向状态码)</td>
<td>需要进行附加操作来完成请求</td>
</tr>
<tr>
<td>4xx</td>
<td>Client Error (客户端错误状态码)</td>
<td>服务器无法处理请求</td>
</tr>
<tr>
<td>5xx</td>
<td>Server Error(服务器错误状态码)</td>
<td>服务器处理请求出错</td>
</tr>
</tbody></table>
<p><strong>常见状态码介绍</strong></p>
<ul>
<li><strong>200 OK</strong>：请求成功，服务器返回请求的数据。</li>
<li><strong>301 Moved Permanently</strong>：资源已被永久移动到新地址，客户端应更新请求链接。</li>
<li><strong>302 Found</strong>：资源临时移动，客户端应继续使用原地址。</li>
<li><strong>304 Not Modified</strong>：资源未修改，客户端可使用缓存，节省带宽。</li>
<li><strong>400 Bad Request</strong>：请求参数错误，服务器无法理解请求。</li>
<li><strong>401 Unauthorized</strong>：请求未经授权，需进行身份验证。</li>
<li><strong>403 Forbidden</strong>：服务器拒绝访问，权限不足。</li>
<li><strong>404 Not Found</strong>：请求资源不存在。</li>
<li><strong>500 Internal Server Error</strong>：服务器内部错误，无法完成请求。</li>
<li><strong>503 Service Unavailable</strong>：服务器暂时不可用，可能过载或维护。</li>
</ul>
<p>更详细的 <strong>HTTP状态码</strong> 总结：</p>
<p>1xx - 信息性状态码（暂时响应）</p>
<table>
<thead>
<tr>
<th>状态码</th>
<th>含义</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>100</td>
<td>Continue（继续）</td>
<td>服务器已收到请求，客户端继续发送请求的剩余部分</td>
</tr>
<tr>
<td>101</td>
<td>Switching Protocols（切换协议）</td>
<td>服务器同意切换协议</td>
</tr>
</tbody></table>
<p>2xx - 成功状态码</p>
<table>
<thead>
<tr>
<th>状态码</th>
<th>含义</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>200</td>
<td>OK</td>
<td>请求成功，服务器返回请求的数据</td>
</tr>
<tr>
<td>201</td>
<td>Created</td>
<td>请求成功且服务器创建了新的资源</td>
</tr>
<tr>
<td>202</td>
<td>Accepted</td>
<td>请求已接受，但未处理完成</td>
</tr>
<tr>
<td>204</td>
<td>No Content</td>
<td>请求成功，但没有内容返回</td>
</tr>
</tbody></table>
<p>3xx - 重定向状态码</p>
<table>
<thead>
<tr>
<th>状态码</th>
<th>含义</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>301</td>
<td>Moved Permanently（永久移动）</td>
<td>请求的资源已永久移动到新URL</td>
</tr>
<tr>
<td>302</td>
<td>Found（临时移动）</td>
<td>请求的资源临时移动</td>
</tr>
<tr>
<td>303</td>
<td>See Other</td>
<td>请求的响应可以在另一个URL获得</td>
</tr>
<tr>
<td>304</td>
<td>Not Modified（未修改）</td>
<td>资源未修改，客户端可使用缓存内容</td>
</tr>
<tr>
<td>307</td>
<td>Temporary Redirect</td>
<td>临时重定向，方法不变</td>
</tr>
<tr>
<td>308</td>
<td>Permanent Redirect</td>
<td>永久重定向，方法不变</td>
</tr>
</tbody></table>
<p>4xx - 客户端错误状态码</p>
<table>
<thead>
<tr>
<th>状态码</th>
<th>含义</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>400</td>
<td>Bad Request（错误请求）</td>
<td>请求参数有误，服务器无法理解</td>
</tr>
<tr>
<td>401</td>
<td>Unauthorized（未授权）</td>
<td>需要身份验证，用户未登录或认证失败</td>
</tr>
<tr>
<td>403</td>
<td>Forbidden（禁止访问）</td>
<td>服务器拒绝请求，权限不足</td>
</tr>
<tr>
<td>404</td>
<td>Not Found（未找到）</td>
<td>请求资源不存在</td>
</tr>
<tr>
<td>405</td>
<td>Method Not Allowed</td>
<td>请求方法不被允许</td>
</tr>
<tr>
<td>408</td>
<td>Request Timeout</td>
<td>请求超时</td>
</tr>
<tr>
<td>429</td>
<td>Too Many Requests</td>
<td>请求过多，限流</td>
</tr>
</tbody></table>
<p>5xx - 服务器错误状态码</p>
<table>
<thead>
<tr>
<th>状态码</th>
<th>含义</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>500</td>
<td>Internal Server Error（服务器内部错误）</td>
<td>服务器发生错误，无法完成请求</td>
</tr>
<tr>
<td>501</td>
<td>Not Implemented</td>
<td>服务器不支持请求的功能</td>
</tr>
<tr>
<td>502</td>
<td>Bad Gateway</td>
<td>网关错误，服务器作为代理时接收无效响应</td>
</tr>
<tr>
<td>503</td>
<td>Service Unavailable</td>
<td>服务器不可用，可能过载或维护</td>
</tr>
<tr>
<td>504</td>
<td>Gateway Timeout</td>
<td>网关超时</td>
</tr>
</tbody></table>
<h3 id="【HTTP请求方法】"><a href="#【HTTP请求方法】" class="headerlink" title="【HTTP请求方法】"></a>【HTTP请求方法】</h3><h4 id="1-GET"><a href="#1-GET" class="headerlink" title="1. GET"></a>1. GET</h4><ul>
<li><strong>作用</strong>：请求访问指定资源，获取资源的表示（数据）。</li>
<li><strong>特点</strong>：只读操作，不应有副作用，幂等（多次请求结果相同）。</li>
<li><strong>常用场景</strong>：获取网页内容、查询数据等。</li>
</ul>
<h4 id="2-POST"><a href="#2-POST" class="headerlink" title="2. POST"></a>2. POST</h4><ul>
<li><strong>作用</strong>：向服务器提交数据，用于创建资源或触发操作。</li>
<li><strong>特点</strong>：非幂等，可能产生副作用（比如新增数据）。</li>
<li><strong>常用场景</strong>：提交表单、上传文件、创建新资源。</li>
</ul>
<h4 id="3-PUT"><a href="#3-PUT" class="headerlink" title="3. PUT"></a>3. PUT</h4><ul>
<li><strong>作用</strong>：更新指定资源，或者如果资源不存在则创建。</li>
<li><strong>特点</strong>：幂等（多次执行结果相同）。</li>
<li><strong>常用场景</strong>：修改用户信息、更新数据。</li>
</ul>
<h4 id="4-DELETE"><a href="#4-DELETE" class="headerlink" title="4. DELETE"></a>4. DELETE</h4><ul>
<li><strong>作用</strong>：删除指定资源。</li>
<li><strong>特点</strong>：幂等。</li>
<li><strong>常用场景</strong>：删除数据库中的记录或文件。</li>
</ul>
<h4 id="5-HEAD"><a href="#5-HEAD" class="headerlink" title="5. HEAD"></a>5. HEAD</h4><ul>
<li><strong>作用</strong>：类似GET请求，但只请求响应头，不返回响应体。</li>
<li><strong>用途</strong>：检测资源是否存在、检查更新、获取元数据。</li>
</ul>
<h4 id="6-OPTIONS"><a href="#6-OPTIONS" class="headerlink" title="6. OPTIONS"></a>6. OPTIONS</h4><ul>
<li><strong>作用</strong>：询问服务器支持的HTTP方法。</li>
<li><strong>用途</strong>：跨域请求时，浏览器发起预检请求。</li>
</ul>
<h4 id="7-PATCH"><a href="#7-PATCH" class="headerlink" title="7. PATCH"></a>7. PATCH</h4><ul>
<li><strong>作用</strong>：对资源进行部分修改。</li>
<li><strong>特点</strong>：非幂等，修改部分字段。</li>
<li><strong>常用场景</strong>：局部更新资源数据。</li>
</ul>
<h3 id="【HTTP请求报文结构】"><a href="#【HTTP请求报文结构】" class="headerlink" title="【HTTP请求报文结构】"></a>【HTTP请求报文结构】</h3><p>HTTP请求报文由三部分组成：</p>
<ol>
<li><strong>请求行（Request Line）</strong></li>
<li><strong>请求头部（Request Headers）</strong></li>
<li>空行</li>
<li><strong>请求体（Request Body）</strong>（可选）</li>
</ol>
<h4 id="请求行（Request-Line）"><a href="#请求行（Request-Line）" class="headerlink" title="请求行（Request Line）"></a><strong>请求行（Request Line）</strong></h4><p>请求行是请求报文的第一行，包含三个部分：<code>方法 请求URL 协议版本</code></p>
<ul>
<li><strong>方法（Method）</strong>：表示客户端希望对资源执行的操作，比如：<ul>
<li>GET（请求资源）</li>
<li>POST（提交数据）</li>
<li>PUT（更新资源）</li>
<li>DELETE（删除资源）</li>
<li>HEAD、OPTIONS、PATCH等</li>
</ul>
</li>
<li><strong>请求URL（Request-URI）</strong>：请求的资源地址，通常是相对路径，如 <code>/index.html</code>。</li>
<li><strong>协议版本（HTTP Version）</strong>：一般是 HTTP&#x2F;1.1 或 HTTP&#x2F;2。</li>
</ul>
<p>示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable constant_">GET</span> /index.<span class="hljs-property">html</span> <span class="hljs-variable constant_">HTTP</span>/<span class="hljs-number">1.1</span><br></code></pre></td></tr></table></figure>

<h4 id="请求头部（Request-Headers）"><a href="#请求头部（Request-Headers）" class="headerlink" title="请求头部（Request Headers）"></a>请求头部（Request Headers）</h4><p>请求头部是若干行键值对，用于描述客户端环境、请求特性等信息。格式为：<code>字段名: 字段值</code></p>
<p>常见请求头字段包括：</p>
<ul>
<li><code>Host</code>：请求的主机名和端口（HTTP&#x2F;1.1中必须）</li>
<li><code>User-Agent</code>：客户端浏览器或工具信息</li>
<li><code>Accept</code>：客户端可接受的响应内容类型</li>
<li><code>Accept-Language</code>：客户端可接受的语言</li>
<li><code>Accept-Encoding</code>：客户端可接受的压缩编码</li>
<li><code>Connection</code>：是否保持连接（keep-alive）</li>
<li><code>Cookie</code>：客户端携带的Cookie信息</li>
<li><code>Content-Type</code>：请求体的数据类型（POST等请求才有）</li>
<li><code>Content-Length</code>：请求体长度</li>
</ul>
<p>示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Host:</span> <span class="hljs-string">www.example.com</span><br><span class="hljs-attr">User-Agent:</span> <span class="hljs-string">Mozilla/5.0</span> <span class="hljs-string">(Windows</span> <span class="hljs-string">NT</span> <span class="hljs-number">10.0</span><span class="hljs-string">;</span> <span class="hljs-string">Win64;</span> <span class="hljs-string">x64)</span><br><span class="hljs-attr">Accept:</span> <span class="hljs-string">text/html,application/xhtml+xml</span><br><span class="hljs-attr">Connection:</span> <span class="hljs-string">keep-alive</span><br></code></pre></td></tr></table></figure>

<p><code>Content-Type</code>常用类型：</p>
<table>
<thead>
<tr>
<th>使用场景</th>
<th>Content-Type</th>
</tr>
</thead>
<tbody><tr>
<td>普通文本传输</td>
<td><code>text/plain; charset=utf-8</code></td>
</tr>
<tr>
<td>浏览器请求网页</td>
<td><code>text/html; charset=utf-8</code></td>
</tr>
<tr>
<td>AJAX请求JSON数据</td>
<td><code>application/json</code></td>
</tr>
<tr>
<td>HTML表单提交</td>
<td><code>application/x-www-form-urlencoded</code></td>
</tr>
<tr>
<td>文件上传</td>
<td><code>multipart/form-data</code></td>
</tr>
<tr>
<td>图片显示</td>
<td><code>image/png</code>、<code>image/jpeg</code></td>
</tr>
<tr>
<td>下载二进制文件</td>
<td><code>application/octet-stream</code></td>
</tr>
</tbody></table>
<h4 id="请求体（Request-Body）"><a href="#请求体（Request-Body）" class="headerlink" title="请求体（Request Body）"></a>请求体（Request Body）</h4><p>请求体是请求的实体内容，只有在某些请求方法中才有（如 POST、PUT）。用于发送提交的数据，比如表单数据、JSON等。</p>
<h3 id="【HTTP响应报文结构】"><a href="#【HTTP响应报文结构】" class="headerlink" title="【HTTP响应报文结构】"></a>【HTTP响应报文结构】</h3><p>HTTP响应报文由三部分组成：</p>
<ol>
<li><strong>响应行（Response Line）</strong></li>
<li><strong>响应头部（Response Headers）</strong></li>
<li>空行</li>
<li><strong>响应体（Response Body）</strong></li>
</ol>
<h4 id="响应行（Response-Line）"><a href="#响应行（Response-Line）" class="headerlink" title="响应行（Response Line）"></a>响应行（Response Line）</h4><p>响应行是响应报文的第一行，包含三个部分：<code>协议版本 状态码 状态描述</code></p>
<ul>
<li><strong>协议版本</strong>：如 HTTP&#x2F;1.1</li>
<li><strong>状态码（Status Code）</strong>：三位数字，表示响应状态，如：<ul>
<li>1xx：信息性状态</li>
<li>2xx：成功（200 OK）</li>
<li>3xx：重定向</li>
<li>4xx：客户端错误（404 Not Found）</li>
<li>5xx：服务器错误（500 Internal Server Error）</li>
</ul>
</li>
<li><strong>状态描述</strong>：对状态码的简短描述，如 OK、Not Found 等</li>
</ul>
<p>示例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">200</span> OK<br></code></pre></td></tr></table></figure>

<h4 id="响应头部（Response-Headers）"><a href="#响应头部（Response-Headers）" class="headerlink" title="响应头部（Response Headers）"></a>响应头部（Response Headers）</h4><p>响应头部是若干行键值对，描述服务器和响应体的相关信息，格式同请求头：</p>
<p>常见响应头字段：</p>
<ul>
<li><code>Content-Type</code>：响应体的数据类型，如 <code>text/html</code>、<code>application/json</code></li>
<li><code>Content-Length</code>：响应体的字节长度</li>
<li><code>Server</code>：服务器软件信息</li>
<li><code>Set-Cookie</code>：服务器向客户端设置Cookie</li>
<li><code>Cache-Control</code>：缓存策略</li>
<li><code>Date</code>：响应时间</li>
<li><code>Connection</code>：连接状态</li>
</ul>
<p>示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Content-Type:</span> <span class="hljs-string">text/html;</span> <span class="hljs-string">charset=UTF-8</span><br><span class="hljs-attr">Content-Length:</span> <span class="hljs-number">138</span><br><span class="hljs-attr">Server:</span> <span class="hljs-string">Apache/2.4.41</span> <span class="hljs-string">(Ubuntu)</span><br><span class="hljs-attr">Connection:</span> <span class="hljs-string">keep-alive</span><br></code></pre></td></tr></table></figure>

<p>响应头部与响应体之间也用空行分隔。</p>
<h4 id="响应体（Response-Body）"><a href="#响应体（Response-Body）" class="headerlink" title="响应体（Response Body）"></a>响应体（Response Body）</h4><p>响应体包含服务器返回给客户端的具体资源内容，比如HTML页面、图片、JSON数据等。它的格式和内容由 <code>Content-Type</code> 头部决定。</p>
<h2 id="强缓存和协商缓存"><a href="#强缓存和协商缓存" class="headerlink" title="强缓存和协商缓存"></a>强缓存和协商缓存</h2><h3 id="【缓存基础】"><a href="#【缓存基础】" class="headerlink" title="【缓存基础】"></a>【缓存基础】</h3><p>浏览器缓存分为两大类：</p>
<ul>
<li><strong>强缓存（强制缓存，Fresh Cache）</strong>：直接使用缓存，不发请求给服务器。</li>
<li><strong>协商缓存（协商验证缓存，Conditional Cache）</strong>：先向服务器询问资源是否更新，服务器判断后决定是否返回资源。</li>
</ul>
<p>浏览器会先判断是否使用强缓存，强缓存未命中时才发起协商缓存请求。</p>
<h3 id="【强缓存（强制缓存）】"><a href="#【强缓存（强制缓存）】" class="headerlink" title="【强缓存（强制缓存）】"></a>【强缓存（强制缓存）】</h3><h4 id="1-工作流程"><a href="#1-工作流程" class="headerlink" title="1. 工作流程"></a>1. 工作流程</h4><p>浏览器访问资源时：</p>
<ul>
<li>先检查该资源是否存在且未过期的强缓存。</li>
<li>如果存在且有效，直接从缓存读取，不发起网络请求。</li>
<li>如果强缓存失效，浏览器才会发起网络请求。</li>
</ul>
<h4 id="2-设置方式（响应头）"><a href="#2-设置方式（响应头）" class="headerlink" title="2. 设置方式（响应头）"></a>2. 设置方式（响应头）</h4><p>服务器通过HTTP响应头告诉浏览器缓存资源的有效时间：</p>
<ul>
<li><code>Expires</code>（HTTP&#x2F;1.0，绝对时间，格式固定）</li>
<li><code>Cache-Control</code>（HTTP&#x2F;1.1，推荐，优先级更高）</li>
</ul>
<p><strong>具体说明</strong></p>
<ul>
<li><code>Expires: &lt;GMT时间&gt;</code><br>表示资源过期时间，客户端只要在过期时间内，使用缓存。但<code>Expires</code>是绝对时间，可能受客户端和服务器时间不一致影响。</li>
<li><code>Cache-Control: max-age=&lt;秒&gt;</code><br>指定资源在客户端缓存的最大生命周期（秒）。max-age优先级高于Expires。</li>
<li>其他 Cache-Control 指令：<ul>
<li><code>public</code>：所有缓存都可以缓存</li>
<li><code>private</code>：只有私有缓存可缓存（浏览器）</li>
<li><code>no-cache</code>：不使用强缓存（需协商缓存）</li>
<li><code>no-store</code>：不缓存</li>
</ul>
</li>
</ul>
<h4 id="3-举例"><a href="#3-举例" class="headerlink" title="3. 举例"></a>3. 举例</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Cache-Control:</span> <span class="hljs-string">max-age=3600</span><br><span class="hljs-attr">Expires:</span> <span class="hljs-string">Wed,</span> <span class="hljs-number">11</span> <span class="hljs-string">Aug</span> <span class="hljs-number">2025 12:00:00 </span><span class="hljs-string">GMT</span><br></code></pre></td></tr></table></figure>

<p>表示缓存1小时有效期，1小时内访问不请求服务器。</p>
<h3 id="【协商缓存（协商验证缓存）】"><a href="#【协商缓存（协商验证缓存）】" class="headerlink" title="【协商缓存（协商验证缓存）】"></a>【协商缓存（协商验证缓存）】</h3><h4 id="1-工作流程-1"><a href="#1-工作流程-1" class="headerlink" title="1. 工作流程"></a>1. 工作流程</h4><ul>
<li>当强缓存失效，浏览器会带上上次缓存时服务器返回的<strong>标识</strong>向服务器发起请求，询问资源是否更新。</li>
<li>服务器根据标识判断资源是否改变：<ul>
<li>如果未改变，返回 <code>304 Not Modified</code>，浏览器使用缓存资源。</li>
<li>如果改变，返回新的资源和状态码 <code>200 OK</code>。</li>
</ul>
</li>
</ul>
<h4 id="2-设置方式（请求头-响应头）"><a href="#2-设置方式（请求头-响应头）" class="headerlink" title="2. 设置方式（请求头 + 响应头）"></a>2. 设置方式（请求头 + 响应头）</h4><p>服务器通过响应头告诉客户端标识，下次请求时客户端会带上验证标识。</p>
<p><strong>两种常用验证方式</strong></p>
<table>
<thead>
<tr>
<th>验证方式</th>
<th>说明</th>
<th>相关头部</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Last-Modified &#x2F; If-Modified-Since</strong></td>
<td>通过最后修改时间比较是否更新</td>
<td>服务器响应头：<code>Last-Modified</code>   浏览器请求头：<code>If-Modified-Since</code></td>
</tr>
<tr>
<td><strong>ETag &#x2F; If-None-Match</strong></td>
<td>通过文件的唯一标识（哈希等）比较是否更新</td>
<td>服务器响应头：<code>ETag</code>   浏览器请求头：<code>If-None-Match</code></td>
</tr>
</tbody></table>
<h4 id="具体过程举例"><a href="#具体过程举例" class="headerlink" title="具体过程举例"></a>具体过程举例</h4><ol>
<li>服务器返回：</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Last-Modified:</span> <span class="hljs-string">Tue,</span> <span class="hljs-number">11</span> <span class="hljs-string">Aug</span> <span class="hljs-number">2025 08:00:00 </span><span class="hljs-string">GMT</span><br><span class="hljs-attr">ETag:</span> <span class="hljs-string">&quot;33a64df551425fcc55e4d42a148795d9f25f89d4&quot;</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>浏览器下次请求带：</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">If-Modified-Since:</span> <span class="hljs-string">Tue,</span> <span class="hljs-number">11</span> <span class="hljs-string">Aug</span> <span class="hljs-number">2025 08:00:00 </span><span class="hljs-string">GMT</span><br><span class="hljs-attr">If-None-Match:</span> <span class="hljs-string">&quot;33a64df551425fcc55e4d42a148795d9f25f89d4&quot;</span><br></code></pre></td></tr></table></figure>

<ol start="3">
<li>服务器判断资源是否变化：</li>
</ol>
<ul>
<li>没变化，返回状态码 <code>304 Not Modified</code>，无响应体。</li>
<li>变化，返回状态码 <code>200 OK</code> 和新的资源。</li>
</ul>
<h3 id="【对比总结】"><a href="#【对比总结】" class="headerlink" title="【对比总结】"></a>【对比总结】</h3><table>
<thead>
<tr>
<th>方面</th>
<th>强缓存</th>
<th>协商缓存</th>
</tr>
</thead>
<tbody><tr>
<td>作用</td>
<td>直接使用缓存，完全不请求服务器</td>
<td>先向服务器询问资源是否改变</td>
</tr>
<tr>
<td>触发条件</td>
<td>缓存有效期内</td>
<td>缓存过期或无强缓存时触发</td>
</tr>
<tr>
<td>缓存时间控制</td>
<td>通过 <code>Cache-Control</code> &#x2F; <code>Expires</code> 设置</td>
<td>服务器通过<code>Last-Modified</code>&#x2F;<code>ETag</code>提供验证标识</td>
</tr>
<tr>
<td>网络请求</td>
<td>无</td>
<td>有请求，但服务器可能返回304</td>
</tr>
<tr>
<td>性能</td>
<td>更快，不发请求</td>
<td>需要发请求但节省传输资源</td>
</tr>
<tr>
<td>是否返回响应体</td>
<td>不返回</td>
<td>未变时不返回，变时返回</td>
</tr>
</tbody></table>
<h2 id="浏览器渲染页面"><a href="#浏览器渲染页面" class="headerlink" title="浏览器渲染页面"></a>浏览器渲染页面</h2><p>浏览器从你输入网址开始，到页面呈现在屏幕上，大致经历以下步骤：</p>
<h4 id="1-解析-HTML-→-生成-DOM-树"><a href="#1-解析-HTML-→-生成-DOM-树" class="headerlink" title="1. 解析 HTML → 生成 DOM 树"></a>1. 解析 HTML → 生成 DOM 树</h4><ul>
<li>浏览器接收到 HTML 文本后，开始<strong>从上到下解析</strong>HTML标记。</li>
<li>解析过程中，浏览器会根据标签构建<strong>DOM（Document Object Model）树</strong>，DOM树是页面的结构化内存表示，包含所有元素节点、文本节点等。</li>
<li>每个 HTML 标签对应 DOM 树中的一个节点。</li>
<li>注意：如果遇到 <code>&lt;script&gt;</code> 标签，且没有设置 <code>async</code> 或 <code>defer</code>，浏览器会<strong>暂停解析HTML</strong>，先下载并执行脚本，执行完再继续解析。</li>
</ul>
<h4 id="2-解析-CSS-→-生成-CSSOM-树"><a href="#2-解析-CSS-→-生成-CSSOM-树" class="headerlink" title="2. 解析 CSS → 生成 CSSOM 树"></a>2. 解析 CSS → 生成 CSSOM 树</h4><ul>
<li>浏览器在解析HTML的过程中，如果遇到 <code>&lt;style&gt;</code> 标签或者外部CSS文件（<code>&lt;link rel=&quot;stylesheet&quot;&gt;</code>），会<strong>同时开始解析 CSS</strong>。</li>
<li>CSS解析器把 CSS 代码转换成<strong>CSSOM（CSS Object Model）树</strong>，描述所有选择器和样式规则。</li>
<li>CSSOM树描述了每个元素应该应用的样式。</li>
</ul>
<h4 id="3-合并-DOM-CSSOM-→-生成渲染树（Render-Tree）"><a href="#3-合并-DOM-CSSOM-→-生成渲染树（Render-Tree）" class="headerlink" title="3. 合并 DOM + CSSOM → 生成渲染树（Render Tree）"></a>3. 合并 DOM + CSSOM → 生成渲染树（Render Tree）</h4><ul>
<li>浏览器将 DOM树和 CSSOM树结合，生成<strong>渲染树（Render Tree）</strong>。</li>
<li>渲染树只包含<strong>需要渲染的节点</strong>（例如 <code>display:none</code> 的节点不会出现在渲染树中）。</li>
<li>渲染树的每个节点包含元素的几何信息（尺寸、颜色、字体等）以及它们的布局关系。</li>
</ul>
<h4 id="4-布局（Layout-或-Reflow）"><a href="#4-布局（Layout-或-Reflow）" class="headerlink" title="4. 布局（Layout 或 Reflow）"></a>4. 布局（Layout 或 Reflow）</h4><ul>
<li>浏览器根据渲染树计算每个节点的<strong>具体位置和大小</strong>（x、y坐标，宽高）。</li>
<li>这个过程称为布局或回流（Reflow）。</li>
<li>布局阶段确定元素在页面上的准确位置，供后续绘制使用。</li>
<li>布局依赖父元素和兄弟元素的位置关系，可能触发多次回流。</li>
</ul>
<h4 id="5-绘制（Paint）"><a href="#5-绘制（Paint）" class="headerlink" title="5. 绘制（Paint）"></a>5. 绘制（Paint）</h4><ul>
<li>布局完成后，浏览器会遍历渲染树，将每个节点的内容转化为实际的<strong>像素绘制指令</strong>，比如绘制文字、颜色、边框、阴影等。</li>
<li>绘制会生成<strong>图层</strong>（Layers），之后传递给合成器进行合成。</li>
</ul>
<h4 id="6-执行-JavaScript"><a href="#6-执行-JavaScript" class="headerlink" title="6. 执行 JavaScript"></a>6. 执行 JavaScript</h4><ul>
<li>浏览器遇到 <code>&lt;script&gt;</code> 标签时，如果没有 <code>async</code> 或 <code>defer</code>，会暂停 HTML 解析，<strong>下载并执行 JavaScript</strong>。</li>
<li>JS 脚本可以操作 DOM 和 CSSOM，改变页面结构和样式。</li>
<li>可能会导致重新生成渲染树、重新布局和重绘。</li>
<li>设置 <code>defer</code> 的脚本会延迟到 DOM 解析完成后执行。</li>
<li>设置 <code>async</code> 的脚本会在下载完成后立即执行，且不会阻塞 HTML 解析。</li>
</ul>
<h4 id="7-并行加载资源"><a href="#7-并行加载资源" class="headerlink" title="7. 并行加载资源"></a>7. 并行加载资源</h4><ul>
<li>页面中存在的资源（图片、CSS文件、JS文件、字体等）会<strong>并行向服务器发起请求</strong>。</li>
<li>这些资源的加载和解析可能和 HTML 解析并行，也可能会影响渲染流程（例如 CSS 解析阻塞渲染，JS 可能阻塞HTML解析）。</li>
<li>当这些资源加载完成，会触发对应的渲染更新。</li>
</ul>
<h1 id="Promise核心总结"><a href="#Promise核心总结" class="headerlink" title="Promise核心总结"></a>Promise核心总结</h1><h2 id="Promise的引入"><a href="#Promise的引入" class="headerlink" title="Promise的引入"></a>Promise的引入</h2><h3 id="【进程与线程】"><a href="#【进程与线程】" class="headerlink" title="【进程与线程】"></a>【进程与线程】</h3><p>程序执行的基本单位</p>
<ol>
<li>进程（Process）</li>
</ol>
<ul>
<li>程序的一次运行实例，拥有独立的资源和内存空间。</li>
<li>是操作系统分配资源的最小单位。</li>
<li>可以并发存在多个进程，互相之间相对独立。</li>
</ul>
<ol start="2">
<li>线程（Thread）</li>
</ol>
<ul>
<li>线程是进程中的一个执行单元，是 CPU 调度的基本单位。</li>
<li>一个进程中可以有多个线程，这些线程共享该进程的资源。</li>
<li>多线程的出现使得<strong>并发处理任务</strong>成为可能。</li>
</ul>
<ol start="3">
<li>JavaScript 的运行环境</li>
</ol>
<ul>
<li>JavaScript 是<strong>单线程语言</strong>，即同一时间只能执行一个任务。</li>
<li>其运行环境（如浏览器、Node.js）通过<strong>事件循环（Event Loop）</strong>机制，配合<strong>异步 API（如定时器、网络请求）</strong>实现了伪“并发”效果。</li>
</ul>
<h3 id="【同步】"><a href="#【同步】" class="headerlink" title="【同步】"></a>【同步】</h3><p>控制执行流程的两种模式</p>
<p><strong>1. 同步（Synchronous）</strong></p>
<ul>
<li>所有操作按顺序执行，当前操作未完成时，程序会阻塞，等待执行完毕后再继续。</li>
<li>简单、直观，但当某一步操作耗时时，<strong>整个程序都被阻塞</strong>。</li>
</ul>
<p>示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">blockingTask</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">const</span> start = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();<br>    <span class="hljs-keyword">while</span> (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - start &lt; <span class="hljs-number">5000</span>) &#123;&#125; <span class="hljs-comment">// 阻塞5秒</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;任务完成&quot;</span>);<br>&#125;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;开始任务&quot;</span>);<br><span class="hljs-title function_">blockingTask</span>();<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;后续代码&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>输出顺序为：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">开始任务<br>任务完成<br>后续代码<br></code></pre></td></tr></table></figure>

<p><strong>2. 为什么不能一直用同步模式？</strong></p>
<p><font color="#409eff">同步的最大问题是阻塞</font>，所谓阻塞就是一段代码不执行完毕其后的所有代码也不会执行。比如上述的案例中，如果sum()函数执行速度比较慢，由于我们编写的是同步代码，所以在sum()执行完之前其后所有代码都不会执行，也就是它会阻塞后边代码的执行。像是这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sum</span>(<span class="hljs-params">a, b</span>)&#123;<br>    <span class="hljs-keyword">let</span> begin = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()<br>    <span class="hljs-keyword">while</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - begin &lt; <span class="hljs-number">10000</span>)&#123;<br><br>    &#125;<br>    <span class="hljs-keyword">return</span> a + b<br>&#125;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;第一行打印&quot;</span>)<br><span class="hljs-keyword">let</span> result = <span class="hljs-title function_">sum</span>(<span class="hljs-number">123</span>, <span class="hljs-number">456</span>)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;第二行打印&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>上例中sum()执行时会停顿10秒，10秒以后才会返回结果，由于是同步执行的代码，所以sum()会阻塞其后所有代码的执行，导致整个程序的执行速度极差。</p>
<p>在现代应用中，经常需要进行一些<strong>高耗时的操作</strong>，如：</p>
<ul>
<li>向服务器请求数据</li>
<li>读写本地文件</li>
<li>等待用户输入或响应</li>
</ul>
<p>如果这些操作都采用同步模式，将导致：</p>
<ul>
<li>用户界面冻结</li>
<li>网络请求阻塞主线程</li>
<li>整体程序无响应</li>
</ul>
<p>因此，我们需要引入<strong>异步机制</strong>。</p>
<h3 id="【异步】"><a href="#【异步】" class="headerlink" title="【异步】"></a>【异步】</h3><ol>
<li><font color="#409eff">异步的基本思路: “耗时任务交给宿主环境，完成后以事件的形式再交还 JS 主线程执行回调。”</font></li>
</ol>
<ul>
<li>将耗时任务“挂起”，不会阻塞主线程。</li>
<li>当任务完成后，通过某种机制“通知”主程序进行处理。</li>
<li>异步任务不是 JavaScript 引擎执行的，而是由“宿主环境的底层系统组件”执行的</li>
</ul>
<table>
<thead>
<tr>
<th>异步类型</th>
<th>真正执行者</th>
</tr>
</thead>
<tbody><tr>
<td>setTimeout</td>
<td>浏览器 Timer 线程</td>
</tr>
<tr>
<td>fetch &#x2F; xhr</td>
<td>浏览器 Network 线程 + OS</td>
</tr>
<tr>
<td>DOM 事件</td>
<td>浏览器 UI 线程</td>
</tr>
<tr>
<td>Promise</td>
<td>JS 引擎（微任务调度）</td>
</tr>
</tbody></table>
<p><strong>2. JavaScript 的异步实现方式：回调函数</strong></p>
<p>最早的异步处理方法是使用<strong>回调函数（Callback）</strong>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">asyncSum</span>(<span class="hljs-params">a, b, callback</span>) &#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-title function_">callback</span>(a + b);<br>    &#125;, <span class="hljs-number">1000</span>);<br>&#125;<br><br><span class="hljs-title function_">asyncSum</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;结果是:&quot;</span>, result);<br>&#125;);<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">结果是: <span class="hljs-number">3</span> （延迟<span class="hljs-number">1</span>秒后输出）<br></code></pre></td></tr></table></figure>

<p>对于其他的编程语言，如java，它的处理方式简单且粗暴，即多线程。线程是计算机中运算的执行者，我们代码需要线程来执行，它是一个干活的人。但是对于Node.js来说，它本身就是单线程的，没有创建多个线程的能力（就像人不能影分身一样）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sum</span>(<span class="hljs-params">a, b</span>)&#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>        <span class="hljs-keyword">return</span> a + b<br>    &#125;, <span class="hljs-number">10000</span>)<br>&#125;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;第一行打印&quot;</span>)<br><span class="hljs-keyword">let</span> result = <span class="hljs-title function_">sum</span>(<span class="hljs-number">123</span>, <span class="hljs-number">456</span>)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;第二行打印&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>上述代码，我们将计算操作放入到了setTimeout中，同样是等待10s，但是setTimeout不会阻塞其他代码的执行，而是在10秒后将函数放入到任务队列中，这样一来就可以很好的解决掉阻塞的问题。</p>
<p>但与此同时也产生了一个问题，函数确实不会阻塞后续代码的执行了，但是由于函数的返回值设置到了setTimeout的回调函数中调用sum时便无法获取到函数的计算结果了，此时我们得到的结果是undefined。这也是异步的一个特点，<font color="#409eff">异步代码的执行结果无法通过返回值获得</font>，返回值只能用来获取同步代码的执行结果。那么如何获取异步代码的执行结果呢？答案只有一个——回调函数，异步代码通常都需要一个回调函数作为参数，当异步代码执行完毕取得结果时便可以将结果作为回调函数的参数进行传递，这样我们便可以在回调函数中来读取结果，并完成后续操作了，像是这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sum</span>(<span class="hljs-params">a, b, cb</span>)&#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>        <span class="hljs-title function_">cb</span>(a + b)<br>    &#125;, <span class="hljs-number">10000</span>)<br>&#125;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;第一行打印&quot;</span>)<br><span class="hljs-title function_">sum</span>(<span class="hljs-number">123</span>, <span class="hljs-number">456</span>, <span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result)<br>&#125;)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;第二行打印&quot;</span>)<br></code></pre></td></tr></table></figure>

<p>通过这样一个介绍，相信你对异步多少能够了解了一些。在java这种多线程的编程语言中，通常需要一个叫做线程池的东西，在程序中随时要有一些线程在线程池中待命，当有任务时需要调用线程去执行程序以完成功能，当线程池中线程不够使用时还必须要创建新的线程协助完成任务，当线程池中的闲置线程过多时也必须要清理掉一些多余的线程。无论是线程池还是线程的管理程序都需要耗费一定的系统的性能，这就要求像java这种多线程的编程语言，必须要运行在一些性能较好的服务器中。</p>
<p>而Node.js这种异步的编程语言，由于始终只有一个线程在干活，不需要线程池存储线程，也无需线程的管理调用程序去管理线程，所以它对服务器的要求就比较低，从而也就降低了服务器的使用成本。但是异步的编程的方式也提升了程序的复杂度，使代码变得难以理解，于是如何简化异步代码，让其更容易编写于维护就是我们下一步要面临的问题。</p>
<p><strong>引入回调函数：异步的初级实现</strong></p>
<ol>
<li>回调函数的定义</li>
</ol>
<ul>
<li>回调函数是将一个函数作为参数传入另一个函数，在该函数执行结束后再调用这个“回调函数”。</li>
<li>适用于处理延迟返回的结果，如网络请求、定时器等。</li>
</ul>
<ol start="2">
<li>为什么异步需要回调函数？</li>
</ol>
<ul>
<li>因为异步操作不会立即返回结果，所以必须通过某种方式在<strong>任务完成时通知我们</strong>。</li>
<li>回调函数就是这个“通知机制”的基本实现。</li>
</ul>
<ol start="3">
<li>回调函数的局限性</li>
</ol>
<p>随着异步操作的增多，程序结构容易变得复杂，出现“<font color="#409eff">回调地狱”（Callback Hell）</font>问题：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">asyncSum</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-function">(<span class="hljs-params">r1</span>) =&gt;</span> &#123;<br>    <span class="hljs-title function_">asyncSum</span>(r1, <span class="hljs-number">3</span>, <span class="hljs-function">(<span class="hljs-params">r2</span>) =&gt;</span> &#123;<br>        <span class="hljs-title function_">asyncSum</span>(r2, <span class="hljs-number">4</span>, <span class="hljs-function">(<span class="hljs-params">r3</span>) =&gt;</span> &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;最终结果:&quot;</span>, r3);<br>        &#125;);<br>    &#125;);<br>&#125;);<br></code></pre></td></tr></table></figure>

<p>问题包括：</p>
<ul>
<li>嵌套层级深，可读性差</li>
<li>错误处理复杂，不易维护</li>
<li>缺乏统一的流程控制机制</li>
</ul>
<p><font color="#409eff">因此Promise就是回调函数的替代方案。</font></p>
<h3 id="【Promise】"><a href="#【Promise】" class="headerlink" title="【Promise】"></a>【Promise】</h3><p><strong>1. 为什么引入 Promise？</strong></p>
<p>Promise 的设计目标是：</p>
<ul>
<li>提供一种统一的方式来处理异步操作</li>
<li>改善回调地狱问题</li>
<li>提供更好的错误处理机制</li>
<li>支持链式调用，流程清晰</li>
</ul>
<p><strong>2. Promise 的本质</strong></p>
<ul>
<li>是一个<strong>对象</strong>，用于表示一个异步操作最终的<strong>完成或失败</strong>。</li>
<li>有三种状态：<ul>
<li><code>pending</code>：初始状态</li>
<li><code>fulfilled</code>：操作成功，调用 <code>resolve</code></li>
<li><code>rejected</code>：操作失败，调用 <code>reject</code></li>
</ul>
</li>
</ul>
<p><strong>3. 基本语法</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">asyncSum</span>(<span class="hljs-params">a, b</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>            <span class="hljs-title function_">resolve</span>(a + b);<br>        &#125;, <span class="hljs-number">1000</span>);<br>    &#125;);<br>&#125;<br><br><span class="hljs-title function_">asyncSum</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">asyncSum</span>(result, <span class="hljs-number">3</span>);<br>    &#125;)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">asyncSum</span>(result, <span class="hljs-number">4</span>);<br>    &#125;)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;最终结果:&quot;</span>, result);<br>    &#125;)<br>    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&quot;出错了:&quot;</span>, error);<br>    &#125;);<br></code></pre></td></tr></table></figure>

<p><strong>4. Promise 的优势</strong></p>
<ul>
<li><strong>结构清晰</strong>，避免回调嵌套</li>
<li><strong>链式调用</strong>，流程线性表达</li>
<li><strong>统一错误处理</strong>，通过 <code>catch</code> 实现异常捕获</li>
</ul>
<h3 id="【总结】"><a href="#【总结】" class="headerlink" title="【总结】"></a>【总结】</h3><table>
<thead>
<tr>
<th>问题</th>
<th>原始方案</th>
<th>存在的问题</th>
<th>改进方案</th>
</tr>
</thead>
<tbody><tr>
<td>耗时操作阻塞程序</td>
<td>同步代码执行</td>
<td>用户体验差，界面卡顿</td>
<td>异步执行</td>
</tr>
<tr>
<td>异步结果处理机制</td>
<td>回调函数（callback）</td>
<td>可读性差，嵌套复杂，难调试</td>
<td>Promise</td>
</tr>
<tr>
<td>多异步操作流程控制复杂</td>
<td>多层嵌套</td>
<td>缺乏统一流程管理</td>
<td>Promise 链式调用</td>
</tr>
<tr>
<td>异步错误难以处理</td>
<td>try-catch 无效</td>
<td>异常不易传播</td>
<td><code>.catch()</code></td>
</tr>
</tbody></table>
<p><font color="#409eff">面试回答模板：</font></p>
<p>在 JavaScript 中，由于它是单线程的，所有任务默认是同步执行的。但现实开发中，很多操作是耗时的，比如网络请求、文件读取、定时器等。如果这些都用同步方式处理，就会阻塞主线程，导致页面卡顿甚至无响应。</p>
<p>为了解决这个问题，JavaScript 引入了异步机制，而最早的异步处理方式就是回调函数。通过给异步操作传入一个回调函数，当操作完成后再调用这个回调来处理结果。</p>
<p>但回调函数有明显的缺点，尤其是当多个异步操作嵌套调用时，会形成所谓的“回调地狱”，代码层层嵌套、结构混乱、难以维护和调试。同时，错误处理也非常分散，不利于统一管理。</p>
<p>为了解决这些问题，ES6 引入了 Promise。它本质上是一个用于表示异步操作最终结果的对象。Promise 可以更清晰地组织异步代码，支持链式调用，把异步流程写得像同步代码一样清晰。它还提供统一的错误捕获机制，使得异步代码更加易读、易维护。</p>
<h2 id="Promise介绍"><a href="#Promise介绍" class="headerlink" title="Promise介绍"></a>Promise介绍</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://lilichao.com/?p=6460">异步编程 – 李立超 | lilichao.com</a></p>
</blockquote>
<p>只要是通过回调函数来获取异步的结果，就一定会遇到回调地狱之类的问题。为了解决这个问题，JS为我们提供一个对象 —— Promise，Promise意为承诺，它可以用来存储一个值，并确保在你需要将这个值返回。这一点听上去似乎也并没有什么新奇的地方，任何一个对象都可以存储值，为什么非得用Promise呢？说到这就必须得看看Promise特别的存取数据的方式了！</p>
<h3 id="【创建Promise】"><a href="#【创建Promise】" class="headerlink" title="【创建Promise】"></a>【创建Promise】</h3><p>Promise存储值的方式非常的特别，我们先来看看它的构造函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(executor)<br></code></pre></td></tr></table></figure>

<p>创建Promise时需要一个executor（执行器）为参数，执行器是一个回调函数，进一步调用它大概长这个样子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;&#125;)<br></code></pre></td></tr></table></figure>

<p>回调函数在执行时会收到两个参数，两个参数都是函数。第一个函数通常命名为resolve，第二个函数通常会命名为reject。向Promise中存储值的关键就在于这两个函数，可以将想要存储到Promise中的值作为函数的参数传递，像是这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&quot;哈哈&quot;</span>)<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>这样我们就将”哈哈”这个字符串存储到了Promise中，那么问题又来了，为什么需要两个函数存储值呢？很简单，resolve用来存储运行正确时的数据，reject用来存储运行出错时的错误信息。我们在使用Promise时需要根据不同的情况，调用不同的函数来存储不同的数据。</p>
<p>Promise为什么整了如此复杂的一种方式来存储数据呢？如果仅仅是存储其他的数据，这么做确实有点脱了放。但是Promise是专门为了异步调用而生的，所以Promise中存储的主要是异步调用的数据，也就是那些本来需要通过回调函数来传递的数据。在Promise中，可以直接调用异步代码，在异步代码执行完毕后直接调用resolve或reject来将执行结果存储到Promise中，这就解决了异步代码无法设置返回值的问题。换句话说，异步代码的执行结果可以直接存储到Promise中，像是这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&quot;哈哈&quot;</span>)<br>    &#125;, <span class="hljs-number">10000</span>)<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>上例中通过setTimeout实现了一个异步调用，定时器会在10秒后执行，并调用resolve将”哈哈”存储到Promise中。现在你应该能够理解为什么Promise有这么一个奇怪的存储值的方式了吧？</p>
<h3 id="【获取Promise中的数据】"><a href="#【获取Promise中的数据】" class="headerlink" title="【获取Promise中的数据】"></a>【获取Promise中的数据】</h3><p>Promise存储数据的方式奇特，读取方式同样特殊。我们需要通过Promise的实例方法来读取存储到Promise中的数据。现在我们有这样一个Promise，Promise中通过resolve存储了一个数据”哈哈”：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&quot;哈哈&quot;</span>)<br>    &#125;, <span class="hljs-number">10000</span>)<br>&#125;)<br></code></pre></td></tr></table></figure>

<h4 id="then"><a href="#then" class="headerlink" title="then"></a>then</h4><p>then是Promise的实例方法，通过该方法可以获取到Promise中存储的数据。它需要一个回调函数作为参数，Promise中存储的数据会作为回调函数的实参返回给我们：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&quot;哈哈&quot;</span>)<br>    &#125;, <span class="hljs-number">10000</span>)<br>&#125;)<br><br>promise.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data) <span class="hljs-comment">// &quot;哈哈&quot;</span><br>&#125;)<br></code></pre></td></tr></table></figure>

<p>注意：这种方式只适合读取通过resolve存储的数据，如果存储数据时出现了错误，或者是通过reject存储的数据，这种方式是读取不到的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;出错了！&quot;</span>)<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&quot;哈哈&quot;</span>)<br>    &#125;, <span class="hljs-number">10000</span>)<br>&#125;)<br><br>promise.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data)<br>&#125;)<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-title function_">reject</span>(<span class="hljs-string">&quot;哈哈&quot;</span>)<br>    &#125;, <span class="hljs-number">10000</span>)<br>&#125;)<br><br>promise.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data)<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>上边的两块代码都是读取不到数据的，而且运行时会在控制台报出错误信息。这是因为，then的第一个参数只负责读取Promise中代码正常执行的结果，也就是只有Promise中数据正常时才会被调用。当Promise中的代码出错，或通过reject来添加数据时，我们还需要为其指定第二个参数来处理错误。</p>
<p>then的第二个参数同样是一个回调函数，两个回调的函数的结构相同，不同点在于第一个回调函数会在没有异常时被调用。而第二个函数会在出现错误（或通过reject存储数据）时调用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;主动抛出错误&quot;</span>)<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&quot;哈哈&quot;</span>)<br>    &#125;, <span class="hljs-number">10000</span>)<br>&#125;)<br><br>promise.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data)<br>&#125;, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;出错了&quot;</span>, err)<br>&#125;)<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-title function_">reject</span>(<span class="hljs-string">&quot;哈哈&quot;</span>)<br>    &#125;, <span class="hljs-number">10000</span>)<br>&#125;)<br><br>promise.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data)<br>&#125;, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;出错了&quot;</span>, err)<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>上边两个案例中，then的第二个回调函数会执行。执行时异常信息或时reject中返回的数据会作为参数传递。现实开发中，第二个回调函数通常会用来编写异常处理的代码。</p>
<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>在Promise中维护着两个隐藏的值PromiseResult和PromiseState，PromiseResult是Promise中真正存储值的地方，在Promise中无论是通过resolve、reject还是报错时的异常信息都会存储到PromiseResult中。PromiseState用来表示Promise中值的状态，Promise一共有三种状态：pending、fulfilled、rejected。pending是Promise的初始化状态，此时Promise中没有任何值。fulfilled是Promise的完成状态，此时表示值已经正常存储到了Promise中（通过resolve）。rejected表示拒绝，此时表示值是通过reject存储的或是执行时出现了错误。</p>
<blockquote>
<p>状态一旦从 <code>pending</code> 转换为 <code>fulfilled</code> 或 <code>rejected</code>，<strong>就不可逆转</strong>。因此resolve()和reject()函数只能有一个执行且只能执行一次。</p>
</blockquote>
<p>当我们调用Promise的then方法时，相当于为Promise设置了一个回调函数，换句话说，<font color="#409eff">then中的回调函数不会立即执行，而是在Promise的PromiseState发生变化时才会执行</font>。如果PromiseState从pending变成了fulfilled则then的第一个回调函数执行，且PromiseResult的值作为参数传递给回调函数。如果PromiseState从pending变成了rejected则then的第二个回调函数执行，且PromiseResult的值作为参数传递给回调函数。</p>
<img src="/2025/12/17/NodeJS/NodeJS%E6%A0%B8%E5%BF%83%E6%80%BB%E7%BB%93/20221010132511667-1024x574.png" srcset="/img/loading.gif" lazyload class title="img">

<p><font color="#409eff">then执行后每次总会返回一个新的Promise</font>，并将then中回调函数的返回值存储到这个Promise中，如果没有指定返回值则新Promise中不会存储任何值。如果 <code>.then()</code> 的回调中<strong>返回的不是一个 Promise（而是普通值）</strong>，那它会被自动包装成一个<strong>立即 resolve 的 Promise</strong>，并作为<strong>下一个 <code>.then()</code> 的输入值</strong>继续执行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&quot;第一步执行结果&quot;</span>)<br>&#125;)<br><br><span class="hljs-keyword">const</span> promise2 = promise.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;收到结果：&quot;</span>, result)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;第二步执行结果&quot;</span> <span class="hljs-comment">// 会作为新的结果存储到新Promise中</span><br>&#125;)<br><br><span class="hljs-keyword">const</span> promise3 = promise2.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;收到结果：&quot;</span>, result)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;第三步执行结果&quot;</span> <span class="hljs-comment">// 会作为新的结果存储到新Promise中</span><br>&#125;)<br></code></pre></td></tr></table></figure>

<p>在简化一些可以这样写：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&quot;第一步执行结果&quot;</span>)<br>&#125;)<br><br>promise.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;收到结果：&quot;</span>, result)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;第二步执行结果&quot;</span> <span class="hljs-comment">// 会作为新的结果存储到新Promise中</span><br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;收到结果：&quot;</span>, result)<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;第三步执行结果&quot;</span> <span class="hljs-comment">// 会作为新的结果存储到新Promise中</span><br>&#125;)<br></code></pre></td></tr></table></figure>

<p>第一个then用来读取上边我们创建的Promise中存储的结果，第二个then用来读取第一个then所返回的结果，依此类推我们就可以根据需要一直then下去，如此便解决了“回调地狱”的问题。</p>
<p>有了Promise后，在异步函数中我们便不再需要通过回调函数来返回结果，取而代之的是返回一个Promise，并将异步执行的结果存储到Promise中，像是这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sum</span>(<span class="hljs-params">a, b</span>)&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>            <span class="hljs-title function_">resolve</span>(a + b)<br>        &#125;, <span class="hljs-number">10000</span>)<br>    &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>由于sum的返回值是一个Promise，所以我们不在需要通过回调函数来读取结果：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">sum</span>(<span class="hljs-number">123</span>, <span class="hljs-number">456</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;结果为：&quot;</span>, result) <span class="hljs-comment">// 结果为： 579</span><br>&#125;)<br></code></pre></td></tr></table></figure>

<p>如果需要连续多次调用，也不会在有“回调地狱的问题”：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">sum</span>(<span class="hljs-number">123</span>, <span class="hljs-number">456</span>)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-title function_">sum</span>(result, <span class="hljs-number">777</span>))<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-title function_">sum</span>(result, <span class="hljs-number">888</span>))<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result))<br></code></pre></td></tr></table></figure>

<h4 id="catch"><a href="#catch" class="headerlink" title="catch"></a>catch</h4><p>除了then以外，Promise中还有一个catch方法，catch和then使用方式类似，但是catch中只需要一个回调函数作为参数。catch中回调函数的作用等同于then中的第二个回调函数，会在执行出错时被调用。既然有了then的第二个参数，为什么还需要一个catch呢？两个回调函数都写到then中，会导致代码不够清晰，但是多了一个catch后立刻就变的不一样了，开发时通常会在then中编写正常运行时的代码，catch中编写出现异常后要执行的代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-title function_">reject</span>(<span class="hljs-string">&quot;出错了&quot;</span>)<br>&#125;)<br><br><br><span class="hljs-comment">// 出现异常，then中只传了一个回调函数，无法读取数据</span><br><span class="hljs-comment">// promise.then((data) =&gt; &#123;</span><br><span class="hljs-comment">//     console.log(data)</span><br><span class="hljs-comment">// &#125;) </span><br><br><span class="hljs-comment">// 出现异常，可以通过catch来读取数据</span><br>promise.<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err)<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>当Promise中代码执行出错时（或者reject执行时），如果我们调用的是catch来处理数据，则Promise会将错误信息传递给catch的回调函数，我们便可以在catch中处理异常，同时catch回调函数的返回值会作为下一步Promise中的数据向下传递。如果我们调用了then来处理数据，同时没有传递第二个参数，这时then是不会执行的，而是将错误信息直接添加到下一步返回的Promise中，由后续的方法处理。在后续调用中如果有catch或then的第二个参数，则正常处理。如果没有，则报错。</p>
<p>简言之，处理Promise时，如果没有对Promise中的异常进行处理（无论是then的二参数，还是catch），则异常信息总是会封装到下一步的Promise中进行传递，直到找到异常处理的代码位置，如果一直没有处理，则报错。</p>
<p>这种设计方式使得我们可以在任意的位置对Promise的异常进行处理，例如有如下代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sum</span>(<span class="hljs-params">a, b</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt; <span class="hljs-number">0.7</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&quot;出错了&quot;</span>)<br>        &#125;<br>        <span class="hljs-title function_">resolve</span>(a + b)<br>    &#125;)<br>&#125;<br><br><span class="hljs-title function_">sum</span>(<span class="hljs-number">123</span>, <span class="hljs-number">456</span>)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-title function_">sum</span>(result, <span class="hljs-number">777</span>))<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-title function_">sum</span>(result, <span class="hljs-number">888</span>))<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result))<br></code></pre></td></tr></table></figure>

<p>上例代码中，sum函数有一定的几率会出现异常，但是我们并不确定何时会出现异常，这时有了catch就变的非常的方便，因为在出现异常后所有的then在异常处理前都不会执行，所以我们可以将catch写在调用链的最后，这样无论哪一步出现异常，我们都可以在最后统一处理。像是这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">sum</span>(<span class="hljs-number">123</span>, <span class="hljs-number">456</span>)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-title function_">sum</span>(result, <span class="hljs-number">777</span>))<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-title function_">sum</span>(result, <span class="hljs-number">888</span>))<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result))<br>    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;哎呀出错了，随便返回一个吧&quot;</span>, <span class="hljs-number">8888</span>))<br></code></pre></td></tr></table></figure>

<p>当然如果我们想在中间处理异常也是没有问题的，只是需要注意在链式调用中间处理异常时，由于后续还有then要执行，所以一定不要忘了考虑是否需要在catch中返回一个结果供后续的Promise使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">sum</span>(<span class="hljs-number">123</span>, <span class="hljs-number">456</span>)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-title function_">sum</span>(result, <span class="hljs-number">777</span>))<br>    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> &#123;<br>        <span class="hljs-comment">// 也可以在调用链的中间处理异常</span><br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;出错了，我选择忽略这个错误，重新计算&quot;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_">sum</span>(<span class="hljs-number">123</span>, <span class="hljs-number">456</span>)<br>    &#125;)<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-title function_">sum</span>(result, <span class="hljs-number">888</span>))<br>    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result))<br>    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;哎呀出错了，随便返回一个吧&quot;</span>, <span class="hljs-number">8888</span>))<br></code></pre></td></tr></table></figure>

<p>还有一点要强调一下，<font color="#409eff">在Promise正常执行的情况下如果遇到catch，catch是不会执行的，此时Promise中的结果会自动传递给下一个Promise供后续使用</font>。</p>
<h4 id="finally"><a href="#finally" class="headerlink" title="finally"></a>finally</h4><p>finally也是Promise的实例方法之一，和then、catch不同，无论何种情况finally中的回调函数总会执行，通常我们在finally中定义一些无论Promise正确执行与否都需要处理的工作。注意，finally的回调函数不会接收任何参数，同时finally的返回值也不会成为下一步的Promise中的结果。简单说，finally只是编写一些必须要执行的代码，不会对Promise产生任何实质的影响。</p>
<h3 id="【Promise静态方法】"><a href="#【Promise静态方法】" class="headerlink" title="【Promise静态方法】"></a>【Promise静态方法】</h3><table>
<thead>
<tr>
<th>方法名</th>
<th>简介</th>
</tr>
</thead>
<tbody><tr>
<td><code>Promise.resolve(value)</code></td>
<td>创建一个立即成功（fulfilled）的 Promise，值为 <code>value</code>（可以是普通值或另一个 Promise）</td>
</tr>
<tr>
<td><code>Promise.reject(reason)</code></td>
<td>创建一个立即失败（rejected）的 Promise，原因为 <code>reason</code></td>
</tr>
<tr>
<td><code>Promise.all(iterable)</code></td>
<td>所有 Promise 成功，整体才成功；有一个失败就失败（并抛出第一个失败的原因）</td>
</tr>
<tr>
<td><code>Promise.allSettled(iterable)</code></td>
<td>等待所有 Promise 都完成（无论成功或失败），返回每个结果的状态和对应值</td>
</tr>
<tr>
<td><code>Promise.race(iterable)</code></td>
<td>只看谁“先完成”（不论成功或失败），第一个 settle 的结果会被采用</td>
</tr>
<tr>
<td><code>Promise.any(iterable)</code></td>
<td>任意一个成功就整体成功，所有都失败才失败（返回一个 <code>AggregateError</code>）</td>
</tr>
</tbody></table>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// Promise.resolve</span><br><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">42</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)); <span class="hljs-comment">// 输出 42</span><br><br><span class="hljs-comment">// Promise.reject</span><br><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">&quot;Error&quot;</span>).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err)); <span class="hljs-comment">// 输出 Error</span><br><br><span class="hljs-comment">// Promise.all</span><br><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<br>    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>),<br>    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">2</span>),<br>    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">3</span>)<br>]).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)); <span class="hljs-comment">// [1, 2, 3]</span><br><br><span class="hljs-comment">// Promise.race</span><br><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">res</span>(<span class="hljs-string">&#x27;A&#x27;</span>), <span class="hljs-number">100</span>)),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">res</span>(<span class="hljs-string">&#x27;B&#x27;</span>), <span class="hljs-number">200</span>))<br>]).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)); <span class="hljs-comment">// &#x27;A&#x27;</span><br><br><span class="hljs-comment">// Promise.any</span><br><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">any</span>([<br>    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">&quot;fail1&quot;</span>),<br>    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">&quot;first success&quot;</span>),<br>    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">&quot;second success&quot;</span>)<br>]).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)); <span class="hljs-comment">// &#x27;first success&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="【总结】-1"><a href="#【总结】-1" class="headerlink" title="【总结】"></a>【总结】</h3><table>
<thead>
<tr>
<th>问题</th>
<th>Promise 解决方式</th>
</tr>
</thead>
<tbody><tr>
<td>回调地狱（嵌套多、难阅读）</td>
<td>支持链式调用，使逻辑扁平化</td>
</tr>
<tr>
<td>错误分散、难统一处理</td>
<td>支持 <code>.catch()</code> 集中处理</td>
</tr>
<tr>
<td>同步代码无法获取异步结果</td>
<td>使用 <code>resolve</code> 显式返回结果</td>
</tr>
<tr>
<td>多个异步任务难以组织</td>
<td>可以组合 Promise.all、Promise.race 等</td>
</tr>
</tbody></table>
<p><font color="#409eff">面试模板：</font></p>
<p><strong>Promise 是 ES6 引入的一个构造函数，用来解决传统异步编程中回调地狱、回调嵌套等问题。</strong>它本质上是一个对象，用来<strong>存储异步操作的结果</strong>，并提供链式调用和统一的错误处理能力。在传统回调方式中，如果多个异步操作相互依赖，我们需要层层嵌套回调，代码结构混乱，可读性差，异常处理也分散，不易维护。而 Promise 的出现就是为了解决这些问题。</p>
<p>存储数据时，在Promise中维护着两个隐藏的值PromiseResult和PromiseState，PromiseResult是Promise中真正存储值的地方，在Promise中无论是通过resolve、reject还是报错时的异常信息都会存储到PromiseResult中。PromiseState用来表示Promise中值的状态，Promise一共有三种状态：pending、fulfilled、rejected。pending是Promise的初始化状态，此时Promise中没有任何值。fulfilled是Promise的完成状态，此时表示值已经正常存储到了Promise中（通过resolve）。rejected表示拒绝，此时表示值是通过reject存储的或是执行时出现了错误。<font color="#409eff">异步任务完成后，通过调用 <code>resolve</code> 或 <code>reject</code> 将结果“写入” Promise 对象，而不是通过回调函数“传出”。</font></p>
<p>调用数据时，使用 <code>.then()</code> 可以注册回调函数，用于处理 <code>resolve</code> 或 <code>reject</code> 的结果。每次调用 <code>.then()</code> 都会返回一个<strong>新的 Promise</strong>，并把上一个回调的返回结果继续向下传递，实现<strong>链式调用</strong>，避免了回调嵌套。<code>.catch()</code> 方法用于统一捕获 Promise 中的异常，不再需要在每一步都处理错误。当我们调用Promise的then方法时，相当于为Promise设置了一个回调函数，换句话说，<font color="#409eff">then中的回调函数不会立即执行，而是在Promise的PromiseState发生变化时才会执行</font>。如果PromiseState从pending变成了fulfilled则then的第一个回调函数执行，且PromiseResult的值作为参数传递给回调函数。如果PromiseState从pending变成了rejected则then的第二个回调函数执行，且PromiseResult的值作为参数传递给回调函数。</p>
<p>最终解决问题：</p>
<ul>
<li><strong>回调地狱</strong> → 通过链式调用让逻辑扁平化</li>
<li><strong>错误分散</strong> → 通过 <code>.catch()</code> 实现集中错误处理</li>
<li><strong>结果不可直接返回</strong> → 通过 <code>resolve()</code> 封装返回值，延迟处理</li>
<li><strong>可组合性差</strong> → Promise 提供 <code>Promise.all()</code>、<code>Promise.race()</code> 等组合方法来管理多个异步任务</li>
</ul>
<h2 id="宏任务和微任务"><a href="#宏任务和微任务" class="headerlink" title="宏任务和微任务"></a>宏任务和微任务</h2><p>现在有这样一段代码，你能说出它在控制台中的输出结果吗？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>)<br><br><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>)<br>&#125;)<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>)<br></code></pre></td></tr></table></figure>

<p>要真正的理解这一段代码，我们必须要先搞懂Promise中的实例方法then到底是在做什么？之前在学习Promise时，我们就已经说过了，then相当于为Promise设置了一个回调函数，当Promise中的数据处理完毕时，便会调用then所设置的回调函数来继续后续任务。</p>
<p>上例中，我们通过Promise.resolve()创建了一个理解完成的Promise，那么按道理讲then中的回调函数应该立刻执行啊？因为Promise已经完成了啊？所以打印的顺序不应该是“1 2 3”吗？如果能想到这些那么证明之前讲解的Promise你已经理解的差不多了，但是还不够准确！</p>
<p>then中的回调函数会在Promise完成后被调用，但是注意并不是立刻就调用，而是采用一种和定时器类似的处理方式，讲函数放入到一个任务队列中，而队列中的代码会在调用栈中的代码执行完毕后才会执行。也就是说then中的代码总是在当前调用栈中的代码执行完后才执行。所以上边代码的输出结果应该为：“1 3 2”</p>
<p>那么问题又来了，如果是这样的代码呢？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>)<br>&#125;)<br><br><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>)<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>错误的分析：setTimeout是定时器，它会在一段时间后将函数放入到任务队列中，而我们没有指定时间，也就意味着函数会立刻放入到任务队列中。then同样也是将函数放入到任务队列中，并且这个Promise是一个立即完成的Promise所以函数也是立刻进入任务队列。那么按照执行顺序来讲，定时器在前，then在后，所以定时器中的函数应该先进入队列，队列又是先进先出的，所以应该先1后2。</p>
<p>上边的分析看似合理，实际上是不对的。因为setTimeout和then虽然都将函数放入到队列中，但是却不是同一个队列。为了更合理的处理异步任务，ES标准规定了一个内部的队列“PromiseJobs”，这个队列是专门用来放置由Promise产生的回调函数的（then、catch、finally），这个队列我们通常被称为“微任务队列（microtask queue）”。相对的，setTimeout这些方法是将函数放入到了“宏任务队列（macrotask queue）”。</p>
<p>简单来说，任务队列有两个，宏任务队列和微任务队列。代码执行时，宏任务进入到宏任务队列，微任务进入到微任务队列。那么哪些任务时微任务，哪些任务是宏任务呢？其实大部分的任务都属于宏任务。而微任务通常在代码运行时产生，通常是由Promise所创建的，Promise的then、catch、finally中的回调函数会作为微任务进入到微任务队列中。</p>
<p>JS代码执行时，每一个宏任务执行完毕后，JS引擎会立即执行微任务队列中的所有任务，然后才是执行宏任务队列中的任务。换句话中then中的回调函数（微任务）会先于定时器中的回调函数（宏任务）执行。所以上例中代码的执行结果应该为：“2 1”。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">queueMicrotask</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>))<br></code></pre></td></tr></table></figure>

<ul>
<li>将一个任务加入到微任务队列中。</li>
</ul>
<h3 id="【总结】-2"><a href="#【总结】-2" class="headerlink" title="【总结】"></a>【总结】</h3><p><font color="#409eff">面试模板：</font></p>
<p>在 JavaScript 中，代码的执行基于<strong>事件循环机制（Event Loop）</strong>。任务按照优先级分为两类：**宏任务（MacroTask）**和**微任务（MicroTask）**。</p>
<p>宏任务指的是<strong>每次执行栈运行的整体任务</strong>，执行完一个宏任务后，事件循环会去执行所有当前产生的微任务，然后再进入下一个宏任务。<br> 常见的宏任务包括：<code>script</code> 整体代码、<code>setTimeout</code>、<code>setInterval</code>、<code>setImmediate</code>（Node）、<code>I/O</code>、<code>UI 渲染</code> 等。</p>
<p>微任务的优先级比宏任务高，它会在当前宏任务执行结束后、下一个宏任务开始前立即执行。常见的微任务包括：<code>Promise.then</code>&#x2F;<code>catch</code>&#x2F;<code>finally</code> 的回调、<code>MutationObserver</code>、<code>queueMicrotask</code> 等。</p>
<p>事件循环的顺序是：</p>
<ol>
<li>执行一个宏任务（比如 <code>script</code> 代码）</li>
<li>执行过程中如果产生微任务，将它们加入微任务队列</li>
<li>当前宏任务执行完后，立刻执行微任务队列，直到清空</li>
<li>再去执行下一个宏任务</li>
</ol>
<p>这样设计的好处是：微任务可以在宏任务之间进行高优先级的补充执行，提高响应速度，比如 <code>Promise</code> 的回调总是比 <code>setTimeout</code> 更快执行。</p>
<h2 id="async和await"><a href="#async和await" class="headerlink" title="async和await"></a>async和await</h2><p>async&#x2F;await 是ES7提出的基于Promise的解决异步的最终方案。</p>
<h3 id="【async函数】"><a href="#【async函数】" class="headerlink" title="【async函数】"></a>【async函数】</h3><p>async是一个加在函数前的修饰符，用来创建一个异步函数，被async定义的函数会默认返回一个Promise对象resolve的值。</p>
<p>因此对async函数可以直接then，返回值就是then方法传入的函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// async基础语法</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fun0</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br><span class="hljs-title function_">fun0</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">val</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(val) <span class="hljs-comment">// 1,1</span><br>&#125;)<br><br><span class="hljs-comment">// ===&gt; 等价于</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fun0</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">resolve,reject</span>)&#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>);<br>    &#125;)<br>&#125;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fun1</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Promise&#x27;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">resolve,reject</span>)&#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;Promise&#x27;</span>)<br>    &#125;)<br>&#125;<br><span class="hljs-title function_">fun1</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(val); <span class="hljs-comment">// Promise Promise</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//声明一个async函数</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;async function&#x27;</span>);<br>    <span class="hljs-comment">//情况1：返回非promise对象数据</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;hahaha&#x27;</span>;<br>    <span class="hljs-comment">//情况2：返回是promise对象数据</span><br>    <span class="hljs-comment">/* return new Promise((resolve, reject) =&gt; &#123;</span><br><span class="hljs-comment">		// resolve(&#x27;ok&#x27;);</span><br><span class="hljs-comment">		reject(&#x27;error&#x27;);</span><br><span class="hljs-comment">	&#125;) */</span><br>    <span class="hljs-comment">//情况3：抛出异常</span><br>    <span class="hljs-comment">// throw new Error(&#x27;出错啦!!!&#x27;);</span><br>&#125;<br><span class="hljs-keyword">let</span> result = <span class="hljs-title function_">main</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<br>&#125;);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);<br></code></pre></td></tr></table></figure>

<h3 id="【await表达式】"><a href="#【await表达式】" class="headerlink" title="【await表达式】"></a>【await表达式】</h3><p>await 也是一个修饰符，只能放在async定义的函数内。可以理解为<strong>等待</strong>。</p>
<p>await 修饰的如果是Promise对象，可以获取Promise中返回的内容（resolve或reject的参数），且取到值后语句才会往下执行；如果不是Promise对象：把这个非promise的东西当做await表达式的结果。</p>
<p>注意事项</p>
<ul>
<li>await必须写在async函数中，但是async函数中可以没有await</li>
<li>如果await的promise失败了，就会抛出异常，需要通过try…catch捕获处理</li>
<li><font color="#409eff">当我们使用await调用函数后，当前函数后面的所有代码会在当前函数执行完毕以后，被放入到微任务队列中。</font></li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fun</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-keyword">let</span> a = <span class="hljs-keyword">await</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">let</span> b = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;setTimeout&#x27;</span>)<br>        &#125;,<span class="hljs-number">3000</span>)<br>    &#125;)<br>    <span class="hljs-keyword">let</span> c = <span class="hljs-keyword">await</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;function&#x27;</span><br>    &#125;()<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a,b,c)<br>&#125;<br><span class="hljs-comment">// === &gt; </span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fun2</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">let</span> a,b,c<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>)=&gt;</span>&#123;<br>        a = <span class="hljs-number">1</span><br>    &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>)=&gt;</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>            <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            	<span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;setTimeout&#x27;</span>)<br>        	&#125;,<span class="hljs-number">3000</span>)<br>    	&#125;)<br>    &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>)=&gt;</span>&#123;<br>        b = resolve<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;function&#x27;</span><br>    &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>)=&gt;</span>&#123;<br>        c = resolve<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a,b,c)<br>    &#125;)<br>&#125;<br><br><span class="hljs-title function_">fun</span>(); <span class="hljs-comment">// 3秒后输出： 1 &quot;setTimeout&quot; &quot;function&quot;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">time</span>)&#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(time);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;,time)<br>&#125;<br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fun</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-keyword">let</span> a = <span class="hljs-keyword">await</span> <span class="hljs-title function_">log</span>(<span class="hljs-number">1000</span>);<br>    <span class="hljs-keyword">let</span> b = <span class="hljs-keyword">await</span> <span class="hljs-title function_">log</span>(<span class="hljs-number">3000</span>);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>)<br>&#125;<br><br><span class="hljs-title function_">fun</span>(); <br><span class="hljs-comment">// === &gt;</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">fun2</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>)=&gt;</span>&#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">log</span>(<span class="hljs-number">1000</span>))<br>    &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">resolve</span>=&gt;</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>)=&gt;</span>&#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">log</span>(<span class="hljs-number">3000</span>);)<br>    &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">resolve</span>=&gt;</span>&#123;<br>        <span class="hljs-title function_">log</span>(<span class="hljs-number">2000</span>);<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a);<br>    	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>)<br>    &#125;)<br>&#125;<br><br><span class="hljs-comment">// 立即输出 undefined 1</span><br><span class="hljs-comment">// 1秒后输出 1000</span><br><span class="hljs-comment">// 2秒后输出 2000</span><br><span class="hljs-comment">// 3秒后输出 3000</span><br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">//1、如果await右侧为非promise类型数据</span><br>    <span class="hljs-keyword">var</span> rs = <span class="hljs-keyword">await</span> <span class="hljs-number">10</span>;<br>    <span class="hljs-keyword">var</span> rs = <span class="hljs-keyword">await</span> <span class="hljs-number">1</span> + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">var</span> rs = <span class="hljs-keyword">await</span> <span class="hljs-string">&quot;非常6+7&quot;</span>;<br><br>    <span class="hljs-comment">//2、如果await右侧为promise成功类型数据</span><br>    <span class="hljs-keyword">var</span> rs = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;success&#x27;</span>);<br>    &#125;)<br><br>    <span class="hljs-comment">//3、如果await右侧为promise失败类型数据,需要借助于try...catch捕获</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">var</span> rs = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>            <span class="hljs-title function_">reject</span>(<span class="hljs-string">&#x27;error&#x27;</span>);<br>        &#125;)<br>        &#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e);<br>        &#125;<br>&#125;<br><span class="hljs-title function_">main</span>();<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 使用async/await获取成功的结果</span><br><br><span class="hljs-comment">// 定义一个异步函数，3秒后才能获取到值(类似操作数据库)</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getSomeThing</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>            <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;获取成功&#x27;</span>)<br>        &#125;,<span class="hljs-number">3000</span>)<br>    &#125;)<br>&#125;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-keyword">let</span> a = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getSomeThing</span>();<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a)<br>&#125;<br><span class="hljs-title function_">test</span>(); <span class="hljs-comment">// 3秒后输出：获取成功</span><br></code></pre></td></tr></table></figure>

<p>案例：async结合await读取文件内容</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//1、导包</span><br><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><span class="hljs-keyword">const</span> &#123;promisify&#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;util&#x27;</span>);<br><span class="hljs-comment">//2、将fs.readFile转化成promise风格的函数</span><br><span class="hljs-keyword">const</span> myreadfile = <span class="hljs-title function_">promisify</span>(fs.<span class="hljs-property">readFile</span>);<br><span class="hljs-comment">//3、声明async函数</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-keyword">try</span>&#123;<br>        <span class="hljs-comment">//4、读取文件</span><br>        <span class="hljs-keyword">let</span> one = <span class="hljs-keyword">await</span> <span class="hljs-title function_">myreadfile</span>(<span class="hljs-string">&#x27;./resource/4.html&#x27;</span>);<br>        <span class="hljs-keyword">let</span> two = <span class="hljs-keyword">await</span> <span class="hljs-title function_">myreadfile</span>(<span class="hljs-string">&#x27;./resource/2.html&#x27;</span>);<br>        <span class="hljs-keyword">let</span> three = <span class="hljs-keyword">await</span> <span class="hljs-title function_">myreadfile</span>(<span class="hljs-string">&#x27;./resource/3.html&#x27;</span>);<br>    <span class="hljs-comment">//5、拼接读取文件内容</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(one + two + three);<br>    &#125;<span class="hljs-keyword">catch</span>(e)&#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e);<br>    &#125;<br>&#125;<br><span class="hljs-comment">//6、调用main函数</span><br><span class="hljs-title function_">main</span>();<br></code></pre></td></tr></table></figure>

<h3 id="【总结】-3"><a href="#【总结】-3" class="headerlink" title="【总结】"></a>【总结】</h3><p><code>async</code> 和 <code>await</code> 是 ES2017 引入的基于 Promise 的语法糖，用来以同步的书写方式处理异步操作。被 <code>async</code> 修饰的函数会始终返回一个 Promise，当函数返回普通值时会被自动包装成一个已完成状态的 Promise，当函数抛出异常时则会返回一个拒绝状态的 Promise。<code>await</code> 只能在 <code>async</code> 函数中使用，它会暂停函数的执行，等待其后表达式返回的 Promise 完成，并将完成的值作为返回结果，如果 Promise 被拒绝则会抛出异常，需要用 <code>try...catch</code> 来捕获。<font color="#409eff">即使 <code>await</code> 后面不是 Promise，也会被转换成一个已完成的 Promise 再处理。</font><code>async/await</code> 的核心优势是让异步代码看起来像同步代码一样直观，减少回调嵌套和链式 then 带来的可读性问题，同时可以通过 <code>try...catch</code> 统一捕获错误，从而让异步逻辑结构更清晰。但它并没有改变 JavaScript 单线程、事件循环的本质，底层依然是通过 Promise 和微任务机制来调度执行的。</p>
<h2 id="尚硅谷Promise从入门到精通"><a href="#尚硅谷Promise从入门到精通" class="headerlink" title="尚硅谷Promise从入门到精通"></a>尚硅谷Promise从入门到精通</h2><h3 id="一、前言：为什么会出现Promise"><a href="#一、前言：为什么会出现Promise" class="headerlink" title="一、前言：为什么会出现Promise?"></a>一、前言：为什么会出现Promise?</h3><p>Promise的重要性我认为没有必要多讲，概括起来说就是五个字：<strong>必！须！得！掌！握！</strong>。</p>
<p>而且还要掌握透彻，在实际的使用中，有非常多的应用场景我们不能立即知道应该如何继续往下执行。</p>
<p>最常见的一个场景就是ajax请求，通俗来说，由于网速的不同，可能你得到返回值的时间也是不同的，</p>
<p>这个时候我们就需要等待，结果出来了之后才知道怎么样继续下去。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();<br>xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;get&#x27;</span>, <span class="hljs-string">&#x27;https://v0.yiketianqi.com/api?unescape=1&amp;version=v61&amp;appid=82294778&amp;appsecret=4PKVFula&amp;city=%E5%8C%97%E4%BA%AC&#x27;</span>);<br>xhr.<span class="hljs-title function_">send</span>();<br>xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span>) &#123;<br>        <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span> &lt; <span class="hljs-number">300</span>) &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(xhr.<span class="hljs-property">responseText</span>)<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在ajax的原生实现中，利用了onreadystatechange事件，当该事件触发并且符合一定条件时，才能拿到想要的数</p>
<p>据，之后才能开始处理数据，这样做看上去并没有什么麻烦，但如果这个时候，我们还需要另外一个ajax请求，这</p>
<p>个新ajax请求的其中一个参数，得从上一个ajax请求中获取，这个时候我们就不得不等待上一个接口请求完成之</p>
<p>后，再请求后一个接口。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();<br>xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;get&#x27;</span>, <span class="hljs-string">&#x27;https://v0.yiketianqi.com/api?unescape=1&amp;version=v61&amp;appid=82294778&amp;appsecret=4PKVFula&amp;city=%E5%8C%97%E4%BA%AC&#x27;</span>);<br>xhr.<span class="hljs-title function_">send</span>();<br>xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span>) &#123;<br>        <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span> &lt; <span class="hljs-number">300</span>) &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(xhr.<span class="hljs-property">responseText</span>)<br>            <br>            <span class="hljs-comment">//伪代码....</span><br>            <span class="hljs-keyword">let</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();<br>            xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;get&#x27;</span>,<span class="hljs-string">&#x27;http://www.xx.com?a&#x27;</span>+xhr.<span class="hljs-property">responseText</span>);<br>            xhr.<span class="hljs-title function_">send</span>();<br>            xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>                <span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span>)&#123;<br>                    <span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">status</span>&gt;=<span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span>&lt;<span class="hljs-number">300</span>)&#123;<br>                        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(xhr.<span class="hljs-property">responseText</span>)<br>                        <br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>当出现第三个ajax(甚至更多)仍然依赖上一个请求时，我们的代码就变成了一场灾难。</p>
<p>这场灾难，往往也被称为<strong>回调地狱</strong>。</p>
<p>因此我们需要一个叫做Promise的东西，来解决这个问题，当然，除了回调地狱之外，还有个非常重要的需求就是</p>
<p><strong>为了代码更加具有可读性和可维护性，我们需要将数据请求与数据处理明确的区分开来</strong>。</p>
<p>上面的写法，是完全没有区分开，当数据变得复杂时，也许我们自己都无法轻松维护自己的代码了。</p>
<p>这也是模块化过程中，必须要掌握的一个重要技能，请一定重视。</p>
<h3 id="二、Promise是什么"><a href="#二、Promise是什么" class="headerlink" title="二、Promise是什么?"></a>二、Promise是什么?</h3><blockquote>
<p>Promise是异步编程的一种解决方案，比传统的解决方案回调函数更合理、更强大。</p>
<p>ES6将其写进了语言标准，统一了用法，原生提供了Promise对象。</p>
<p>指定回调函数的方式也变得更加灵活易懂，也解决了异步<code>回调地狱</code>的问题</p>
<p>旧方案是单纯使用回调函数，常见的异步操作有：定时器、fs模块、ajax、数据库操作  </p>
<p>从语法上说，Promise是一个构造函数；</p>
<p>从功能上说，Promise对象用来封装一个异步操作并可以获取其成功&#x2F;失败的结果值。</p>
</blockquote>
<h4 id="2-1-Promise的初体验"><a href="#2-1-Promise的初体验" class="headerlink" title="2.1  Promise的初体验"></a>2.1  Promise的初体验</h4><p>创建promise对象（pending状态）</p>
<p>const p &#x3D; new Promise(executor);</p>
<p>其中：</p>
<p>executor函数:  执行器  (resolve, reject) &#x3D;&gt; {}</p>
<p>resolve函数: 内部定义成功时我们调用的函数 value &#x3D;&gt; {}</p>
<p>reject函数: 内部定义失败时我们调用的函数 reason &#x3D;&gt; {}</p>
<p>executor会在Promise内部立即同步调用,异步操作在执行器中执行</p>
<p>实例对象调用Promise原型中的then方法来完成对结果的处理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script&gt;<br>    <span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>        <span class="hljs-comment">//如果咱们公司今年挣钱了，年底就发奖金，否则不发</span><br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;ok&#x27;</span>);<br>    &#125;)<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p)<br>    p.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;发奖金&#x27;</span>)<br>    &#125;, <span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;不发奖金&#x27;</span>)<br>    &#125;)<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>

<h3 id="三、使用Promise的好处"><a href="#三、使用Promise的好处" class="headerlink" title="三、使用Promise的好处?"></a>三、使用Promise的好处?</h3><h4 id="3-1-指定回调函数的方式更加灵活"><a href="#3-1-指定回调函数的方式更加灵活" class="headerlink" title="3.1  指定回调函数的方式更加灵活"></a>3.1  指定回调函数的方式更加灵活</h4><ol>
<li><p>旧的：必须在启动异步任务前指定</p>
</li>
<li><p>promise：启动异步任务-&gt;返回promise对象-&gt;给promise对象绑定回调函数</p>
<p>(甚至可以在异步任务结束后指定&#x2F;多个)</p>
</li>
</ol>
<h4 id="3-2-可以解决回调地狱问题，支持链式调用"><a href="#3-2-可以解决回调地狱问题，支持链式调用" class="headerlink" title="3.2 可以解决回调地狱问题，支持链式调用"></a>3.2 可以解决回调地狱问题，支持链式调用</h4><ol>
<li><p>什么是回调地狱？</p>
<p>回调函数嵌套调用，外部回调函数异步执行的结果是嵌套的回调执行的条件</p>
</li>
<li><p>回调地狱的缺点?</p>
<p>不便于阅读</p>
<p>不便于异常处理</p>
</li>
<li><p>解决方案？</p>
<p>promise链式调用</p>
</li>
<li><p>终极解决方案？</p>
<p>async&#x2F;await</p>
</li>
</ol>
<h3 id="四、Promise实例对象的两个属性"><a href="#四、Promise实例对象的两个属性" class="headerlink" title="四、Promise实例对象的两个属性"></a>四、Promise实例对象的两个属性</h3><ul>
<li><p>PromiseState</p>
<p>此属性为promise对象的状态属性。</p>
<ul>
<li>fulfilled：成功的状态</li>
<li>rejected：失败的状态</li>
<li>pending：初始化的状态</li>
</ul>
<p>【注】状态只能由pending-&gt;fulfilled 或者是 pending-&gt;rejected</p>
</li>
<li><p>PromiseResult</p>
<p>此属性为promise对象的结果值（resolve以及reject函数的形参值）</p>
</li>
</ul>
<h3 id="五、resolve函数以及reject函数"><a href="#五、resolve函数以及reject函数" class="headerlink" title="五、resolve函数以及reject函数"></a>五、resolve函数以及reject函数</h3><ul>
<li>resolve：修改promise对象的状态，由pending修改到fulfilled；将实参设置到这个属性PromiseResult中。</li>
<li>reject：修改promise对象的状态，由pending修改到rejected；将实参设置到这个属性PromiseResult中。</li>
</ul>
<p>案例1：利用promise来进行读取文件操作</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//1.普通文件读取方式</span><br><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><br><span class="hljs-comment">//2.直接利用readfile来进行读取</span><br><span class="hljs-comment">/* fs.readFile(__dirname + &#x27;/data.txt&#x27;,(err,data)=&gt;&#123;</span><br><span class="hljs-comment">    if(err) throw err;</span><br><span class="hljs-comment">    console.log(data.toString());</span><br><span class="hljs-comment">&#125;) */</span><br><br><span class="hljs-comment">//3.利用promise来实现文件的读取</span><br><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    fs.<span class="hljs-title function_">readFile</span>(__dirname + <span class="hljs-string">&#x27;/data.txt&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">if</span> (err) &#123;<br>            <span class="hljs-title function_">reject</span>(err);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-title function_">resolve</span>(data);<br>        &#125;<br>    &#125;)<br>&#125;); <br><br>p.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value.<span class="hljs-title function_">toString</span>());<br>&#125;,<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason);<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>案例2：利用promise进行ajax请求</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;body&gt;<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>发送ajax请求<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span><br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="language-javascript"><span class="language-xml">        <span class="hljs-comment">//1.获取DOM元素对象</span></span></span><br><span class="language-javascript"><span class="language-xml">        <span class="hljs-keyword">let</span> btn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;button&#x27;</span>);</span></span><br><span class="language-javascript"><span class="language-xml">        <span class="hljs-comment">//2.绑定事件</span></span></span><br><span class="language-javascript"><span class="language-xml">        btn.<span class="hljs-property">onclick</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-comment">//3.创建promise实例对象</span></span></span><br><span class="language-javascript"><span class="language-xml">            <span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;</span></span><br><span class="language-javascript"><span class="language-xml">                <span class="hljs-comment">//4.创建ajax实例对象</span></span></span><br><span class="language-javascript"><span class="language-xml">                <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();</span></span><br><span class="language-javascript"><span class="language-xml">                <span class="hljs-comment">//5.打开请求</span></span></span><br><span class="language-javascript"><span class="language-xml">                xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;get&#x27;</span>,<span class="hljs-string">&#x27;https://www.yiketianqi.com/free/day?appid=82294778&amp;appsecret=4PKVFula&amp;unescape=1&#x27;</span>);</span></span><br><span class="language-javascript"><span class="language-xml">                <span class="hljs-comment">//6.发送请求</span></span></span><br><span class="language-javascript"><span class="language-xml">                xhr.<span class="hljs-title function_">send</span>();</span></span><br><span class="language-javascript"><span class="language-xml">                <span class="hljs-comment">//7.利用onreadystatechange事件</span></span></span><br><span class="language-javascript"><span class="language-xml">                xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml">                    <span class="hljs-comment">//8.判断</span></span></span><br><span class="language-javascript"><span class="language-xml">                    <span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">readyState</span> == <span class="hljs-number">4</span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml">                        <span class="hljs-keyword">if</span>(xhr.<span class="hljs-property">status</span> == <span class="hljs-number">200</span>)&#123;</span></span><br><span class="language-javascript"><span class="language-xml">                            <span class="hljs-title function_">resolve</span>(xhr.<span class="hljs-property">responseText</span>);</span></span><br><span class="language-javascript"><span class="language-xml">                        &#125;<span class="hljs-keyword">else</span>&#123;</span></span><br><span class="language-javascript"><span class="language-xml">                            <span class="hljs-title function_">reject</span>(xhr.<span class="hljs-property">response</span>);</span></span><br><span class="language-javascript"><span class="language-xml">                        &#125;</span></span><br><span class="language-javascript"><span class="language-xml">                    &#125;</span></span><br><span class="language-javascript"><span class="language-xml">                &#125;</span></span><br><span class="language-javascript"><span class="language-xml">            &#125;);</span></span><br><span class="language-javascript"><span class="language-xml">            p.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;</span></span><br><span class="language-javascript"><span class="language-xml">                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(value));</span></span><br><span class="language-javascript"><span class="language-xml">            &#125;,<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;</span></span><br><span class="language-javascript"><span class="language-xml">                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;获取信息失败&#x27;</span>);</span></span><br><span class="language-javascript"><span class="language-xml">            &#125;)</span></span><br><span class="language-javascript"><span class="language-xml">        &#125;</span></span><br><span class="language-javascript"><span class="language-xml">    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span><br>&lt;/body&gt;<br></code></pre></td></tr></table></figure>

<p>案例3：利用promise进行数据库操作</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;mongoose&#x27;</span>);<br><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    mongoose.<span class="hljs-title function_">connect</span>(<span class="hljs-string">&#x27;mongodb://127.0.0.1/project&#x27;</span>);<br>    mongoose.<span class="hljs-property">connection</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;open&#x27;</span>, <span class="hljs-function">()=&gt;</span>&#123;<br>        <span class="hljs-comment">//连接成功的情况</span><br>        <span class="hljs-title function_">resolve</span>();<br>    &#125;);<br><br>    mongoose.<span class="hljs-property">connection</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;error&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-comment">//连接失败的情况</span><br>        <span class="hljs-title function_">reject</span>();<br>    &#125;)<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>    <span class="hljs-comment">//创建结构</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-title class_">NoteSchema</span> = <span class="hljs-keyword">new</span> mongoose.<span class="hljs-title class_">Schema</span>(&#123;<br>        <span class="hljs-attr">title</span>: <span class="hljs-title class_">String</span>,<br>        <span class="hljs-attr">content</span>: <span class="hljs-title class_">String</span><br>    &#125;)<br>    <span class="hljs-comment">//创建模型</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-title class_">NoteModel</span> = mongoose.<span class="hljs-title function_">model</span>(<span class="hljs-string">&#x27;notes&#x27;</span>, <span class="hljs-title class_">NoteSchema</span>);<br><br>    <span class="hljs-comment">//读取操作</span><br>    <span class="hljs-title class_">NoteModel</span>.<span class="hljs-title function_">find</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<br>    &#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason);<br>    &#125;)<br>&#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;连接失败&#x27;</span>);<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>案例4：封装一个函数，作用是读取文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ReadFileFun</span>(<span class="hljs-params">path</span>)&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>         fs.<span class="hljs-title function_">readFile</span>(path,<span class="hljs-function">(<span class="hljs-params">err,data</span>)=&gt;</span>&#123;<br>              <span class="hljs-comment">//判断</span><br>              <span class="hljs-keyword">if</span>(err)&#123;<br>                    <span class="hljs-title function_">reject</span>(err)<br>              &#125;<span class="hljs-keyword">else</span>&#123;<br>                    <span class="hljs-title function_">resolve</span>(data);<br>              &#125;<br>         &#125;)<br>    &#125;);<br>&#125;<br><br><span class="hljs-title class_">ReadFileFun</span>(<span class="hljs-string">&#x27;./data.txt&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value.<span class="hljs-title function_">toString</span>());<br>&#125;,<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason);<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>node中的promisify</p>
<ul>
<li>promisify  (只能在 NodeJS 环境中使用)</li>
<li>promisify 是 util 模块中的一个方法  util 是 nodeJS 的内置模块</li>
<li>作用: 返回一个新的函数, 函数的是 promise 风格的.</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;util&#x27;</span>);<br><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><span class="hljs-comment">//通过 fs.readFile 创建一个新的函数</span><br><span class="hljs-keyword">const</span> mineReadFile = util.<span class="hljs-title function_">promisify</span>(fs.<span class="hljs-property">readFile</span>);<br><br><span class="hljs-title function_">mineReadFile</span>(<span class="hljs-string">&#x27;./resource/2.html&#x27;</span>)<br>.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value.<span class="hljs-title function_">toString</span>());<br>&#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason);<br>&#125;)<br></code></pre></td></tr></table></figure>

<h3 id="六、Promise对象的状态"><a href="#六、Promise对象的状态" class="headerlink" title="六、Promise对象的状态"></a>六、Promise对象的状态</h3><p>Promise对象通过自身的状态来控制异步操作，Promise实例具有三种状态.</p>
<ul>
<li>异步操作未完成：pending</li>
<li>异步操作成功：fulfilled</li>
<li>异步操作失败：rejected</li>
</ul>
<p>这三种的状态的变化途径只有两种</p>
<ul>
<li>从pending(未完成)到fulfilled(成功)</li>
<li>从pending(未成功)到rejected(失败)</li>
</ul>
<p>一旦状态发生变化，就凝固了，不会再有新的状态变化，这也是Promise这个名字的由来，它的英语意思”承诺”，</p>
<p>一旦承诺生效，就不得再改变了，这也意味着Promise实例的状态变化只可能发生一次。</p>
<p>在Promise对象的构造函数中，将一个函数作为第一个参数。而这个函数，就是用来处理Promise的状态变化。</p>
<p>上面的resolve和reject都为一个函数，他们的作用分别是将状态修改为resolved和rejected。</p>
<p>因此，Promise的最终结果只有两种。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js">异步操作成功，<span class="hljs-title class_">Promise</span>实例传回一个值(value)，状态变为fulfilled.<br>异步操作失败，<span class="hljs-title class_">Promise</span>实例抛出一个错误(error),状态变为rejected<br></code></pre></td></tr></table></figure>

<h3 id="七、Promise的then方法"><a href="#七、Promise的then方法" class="headerlink" title="七、Promise的then方法"></a>七、Promise的then方法</h3><p>then：指定用于得到成功value的成功回调和用于得到失败reason的失败回调，<code>返回一个新的promise对象</code></p>
<ul>
<li>成功的状态：执行第一个回调函数</li>
<li>失败的状态：执行第二个回调函数</li>
</ul>
<p>promise.then()返回的新promise的结果状态由什么决定?</p>
<p>(1) 简单表达: 由then()指定的回调函数执行的结果决定</p>
<p>(2) 详细表达:</p>
<p>① 如果抛出异常, 新promise变为rejected, reason为抛出的异常</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>     <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;ok&#x27;</span>);<br>&#125;);<br><br><span class="hljs-keyword">let</span> result = p.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>	<span class="hljs-keyword">throw</span> <span class="hljs-string">&#x27;错误&#x27;</span>;<br>&#125;,<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason);<br>&#125;);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);<br></code></pre></td></tr></table></figure>

<p>② 如果返回的是非promise的任意值, 新promise变为fulfilled, PromiseResult为返回的值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>                <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;ok&#x27;</span>);<br>&#125;);<br><br><span class="hljs-keyword">let</span> result = p.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-number">100</span>;<br>&#125;,<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason);<br>&#125;);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);<br></code></pre></td></tr></table></figure>

<p>③ 如果返回的是另一个新promise, 此promise的结果就会成为新promise的结果 </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>                <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;ok&#x27;</span>);<br>&#125;);<br><br><span class="hljs-keyword">let</span> result = p.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>	<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>		<span class="hljs-comment">//resolve(&#x27;111&#x27;);</span><br>        <span class="hljs-title function_">reject</span>(<span class="hljs-string">&#x27;error&#x27;</span>);<br>	&#125;)<br>&#125;,<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason);<br>&#125;);<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);<br></code></pre></td></tr></table></figure>

<h3 id="八、Promise的链式调用"><a href="#八、Promise的链式调用" class="headerlink" title="八、Promise的链式调用"></a>八、Promise的链式调用</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>	<span class="hljs-comment">//resolve(&#x27;ok&#x27;);</span><br>    <span class="hljs-title function_">reject</span>(<span class="hljs-string">&#x27;error&#x27;</span>);<br>&#125;);<br><br>p.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<br>&#125;,<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason);<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<br>&#125;,<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason);<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>案例：通过promise的链式调用来读取文件</p>
<p>回调地狱的方式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br>fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">&#x27;./resource/1.html&#x27;</span>,<span class="hljs-function">(<span class="hljs-params">err,data1</span>)=&gt;</span>&#123;<br>    <span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">throw</span> err;<br>    fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">&#x27;./resource/1.html&#x27;</span>,<span class="hljs-function">(<span class="hljs-params">err,data2</span>)=&gt;</span>&#123;<br>    	<span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">throw</span> err;<br>        fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">&#x27;./resource/1.html&#x27;</span>,<span class="hljs-function">(<span class="hljs-params">err,data3</span>)=&gt;</span>&#123;<br>    		<span class="hljs-keyword">if</span>(err) <span class="hljs-keyword">throw</span> err;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data1 + data2 + data3);<br>		&#125;)<br>	&#125;)<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>Promise的形式：</p>
<p>需求：读取resource下三个文件内容，并在控制台合并输出</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>	fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">&#x27;./resource/1.html&#x27;</span>,<span class="hljs-function">(<span class="hljs-params">err,data</span>)=&gt;</span>&#123;<br>		 <span class="hljs-comment">//如果失败 则修改promise对象状态为失败</span><br>        <span class="hljs-keyword">if</span>(err) <span class="hljs-title function_">reject</span>(err);<br>        <span class="hljs-comment">//如果成功 则修改promise对象状态为成功</span><br>        <span class="hljs-title function_">resolve</span>(data);<br>	&#125;)<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>        fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">&#x27;./resource/2.html&#x27;</span>,<span class="hljs-function">(<span class="hljs-params">err,data</span>)=&gt;</span>&#123;<br>             <span class="hljs-comment">//失败</span><br>            <span class="hljs-keyword">if</span>(err) <span class="hljs-title function_">reject</span>(err);<br>            <span class="hljs-comment">//成功</span><br>            <span class="hljs-title function_">resolve</span>([value,data]);<br>        &#125;)<br>	&#125;)<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>        fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">&#x27;./resource/3.html&#x27;</span>,<span class="hljs-function">(<span class="hljs-params">err,data</span>)=&gt;</span>&#123;<br>             <span class="hljs-comment">//失败</span><br>            <span class="hljs-keyword">if</span>(err) <span class="hljs-title function_">reject</span>(err);<br>            value.<span class="hljs-title function_">push</span>(data);<br>            <span class="hljs-comment">//成功</span><br>            <span class="hljs-title function_">resolve</span>(value);<br>        &#125;)<br>	&#125;)<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value.<span class="hljs-title function_">join</span>(<span class="hljs-string">&quot;&quot;</span>));<br>&#125;)<br></code></pre></td></tr></table></figure>

<h3 id="九、Promise下的几种方法"><a href="#九、Promise下的几种方法" class="headerlink" title="九、Promise下的几种方法"></a>九、Promise下的几种方法</h3><h4 id="9-1-Promise-resolve"><a href="#9-1-Promise-resolve" class="headerlink" title="9.1 Promise.resolve()"></a>9.1 Promise.resolve()</h4><p>将一个普通值转化为promise类型的数据</p>
<ul>
<li>若参数为非promise对象，则返回的结果为成功状态的promise对象</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> p1 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-number">123</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p1);<br><span class="hljs-keyword">let</span> p2 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-literal">undefined</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p2);<br></code></pre></td></tr></table></figure>

<ul>
<li>若参数为promise对象，参数的状态决定返回结果的状态</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> p3 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>	<span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;success&#x27;</span>);<br>&#125;));<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p3);<br><br><span class="hljs-keyword">let</span> p4 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">&quot;OK&quot;</span>)));<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p4);<br></code></pre></td></tr></table></figure>

<h4 id="9-2-Promise-reject"><a href="#9-2-Promise-reject" class="headerlink" title="9.2 Promise.reject()"></a>9.2 Promise.reject()</h4><p>返回的结果<code>始终为失败的Promise对象</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-number">123</span>));<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;ok&#x27;</span>)));<br></code></pre></td></tr></table></figure>

<h4 id="9-3-Promise-catch"><a href="#9-3-Promise-catch" class="headerlink" title="9.3 Promise.catch()"></a>9.3 Promise.catch()</h4><p>功能是用来指定失败的回调函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>	<span class="hljs-comment">//resolve(&#x27;success&#x27;);</span><br>    <span class="hljs-title function_">reject</span>(<span class="hljs-string">&#x27;error&#x27;</span>);<br>&#125;);<br><br>p.<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason);<br>&#125;);<br><br><span class="hljs-comment">//then方法中不是必须传入两个参数，可以只传递成功时的回调函数</span><br><span class="hljs-comment">//也可以单独使用catch来指定失败的回调函数</span><br><br><span class="hljs-comment">//异常（错误）穿透</span><br><span class="hljs-comment">//当如果有多个需要执行的成功时的回调函数，可以不需要每一次都写失败回调，可以统一最后利用catch</span><br><span class="hljs-comment">//当如果promise对象的状态为reject的话，会一直向下穿透直到catch方法</span><br>p.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<br>&#125;).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason);<br>&#125;)<br></code></pre></td></tr></table></figure>

<h4 id="9-4-Promise-all"><a href="#9-4-Promise-all" class="headerlink" title="9.4 Promise.all()"></a>9.4 Promise.all()</h4><p>作用：针对于多个Promise的异步任务进行处理</p>
<p>接收的参数：promise数组</p>
<p>返回值：promise对象，状态由<code>promise数组中的对象状态</code>决定</p>
<ul>
<li>若每个对象状态<code>都为</code>成功，则返回的promise对象状态为成功，</li>
</ul>
<p>​		 成功的结果值为<code>每个promise对象成功结构值组成的数组</code></p>
<ul>
<li>若<code>其中一个对象</code>状态为失败，则返回的promise对象状态为失败，</li>
</ul>
<p>​	    失败的结果值为<code>失败的promise对象的结果值</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>            <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;ok&#x27;</span>);<br>&#125;)<br><span class="hljs-keyword">let</span> p2 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;hello&#x27;</span>);<br><span class="hljs-keyword">let</span> p3 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;oh yeah&#x27;</span>);<br><span class="hljs-keyword">let</span> result = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([p1, p2, p3])<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);<br></code></pre></td></tr></table></figure>

<p>当有一个ajax请求，它的参数需要另外2个甚至更多请求都有返回结果之后才能确定，</p>
<p>那么这个时候，就需要用到Promise.all来帮助我们应对这个场景。</p>
<p>Promise.all接收一个Promise对象组成的数组作为参数，</p>
<p>当这个数组所有的Promise对象状态都变成resolved或者rejected的时候，它才会去调用then方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//ES6中对Promise.all()的理解以及应用场景</span><br><span class="hljs-comment">//用于将多个Promise实例，包装成一个新的Promise实例</span><br><span class="hljs-keyword">let</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>   <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;成功01&#x27;</span>);<br>&#125;)<br><span class="hljs-keyword">let</span> p2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>	<span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;成功02&#x27;</span>);<br>&#125;).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason));<br><span class="hljs-keyword">let</span> p3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>	<span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;成功03&#x27;</span>);<br>&#125;)<br><span class="hljs-comment">//参数可以不是数组，但必须是iterator接口</span><br><span class="hljs-keyword">let</span> pAll = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([p1,p2,p3]);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(pAll)<br><span class="hljs-comment">//pAll的状态是由p1,p2,p3来决定，只有当这三个都为成功，pAll才会为成功,反之，但凡其中一个失败结果就是失败</span><br><span class="hljs-comment">//这个时候第一个失败的实力的返回值会传递给pAll的回调函数，如果作为参数的实例，自己定义了catch方法，那么它一旦为rejected，是不会触碰到pAll中的catch方法</span><br>pAll.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<br>&#125;,<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason);<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>案例1：模拟请求三个接口中的数据，全部请求成功后获取。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getUsersList</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>        <span class="hljs-comment">//模拟请求用户列表数据</span><br>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>            <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;用户列表的数据&#x27;</span>);<br>        &#125;, <span class="hljs-number">1000</span>);<br>    &#125;)<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getBannersList</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>        <span class="hljs-comment">//模拟请求用户列表数据</span><br>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>            <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;轮播图的数据&#x27;</span>);<br>        &#125;, <span class="hljs-number">2000</span>);<br>    &#125;)<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getVideoList</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>        <span class="hljs-comment">//模拟请求用户列表数据</span><br>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>            <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;视频列表的数据&#x27;</span>);<br>        &#125;, <span class="hljs-number">3000</span>);<br>    &#125;)<br>&#125;<br><span class="hljs-comment">//初始加载的时候</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">initLoad</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">let</span> all = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([<span class="hljs-title function_">getUsersList</span>(), <span class="hljs-title function_">getBannersList</span>(), <span class="hljs-title function_">getVideoList</span>()]);<br>    <span class="hljs-comment">//获取成功请求的结果值</span><br>    all.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<br>    &#125;)<br>&#125;<br><span class="hljs-title function_">initLoad</span>();<br></code></pre></td></tr></table></figure>

<p>案例2：修改多文件读取代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><span class="hljs-keyword">const</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;util&#x27;</span>);<br><span class="hljs-keyword">const</span> mywriteFile = util.<span class="hljs-title function_">promisify</span>(fs.<span class="hljs-property">readFile</span>);<br><span class="hljs-keyword">let</span> one = <span class="hljs-title function_">mywriteFile</span>(<span class="hljs-string">&#x27;./resource/1.html&#x27;</span>);<br><span class="hljs-keyword">let</span> two = <span class="hljs-title function_">mywriteFile</span>(<span class="hljs-string">&#x27;./resource/2.html&#x27;</span>);<br><span class="hljs-keyword">let</span> three = <span class="hljs-title function_">mywriteFile</span>(<span class="hljs-string">&#x27;./resource/3.html&#x27;</span>);<br><span class="hljs-keyword">let</span> result = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([one,two,three]);<br>result.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value.<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;&#x27;</span>));<br>&#125;,<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason);<br>&#125;)<br></code></pre></td></tr></table></figure>

<h4 id="9-5-Promise-race"><a href="#9-5-Promise-race" class="headerlink" title="9.5 Promise.race()"></a>9.5 Promise.race()</h4><p>Promise.race  race 赛跑的意思</p>
<p>参数: promise 数组</p>
<p>返回结果: promise 对象</p>
<p>状态由『最先改变状态的 promise对象』决定 </p>
<p>结果值由 『最先改变状态的 promise对象』决定</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>            <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>                <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;ok&#x27;</span>);<br>            &#125;, <span class="hljs-number">2000</span>)<br>&#125;);<br><span class="hljs-keyword">let</span> p2 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;success&#x27;</span>);<br><span class="hljs-keyword">let</span> p3 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;oh hou&#x27;</span>);<br><span class="hljs-keyword">let</span> result = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([p1, p2, p3]);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);<br></code></pre></td></tr></table></figure>

<p>与Promise.all相似的是，Promise.race都是以一个Promise对象组成的数组作为参数。</p>
<p>不同的是，只要当数组中的其中一个Promsie状态变成resolved或者rejected时，就可以调用.then方法了。</p>
<p>而传递给then方法的值也会有所不同。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script&gt;<br>    <span class="hljs-comment">//ES6中Promise.race的用法以及使用场景</span><br>    <span class="hljs-comment">//将多个Promise实例包装成一个新的Promise实例</span><br>    <span class="hljs-keyword">let</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, rejct</span>) =&gt;</span> &#123;<br>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>            <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;p1成功&#x27;</span>)<br>        &#125;, <span class="hljs-number">2000</span>);<br>    &#125;)<br>    <span class="hljs-keyword">let</span> p2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, rejct</span>) =&gt;</span> &#123;<br>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>            <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;p2成功&#x27;</span>);<br>        &#125;, <span class="hljs-number">1000</span>);<br>    &#125;, <span class="hljs-number">1000</span>);<br>    <span class="hljs-comment">//调用</span><br>    <span class="hljs-keyword">const</span> prace = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([p1, p2]);<br>    <span class="hljs-comment">//Promise.race区别于Promise.all：</span><br>    <span class="hljs-comment">//只要是实例中有一个先改变状态，就会把这个实例的返回值传递给prace的回调函数</span><br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//使用场景：请求超时提示</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">request</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>            <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;请求成功&#x27;</span>);<br>        &#125;, <span class="hljs-number">4000</span>);<br>    &#125;)<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">timeout</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>            <span class="hljs-title function_">reject</span>(<span class="hljs-string">&#x27;网络不畅,请求超时&#x27;</span>);<br>        &#125;, <span class="hljs-number">3000</span>);<br>    &#125;);<br>&#125;<br><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([<span class="hljs-title function_">request</span>(), <span class="hljs-title function_">timeout</span>()]).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value)<br>&#125;).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason)<br>&#125;)<br></code></pre></td></tr></table></figure>

<h4 id="9-6-Promise-allSettled"><a href="#9-6-Promise-allSettled" class="headerlink" title="9.6 Promise.allSettled()"></a>9.6 Promise.allSettled()</h4><p>Promise.allSettled()方法，用来确定要一组异步操作是否都结束了(不管成功或失败)。</p>
<p>所以，它的名字叫”Settled”，包含了”fufilled”和”rejected”两种情况.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script&gt;<br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">ajax</span>(<span class="hljs-params">url</span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>        <span class="hljs-keyword">let</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();<br>        xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;get&#x27;</span>, url, <span class="hljs-literal">true</span>);<br>        xhr.<span class="hljs-title function_">send</span>();<br>        xhr.<span class="hljs-property">onreadystatechange</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) &#123;<br>            <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">readyState</span> === <span class="hljs-number">4</span>) &#123;<br>                <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span> &lt; <span class="hljs-number">300</span>) &#123;<br>                    <span class="hljs-title function_">resolve</span>(xhr.<span class="hljs-property">responseText</span>);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-title function_">reject</span>(xhr.<span class="hljs-property">responseText</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;)<br><br>&#125;<br><span class="hljs-comment">//类比Promise下的all方法和allSettled</span><br><span class="hljs-comment">// Promise.all([ajax(&#x27;http://www.xiongmaoyouxuan.com/api/tabs&#x27;),</span><br><span class="hljs-comment">// ajax(&#x27;https://m.maizuo.com/gateway?cityId=110100&amp;k=4770248&#x27;)</span><br><span class="hljs-comment">// ]).then(value =&gt; &#123;</span><br><span class="hljs-comment">//     console.log(value)</span><br><span class="hljs-comment">// &#125;).catch(error =&gt; &#123;</span><br><span class="hljs-comment">//     console.log(error);</span><br><span class="hljs-comment">// &#125;)</span><br><br><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">allSettled</span>([<span class="hljs-title function_">ajax</span>(<span class="hljs-string">&#x27;http://www.xiongmaoyouxuan.com/api/tabs&#x27;</span>),<br>                    <span class="hljs-title function_">ajax</span>(<span class="hljs-string">&#x27;https://m.maizuo.com/gateway?cityId=110100&amp;k=4770248&#x27;</span>)<br>                   ]).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>    <span class="hljs-comment">// console.log(value)</span><br>    <span class="hljs-keyword">let</span> successList = value.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">status</span> === <span class="hljs-string">&#x27;fulfilled&#x27;</span>);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(successList)<br><br>    <span class="hljs-keyword">let</span> errorList = value.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">status</span> === <span class="hljs-string">&#x27;rejected&#x27;</span>);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(errorList)<br>&#125;).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error);<br>&#125;)<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>

<h4 id="9-7-Promise-any"><a href="#9-7-Promise-any" class="headerlink" title="9.7 Promise.any()"></a>9.7 Promise.any()</h4><p>只要参数实例有一个变成fulfilled状态，包装实例就会变成fulfiilled状态；</p>
<p>如果所有参数实例都变成rejected，包装实例就会变成rejected状态。</p>
<blockquote>
<p>Promise.any()跟Promise.race()方法很像，但是有一点不同，</p>
<p>就是Promise.any()不会因为某个Promise变成rejected状态而结束，</p>
<p>必须等到所有参数Promise变成rejected状态才会结束。</p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script&gt;<br>    <span class="hljs-keyword">let</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>            <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;ok&#x27;</span>);<br>        &#125;, <span class="hljs-number">1000</span>)<br>    &#125;)<br>    <span class="hljs-keyword">let</span> p2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>            <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;okk&#x27;</span>);<br>        &#125;, <span class="hljs-number">2000</span>)<br>    &#125;)<br>    <span class="hljs-keyword">let</span> p3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>            <span class="hljs-title function_">reject</span>(<span class="hljs-string">&#x27;error&#x27;</span>);<br>        &#125;, <span class="hljs-number">3000</span>)<br>    &#125;)<br>    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">any</span>([p1, p2, p3]).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)<br>    &#125;).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;error&#x27;</span>)<br>    &#125;)<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>

<h4 id="9-8-Promise-finally"><a href="#9-8-Promise-finally" class="headerlink" title="9.8 Promise.finally()"></a>9.8 Promise.finally()</h4><p>finally是在ES9(ES2018)中新增的一个特性：表示无论Promise对象变成fufilled还是rejected状态，最终都会被执行。</p>
<p>finally方法中的<code>回调函数</code>是不接受参数的，因为无论前面是fulfilled状态还是rejected状态， 它都是执行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// resolve(&#x27;ok&#x27;);</span><br>    <span class="hljs-title function_">reject</span>(<span class="hljs-string">&#x27;error&#x27;</span>);<br>&#125;);<br>p.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res);<br>&#125;).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err);<br>&#125;).<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;finally&#x27;</span>)<br>&#125;)<br></code></pre></td></tr></table></figure>

<h3 id="十、终止Promise链条"><a href="#十、终止Promise链条" class="headerlink" title="十、终止Promise链条"></a>十、终止Promise链条</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-title function_">resolve</span>(<span class="hljs-number">111</span>);<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">222</span>);<br>    <span class="hljs-comment">//</span><br>    <span class="hljs-comment">// return false;</span><br>    <span class="hljs-comment">// throw &#x27;出错啦&#x27;;</span><br>    <span class="hljs-comment">//有且只有一种方式 返回一个pending状态的promise对象</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;&#125;);<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">333</span>);<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">444</span>);<br>&#125;).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason);<br>&#125;);<br></code></pre></td></tr></table></figure>

<h3 id="十一、几个关键问题"><a href="#十一、几个关键问题" class="headerlink" title="十一、几个关键问题"></a>十一、几个关键问题</h3><h4 id="11-1-如何修改-promise-对象状态"><a href="#11-1-如何修改-promise-对象状态" class="headerlink" title="11.1 如何修改 promise 对象状态"></a>11.1 如何修改 promise 对象状态</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script&gt;<br>    <span class="hljs-comment">//如何修改 promise 对象状态</span><br>    <span class="hljs-keyword">let</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>        <span class="hljs-comment">//1. resolve</span><br>        <span class="hljs-comment">// resolve(&#x27;success&#x27;);</span><br>        <span class="hljs-comment">//2. reject</span><br>        <span class="hljs-comment">// reject(&#x27;error&#x27;);</span><br>        <span class="hljs-comment">//3. 抛出错误 异常</span><br>        <span class="hljs-comment">// throw &#x27;出问题啦! 你说出这样的话  你没有良心!!&#x27;;</span><br>        <span class="hljs-comment">// 状态的改变只有一次 </span><br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;ok&#x27;</span>);<br>        <span class="hljs-title function_">reject</span>(<span class="hljs-string">&#x27;error&#x27;</span>);<br>    &#125;);<br>	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p);<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>

<h4 id="11-2-指定多个回调执行情况"><a href="#11-2-指定多个回调执行情况" class="headerlink" title="11.2 指定多个回调执行情况"></a>11.2 指定多个回调执行情况</h4><p>问题：一个promise指定多个成功&#x2F;失败回调函数，都会调用吗？</p>
<p>答：会，但是前提是当promise对象的状态改变(fulfilled&#x2F;rejected)时才会调用</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script&gt;<br>        <span class="hljs-keyword">let</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>            <span class="hljs-comment">//promise对象是可以多次调用then方法完成多个成功/失败回调函数</span><br>            <span class="hljs-comment">//但是使用的前提是这个promise对象的状态必须要么是fulfilled或者是rejected</span><br>            <span class="hljs-comment">//不能是pending</span><br>            <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;OK&#x27;</span>);<br>        &#125;);	<br>		<br>        <span class="hljs-comment">//第一次指定回调</span><br>        p.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<br>        &#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(reason);<br>        &#125;);<br><br>        p.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>            <span class="hljs-title function_">alert</span>(value);<br>        &#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>            <span class="hljs-title function_">alert</span>(reason);<br>        &#125;)<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>

<h4 id="11-3-指定回调与改变状态先后顺序问题"><a href="#11-3-指定回调与改变状态先后顺序问题" class="headerlink" title="11.3 指定回调与改变状态先后顺序问题"></a>11.3 指定回调与改变状态先后顺序问题</h4><p>改变promise状态和指定回调函数执行谁先谁后？</p>
<ul>
<li><p>都有可能，正常情况下是先指定回调再改变状态，但也可以先改变状态在指定回调</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//若执行器函数中是异步任务, 则先指定回调, 然后再改变状态  更为常见</span><br><span class="hljs-comment">//若执行器函数中是同步任务, 则先改变状态, 然后再指定回调</span><br><span class="hljs-keyword">let</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">//同步任务</span><br>    <span class="hljs-comment">//resolve(&#x27;ok&#x27;);</span><br>    <span class="hljs-comment">//异步任务</span><br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;ok&#x27;</span>);<br>    &#125;, <span class="hljs-number">1000</span>);<br>&#125;);<br></code></pre></td></tr></table></figure>
</li>
<li><p>如何先改状态再指定回调？</p>
<ul>
<li>在执行器中直接调用resolve()&#x2F;reject()</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">let</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>	<span class="hljs-comment">//resolve(&#x27;ok&#x27;);</span><br>	<span class="hljs-title function_">reject</span>(<span class="hljs-string">&#x27;error&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure>

<ul>
<li>延迟更长时间才调用then()</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;ok&#x27;</span>);<br>    &#125;, <span class="hljs-number">1000</span>)<br><br>&#125;)<br><span class="hljs-comment">//then方法使用定时器延迟更久的时间</span><br><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    p.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<br>    &#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason);<br>    &#125;)<br><br>&#125;, <span class="hljs-number">3000</span>)<br></code></pre></td></tr></table></figure>
</li>
<li><p>什么时候才能得到数据？</p>
<ul>
<li>如果是先指定的回调，那当状态发生改变时，回调函数就会调用，得到数据</li>
<li>如果先改变的状态，那当指定回调时，回调函数就会调用，得到数据</li>
</ul>
</li>
</ul>
<h4 id="11-4-promise-then-返回的新promise的结果状态由什么决定？"><a href="#11-4-promise-then-返回的新promise的结果状态由什么决定？" class="headerlink" title="11.4 promise.then()返回的新promise的结果状态由什么决定？"></a>11.4 promise.then()返回的新promise的结果状态由什么决定？</h4><ul>
<li>简单表达：由then指定的回调函数执行的结果决定</li>
<li>详细表达：<ul>
<li>如果抛出异常：新promise对象状态变成rejected，reason为抛出的异常</li>
<li>如果返回的是是非promise的任意值，新promise对象状态变成fulfilled，value为返回的值</li>
<li>如果返回的是另一个新的promise对象，此promise的结果就会称为新promise的结果</li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;ok&#x27;</span>);<br>&#125;)<br><span class="hljs-keyword">let</span> result = p.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>    <span class="hljs-comment">//return value;</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;okk&#x27;</span>);<br>    &#125;)<br>&#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason);<br>&#125;)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);<br></code></pre></td></tr></table></figure>

<h4 id="11-5-promise如何串联多个操作任务"><a href="#11-5-promise如何串联多个操作任务" class="headerlink" title="11.5 promise如何串联多个操作任务?"></a>11.5 promise如何串联多个操作任务?</h4><ul>
<li>promise的then()返回一个新的promise对象，可以写成then()方法的链式调用</li>
<li>通过then()的链式调用串联多个同步&#x2F;异步任务</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;script&gt;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">111</span>);<br>            <span class="hljs-title function_">reject</span>();<br>    &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">222</span>);<br>    &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span> &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<br>    &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value)<br>    &#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(reason);<br>    &#125;);<br>&lt;/script&gt;<br></code></pre></td></tr></table></figure>

<h4 id="11-6-promise的异常穿透"><a href="#11-6-promise的异常穿透" class="headerlink" title="11.6 promise的异常穿透"></a>11.6 promise的异常穿透</h4><ul>
<li>当使用promise的then链式调用时, 可以在最后指定失败的回调,</li>
<li>前面任何操作出了异常, 都会传到最后失败的回调中处理</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">111</span>);<br>    <span class="hljs-title function_">reject</span>(<span class="hljs-string">&#x27;error&#x27;</span>);<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">222</span>);<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value)<br>&#125;).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(reason);<br>&#125;)<br></code></pre></td></tr></table></figure>

<h4 id="11-7-中断promise链"><a href="#11-7-中断promise链" class="headerlink" title="11.7 中断promise链"></a>11.7 中断promise链</h4><ul>
<li>当使用promise的then链式调用时, 在中间中断, 不再调用后面的回调函数</li>
<li>办法: 在回调函数中返回一个pending状态的promise对象</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">111</span>);<br>    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;ok&#x27;</span>);<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">222</span>);<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">() =&gt;</span> &#123; &#125;)<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value)<br>&#125;, <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(reason);<br>&#125;);<br></code></pre></td></tr></table></figure>

<h3 id="十二、async和await"><a href="#十二、async和await" class="headerlink" title="十二、async和await"></a>十二、async和await</h3><p>async&#x2F;await 是ES7提出的基于Promise的解决异步的最终方案。</p>
<h4 id="12-1-async函数"><a href="#12-1-async函数" class="headerlink" title="12.1  async函数"></a>12.1  async函数</h4><p>async是一个加在函数前的修饰符，用来创建一个异步函数，被async定义的函数会默认返回一个Promise对象resolve的值。</p>
<p>因此对async函数可以直接then，返回值就是then方法传入的函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// async基础语法</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fun0</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br><span class="hljs-title function_">fun0</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">val</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(val) <span class="hljs-comment">// 1,1</span><br>&#125;)<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fun1</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Promise&#x27;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">resolve,reject</span>)&#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;Promise&#x27;</span>)<br>    &#125;)<br>&#125;<br><span class="hljs-title function_">fun1</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">val</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(val); <span class="hljs-comment">// Promise Promise</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//声明一个async函数</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;async function&#x27;</span>);<br>    <span class="hljs-comment">//情况1：返回非promise对象数据</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;hahaha&#x27;</span>;<br>    <span class="hljs-comment">//情况2：返回是promise对象数据</span><br>    <span class="hljs-comment">/* return new Promise((resolve, reject) =&gt; &#123;</span><br><span class="hljs-comment">		// resolve(&#x27;ok&#x27;);</span><br><span class="hljs-comment">		reject(&#x27;error&#x27;);</span><br><span class="hljs-comment">	&#125;) */</span><br>    <span class="hljs-comment">//情况3：抛出异常</span><br>    <span class="hljs-comment">// throw new Error(&#x27;出错啦!!!&#x27;);</span><br>&#125;<br><span class="hljs-keyword">let</span> result = <span class="hljs-title function_">main</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<br>&#125;);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result);<br></code></pre></td></tr></table></figure>

<h4 id="12-2-await表达式"><a href="#12-2-await表达式" class="headerlink" title="12.2  await表达式"></a>12.2  await表达式</h4><p>await 也是一个修饰符，只能放在async定义的函数内。可以理解为<strong>等待</strong>。</p>
<p>await 修饰的如果是Promise对象，可以获取Promise中返回的内容（resolve或reject的参数），且取到值后语句才会往下执行；如果不是Promise对象：把这个非promise的东西当做await表达式的结果。</p>
<p>注意事项</p>
<ul>
<li>await必须写在async函数中，但是async函数中可以没有await</li>
<li>如果await的promise失败了，就会抛出异常，需要通过try…catch捕获处理</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fun</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-keyword">let</span> a = <span class="hljs-keyword">await</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">let</span> b = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>            <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;setTimeout&#x27;</span>)<br>        &#125;,<span class="hljs-number">3000</span>)<br>    &#125;)<br>    <span class="hljs-keyword">let</span> c = <span class="hljs-keyword">await</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;function&#x27;</span><br>    &#125;()<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a,b,c)<br>&#125;<br><br><span class="hljs-title function_">fun</span>(); <span class="hljs-comment">// 3秒后输出： 1 &quot;setTimeout&quot; &quot;function&quot;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">time</span>)&#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(time);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;,time)<br>&#125;<br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fun</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-keyword">let</span> a = <span class="hljs-keyword">await</span> <span class="hljs-title function_">log</span>(<span class="hljs-number">1000</span>);<br>    <span class="hljs-keyword">let</span> b = <span class="hljs-keyword">await</span> <span class="hljs-title function_">log</span>(<span class="hljs-number">3000</span>);<br>    <span class="hljs-keyword">let</span> c = <span class="hljs-title function_">log</span>(<span class="hljs-number">2000</span>);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>)<br>&#125;<br><br><span class="hljs-title function_">fun</span>(); <br><br><span class="hljs-comment">// 立即输出 undefined 1</span><br><span class="hljs-comment">// 1秒后输出 1000</span><br><span class="hljs-comment">// 2秒后输出 2000</span><br><span class="hljs-comment">// 3秒后输出 3000</span><br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">//1、如果await右侧为非promise类型数据</span><br>    <span class="hljs-keyword">var</span> rs = <span class="hljs-keyword">await</span> <span class="hljs-number">10</span>;<br>    <span class="hljs-keyword">var</span> rs = <span class="hljs-keyword">await</span> <span class="hljs-number">1</span> + <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">var</span> rs = <span class="hljs-keyword">await</span> <span class="hljs-string">&quot;非常6+7&quot;</span>;<br><br>    <span class="hljs-comment">//2、如果await右侧为promise成功类型数据</span><br>    <span class="hljs-keyword">var</span> rs = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;success&#x27;</span>);<br>    &#125;)<br><br>    <span class="hljs-comment">//3、如果await右侧为promise失败类型数据,需要借助于try...catch捕获</span><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">var</span> rs = <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>            <span class="hljs-title function_">reject</span>(<span class="hljs-string">&#x27;error&#x27;</span>);<br>        &#125;)<br>        &#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e);<br>        &#125;<br>&#125;<br><span class="hljs-title function_">main</span>();<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 使用async/await获取成功的结果</span><br><br><span class="hljs-comment">// 定义一个异步函数，3秒后才能获取到值(类似操作数据库)</span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">getSomeThing</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>            <span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;获取成功&#x27;</span>)<br>        &#125;,<span class="hljs-number">3000</span>)<br>    &#125;)<br>&#125;<br><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-keyword">let</span> a = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getSomeThing</span>();<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a)<br>&#125;<br><span class="hljs-title function_">test</span>(); <span class="hljs-comment">// 3秒后输出：获取成功</span><br></code></pre></td></tr></table></figure>

<p>案例：async结合await读取文件内容</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//1、导包</span><br><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br><span class="hljs-keyword">const</span> &#123;promisify&#125; = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;util&#x27;</span>);<br><span class="hljs-comment">//2、将fs.readFile转化成promise风格的函数</span><br><span class="hljs-keyword">const</span> myreadfile = <span class="hljs-title function_">promisify</span>(fs.<span class="hljs-property">readFile</span>);<br><span class="hljs-comment">//3、声明async函数</span><br><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-keyword">try</span>&#123;<br>        <span class="hljs-comment">//4、读取文件</span><br>        <span class="hljs-keyword">let</span> one = <span class="hljs-keyword">await</span> <span class="hljs-title function_">myreadfile</span>(<span class="hljs-string">&#x27;./resource/4.html&#x27;</span>);<br>        <span class="hljs-keyword">let</span> two = <span class="hljs-keyword">await</span> <span class="hljs-title function_">myreadfile</span>(<span class="hljs-string">&#x27;./resource/2.html&#x27;</span>);<br>        <span class="hljs-keyword">let</span> three = <span class="hljs-keyword">await</span> <span class="hljs-title function_">myreadfile</span>(<span class="hljs-string">&#x27;./resource/3.html&#x27;</span>);<br>    <span class="hljs-comment">//5、拼接读取文件内容</span><br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(one + two + three);<br>    &#125;<span class="hljs-keyword">catch</span>(e)&#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(e);<br>    &#125;<br>&#125;<br><span class="hljs-comment">//6、调用main函数</span><br><span class="hljs-title function_">main</span>();<br></code></pre></td></tr></table></figure>

<h3 id="十三、JS中的宏队列与微队列"><a href="#十三、JS中的宏队列与微队列" class="headerlink" title="十三、JS中的宏队列与微队列"></a>十三、JS中的宏队列与微队列</h3><ul>
<li>说明<ul>
<li>JS中用来存储待执行回调函数的队列包含2个不同特定的列队</li>
<li>宏列队: 用来保存待执行的宏任务(回调), 比如: 定时器回调&#x2F;DOM事件回调&#x2F;ajax回调</li>
<li>微列队: 用来保存待执行的微任务(回调), 比如: promise的回调&#x2F;MutationObserver的回调</li>
<li>JS执行时会区别这2个队列<ul>
<li>JS引擎首先必须先执行所有的初始化同步任务代码</li>
<li>每次准备取出第一个宏任务执行前, 都要将所有的微任务一个一个取出来执行</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">111</span>);<br>&#125;);<br><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-title function_">resolve</span>();<br>    <span class="hljs-comment">//return ;throw</span><br>    <span class="hljs-title function_">reject</span>();<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">222</span>);<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">v</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">333</span>);<br>&#125;)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">444</span>);<br></code></pre></td></tr></table></figure>

<h3 id="十四、Promise常见面试题"><a href="#十四、Promise常见面试题" class="headerlink" title="十四、Promise常见面试题"></a>十四、Promise常见面试题</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>)<br>&#125;, <span class="hljs-number">0</span>)<br><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>)<br>&#125;)<br><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">4</span>)<br>&#125;)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>)<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>)<br>&#125;, <span class="hljs-number">0</span>)<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>)<br>    <span class="hljs-title function_">resolve</span>()<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>)<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">4</span>)<br>&#125;)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">5</span>)<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">first</span> = (<span class="hljs-params"></span>) =&gt; (<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>)<br>    <span class="hljs-keyword">let</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">7</span>)<br>        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">5</span>)<br>            <span class="hljs-title function_">resolve</span>(<span class="hljs-number">6</span>)<br>        &#125;, <span class="hljs-number">0</span>)<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>)<br>    &#125;)<br>    <span class="hljs-title function_">resolve</span>(<span class="hljs-number">2</span>)<br>    p.<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">arg</span>) =&gt;</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arg)<br>    &#125;)<br><br>&#125;))<br><span class="hljs-title function_">first</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">arg</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arg)<br>&#125;)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">4</span>)<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;0&quot;</span>)<br>&#125;, <span class="hljs-number">0</span>)<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;1&quot;</span>)<br>    <span class="hljs-title function_">resolve</span>()<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;2&quot;</span>)<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;3&quot;</span>)<br>        <span class="hljs-title function_">resolve</span>()<br>    &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;4&quot;</span>)<br>    &#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;5&quot;</span>)<br>    &#125;)<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;6&quot;</span>);<br>&#125;)<br><br><span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;7&quot;</span>)<br>    <span class="hljs-title function_">resolve</span>()<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;8&quot;</span>)<br>&#125;);<br></code></pre></td></tr></table></figure>

<h3 id="十五、手写promise自定义基础结构的搭建"><a href="#十五、手写promise自定义基础结构的搭建" class="headerlink" title="十五、手写promise自定义基础结构的搭建"></a>十五、手写promise自定义基础结构的搭建</h3><h4 id="15-1-Promise-的基本结构"><a href="#15-1-Promise-的基本结构" class="headerlink" title="15.1   Promise 的基本结构"></a>15.1   Promise 的基本结构</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 1- Promise 是一个构造函数</span><br><span class="hljs-comment"> * 2- Promise 接收一个参数，该参数的类型是函数（执行器函数executor）</span><br><span class="hljs-comment"> * 3- executor接收两个参数（resolve,reject）,参数的类型是函数</span><br><span class="hljs-comment"> * 4- 执行器函数会同步执行。</span><br><span class="hljs-comment"> * 5- then方法在其显式原型属性上</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-comment">// 立即调用函数的好处：可以避免对外部的变量造成污染。</span><br>(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">window</span></span>)&#123;<br>    <span class="hljs-comment">// executor是执行器函数</span><br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>)&#123;<br>        <span class="hljs-title function_">executor</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br><br>        &#125;,<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br><br>        &#125;);<br>    &#125;<br>    <span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;这是我的执行器函数&quot;</span>,resolve,reject)<br>&#125;)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;over&quot;</span>,<span class="hljs-title class_">Promise</span>);<br></code></pre></td></tr></table></figure>

<h4 id="15-2-Promise实例拥有两个实例属性"><a href="#15-2-Promise实例拥有两个实例属性" class="headerlink" title="15.2  Promise实例拥有两个实例属性"></a>15.2  Promise实例拥有两个实例属性</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 1- Promise实例拥有两个实例属性：</span><br><span class="hljs-comment"> * 状态（[[PromiseState]]），初始状态为pending</span><br><span class="hljs-comment"> * 值（[[PromiseResult]]）,初始值为undefined</span><br><span class="hljs-comment">*/</span> <br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 立即调用函数的好处：可以避免对外部的变量造成污染。</span><br>(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">window</span></span>)&#123;<br>	<span class="hljs-comment">// executor是执行器函数</span><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>)&#123;<br>		<span class="hljs-comment">// 定义实例属性state,初始值为pending</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<br>		<span class="hljs-comment">// 定义实例属性result,初始值为undefined</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<br>		<span class="hljs-title function_">executor</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>		<br>		&#125;,<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>		<br>		&#125;);<br>	&#125;<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>)=&gt;</span>&#123;<br>	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;这是我的执行器函数&quot;</span>,resolve,reject)<br>&#125;)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p1);<br></code></pre></td></tr></table></figure>

<h4 id="15-3-更改状态三种方式-方法未抽离"><a href="#15-3-更改状态三种方式-方法未抽离" class="headerlink" title="15.3 更改状态三种方式-方法未抽离"></a>15.3 更改状态三种方式-方法未抽离</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 更改状态三种方式</span><br><span class="hljs-comment"> * 1- 通过调用resolve将状态更改为成功（fulfilled），接收的值为成功值</span><br><span class="hljs-comment"> * 2- 通过调用reject将状态更改为失败(rejected)，接收的值为失败值</span><br><span class="hljs-comment"> * 3- 抛出异常将状态更改为失败(rejected)，失败的值为异常信息。</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 立即调用函数的好处：可以避免对外部的变量造成污染。</span><br>(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">window</span></span>)&#123;<br>	<span class="hljs-comment">// executor是执行器函数</span><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>)&#123;<br>		<span class="hljs-comment">// 定义实例属性state,初始值为pending</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<br>		<span class="hljs-comment">// 定义实例属性result,初始值为undefined</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<br>		<span class="hljs-keyword">try</span>&#123;<br>			<span class="hljs-title function_">executor</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>)&#123;<br>				<span class="hljs-comment">// 将状态更改为成功(fulfilled)</span><br>				<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<br>				<span class="hljs-comment">// 成功值为value</span><br>				<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>			&#125;.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>),<span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>)&#123;<br>				<span class="hljs-comment">// 将状态更改为失败</span><br>				<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;rejected&quot;</span>;<br>				<span class="hljs-comment">// 将result设置为value</span><br>				<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>			&#125;.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));<br>		&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>			<span class="hljs-comment">// 将状态更改为失败</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;rejected&quot;</span>;<br>			<span class="hljs-comment">// 将异常信息作为失败值</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = err;<br>		&#125;<br>		<br>	&#125;<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-comment">// resolve(1);</span><br>    <span class="hljs-comment">// reject(2);</span><br>    <span class="hljs-keyword">throw</span> <span class="hljs-string">&quot;异常&quot;</span><br>&#125;)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p1);<br></code></pre></td></tr></table></figure>

<h4 id="15-4-更改状态三种方式-抽离为普通函数"><a href="#15-4-更改状态三种方式-抽离为普通函数" class="headerlink" title="15.4  更改状态三种方式-抽离为普通函数"></a>15.4  更改状态三种方式-抽离为普通函数</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 立即调用函数的好处：可以避免对外部的变量造成污染。</span><br>(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">window</span></span>)&#123;<br>	<span class="hljs-comment">// executor是执行器函数</span><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>)&#123;<br>		<span class="hljs-comment">// 定义实例属性state,初始值为pending</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<br>		<span class="hljs-comment">// 定义实例属性result,初始值为undefined</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<br>		<span class="hljs-comment">// 定义resolve函数</span><br>		<span class="hljs-keyword">const</span> _resolve = <span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>)&#123;<br>			<span class="hljs-comment">// 将状态更改为成功(fulfilled)</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<br>			<span class="hljs-comment">// 成功值为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>		&#125;.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>)<br>		<span class="hljs-comment">// 定义reject函数</span><br>		<span class="hljs-keyword">const</span> _reject = <span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>)&#123;<br>			<span class="hljs-comment">// 将状态更改为失败</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;rejected&quot;</span>;<br>			<span class="hljs-comment">// 将result设置为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>		&#125;.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>)<br>		<span class="hljs-keyword">try</span>&#123;<br>			<span class="hljs-title function_">executor</span>(_resolve,_reject);<br>		&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>			<span class="hljs-comment">// 将状态更改为失败</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;rejected&quot;</span>;<br>			<span class="hljs-comment">// 将异常信息作为失败值</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = err;<br>		&#125;<br>	&#125;<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-comment">// resolve(1);</span><br>    <span class="hljs-title function_">reject</span>(<span class="hljs-number">2</span>);<br>    <span class="hljs-comment">// throw &quot;异常&quot;</span><br>&#125;)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p1);<br></code></pre></td></tr></table></figure>

<h4 id="15-5-更改状态三种方式-抽离为箭头函数"><a href="#15-5-更改状态三种方式-抽离为箭头函数" class="headerlink" title="15.5   更改状态三种方式-抽离为箭头函数"></a>15.5   更改状态三种方式-抽离为箭头函数</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 立即调用函数的好处：可以避免对外部的变量造成污染。</span><br>(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">window</span></span>)&#123;<br>	<span class="hljs-comment">// executor是执行器函数</span><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>)&#123;<br>		<span class="hljs-comment">// 定义实例属性state,初始值为pending</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<br>		<span class="hljs-comment">// 定义实例属性result,初始值为undefined</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<br>		<span class="hljs-comment">// 定义resolve函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_resolve</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 将状态更改为成功(fulfilled)</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<br>			<span class="hljs-comment">// 成功值为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>		&#125;<br>		<span class="hljs-comment">// 定义reject函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_reject</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 将状态更改为失败</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;rejected&quot;</span>;<br>			<span class="hljs-comment">// 将result设置为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>		&#125;<br>		<span class="hljs-keyword">try</span>&#123;<br>			<span class="hljs-title function_">executor</span>(_resolve,_reject);<br>		&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>			<span class="hljs-comment">// 将状态更改为失败</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;rejected&quot;</span>;<br>			<span class="hljs-comment">// 将异常信息作为失败值</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = err;<br>		&#125;<br>		<br>	&#125;<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-comment">// resolve(1);</span><br>    <span class="hljs-comment">// reject(2);</span><br>    <span class="hljs-keyword">throw</span> <span class="hljs-string">&quot;异常&quot;</span><br>&#125;)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p1);<br></code></pre></td></tr></table></figure>

<h4 id="15-6-状态只允许更改一次"><a href="#15-6-状态只允许更改一次" class="headerlink" title="15.6   状态只允许更改一次"></a>15.6   状态只允许更改一次</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * pending-&gt; fulfilled</span><br><span class="hljs-comment"> * pending-&gt; rejected</span><br><span class="hljs-comment"> * 改变状态只有这两种，且一个promise对象只能改变一次，，无论变成成功还是失败，都会有一个结果值</span><br><span class="hljs-comment"> * 成功的结果数据一般称为value，失败的结果值一般称为reason</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 立即调用函数的好处：可以避免对外部的变量造成污染。</span><br>(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">window</span></span>)&#123;<br>	<span class="hljs-comment">// executor是执行器函数</span><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>)&#123;<br>		<span class="hljs-comment">// 定义实例属性state,初始值为pending</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<br>		<span class="hljs-comment">// 定义实例属性result,初始值为undefined</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<br>		<span class="hljs-comment">// 定义resolve函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_resolve</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为成功(fulfilled)</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<br>			<span class="hljs-comment">// 成功值为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>		&#125;<br>		<span class="hljs-comment">// 定义reject函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_reject</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为失败</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;rejected&quot;</span>;<br>			<span class="hljs-comment">// 将result设置为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>		&#125;<br>		<span class="hljs-keyword">try</span>&#123;<br>			<span class="hljs-title function_">executor</span>(_resolve,_reject);<br>		&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>			<span class="hljs-title function_">_reject</span>(err);<span class="hljs-comment">// 状态更改为失败，值为异常信息</span><br>		&#125;<br>		<br>	&#125;<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-title function_">reject</span>(<span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">throw</span> <span class="hljs-string">&quot;异常&quot;</span><br>&#125;)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p1);<br></code></pre></td></tr></table></figure>

<h4 id="15-7-then函数调用成功或失败回调函数"><a href="#15-7-then函数调用成功或失败回调函数" class="headerlink" title="15.7  then函数调用成功或失败回调函数"></a>15.7  then函数调用成功或失败回调函数</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 1- then是Promise中的原型方法</span><br><span class="hljs-comment"> * 2- then函数接收两个参数（成功回调，失败回调）</span><br><span class="hljs-comment"> * 3- 如果p1状态为成功执行成功回调，失败执行失败回调。</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 立即调用函数的好处：可以避免对外部的变量造成污染。</span><br>(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">window</span></span>)&#123;<br>	<span class="hljs-comment">// executor是执行器函数</span><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>)&#123;<br>		<span class="hljs-comment">// 定义实例属性state,初始值为pending</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<br>		<span class="hljs-comment">// 定义实例属性result,初始值为undefined</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<br>		<span class="hljs-comment">// 定义resolve函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_resolve</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为成功(fulfilled)</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<br>			<span class="hljs-comment">// 成功值为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>		&#125;<br>		<span class="hljs-comment">// 定义reject函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_reject</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为失败</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;rejected&quot;</span>;<br>			<span class="hljs-comment">// 将result设置为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>		&#125;<br>		<span class="hljs-keyword">try</span>&#123;<br>			<span class="hljs-title function_">executor</span>(_resolve,_reject);<br>		&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>			<span class="hljs-title function_">_reject</span>(err);<span class="hljs-comment">// 状态更改为失败，值为异常信息</span><br>		&#125;<br>		<br>	&#125;<br><br>	<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>,&#123;<br>		<span class="hljs-comment">// onResolved:成功回调</span><br>		<span class="hljs-comment">// onRejected:失败回调</span><br>		<span class="hljs-title function_">then</span>(<span class="hljs-params">onResolved,onRejected</span>)&#123;<br>			<span class="hljs-comment">// 状态成功调用onResolved</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;fulfilled&quot;</span>)&#123;<br>				<span class="hljs-title function_">onResolved</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>);<br>			&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;rejected&quot;</span>)&#123;<br>				<span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>);<br>			&#125;<br>		&#125;,<br>		<span class="hljs-keyword">catch</span>()&#123;<br>		<br>		&#125;<br>	&#125;)<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<h4 id="15-8-then函数中的回调函数是异步调用的"><a href="#15-8-then函数中的回调函数是异步调用的" class="headerlink" title="15.8  then函数中的回调函数是异步调用的"></a>15.8  then函数中的回调函数是异步调用的</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 立即调用函数的好处：可以避免对外部的变量造成污染。</span><br>(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">window</span></span>)&#123;<br>	<span class="hljs-comment">// executor是执行器函数</span><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>)&#123;<br>		<span class="hljs-comment">// 定义实例属性state,初始值为pending</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<br>		<span class="hljs-comment">// 定义实例属性result,初始值为undefined</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<br>		<span class="hljs-comment">// 定义resolve函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_resolve</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为成功(fulfilled)</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<br>			<span class="hljs-comment">// 成功值为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>		&#125;<br>		<span class="hljs-comment">// 定义reject函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_reject</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为失败</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;rejected&quot;</span>;<br>			<span class="hljs-comment">// 将result设置为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>		&#125;<br>		<span class="hljs-keyword">try</span>&#123;<br>			<span class="hljs-title function_">executor</span>(_resolve,_reject);<br>		&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>			<span class="hljs-title function_">_reject</span>(err);<span class="hljs-comment">// 状态更改为失败，值为异常信息</span><br>		&#125;<br>		<br>	&#125;<br><br>	<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>,&#123;<br>		<span class="hljs-comment">// onResolved:成功回调</span><br>		<span class="hljs-comment">// onRejected:失败回调</span><br>		<span class="hljs-title function_">then</span>(<span class="hljs-params">onResolved,onRejected</span>)&#123;<br>			<span class="hljs-comment">// 状态成功调用onResolved</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;fulfilled&quot;</span>)&#123;<br>				<span class="hljs-comment">// 异步调用</span><br>				<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>					<span class="hljs-title function_">onResolved</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>);<br>				&#125;)<br>				<br>			&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;rejected&quot;</span>)&#123;<br>				<span class="hljs-comment">// 异步调用</span><br>				<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>					<span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>);<br>				&#125;)<br>			&#125;<br>		&#125;,<br>		<span class="hljs-keyword">catch</span>()&#123;<br>		<br>		&#125;<br>	&#125;)<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-comment">// resolve(1);</span><br>    <span class="hljs-comment">// reject(2);</span><br>    <span class="hljs-keyword">throw</span> <span class="hljs-string">&quot;异常&quot;</span><br>&#125;)<br>p1.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;成功回调&quot;</span>,value);<br>&#125;,<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;失败回调&quot;</span>,reason);<br>&#125;)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;over&quot;</span>);<br></code></pre></td></tr></table></figure>

<h4 id="15-9-then函数返回的是一个Promise实例"><a href="#15-9-then函数返回的是一个Promise实例" class="headerlink" title="15.9  then函数返回的是一个Promise实例"></a>15.9  then函数返回的是一个Promise实例</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 立即调用函数的好处：可以避免对外部的变量造成污染。</span><br>(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">window</span></span>)&#123;<br>	<span class="hljs-comment">// executor是执行器函数</span><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>)&#123;<br>		<span class="hljs-comment">// 定义实例属性state,初始值为pending</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<br>		<span class="hljs-comment">// 定义实例属性result,初始值为undefined</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<br>		<span class="hljs-comment">// 定义resolve函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_resolve</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为成功(fulfilled)</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<br>			<span class="hljs-comment">// 成功值为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>		&#125;<br>		<span class="hljs-comment">// 定义reject函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_reject</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为失败</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;rejected&quot;</span>;<br>			<span class="hljs-comment">// 将result设置为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>		&#125;<br>		<span class="hljs-keyword">try</span>&#123;<br>			<span class="hljs-title function_">executor</span>(_resolve,_reject);<br>		&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>			<span class="hljs-title function_">_reject</span>(err);<span class="hljs-comment">// 状态更改为失败，值为异常信息</span><br>		&#125;<br>		<br>	&#125;<br><br>	<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>,&#123;<br>		<span class="hljs-comment">// onResolved:成功回调</span><br>		<span class="hljs-comment">// onRejected:失败回调</span><br>		<span class="hljs-title function_">then</span>(<span class="hljs-params">onResolved,onRejected</span>)&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>				<span class="hljs-comment">// 状态成功调用onResolved</span><br>				<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;fulfilled&quot;</span>)&#123;<br>					<span class="hljs-comment">// 异步调用</span><br>					<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>						<span class="hljs-title function_">onResolved</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>);<br>					&#125;)<br>					<br>				&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;rejected&quot;</span>)&#123;<br>					<span class="hljs-comment">// 异步调用</span><br>					<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>						<span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>);<br>					&#125;)<br>				&#125;<br>			&#125;)<br>			<br>		&#125;,<br>		<span class="hljs-keyword">catch</span>()&#123;<br>		<br>		&#125;<br>	&#125;)<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-comment">// resolve(1);</span><br>    <span class="hljs-comment">// reject(2);</span><br>    <span class="hljs-keyword">throw</span> <span class="hljs-string">&quot;异常&quot;</span><br>&#125;)<br><span class="hljs-keyword">const</span> p2 = p1.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;成功回调&quot;</span>,value);<br>&#125;,<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;失败回调&quot;</span>,reason);<br>&#125;)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p2);<br></code></pre></td></tr></table></figure>

<h4 id="15-10-then函数返回的Promise实例状态以及值-未优化"><a href="#15-10-then函数返回的Promise实例状态以及值-未优化" class="headerlink" title="15.10  then函数返回的Promise实例状态以及值-未优化"></a>15.10  then函数返回的Promise实例状态以及值-未优化</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * then返回的Promise实例受成功或失败回调函数返回值的影响</span><br><span class="hljs-comment"> * 1- 如果返回的是非Promise,那么p2状态为成功，值为返回值</span><br><span class="hljs-comment"> * 2- 如果返回的是Promise,那么p2状态以及值与返回的状态，值相同。</span><br><span class="hljs-comment"> * 3- 如果出现异常，那么p2状态为失败，值为异常信息。</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 立即调用函数的好处：可以避免对外部的变量造成污染。</span><br>(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">window</span></span>)&#123;<br>	<span class="hljs-comment">// executor是执行器函数</span><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>)&#123;<br>		<span class="hljs-comment">// 定义实例属性state,初始值为pending</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<br>		<span class="hljs-comment">// 定义实例属性result,初始值为undefined</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<br>		<span class="hljs-comment">// 定义resolve函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_resolve</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为成功(fulfilled)</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<br>			<span class="hljs-comment">// 成功值为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>		&#125;<br>		<span class="hljs-comment">// 定义reject函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_reject</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为失败</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;rejected&quot;</span>;<br>			<span class="hljs-comment">// 将result设置为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>		&#125;<br>		<span class="hljs-keyword">try</span>&#123;<br>			<span class="hljs-title function_">executor</span>(_resolve,_reject);<br>		&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>			<span class="hljs-title function_">_reject</span>(err);<span class="hljs-comment">// 状态更改为失败，值为异常信息</span><br>		&#125;<br>		<br>	&#125;<br><br>	<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>,&#123;<br>		<span class="hljs-comment">// onResolved:成功回调</span><br>		<span class="hljs-comment">// onRejected:失败回调</span><br>		<span class="hljs-title function_">then</span>(<span class="hljs-params">onResolved,onRejected</span>)&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>				<span class="hljs-comment">// 状态成功调用onResolved</span><br>				<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;fulfilled&quot;</span>)&#123;<br>					<span class="hljs-comment">// 异步调用</span><br>					<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>						<span class="hljs-keyword">try</span>&#123;<br>							<span class="hljs-comment">// value是成功回调的返回值</span><br>							<span class="hljs-keyword">const</span> value = <span class="hljs-title function_">onResolved</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>);<br>							<span class="hljs-comment">// 判断value是不是通过Promise实例化出来的（判断value是否为Promise实例）</span><br>							<span class="hljs-keyword">if</span>(value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>)&#123;<br>								<span class="hljs-comment">// value.then(v=&gt;&#123;</span><br>								<span class="hljs-comment">// 	// 将返回的Promise实例设置为成功，值为v</span><br>								<span class="hljs-comment">// 	resolve(v);</span><br>								<span class="hljs-comment">// &#125;,s=&gt;&#123;</span><br>								<span class="hljs-comment">// 	// 将返回的Promise实例设置为失败，值为s</span><br>								<span class="hljs-comment">// 	reject(s);</span><br>								<span class="hljs-comment">// &#125;)</span><br>								<br>								<span class="hljs-comment">// 简化：</span><br>								value.<span class="hljs-title function_">then</span>(resolve,reject)<br>							&#125;<span class="hljs-keyword">else</span>&#123;<br>								<span class="hljs-comment">// 不是Promise实例，将返回的Promise状态设置为成功，值为value</span><br>								<span class="hljs-title function_">resolve</span>(value);<br>							&#125;<br>						&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>							<span class="hljs-comment">// 有异常，将返回Promise的状态更改为失败，值为err</span><br>							<span class="hljs-title function_">reject</span>(err);<br>						&#125;<br>						<br>					&#125;)<br>					<br>				&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;rejected&quot;</span>)&#123;<br>					<span class="hljs-comment">// 异步调用</span><br>					<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>						<span class="hljs-keyword">try</span>&#123;<br>							<span class="hljs-comment">// value是失败回调的返回值</span><br>							<span class="hljs-keyword">const</span> value = <span class="hljs-title function_">onRejected</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>);<br>							<span class="hljs-comment">// value是否为Promise实例</span><br>							<span class="hljs-keyword">if</span>(value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>)&#123;<br>								<span class="hljs-comment">// 将返回Promise设置为与value相同的结果</span><br>								value.<span class="hljs-title function_">then</span>(resolve,reject);<br>							&#125;<span class="hljs-keyword">else</span>&#123;<br>								<span class="hljs-comment">// 返回成功promise,值为value</span><br>								<span class="hljs-title function_">resolve</span>(value);<br>							&#125;<br>						&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>							<span class="hljs-comment">// 返回失败promise,值为err</span><br>							<span class="hljs-title function_">reject</span>(err);<br>						&#125;<br>						<br>					&#125;)<br>				&#125;<br>			&#125;)<br>			<br>		&#125;,<br>		<span class="hljs-keyword">catch</span>()&#123;<br>		<br>		&#125;<br>	&#125;)<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-comment">// resolve(1);</span><br>    <span class="hljs-title function_">reject</span>(<span class="hljs-number">2</span>);<br>    <span class="hljs-comment">// throw &quot;异常&quot;</span><br>&#125;)<br><span class="hljs-keyword">const</span> p2 = p1.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>        <span class="hljs-comment">// resolve(100)</span><br>        <span class="hljs-comment">// reject(200)</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-string">&quot;异常2&quot;</span><br>    &#125;)<br>    <span class="hljs-comment">// return 1;</span><br>    <span class="hljs-comment">// console.log(&quot;成功回调&quot;,value);</span><br>&#125;,<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>        <span class="hljs-comment">// resolve(100);</span><br>        <span class="hljs-comment">// reject(2)</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-string">&quot;异常3&quot;</span><br>    &#125;)<br>    <span class="hljs-comment">// return 1;</span><br>    <span class="hljs-comment">// console.log(&quot;失败回调&quot;,reason);</span><br>&#125;)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p2);<br></code></pre></td></tr></table></figure>

<h4 id="15-11-then函数返回的Promise实例状态以及值-优化封装函数-common"><a href="#15-11-then函数返回的Promise实例状态以及值-优化封装函数-common" class="headerlink" title="15.11   then函数返回的Promise实例状态以及值-优化封装函数_common"></a>15.11   then函数返回的Promise实例状态以及值-优化封装函数_common</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 立即调用函数的好处：可以避免对外部的变量造成污染。</span><br>(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">window</span></span>)&#123;<br>	<span class="hljs-comment">// executor是执行器函数</span><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>)&#123;<br>		<span class="hljs-comment">// 定义实例属性state,初始值为pending</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<br>		<span class="hljs-comment">// 定义实例属性result,初始值为undefined</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<br>		<span class="hljs-comment">// 定义resolve函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_resolve</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为成功(fulfilled)</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<br>			<span class="hljs-comment">// 成功值为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>		&#125;<br>		<span class="hljs-comment">// 定义reject函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_reject</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为失败</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;rejected&quot;</span>;<br>			<span class="hljs-comment">// 将result设置为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>		&#125;<br>		<span class="hljs-keyword">try</span>&#123;<br>			<span class="hljs-title function_">executor</span>(_resolve,_reject);<br>		&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>			<span class="hljs-title function_">_reject</span>(err);<span class="hljs-comment">// 状态更改为失败，值为异常信息</span><br>		&#125;<br>		<br>	&#125;<br><br>	<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>,&#123;<br>		<span class="hljs-comment">// onResolved:成功回调</span><br>		<span class="hljs-comment">// onRejected:失败回调</span><br>		<span class="hljs-title function_">then</span>(<span class="hljs-params">onResolved,onRejected</span>)&#123;<br>			<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>				<span class="hljs-keyword">const</span> _common = <span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>)&#123;<br>					<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>						<span class="hljs-keyword">try</span>&#123;<br>							<span class="hljs-comment">// value是成功回调的返回值</span><br>							<span class="hljs-keyword">const</span> value = <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>);<br>							<span class="hljs-comment">// 判断value是不是通过Promise实例化出来的（判断value是否为Promise实例）</span><br>							<span class="hljs-keyword">if</span>(value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>)&#123;<br>								value.<span class="hljs-title function_">then</span>(resolve,reject);<br>							&#125;<span class="hljs-keyword">else</span>&#123;<br>								<span class="hljs-comment">// 不是Promise实例，将返回的Promise状态设置为成功，值为value</span><br>								<span class="hljs-title function_">resolve</span>(value);<br>							&#125;<br>						&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>							<span class="hljs-comment">// 有异常，将返回Promise的状态更改为失败，值为err</span><br>							<span class="hljs-title function_">reject</span>(err);<br>						&#125;<br>						<br>					&#125;)<br>				&#125;<br>				<span class="hljs-comment">// 状态成功调用onResolved</span><br>				<span class="hljs-comment">// p1的状态为成功</span><br>				<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;fulfilled&quot;</span>)&#123;<br>					_common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,onResolved);<br>				&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;rejected&quot;</span>)&#123;<br>					_common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,onRejected);<br>				&#125;<br>			&#125;)<br>			<br>		&#125;,<br>		<span class="hljs-keyword">catch</span>()&#123;<br>		<br>		&#125;<br>	&#125;)<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-comment">// resolve(1);</span><br>    <span class="hljs-title function_">reject</span>(<span class="hljs-number">2</span>);<br>    <span class="hljs-comment">// throw &quot;异常&quot;</span><br>&#125;)<br><span class="hljs-keyword">const</span> p2 = p1.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-comment">// return new Promise((resolve,reject)=&gt;&#123;</span><br>    <span class="hljs-comment">// 	// resolve(100)</span><br>    <span class="hljs-comment">// 	// reject(200)</span><br>    <span class="hljs-keyword">throw</span> <span class="hljs-string">&quot;异常2&quot;</span><br>    <span class="hljs-comment">// &#125;)</span><br>    <span class="hljs-comment">// return 1;</span><br>    <span class="hljs-comment">// console.log(&quot;成功回调&quot;,value);</span><br>&#125;,<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>    <span class="hljs-comment">// return new Promise((resolve,reject)=&gt;&#123;</span><br>    <span class="hljs-comment">// 	// resolve(100);</span><br>    <span class="hljs-comment">// 	// reject(2)</span><br>    <span class="hljs-comment">// 	throw &quot;异常3&quot;</span><br>    <span class="hljs-comment">// &#125;)</span><br>    <span class="hljs-comment">// return 1;</span><br>    <span class="hljs-comment">// console.log(&quot;失败回调&quot;,reason);</span><br>&#125;)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p2);<br></code></pre></td></tr></table></figure>

<h4 id="15-12-增加成功与失败回调函数的默认值"><a href="#15-12-增加成功与失败回调函数的默认值" class="headerlink" title="15.12  增加成功与失败回调函数的默认值"></a>15.12  增加成功与失败回调函数的默认值</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 1- then如果省略成功回调，默认成功回调为 value=&gt;value;</span><br><span class="hljs-comment"> * 2- then如果省略失败回调，默认失败回调为 reason=&gt;&#123;throw reason&#125;;</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 立即调用函数的好处：可以避免对外部的变量造成污染。</span><br>(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">window</span></span>)&#123;<br>	<span class="hljs-comment">// executor是执行器函数</span><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>)&#123;<br>		<span class="hljs-comment">// 定义实例属性state,初始值为pending</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<br>		<span class="hljs-comment">// 定义实例属性result,初始值为undefined</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<br>		<span class="hljs-comment">// 定义resolve函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_resolve</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为成功(fulfilled)</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<br>			<span class="hljs-comment">// 成功值为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>		&#125;<br>		<span class="hljs-comment">// 定义reject函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_reject</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为失败</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;rejected&quot;</span>;<br>			<span class="hljs-comment">// 将result设置为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>		&#125;<br>		<span class="hljs-keyword">try</span>&#123;<br>			<span class="hljs-title function_">executor</span>(_resolve,_reject);<br>		&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>			<span class="hljs-title function_">_reject</span>(err);<span class="hljs-comment">// 状态更改为失败，值为异常信息</span><br>		&#125;<br>		<br>	&#125;<br><br>	<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>,&#123;<br>		<span class="hljs-comment">// onResolved:成功回调</span><br>		<span class="hljs-comment">// onRejected:失败回调</span><br>		<span class="hljs-title function_">then</span>(<span class="hljs-params">onResolved,onRejected</span>)&#123;<br>			<span class="hljs-comment">// 如果成功回调不是函数，那么增加成功回调默认值</span><br>			<span class="hljs-keyword">if</span>(!(onResolved <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>))&#123;<br>				onResolved = <span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>value;<br>			&#125;<br>			<span class="hljs-comment">// 如果失败回调不是函数，那么增加失败回调默认值</span><br>			<span class="hljs-keyword">if</span>(!(onRejected <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>))&#123;<br>				onRejected = <span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>					<span class="hljs-keyword">throw</span> reason;<br>				&#125;;<br>			&#125;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>				<span class="hljs-keyword">const</span> _common = <span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>)&#123;<br>					<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>						<span class="hljs-keyword">try</span>&#123;<br>							<span class="hljs-comment">// value是成功回调的返回值</span><br>							<span class="hljs-keyword">const</span> value = <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>);<br>							<span class="hljs-comment">// 判断value是不是通过Promise实例化出来的（判断value是否为Promise实例）</span><br>							<span class="hljs-keyword">if</span>(value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>)&#123;<br>								value.<span class="hljs-title function_">then</span>(resolve,reject);<br>							&#125;<span class="hljs-keyword">else</span>&#123;<br>								<span class="hljs-comment">// 不是Promise实例，将返回的Promise状态设置为成功，值为value</span><br>								<span class="hljs-title function_">resolve</span>(value);<br>							&#125;<br>						&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>							<span class="hljs-comment">// 有异常，将返回Promise的状态更改为失败，值为err</span><br>							<span class="hljs-title function_">reject</span>(err);<br>						&#125;<br>						<br>					&#125;)<br>				&#125;<br>				<span class="hljs-comment">// 状态成功调用onResolved</span><br>				<span class="hljs-comment">// p1的状态为成功</span><br>				<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;fulfilled&quot;</span>)&#123;<br>					_common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,onResolved);<br>				&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;rejected&quot;</span>)&#123;<br>					_common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,onRejected);<br>				&#125;<br>			&#125;)<br>			<br>		&#125;,<br>		<span class="hljs-keyword">catch</span>()&#123;<br>		<br>		&#125;<br>	&#125;)<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>);<br>    <span class="hljs-comment">// reject(2);</span><br>&#125;)<br><span class="hljs-keyword">const</span> p2 = p1.<span class="hljs-title function_">then</span>();<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p2);<br></code></pre></td></tr></table></figure>

<h4 id="15-14-执行器函数常用于处理异步行为"><a href="#15-14-执行器函数常用于处理异步行为" class="headerlink" title="15.14   执行器函数常用于处理异步行为"></a>15.14   执行器函数常用于处理异步行为</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs js">(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">window</span></span>)&#123;<br>	<span class="hljs-comment">// executor是执行器函数</span><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>)&#123;<br>		<span class="hljs-comment">// 记录成功与失败回调函数</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span> = &#123;&#125;;<br>		<span class="hljs-comment">// 定义实例属性state,初始值为pending</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<br>		<span class="hljs-comment">// 定义实例属性result,初始值为undefined</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<br>		<span class="hljs-comment">// 定义resolve函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_resolve</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为成功(fulfilled)</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<br>			<span class="hljs-comment">// 成功值为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-property">onResolved</span>)&#123;<br>				<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">onResolved</span>();<br>			&#125;<br>		&#125;<br>		<span class="hljs-comment">// 定义reject函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_reject</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为失败</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<br>			<span class="hljs-comment">// 将result设置为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-property">onRejected</span>)&#123;<br>				<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">onRejected</span>();<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">try</span>&#123;<br>			<span class="hljs-title function_">executor</span>(_resolve,_reject);<br>		&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>			<span class="hljs-title function_">_reject</span>(err);<span class="hljs-comment">// 状态更改为失败，值为异常信息</span><br>		&#125;<br>	&#125;<br><br>	<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>,&#123;<br>		<span class="hljs-comment">// onResolved:成功回调</span><br>		<span class="hljs-comment">// onRejected:失败回调</span><br>		<span class="hljs-title function_">then</span>(<span class="hljs-params">onResolved,onRejected</span>)&#123;<br>			<span class="hljs-comment">// 如果成功回调不是函数，那么增加成功回调默认值</span><br>			<span class="hljs-keyword">if</span>(!(onResolved <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>))&#123;<br>				onResolved = <span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>value;<br>			&#125;<br>			<span class="hljs-comment">// 如果失败回调不是函数，那么增加失败回调默认值</span><br>			<span class="hljs-keyword">if</span>(!(onRejected <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>))&#123;<br>				onRejected = <span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>					<span class="hljs-keyword">throw</span> reason;<br>				&#125;;<br>			&#125;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>				<span class="hljs-keyword">const</span> _common = <span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>)&#123;<br>					<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>						<span class="hljs-keyword">try</span>&#123;<br>							<span class="hljs-comment">// value是成功回调的返回值</span><br>							<span class="hljs-keyword">const</span> value = <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>);<br>							<span class="hljs-comment">// 判断value是不是通过Promise实例化出来的（判断value是否为Promise实例）</span><br>							<span class="hljs-keyword">if</span>(value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) value.<span class="hljs-title function_">then</span>(resolve,reject);<br>							<span class="hljs-keyword">else</span>&#123;<br>								<span class="hljs-comment">// 不是Promise实例，将返回的Promise状态设置为成功，值为value</span><br>								<span class="hljs-title function_">resolve</span>(value);<br>							&#125;<br>						&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>							<span class="hljs-comment">// 有异常，将返回Promise的状态更改为失败，值为err</span><br>							<span class="hljs-title function_">reject</span>(err);<br>						&#125;<br>						<br>					&#125;)<br>				&#125;<br>				<span class="hljs-comment">// 状态成功调用onResolved</span><br>				<span class="hljs-comment">// p1的状态为成功</span><br>				<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;fulfilled&quot;</span>)&#123;<br>					_common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,onResolved);<br>				&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;rejected&quot;</span>)&#123;<br>					_common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,onRejected);<br>				&#125;<span class="hljs-keyword">else</span>&#123;<br>					<span class="hljs-comment">// pending</span><br>					<span class="hljs-comment">// 如果状态为pending,那么保存成功与失败回调</span><br>					<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span> = &#123;<br>						<span class="hljs-attr">onResolved</span>:_common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>,onResolved),<br>						<span class="hljs-attr">onRejected</span>:_common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>,onRejected)<br>					&#125;<br>				&#125;<br>			&#125;)<br>			<br>		&#125;,<br>		<span class="hljs-keyword">catch</span>()&#123;<br>		<br>		&#125;<br>	&#125;)<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>        <span class="hljs-title function_">reject</span>(<span class="hljs-number">100</span>);<br>    &#125;)<br>&#125;)<br>p1.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<br>&#125;,<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;失败&quot;</span>,reason);<br>&#125;)<br></code></pre></td></tr></table></figure>

<h4 id="15-15-可以指定多个成功或失败的回调"><a href="#15-15-可以指定多个成功或失败的回调" class="headerlink" title="15.15  可以指定多个成功或失败的回调"></a>15.15  可以指定多个成功或失败的回调</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs js">(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">window</span></span>)&#123;<br>	<span class="hljs-comment">// executor是执行器函数</span><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>)&#123;<br>		<span class="hljs-comment">// 记录成功与失败回调函数</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span> = [];<br>		<span class="hljs-comment">// 定义实例属性state,初始值为pending</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<br>		<span class="hljs-comment">// 定义实例属性result,初始值为undefined</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<br>		<span class="hljs-comment">// 定义resolve函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_resolve</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为成功(fulfilled)</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<br>			<span class="hljs-comment">// 成功值为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>&#123;<br>				item.<span class="hljs-title function_">onResolved</span>()<br>			&#125;)<br>		&#125;<br>		<span class="hljs-comment">// 定义reject函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_reject</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为失败</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<br>			<span class="hljs-comment">// 将result设置为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>&#123;<br>				item.<span class="hljs-title function_">onRejected</span>()<br>			&#125;)<br>		&#125;<br>		<span class="hljs-keyword">try</span>&#123;<br>			<span class="hljs-title function_">executor</span>(_resolve,_reject);<br>		&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>			<span class="hljs-title function_">_reject</span>(err);<span class="hljs-comment">// 状态更改为失败，值为异常信息</span><br>		&#125;<br>	&#125;<br><br>	<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>,&#123;<br>		<span class="hljs-comment">// onResolved:成功回调</span><br>		<span class="hljs-comment">// onRejected:失败回调</span><br>		<span class="hljs-title function_">then</span>(<span class="hljs-params">onResolved,onRejected</span>)&#123;<br>			<span class="hljs-comment">// 如果成功回调不是函数，那么增加成功回调默认值</span><br>			<span class="hljs-keyword">if</span>(!(onResolved <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>))&#123;<br>				onResolved = <span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>value;<br>			&#125;<br>			<span class="hljs-comment">// 如果失败回调不是函数，那么增加失败回调默认值</span><br>			<span class="hljs-keyword">if</span>(!(onRejected <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>))&#123;<br>				onRejected = <span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>					<span class="hljs-keyword">throw</span> reason;<br>				&#125;;<br>			&#125;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>				<span class="hljs-keyword">const</span> _common = <span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>)&#123;<br>					<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>						<span class="hljs-keyword">try</span>&#123;<br>							<span class="hljs-comment">// value是成功回调的返回值</span><br>							<span class="hljs-keyword">const</span> value = <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>);<br>							<span class="hljs-comment">// 判断value是不是通过Promise实例化出来的（判断value是否为Promise实例）</span><br>							<span class="hljs-keyword">if</span>(value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) value.<span class="hljs-title function_">then</span>(resolve,reject);<br>							<span class="hljs-keyword">else</span>&#123;<br>								<span class="hljs-comment">// 不是Promise实例，将返回的Promise状态设置为成功，值为value</span><br>								<span class="hljs-title function_">resolve</span>(value);<br>							&#125;<br>						&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>							<span class="hljs-comment">// 有异常，将返回Promise的状态更改为失败，值为err</span><br>							<span class="hljs-title function_">reject</span>(err);<br>						&#125;<br>						<br>					&#125;)<br>				&#125;<br>				<span class="hljs-comment">// 状态成功调用onResolved</span><br>				<span class="hljs-comment">// p1的状态为成功</span><br>				<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;fulfilled&quot;</span>)&#123;<br>					_common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,onResolved);<br>				&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;rejected&quot;</span>)&#123;<br>					_common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,onRejected);<br>				&#125;<span class="hljs-keyword">else</span>&#123;<br>					<span class="hljs-comment">// pending</span><br>					<span class="hljs-comment">// 如果状态为pending,那么保存成功与失败回调</span><br>					<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">push</span>(&#123;<br>						<span class="hljs-attr">onResolved</span>:_common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>,onResolved),<br>						<span class="hljs-attr">onRejected</span>:_common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>,onRejected)<br>					&#125;)<br>				&#125;<br>			&#125;)<br>			<br>		&#125;,<br>		<span class="hljs-keyword">catch</span>()&#123;<br>		<br>		&#125;<br>	&#125;)<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 可以指定多个成功或失败的回调</span><br><span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>        <span class="hljs-title function_">reject</span>(<span class="hljs-number">100</span>);<br>    &#125;)<br>&#125;)<br>p1.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;成功1&quot;</span>,value);<br>&#125;,<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;失败1&quot;</span>,reason);<br>&#125;)<br>p1.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;成功2&quot;</span>,value);<br>&#125;,<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;失败2&quot;</span>,reason);<br>&#125;)<br>p1.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;成功3&quot;</span>,value);<br>&#125;,<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;失败3&quot;</span>,reason);<br>&#125;)<br>p1.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;成功4&quot;</span>,value);<br>&#125;,<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;失败4&quot;</span>,reason);<br>&#125;)<br></code></pre></td></tr></table></figure>

<h4 id="15-16-catch"><a href="#15-16-catch" class="headerlink" title="15.16  catch"></a>15.16  catch</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs js">(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">window</span></span>)&#123;<br>	<span class="hljs-comment">// executor是执行器函数</span><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>)&#123;<br>		<span class="hljs-comment">// 记录成功与失败回调函数</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span> = [];<br>		<span class="hljs-comment">// 定义实例属性state,初始值为pending</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<br>		<span class="hljs-comment">// 定义实例属性result,初始值为undefined</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<br>		<span class="hljs-comment">// 定义resolve函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_resolve</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为成功(fulfilled)</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<br>			<span class="hljs-comment">// 成功值为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>&#123;<br>				item.<span class="hljs-title function_">onResolved</span>()<br>			&#125;)<br>		&#125;<br>		<span class="hljs-comment">// 定义reject函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_reject</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为失败</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<br>			<span class="hljs-comment">// 将result设置为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>&#123;<br>				item.<span class="hljs-title function_">onRejected</span>()<br>			&#125;)<br>		&#125;<br>		<span class="hljs-keyword">try</span>&#123;<br>			<span class="hljs-title function_">executor</span>(_resolve,_reject);<br>		&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>			<span class="hljs-title function_">_reject</span>(err);<span class="hljs-comment">// 状态更改为失败，值为异常信息</span><br>		&#125;<br>	&#125;<br><br>	<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>,&#123;<br>		<span class="hljs-comment">// onResolved:成功回调</span><br>		<span class="hljs-comment">// onRejected:失败回调</span><br>		<span class="hljs-title function_">then</span>(<span class="hljs-params">onResolved,onRejected</span>)&#123;<br>			<span class="hljs-comment">// 如果成功回调不是函数，那么增加成功回调默认值</span><br>			<span class="hljs-keyword">if</span>(!(onResolved <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>))&#123;<br>				onResolved = <span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>value;<br>			&#125;<br>			<span class="hljs-comment">// 如果失败回调不是函数，那么增加失败回调默认值</span><br>			<span class="hljs-keyword">if</span>(!(onRejected <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>))&#123;<br>				onRejected = <span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>					<span class="hljs-keyword">throw</span> reason;<br>				&#125;;<br>			&#125;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>				<span class="hljs-keyword">const</span> _common = <span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>)&#123;<br>					<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>						<span class="hljs-keyword">try</span>&#123;<br>							<span class="hljs-comment">// value是成功回调的返回值</span><br>							<span class="hljs-keyword">const</span> value = <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>);<br>							<span class="hljs-comment">// 判断value是不是通过Promise实例化出来的（判断value是否为Promise实例）</span><br>							<span class="hljs-keyword">if</span>(value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) value.<span class="hljs-title function_">then</span>(resolve,reject);<br>							<span class="hljs-keyword">else</span>&#123;<br>								<span class="hljs-comment">// 不是Promise实例，将返回的Promise状态设置为成功，值为value</span><br>								<span class="hljs-title function_">resolve</span>(value);<br>							&#125;<br>						&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>							<span class="hljs-comment">// 有异常，将返回Promise的状态更改为失败，值为err</span><br>							<span class="hljs-title function_">reject</span>(err);<br>						&#125;<br>						<br>					&#125;)<br>				&#125;<br>				<span class="hljs-comment">// 状态成功调用onResolved</span><br>				<span class="hljs-comment">// p1的状态为成功</span><br>				<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;fulfilled&quot;</span>)&#123;<br>					_common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,onResolved);<br>				&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;rejected&quot;</span>)&#123;<br>					_common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,onRejected);<br>				&#125;<span class="hljs-keyword">else</span>&#123;<br>					<span class="hljs-comment">// pending</span><br>					<span class="hljs-comment">// 如果状态为pending,那么保存成功与失败回调</span><br>					<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">push</span>(&#123;<br>						<span class="hljs-attr">onResolved</span>:_common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>,onResolved),<br>						<span class="hljs-attr">onRejected</span>:_common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>,onRejected)<br>					&#125;)<br>				&#125;<br>			&#125;)<br>			<br>		&#125;,<br>		<span class="hljs-keyword">catch</span>(onRejected)&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(<span class="hljs-literal">undefined</span>,onRejected)<br>		&#125;<br>	&#125;)<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 可以指定多个成功或失败的回调</span><br><span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>        <span class="hljs-title function_">reject</span>(<span class="hljs-number">100</span>);<br>    &#125;)<br>&#125;)<br><span class="hljs-comment">// p1.then(undefined,reason=&gt;&#123;</span><br><span class="hljs-comment">// 	console.log(reason);</span><br><span class="hljs-comment">// &#125;)</span><br><span class="hljs-comment">// catch的返回值是Promise实例,实例的属性与值取决于回调函数的返回值</span><br><span class="hljs-comment">// 返回值为非Promise实例，那么得到的状态为成功，值为返回值</span><br><span class="hljs-comment">// 返回值为Promise实例，那么得到的结果与返回的结果相同。</span><br><span class="hljs-comment">// 有异常，那么得到的状态为失败，值为异常信息。</span><br><span class="hljs-keyword">const</span> p2 = p1.<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>    <span class="hljs-comment">// console.log(reason);</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-number">2</span>);<br>    &#125;)<br>    <span class="hljs-comment">// throw &quot;异常&quot;</span><br>&#125;)<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p2);<br></code></pre></td></tr></table></figure>

<h4 id="15-17-链式调用支持"><a href="#15-17-链式调用支持" class="headerlink" title="15.17  链式调用支持"></a>15.17  链式调用支持</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs js">(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">window</span></span>)&#123;<br>	<span class="hljs-comment">// executor是执行器函数</span><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>)&#123;<br>		<span class="hljs-comment">// 记录成功与失败回调函数</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span> = [];<br>		<span class="hljs-comment">// 定义实例属性state,初始值为pending</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<br>		<span class="hljs-comment">// 定义实例属性result,初始值为undefined</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<br>		<span class="hljs-comment">// 定义resolve函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_resolve</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为成功(fulfilled)</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<br>			<span class="hljs-comment">// 成功值为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>&#123;<br>				item.<span class="hljs-title function_">onResolved</span>()<br>			&#125;)<br>		&#125;<br>		<span class="hljs-comment">// 定义reject函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_reject</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为失败</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;rejected&quot;</span>;<br>			<span class="hljs-comment">// 将result设置为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>&#123;<br>				item.<span class="hljs-title function_">onRejected</span>()<br>			&#125;)<br>		&#125;<br>		<span class="hljs-keyword">try</span>&#123;<br>			<span class="hljs-title function_">executor</span>(_resolve,_reject);<br>		&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>			<span class="hljs-title function_">_reject</span>(err);<span class="hljs-comment">// 状态更改为失败，值为异常信息</span><br>		&#125;<br>	&#125;<br><br>	<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>,&#123;<br>		<span class="hljs-comment">// onResolved:成功回调</span><br>		<span class="hljs-comment">// onRejected:失败回调</span><br>		<span class="hljs-title function_">then</span>(<span class="hljs-params">onResolved,onRejected</span>)&#123;<br>			<span class="hljs-comment">// 如果成功回调不是函数，那么增加成功回调默认值</span><br>			<span class="hljs-keyword">if</span>(!(onResolved <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>))&#123;<br>				onResolved = <span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>value;<br>			&#125;<br>			<span class="hljs-comment">// 如果失败回调不是函数，那么增加失败回调默认值</span><br>			<span class="hljs-keyword">if</span>(!(onRejected <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>))&#123;<br>				onRejected = <span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>					<span class="hljs-keyword">throw</span> reason;<br>				&#125;;<br>			&#125;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>				<span class="hljs-keyword">const</span> _common = <span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>)&#123;<br>					<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>						<span class="hljs-keyword">try</span>&#123;<br>							<span class="hljs-comment">// value是成功回调的返回值</span><br>							<span class="hljs-keyword">const</span> value = <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>);<br>							<span class="hljs-comment">// 判断value是不是通过Promise实例化出来的（判断value是否为Promise实例）</span><br>							<span class="hljs-keyword">if</span>(value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) value.<span class="hljs-title function_">then</span>(resolve,reject);<br>							<span class="hljs-keyword">else</span>&#123;<br>								<span class="hljs-comment">// 不是Promise实例，将返回的Promise状态设置为成功，值为value</span><br>								<span class="hljs-title function_">resolve</span>(value);<br>							&#125;<br>						&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>							<span class="hljs-comment">// 有异常，将返回Promise的状态更改为失败，值为err</span><br>							<span class="hljs-title function_">reject</span>(err);<br>						&#125;<br>						<br>					&#125;)<br>				&#125;<br>				<span class="hljs-comment">// 状态成功调用onResolved</span><br>				<span class="hljs-comment">// p1的状态为成功</span><br>				<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;fulfilled&quot;</span>)&#123;<br>					_common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,onResolved);<br>				&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;rejected&quot;</span>)&#123;<br>					_common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,onRejected);<br>				&#125;<span class="hljs-keyword">else</span>&#123;<br>					<span class="hljs-comment">// pending</span><br>					<span class="hljs-comment">// 如果状态为pending,那么保存成功与失败回调</span><br>					<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">push</span>(&#123;<br>						<span class="hljs-attr">onResolved</span>:_common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>,onResolved),<br>						<span class="hljs-attr">onRejected</span>:_common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>,onRejected)<br>					&#125;)<br>				&#125;<br>			&#125;)<br>			<br>		&#125;,<br>		<span class="hljs-keyword">catch</span>(onRejected)&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(<span class="hljs-literal">undefined</span>,onRejected)<br>		&#125;<br>	&#125;)<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>);<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<span class="hljs-comment">// 1</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<span class="hljs-comment">// 2</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<span class="hljs-comment">// 3</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>;<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<span class="hljs-comment">// 4</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>;<br>&#125;)<br></code></pre></td></tr></table></figure>

<h4 id="15-18-异常穿透支持"><a href="#15-18-异常穿透支持" class="headerlink" title="15.18   异常穿透支持"></a>15.18   异常穿透支持</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs js">(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">window</span></span>)&#123;<br>	<span class="hljs-comment">// executor是执行器函数</span><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>)&#123;<br>		<span class="hljs-comment">// 记录成功与失败回调函数</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span> = [];<br>		<span class="hljs-comment">// 定义实例属性state,初始值为pending</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<br>		<span class="hljs-comment">// 定义实例属性result,初始值为undefined</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<br>		<span class="hljs-comment">// 定义resolve函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_resolve</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为成功(fulfilled)</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<br>			<span class="hljs-comment">// 成功值为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>&#123;<br>				item.<span class="hljs-title function_">onResolved</span>()<br>			&#125;)<br>		&#125;<br>		<span class="hljs-comment">// 定义reject函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_reject</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为失败</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;rejected&quot;</span>;<br>			<span class="hljs-comment">// 将result设置为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>&#123;<br>				item.<span class="hljs-title function_">onRejected</span>()<br>			&#125;)<br>		&#125;<br>		<span class="hljs-keyword">try</span>&#123;<br>			<span class="hljs-title function_">executor</span>(_resolve,_reject);<br>		&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>			<span class="hljs-title function_">_reject</span>(err);<span class="hljs-comment">// 状态更改为失败，值为异常信息</span><br>		&#125;<br>	&#125;<br><br>	<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>,&#123;<br>		<span class="hljs-comment">// onResolved:成功回调</span><br>		<span class="hljs-comment">// onRejected:失败回调</span><br>		<span class="hljs-title function_">then</span>(<span class="hljs-params">onResolved,onRejected</span>)&#123;<br>			<span class="hljs-comment">// 如果成功回调不是函数，那么增加成功回调默认值</span><br>			<span class="hljs-keyword">if</span>(!(onResolved <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>))&#123;<br>				onResolved = <span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>value;<br>			&#125;<br>			<span class="hljs-comment">// 如果失败回调不是函数，那么增加失败回调默认值</span><br>			<span class="hljs-keyword">if</span>(!(onRejected <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>))&#123;<br>				onRejected = <span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>					<span class="hljs-keyword">throw</span> reason;<br>				&#125;;<br>			&#125;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>				<span class="hljs-keyword">const</span> _common = <span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>)&#123;<br>					<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>						<span class="hljs-keyword">try</span>&#123;<br>							<span class="hljs-comment">// value是成功回调的返回值</span><br>							<span class="hljs-keyword">const</span> value = <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>);<br>							<span class="hljs-comment">// 判断value是不是通过Promise实例化出来的（判断value是否为Promise实例）</span><br>							<span class="hljs-keyword">if</span>(value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) value.<span class="hljs-title function_">then</span>(resolve,reject);<br>							<span class="hljs-keyword">else</span>&#123;<br>								<span class="hljs-comment">// 不是Promise实例，将返回的Promise状态设置为成功，值为value</span><br>								<span class="hljs-title function_">resolve</span>(value);<br>							&#125;<br>						&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>							<span class="hljs-comment">// 有异常，将返回Promise的状态更改为失败，值为err</span><br>							<span class="hljs-title function_">reject</span>(err);<br>						&#125;<br>						<br>					&#125;)<br>				&#125;<br>				<span class="hljs-comment">// 状态成功调用onResolved</span><br>				<span class="hljs-comment">// p1的状态为成功</span><br>				<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;fulfilled&quot;</span>)&#123;<br>					_common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,onResolved);<br>				&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;rejected&quot;</span>)&#123;<br>					_common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,onRejected);<br>				&#125;<span class="hljs-keyword">else</span>&#123;<br>					<span class="hljs-comment">// pending</span><br>					<span class="hljs-comment">// 如果状态为pending,那么保存成功与失败回调</span><br>					<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">push</span>(&#123;<br>						<span class="hljs-attr">onResolved</span>:_common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>,onResolved),<br>						<span class="hljs-attr">onRejected</span>:_common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>,onRejected)<br>					&#125;)<br>				&#125;<br>			&#125;)<br>			<br>		&#125;,<br>		<span class="hljs-keyword">catch</span>(onRejected)&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(<span class="hljs-literal">undefined</span>,onRejected)<br>		&#125;<br>	&#125;)<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>    <span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>);<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">throw</span> <span class="hljs-string">&quot;异常&quot;</span><br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<span class="hljs-comment">// 3</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>;<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<span class="hljs-comment">// 4</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>;<br>&#125;).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">4</span>,reason);<br>&#125;)<br></code></pre></td></tr></table></figure>

<h4 id="15-19-中断Promise链"><a href="#15-19-中断Promise链" class="headerlink" title="15.19   中断Promise链"></a>15.19   中断Promise链</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs js">(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">window</span></span>)&#123;<br>	<span class="hljs-comment">// executor是执行器函数</span><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>)&#123;<br>		<span class="hljs-comment">// 记录成功与失败回调函数</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span> = [];<br>		<span class="hljs-comment">// 定义实例属性state,初始值为pending</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<br>		<span class="hljs-comment">// 定义实例属性result,初始值为undefined</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<br>		<span class="hljs-comment">// 定义resolve函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_resolve</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为成功(fulfilled)</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<br>			<span class="hljs-comment">// 成功值为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>&#123;<br>				item.<span class="hljs-title function_">onResolved</span>()<br>			&#125;)<br>		&#125;<br>		<span class="hljs-comment">// 定义reject函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_reject</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为失败</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;rejected&quot;</span>;<br>			<span class="hljs-comment">// 将result设置为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>&#123;<br>				item.<span class="hljs-title function_">onRejected</span>()<br>			&#125;)<br>		&#125;<br>		<span class="hljs-keyword">try</span>&#123;<br>			<span class="hljs-title function_">executor</span>(_resolve,_reject);<br>		&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>			<span class="hljs-title function_">_reject</span>(err);<span class="hljs-comment">// 状态更改为失败，值为异常信息</span><br>		&#125;<br>	&#125;<br><br>	<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>,&#123;<br>		<span class="hljs-comment">// onResolved:成功回调</span><br>		<span class="hljs-comment">// onRejected:失败回调</span><br>		<span class="hljs-title function_">then</span>(<span class="hljs-params">onResolved,onRejected</span>)&#123;<br>			<span class="hljs-comment">// 如果成功回调不是函数，那么增加成功回调默认值</span><br>			<span class="hljs-keyword">if</span>(!(onResolved <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>))&#123;<br>				onResolved = <span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>value;<br>			&#125;<br>			<span class="hljs-comment">// 如果失败回调不是函数，那么增加失败回调默认值</span><br>			<span class="hljs-keyword">if</span>(!(onRejected <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>))&#123;<br>				onRejected = <span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>					<span class="hljs-keyword">throw</span> reason;<br>				&#125;;<br>			&#125;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>				<span class="hljs-keyword">const</span> _common = <span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>)&#123;<br>					<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>						<span class="hljs-keyword">try</span>&#123;<br>							<span class="hljs-comment">// value是成功回调的返回值</span><br>							<span class="hljs-keyword">const</span> value = <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>);<br>							<span class="hljs-comment">// 判断value是不是通过Promise实例化出来的（判断value是否为Promise实例）</span><br>							<span class="hljs-keyword">if</span>(value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) value.<span class="hljs-title function_">then</span>(resolve,reject);<br>							<span class="hljs-keyword">else</span>&#123;<br>								<span class="hljs-comment">// 不是Promise实例，将返回的Promise状态设置为成功，值为value</span><br>								<span class="hljs-title function_">resolve</span>(value);<br>							&#125;<br>						&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>							<span class="hljs-comment">// 有异常，将返回Promise的状态更改为失败，值为err</span><br>							<span class="hljs-title function_">reject</span>(err);<br>						&#125;<br>						<br>					&#125;)<br>				&#125;<br>				<span class="hljs-comment">// 状态成功调用onResolved</span><br>				<span class="hljs-comment">// p1的状态为成功</span><br>				<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;fulfilled&quot;</span>)&#123;<br>					_common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,onResolved);<br>				&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;rejected&quot;</span>)&#123;<br>					_common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,onRejected);<br>				&#125;<span class="hljs-keyword">else</span>&#123;<br>					<span class="hljs-comment">// pending</span><br>					<span class="hljs-comment">// 如果状态为pending,那么保存成功与失败回调</span><br>					<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">push</span>(&#123;<br>						<span class="hljs-attr">onResolved</span>:_common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>,onResolved),<br>						<span class="hljs-attr">onRejected</span>:_common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>,onRejected)<br>					&#125;)<br>				&#125;<br>			&#125;)<br>			<br>		&#125;,<br>		<span class="hljs-keyword">catch</span>(onRejected)&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(<span class="hljs-literal">undefined</span>,onRejected)<br>		&#125;<br>	&#125;)<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>);<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<span class="hljs-comment">// 1</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<span class="hljs-comment">// 2</span><br>    <span class="hljs-comment">// 在回调函数中返回一个`pendding`状态的promise对象</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">()=&gt;</span>&#123;&#125;)<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<span class="hljs-comment">// undefined</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>;<br>&#125;).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value);<span class="hljs-comment">// 4</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>;<br>&#125;)<br></code></pre></td></tr></table></figure>

<h4 id="15-20-resolve"><a href="#15-20-resolve" class="headerlink" title="15.20  resolve"></a>15.20  resolve</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs js">(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">window</span></span>)&#123;<br>	<span class="hljs-comment">// executor是执行器函数</span><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>)&#123;<br>		<span class="hljs-comment">// 记录成功与失败回调函数</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span> = [];<br>		<span class="hljs-comment">// 定义实例属性state,初始值为pending</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<br>		<span class="hljs-comment">// 定义实例属性result,初始值为undefined</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<br>		<span class="hljs-comment">// 定义resolve函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_resolve</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为成功(fulfilled)</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<br>			<span class="hljs-comment">// 成功值为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>&#123;<br>				item.<span class="hljs-title function_">onResolved</span>()<br>			&#125;)<br>		&#125;<br>		<span class="hljs-comment">// 定义reject函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_reject</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为失败</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;rejected&quot;</span>;<br>			<span class="hljs-comment">// 将result设置为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>&#123;<br>				item.<span class="hljs-title function_">onRejected</span>()<br>			&#125;)<br>		&#125;<br>		<span class="hljs-keyword">try</span>&#123;<br>			<span class="hljs-title function_">executor</span>(_resolve,_reject);<br>		&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>			<span class="hljs-title function_">_reject</span>(err);<span class="hljs-comment">// 状态更改为失败，值为异常信息</span><br>		&#125;<br>	&#125;<br><br>	<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>,&#123;<br>		<span class="hljs-comment">// onResolved:成功回调</span><br>		<span class="hljs-comment">// onRejected:失败回调</span><br>		<span class="hljs-title function_">then</span>(<span class="hljs-params">onResolved,onRejected</span>)&#123;<br>			<span class="hljs-comment">// 如果成功回调不是函数，那么增加成功回调默认值</span><br>			<span class="hljs-keyword">if</span>(!(onResolved <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>))&#123;<br>				onResolved = <span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>value;<br>			&#125;<br>			<span class="hljs-comment">// 如果失败回调不是函数，那么增加失败回调默认值</span><br>			<span class="hljs-keyword">if</span>(!(onRejected <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>))&#123;<br>				onRejected = <span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>					<span class="hljs-keyword">throw</span> reason;<br>				&#125;;<br>			&#125;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>				<span class="hljs-keyword">const</span> _common = <span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>)&#123;<br>					<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>						<span class="hljs-keyword">try</span>&#123;<br>							<span class="hljs-comment">// value是成功回调的返回值</span><br>							<span class="hljs-keyword">const</span> value = <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>);<br>							<span class="hljs-comment">// 判断value是不是通过Promise实例化出来的（判断value是否为Promise实例）</span><br>							<span class="hljs-keyword">if</span>(value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) value.<span class="hljs-title function_">then</span>(resolve,reject);<br>							<span class="hljs-keyword">else</span>&#123;<br>								<span class="hljs-comment">// 不是Promise实例，将返回的Promise状态设置为成功，值为value</span><br>								<span class="hljs-title function_">resolve</span>(value);<br>							&#125;<br>						&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>							<span class="hljs-comment">// 有异常，将返回Promise的状态更改为失败，值为err</span><br>							<span class="hljs-title function_">reject</span>(err);<br>						&#125;<br>						<br>					&#125;)<br>				&#125;<br>				<span class="hljs-comment">// 状态成功调用onResolved</span><br>				<span class="hljs-comment">// p1的状态为成功</span><br>				<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;fulfilled&quot;</span>)&#123;<br>					_common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,onResolved);<br>				&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;rejected&quot;</span>)&#123;<br>					_common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,onRejected);<br>				&#125;<span class="hljs-keyword">else</span>&#123;<br>					<span class="hljs-comment">// pending</span><br>					<span class="hljs-comment">// 如果状态为pending,那么保存成功与失败回调</span><br>					<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">push</span>(&#123;<br>						<span class="hljs-attr">onResolved</span>:_common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>,onResolved),<br>						<span class="hljs-attr">onRejected</span>:_common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>,onRejected)<br>					&#125;)<br>				&#125;<br>			&#125;)<br>			<br>		&#125;,<br>		<span class="hljs-keyword">catch</span>(onRejected)&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(<span class="hljs-literal">undefined</span>,onRejected)<br>		&#125;<br>	&#125;)<br>	<span class="hljs-title class_">Promise</span>.<span class="hljs-property">resolve</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>)&#123;<br>		<span class="hljs-keyword">if</span>(value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>)&#123;<br>			<span class="hljs-keyword">return</span> value;<span class="hljs-comment">// 如果是Promise实例直接返回</span><br>		&#125;<span class="hljs-keyword">else</span>&#123;<br>			<span class="hljs-comment">// 如果不是Promise实例，那么返回的状态为成功，值为value</span><br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span>=&gt;</span>&#123;<br>				<span class="hljs-title function_">resolve</span>(value);<br>			&#125;)<br>		&#125;<br>	&#125;<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// const p1 = Promise.resolve(1);</span><br><span class="hljs-comment">// console.log(p1);</span><br><br><span class="hljs-comment">// const p1 = Promise.resolve(new Promise((resolve,reject)=&gt;&#123;</span><br><span class="hljs-comment">// 	resolve(2);</span><br><span class="hljs-comment">// &#125;));</span><br><span class="hljs-comment">// console.log(p1);</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// const p1 = Promise.resolve(new Promise((resolve,reject)=&gt;&#123;</span><br><span class="hljs-comment">// 	reject(2);</span><br><span class="hljs-comment">// &#125;));</span><br><span class="hljs-comment">// console.log(p1);</span><br><br><br><span class="hljs-keyword">const</span> p =<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-title function_">reject</span>(<span class="hljs-number">2</span>);<br>&#125;)<br><span class="hljs-keyword">const</span> p1 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(p);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p1===p);<br></code></pre></td></tr></table></figure>

<h4 id="15-21-reject"><a href="#15-21-reject" class="headerlink" title="15.21  reject"></a>15.21  reject</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs js">(<span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">window</span></span>)&#123;<br>	<span class="hljs-comment">// executor是执行器函数</span><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>)&#123;<br>		<span class="hljs-comment">// 记录成功与失败回调函数</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span> = [];<br>		<span class="hljs-comment">// 定义实例属性state,初始值为pending</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<br>		<span class="hljs-comment">// 定义实例属性result,初始值为undefined</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<br>		<span class="hljs-comment">// 定义resolve函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_resolve</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为成功(fulfilled)</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<br>			<span class="hljs-comment">// 成功值为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>&#123;<br>				item.<span class="hljs-title function_">onResolved</span>()<br>			&#125;)<br>		&#125;<br>		<span class="hljs-comment">// 定义reject函数</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_reject</span> = value=&gt;&#123;<br>			<span class="hljs-comment">// 当状态已经被更改过，不允许再次更改</span><br>			<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-comment">// 将状态更改为失败</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;rejected&quot;</span>;<br>			<span class="hljs-comment">// 将result设置为value</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>&#123;<br>				item.<span class="hljs-title function_">onRejected</span>()<br>			&#125;)<br>		&#125;<br>		<span class="hljs-keyword">try</span>&#123;<br>			<span class="hljs-title function_">executor</span>(_resolve,_reject);<br>		&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>			<span class="hljs-title function_">_reject</span>(err);<span class="hljs-comment">// 状态更改为失败，值为异常信息</span><br>		&#125;<br>	&#125;<br><br>	<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>,&#123;<br>		<span class="hljs-comment">// onResolved:成功回调</span><br>		<span class="hljs-comment">// onRejected:失败回调</span><br>		<span class="hljs-title function_">then</span>(<span class="hljs-params">onResolved,onRejected</span>)&#123;<br>			<span class="hljs-comment">// 如果成功回调不是函数，那么增加成功回调默认值</span><br>			<span class="hljs-keyword">if</span>(!(onResolved <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>))&#123;<br>				onResolved = <span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>value;<br>			&#125;<br>			<span class="hljs-comment">// 如果失败回调不是函数，那么增加失败回调默认值</span><br>			<span class="hljs-keyword">if</span>(!(onRejected <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>))&#123;<br>				onRejected = <span class="hljs-function"><span class="hljs-params">reason</span>=&gt;</span>&#123;<br>					<span class="hljs-keyword">throw</span> reason;<br>				&#125;;<br>			&#125;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>				<span class="hljs-keyword">const</span> _common = <span class="hljs-keyword">function</span>(<span class="hljs-params">callback</span>)&#123;<br>					<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>						<span class="hljs-keyword">try</span>&#123;<br>							<span class="hljs-comment">// value是成功回调的返回值</span><br>							<span class="hljs-keyword">const</span> value = <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>);<br>							<span class="hljs-comment">// 判断value是不是通过Promise实例化出来的（判断value是否为Promise实例）</span><br>							<span class="hljs-keyword">if</span>(value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) value.<span class="hljs-title function_">then</span>(resolve,reject);<br>							<span class="hljs-keyword">else</span>&#123;<br>								<span class="hljs-comment">// 不是Promise实例，将返回的Promise状态设置为成功，值为value</span><br>								<span class="hljs-title function_">resolve</span>(value);<br>							&#125;<br>						&#125;<span class="hljs-keyword">catch</span> (err)&#123;<br>							<span class="hljs-comment">// 有异常，将返回Promise的状态更改为失败，值为err</span><br>							<span class="hljs-title function_">reject</span>(err);<br>						&#125;<br>						<br>					&#125;)<br>				&#125;<br>				<span class="hljs-comment">// 状态成功调用onResolved</span><br>				<span class="hljs-comment">// p1的状态为成功</span><br>				<span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;fulfilled&quot;</span>)&#123;<br>					_common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,onResolved);<br>				&#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;rejected&quot;</span>)&#123;<br>					_common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>,onRejected);<br>				&#125;<span class="hljs-keyword">else</span>&#123;<br>					<span class="hljs-comment">// pending</span><br>					<span class="hljs-comment">// 如果状态为pending,那么保存成功与失败回调</span><br>					<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">push</span>(&#123;<br>						<span class="hljs-attr">onResolved</span>:_common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>,onResolved),<br>						<span class="hljs-attr">onRejected</span>:_common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>,onRejected)<br>					&#125;)<br>				&#125;<br>			&#125;)<br>			<br>		&#125;,<br>		<span class="hljs-keyword">catch</span>(onRejected)&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(<span class="hljs-literal">undefined</span>,onRejected)<br>		&#125;<br>	&#125;)<br>	<span class="hljs-title class_">Promise</span>.<span class="hljs-property">resolve</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>)&#123;<br>		<span class="hljs-keyword">if</span>(value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>)&#123;<br>			<span class="hljs-keyword">return</span> value;<span class="hljs-comment">// 如果是Promise实例直接返回</span><br>		&#125;<span class="hljs-keyword">else</span>&#123;<br>			<span class="hljs-comment">// 如果不是Promise实例，那么返回的状态为成功，值为value</span><br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span>=&gt;</span>&#123;<br>				<span class="hljs-title function_">resolve</span>(value);<br>			&#125;)<br>		&#125;<br>	&#125;<br>	<span class="hljs-title class_">Promise</span>.<span class="hljs-property">reject</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>)&#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>			<span class="hljs-title function_">reject</span>(value);<br>		&#125;)<br>	&#125;<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p1 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-number">1</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p1);<br><br><span class="hljs-keyword">const</span> p2 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-title function_">resolve</span>(<span class="hljs-number">2</span>);<br>&#125;));<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p2);<br><br><span class="hljs-keyword">const</span> p3 = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-title function_">reject</span>(<span class="hljs-number">2</span>);<br>&#125;));<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p3);<br></code></pre></td></tr></table></figure>

<h4 id="15-22-完成all"><a href="#15-22-完成all" class="headerlink" title="15.22 完成all"></a>15.22 完成all</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs js">(<span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable language_">window</span></span>) &#123;<br>	<span class="hljs-comment">// 接收执行器函数(executor)，执行器函数会同步执行（立即执行）。</span><br>	<span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>) &#123;<br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<span class="hljs-comment">// 初始状态</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<span class="hljs-comment">// 初始值</span><br>		<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span> = [];<br>		<span class="hljs-comment">// _resolve函数将状态更新为成功，成功值为接收的value</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_resolve</span> = value =&gt; &#123;<br>			<span class="hljs-comment">// 如果状态已经更改，直接跳出函数体</span><br>			<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<span class="hljs-comment">// 状态更新为成功</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<span class="hljs-comment">// 更新成功值</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>&#123;<br>				item.<span class="hljs-title function_">onResolved</span>();<br>			&#125;)<br>		&#125;<br>		<span class="hljs-comment">// _reject函数将状态更新为失败，失败值为接收的value</span><br>		<span class="hljs-keyword">const</span> <span class="hljs-title function_">_reject</span> = value =&gt; &#123;<br>			<span class="hljs-comment">// 如果状态已经更改，直接跳出函数体</span><br>			<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;rejected&quot;</span>;<span class="hljs-comment">// 状态更新为失败</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<span class="hljs-comment">// 更新失败值</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>&#123;<br>				item.<span class="hljs-title function_">onRejected</span>();<br>			&#125;)<br>		&#125;<br>		<span class="hljs-keyword">try</span> &#123;<br>			<span class="hljs-title function_">executor</span>(_resolve, _reject);<br>		&#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>			<span class="hljs-comment">// 如果有异常，将状态更新为失败，失败的值为异常信息</span><br>			<span class="hljs-title function_">_reject</span>(err);<br>		&#125;<br>	&#125;<br>	<br>	<span class="hljs-comment">// 将第二个参数（对象）合并至Promise.prototype对象中。</span><br>	<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>, &#123;<br>		<span class="hljs-comment">// 1- 接收成功与失败回调函数</span><br>		<span class="hljs-comment">// 2- 返回的是一个Promise实例</span><br>		<span class="hljs-comment">// 3- onResolved成功回调，默认值为value=&gt;value;</span><br>		<span class="hljs-comment">// 4- onRejected失败回调，默认值为reason=&gt;&#123;throw reason&#125;;</span><br>		<span class="hljs-title function_">then</span>(<span class="hljs-params">onResolved, onRejected</span>) &#123;<br>			<span class="hljs-comment">// onResolved成功回调，默认值为value=&gt;value;</span><br>			<span class="hljs-keyword">if</span> (!(onResolved <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>)) onResolved = <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> value;<br>			<span class="hljs-comment">//onRejected失败回调，默认值为reason=&gt;&#123;throw reason&#125;;</span><br>			<span class="hljs-keyword">if</span> (!(onRejected <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>)) onRejected = <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>				<span class="hljs-keyword">throw</span> reason<br>			&#125;;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>				<span class="hljs-comment">// callback是成功或失败回调</span><br>				<span class="hljs-keyword">const</span> _common = <span class="hljs-keyword">function</span> (<span class="hljs-params">callback</span>) &#123;<br>					<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>						<span class="hljs-keyword">try</span> &#123;<br>							<span class="hljs-comment">// value是成功回调返回结果</span><br>							<span class="hljs-keyword">const</span> value = <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>);<br>							<span class="hljs-comment">// 判断是否为Promise实例</span><br>							<span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) &#123;<br>								value.<span class="hljs-title function_">then</span>(resolve, reject);<br>							&#125; <span class="hljs-keyword">else</span> &#123;<br>								<span class="hljs-comment">// 非Promise实例</span><br>								<span class="hljs-title function_">resolve</span>(value);<br>							&#125;<br>						&#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>							<span class="hljs-title function_">reject</span>(err);<br>						&#125;<br>					&#125;)<br>					<br>				&#125;<br>				<span class="hljs-comment">// 判断状态为成功，调用成功回调</span><br>				<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;fulfilled&quot;</span>) _common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, onResolved);<br>				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;rejected&quot;</span>) _common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, onRejected);<br>				<span class="hljs-keyword">else</span> &#123;<br>					<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">push</span>(&#123;<br>						<span class="hljs-attr">onResolved</span>: _common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>, onResolved),<br>						<span class="hljs-attr">onRejected</span>: _common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>, onRejected)<br>					&#125;)<br>				&#125;<br>			&#125;)<br>		&#125;,<br>		<span class="hljs-keyword">catch</span>(onRejected)&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(<span class="hljs-literal">undefined</span>,onRejected);<br>		&#125;<br>	&#125;)<br>	<span class="hljs-title class_">Promise</span>.<span class="hljs-property">resolve</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>)&#123;<br>		<span class="hljs-comment">// 判断接收的参数是否为Promise实例，如果是直接返回</span><br>		<span class="hljs-keyword">if</span>(value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>)&#123;<br>			<span class="hljs-keyword">return</span> value;<br>		&#125;<span class="hljs-keyword">else</span>&#123;<br>			<span class="hljs-comment">// 如果不是，创建一个新的Promise,状态为成功，值为value;</span><br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span>=&gt;</span>&#123;<br>				<span class="hljs-title function_">resolve</span>(value);<br>			&#125;)<br>		&#125;<br>	&#125;<br>	<span class="hljs-title class_">Promise</span>.<span class="hljs-property">reject</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>)&#123;<br>		<span class="hljs-comment">// 返回失败的Promise,失败值为接收的value</span><br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>			<span class="hljs-title function_">reject</span>(value);<br>		&#125;)<br>	&#125;<br>	<span class="hljs-comment">// 1- 接收的是数组，返回的是Promise</span><br>	<span class="hljs-title class_">Promise</span>.<span class="hljs-property">all</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">promiseArr</span>)&#123;<br>		<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">let</span> successArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(promiseArr.<span class="hljs-property">length</span>);<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>			promiseArr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">value,i</span>)=&gt;</span>&#123;<br>				value.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">v</span>=&gt;</span>&#123;<br>					index++;<br>					successArr[i] = v;<br>					<span class="hljs-keyword">if</span>(index === promiseArr.<span class="hljs-property">length</span>)&#123;<br>						<span class="hljs-title function_">resolve</span>(successArr);<br>					&#125;<br>				&#125;,<span class="hljs-function"><span class="hljs-params">s</span>=&gt;</span>&#123;<br>					<span class="hljs-comment">// 返回Promise的状态设置失败</span><br>					<span class="hljs-title function_">reject</span>(s);<br>				&#125;)<br>			&#125;)<br>		&#125;)<br>	&#125;<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-number">100</span>)<br>    &#125;,<span class="hljs-number">100</span>)<br>&#125;)<br><span class="hljs-keyword">const</span> p2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-number">200</span>)<br>    &#125;,<span class="hljs-number">50</span>)<br>&#125;)<br><span class="hljs-keyword">const</span> p3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-number">300</span>)<br>    &#125;,<span class="hljs-number">200</span>)<br>&#125;)<br><span class="hljs-keyword">const</span> p4 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-number">400</span>)<br>    &#125;,<span class="hljs-number">100</span>)<br>&#125;)<br><span class="hljs-comment">// all接收的数组中的元素是Promise实例。</span><br><span class="hljs-comment">// 元素中的Promise实例都成功，p的状态为成功，值为数组，数组的元素为成功值</span><br><span class="hljs-comment">// 元素中有一个失败，那么p的状态为失败，值为失败值</span><br><span class="hljs-keyword">const</span> p = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([p1,p2,p3,p4]);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p);<br></code></pre></td></tr></table></figure>

<h4 id="15-23-完成race"><a href="#15-23-完成race" class="headerlink" title="15.23 完成race"></a>15.23 完成race</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs js">(<span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable language_">window</span></span>) &#123;<br>    <span class="hljs-comment">// 接收执行器函数(executor)，执行器函数会同步执行（立即执行）。</span><br>    <span class="hljs-keyword">function</span> <span class="hljs-title function_">Promise</span>(<span class="hljs-params">executor</span>) &#123;<br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<span class="hljs-comment">// 初始状态</span><br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<span class="hljs-comment">// 初始值</span><br>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span> = [];<br>        <span class="hljs-comment">// _resolve函数将状态更新为成功，成功值为接收的value</span><br>        <span class="hljs-keyword">const</span> <span class="hljs-title function_">_resolve</span> = value =&gt; &#123;<br>            <span class="hljs-comment">// 如果状态已经更改，直接跳出函数体</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<span class="hljs-comment">// 状态更新为成功</span><br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<span class="hljs-comment">// 更新成功值</span><br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>&#123;<br>                item.<span class="hljs-title function_">onResolved</span>();<br>            &#125;)<br>        &#125;<br>        <span class="hljs-comment">// _reject函数将状态更新为失败，失败值为接收的value</span><br>        <span class="hljs-keyword">const</span> <span class="hljs-title function_">_reject</span> = value =&gt; &#123;<br>            <span class="hljs-comment">// 如果状态已经更改，直接跳出函数体</span><br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;rejected&quot;</span>;<span class="hljs-comment">// 状态更新为失败</span><br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<span class="hljs-comment">// 更新失败值</span><br>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>&#123;<br>                item.<span class="hljs-title function_">onRejected</span>();<br>            &#125;)<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-title function_">executor</span>(_resolve, _reject);<br>        &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>            <span class="hljs-comment">// 如果有异常，将状态更新为失败，失败的值为异常信息</span><br>            <span class="hljs-title function_">_reject</span>(err);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 将第二个参数（对象）合并至Promise.prototype对象中。</span><br>    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>, &#123;<br>        <span class="hljs-comment">// 1- 接收成功与失败回调函数</span><br>        <span class="hljs-comment">// 2- 返回的是一个Promise实例</span><br>        <span class="hljs-comment">// 3- onResolved成功回调，默认值为value=&gt;value;</span><br>        <span class="hljs-comment">// 4- onRejected失败回调，默认值为reason=&gt;&#123;throw reason&#125;;</span><br>        <span class="hljs-title function_">then</span>(<span class="hljs-params">onResolved, onRejected</span>) &#123;<br>            <span class="hljs-comment">// onResolved成功回调，默认值为value=&gt;value;</span><br>            <span class="hljs-keyword">if</span> (!(onResolved <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>)) onResolved = <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> value;<br>            <span class="hljs-comment">//onRejected失败回调，默认值为reason=&gt;&#123;throw reason&#125;;</span><br>            <span class="hljs-keyword">if</span> (!(onRejected <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>)) onRejected = <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>                <span class="hljs-keyword">throw</span> reason<br>            &#125;;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>                <span class="hljs-comment">// callback是成功或失败回调</span><br>                <span class="hljs-keyword">const</span> _common = <span class="hljs-keyword">function</span> (<span class="hljs-params">callback</span>) &#123;<br>                    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>                        <span class="hljs-keyword">try</span> &#123;<br>                            <span class="hljs-comment">// value是成功回调返回结果</span><br>                            <span class="hljs-keyword">const</span> value = <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>);<br>                            <span class="hljs-comment">// 判断是否为Promise实例</span><br>                            <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) &#123;<br>                                value.<span class="hljs-title function_">then</span>(resolve, reject);<br>                            &#125; <span class="hljs-keyword">else</span> &#123;<br>                                <span class="hljs-comment">// 非Promise实例</span><br>                                <span class="hljs-title function_">resolve</span>(value);<br>                            &#125;<br>                        &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>                            <span class="hljs-title function_">reject</span>(err);<br>                        &#125;<br>                    &#125;)<br><br>                &#125;<br>                <span class="hljs-comment">// 判断状态为成功，调用成功回调</span><br>                <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;fulfilled&quot;</span>) _common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, onResolved);<br>                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;rejected&quot;</span>) _common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, onRejected);<br>                <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">push</span>(&#123;<br>                        <span class="hljs-attr">onResolved</span>: _common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>, onResolved),<br>                        <span class="hljs-attr">onRejected</span>: _common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>, onRejected)<br>                    &#125;)<br>                &#125;<br>            &#125;)<br>        &#125;,<br>        <span class="hljs-keyword">catch</span>(onRejected)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(<span class="hljs-literal">undefined</span>,onRejected);<br>        &#125;<br>    &#125;)<br>    <span class="hljs-title class_">Promise</span>.<span class="hljs-property">resolve</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>)&#123;<br>        <span class="hljs-comment">// 判断接收的参数是否为Promise实例，如果是直接返回</span><br>        <span class="hljs-keyword">if</span>(value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>)&#123;<br>            <span class="hljs-keyword">return</span> value;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-comment">// 如果不是，创建一个新的Promise,状态为成功，值为value;</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span>=&gt;</span>&#123;<br>                <span class="hljs-title function_">resolve</span>(value);<br>            &#125;)<br>        &#125;<br>    &#125;<br>    <span class="hljs-title class_">Promise</span>.<span class="hljs-property">reject</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>)&#123;<br>        <span class="hljs-comment">// 返回失败的Promise,失败值为接收的value</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>            <span class="hljs-title function_">reject</span>(value);<br>        &#125;)<br>    &#125;<br>    <span class="hljs-comment">// 1- 接收的是数组，返回的是Promise</span><br>    <span class="hljs-title class_">Promise</span>.<span class="hljs-property">all</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">promiseArr</span>)&#123;<br>        <span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">let</span> successArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(promiseArr.<span class="hljs-property">length</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>            promiseArr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">value,i</span>)=&gt;</span>&#123;<br>                value.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">v</span>=&gt;</span>&#123;<br>                    index++;<br>                    successArr[i] = v;<br>                    <span class="hljs-keyword">if</span>(index === promiseArr.<span class="hljs-property">length</span>)&#123;<br>                        <span class="hljs-title function_">resolve</span>(successArr);<br>                    &#125;<br>                &#125;,<span class="hljs-function"><span class="hljs-params">s</span>=&gt;</span>&#123;<br>                    <span class="hljs-comment">// 返回Promise的状态设置失败</span><br>                    <span class="hljs-title function_">reject</span>(s);<br>                &#125;)<br>            &#125;)<br>        &#125;)<br>    &#125;<br>    <span class="hljs-title class_">Promise</span>.<span class="hljs-property">race</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">promiseArr</span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>            promiseArr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>                <span class="hljs-comment">// value.then(v=&gt;&#123;</span><br>                <span class="hljs-comment">// 	resolve(v);</span><br>                <span class="hljs-comment">// &#125;,s=&gt;&#123;</span><br>                <span class="hljs-comment">// 	reject(s);</span><br>                <span class="hljs-comment">// &#125;)</span><br>                value.<span class="hljs-title function_">then</span>(resolve,reject);<br>            &#125;)<br>        &#125;)<br>    &#125;<br>    <span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-number">100</span>)<br>    &#125;,<span class="hljs-number">100</span>)<br>&#125;)<br><span class="hljs-keyword">const</span> p2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>        <span class="hljs-title function_">reject</span>(<span class="hljs-number">200</span>)<br>    &#125;,<span class="hljs-number">50</span>)<br>&#125;)<br><span class="hljs-keyword">const</span> p3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-number">300</span>)<br>    &#125;,<span class="hljs-number">200</span>)<br>&#125;)<br><span class="hljs-keyword">const</span> p4 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-number">400</span>)<br>    &#125;,<span class="hljs-number">100</span>)<br>&#125;)<br><span class="hljs-comment">// race:返回的是Promise实例，谁先执行完就与谁的状态以及值相同。</span><br><span class="hljs-keyword">const</span> p = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([p1,p2,p3,p4]);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p);<br></code></pre></td></tr></table></figure>

<h4 id="15-24-class版本实现Promise"><a href="#15-24-class版本实现Promise" class="headerlink" title="15.24 class版本实现Promise"></a>15.24 class版本实现Promise</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><code class="hljs js">(<span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-variable language_">window</span></span>) &#123;<br>	<span class="hljs-comment">// 1-将之前构造函数体内的语句放置到constructor函数中</span><br>	<span class="hljs-comment">// 2-将之前prototype的属性直接放置到Promise中</span><br>	<span class="hljs-keyword">class</span> <span class="hljs-title class_">Promise</span>&#123;<br>		<span class="hljs-keyword">static</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-params">value</span>)&#123;<br>			<span class="hljs-comment">// 判断接收的参数是否为Promise实例，如果是直接返回</span><br>			<span class="hljs-keyword">if</span>(value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>)&#123;<br>				<span class="hljs-keyword">return</span> value;<br>			&#125;<span class="hljs-keyword">else</span>&#123;<br>				<span class="hljs-comment">// 如果不是，创建一个新的Promise,状态为成功，值为value;</span><br>				<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span>=&gt;</span>&#123;<br>					<span class="hljs-title function_">resolve</span>(value);<br>				&#125;)<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">static</span> <span class="hljs-title function_">reject</span>(<span class="hljs-params">value</span>)&#123;<br>			<span class="hljs-comment">// 返回失败的Promise,失败值为接收的value</span><br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>				<span class="hljs-title function_">reject</span>(value);<br>			&#125;)<br>		&#125;<br>		<span class="hljs-keyword">static</span> <span class="hljs-title function_">all</span>(<span class="hljs-params">promiseArr</span>)&#123;<br>			<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;<br>			<span class="hljs-keyword">let</span> successArr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(promiseArr.<span class="hljs-property">length</span>);<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>				promiseArr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">value,i</span>)=&gt;</span>&#123;<br>					value.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">v</span>=&gt;</span>&#123;<br>						index++;<br>						successArr[i] = v;<br>						<span class="hljs-keyword">if</span>(index === promiseArr.<span class="hljs-property">length</span>)&#123;<br>							<span class="hljs-title function_">resolve</span>(successArr);<br>						&#125;<br>					&#125;,<span class="hljs-function"><span class="hljs-params">s</span>=&gt;</span>&#123;<br>						<span class="hljs-comment">// 返回Promise的状态设置失败</span><br>						<span class="hljs-title function_">reject</span>(s);<br>					&#125;)<br>				&#125;)<br>			&#125;)<br>		&#125;<br>		<span class="hljs-keyword">static</span> <span class="hljs-title function_">race</span>(<span class="hljs-params">promiseArr</span>)&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>				promiseArr.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">value</span>=&gt;</span>&#123;<br>					<span class="hljs-comment">// value.then(v=&gt;&#123;</span><br>					<span class="hljs-comment">// 	resolve(v);</span><br>					<span class="hljs-comment">// &#125;,s=&gt;&#123;</span><br>					<span class="hljs-comment">// 	reject(s);</span><br>					<span class="hljs-comment">// &#125;)</span><br>					value.<span class="hljs-title function_">then</span>(resolve,reject);<br>				&#125;)<br>			&#125;)<br>		&#125;<br>		<span class="hljs-title function_">constructor</span>(<span class="hljs-params">executor</span>) &#123;<br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;pending&quot;</span>;<span class="hljs-comment">// 初始状态</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-literal">undefined</span>;<span class="hljs-comment">// 初始值</span><br>			<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span> = [];<br>			<span class="hljs-comment">// _resolve函数将状态更新为成功，成功值为接收的value</span><br>			<span class="hljs-keyword">const</span> <span class="hljs-title function_">_resolve</span> = value =&gt; &#123;<br>				<span class="hljs-comment">// 如果状态已经更改，直接跳出函数体</span><br>				<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>				<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;fulfilled&quot;</span>;<span class="hljs-comment">// 状态更新为成功</span><br>				<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<span class="hljs-comment">// 更新成功值</span><br>				<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>&#123;<br>					item.<span class="hljs-title function_">onResolved</span>();<br>				&#125;)<br>			&#125;<br>			<span class="hljs-comment">// _reject函数将状态更新为失败，失败值为接收的value</span><br>			<span class="hljs-keyword">const</span> <span class="hljs-title function_">_reject</span> = value =&gt; &#123;<br>				<span class="hljs-comment">// 如果状态已经更改，直接跳出函数体</span><br>				<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> !== <span class="hljs-string">&quot;pending&quot;</span>) <span class="hljs-keyword">return</span>;<br>				<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = <span class="hljs-string">&quot;rejected&quot;</span>;<span class="hljs-comment">// 状态更新为失败</span><br>				<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = value;<span class="hljs-comment">// 更新失败值</span><br>				<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span>=&gt;</span>&#123;<br>					item.<span class="hljs-title function_">onRejected</span>();<br>				&#125;)<br>			&#125;<br>			<span class="hljs-keyword">try</span> &#123;<br>				<span class="hljs-title function_">executor</span>(_resolve, _reject);<br>			&#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>				<span class="hljs-comment">// 如果有异常，将状态更新为失败，失败的值为异常信息</span><br>				<span class="hljs-title function_">_reject</span>(err);<br>			&#125;<br>		&#125;<br>		<span class="hljs-title function_">then</span>(<span class="hljs-params">onResolved, onRejected</span>) &#123;<br>			<span class="hljs-comment">// onResolved成功回调，默认值为value=&gt;value;</span><br>			<span class="hljs-keyword">if</span> (!(onResolved <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>)) onResolved = <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> value;<br>			<span class="hljs-comment">//onRejected失败回调，默认值为reason=&gt;&#123;throw reason&#125;;</span><br>			<span class="hljs-keyword">if</span> (!(onRejected <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Function</span>)) onRejected = <span class="hljs-function"><span class="hljs-params">reason</span> =&gt;</span> &#123;<br>				<span class="hljs-keyword">throw</span> reason<br>			&#125;;<br>			<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> &#123;<br>				<span class="hljs-comment">// callback是成功或失败回调</span><br>				<span class="hljs-keyword">const</span> _common = <span class="hljs-keyword">function</span> (<span class="hljs-params">callback</span>) &#123;<br>					<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>						<span class="hljs-keyword">try</span> &#123;<br>							<span class="hljs-comment">// value是成功回调返回结果</span><br>							<span class="hljs-keyword">const</span> value = <span class="hljs-title function_">callback</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span>);<br>							<span class="hljs-comment">// 判断是否为Promise实例</span><br>							<span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Promise</span>) &#123;<br>								value.<span class="hljs-title function_">then</span>(resolve, reject);<br>							&#125; <span class="hljs-keyword">else</span> &#123;<br>								<span class="hljs-comment">// 非Promise实例</span><br>								<span class="hljs-title function_">resolve</span>(value);<br>							&#125;<br>						&#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>							<span class="hljs-title function_">reject</span>(err);<br>						&#125;<br>					&#125;)<br>					<br>				&#125;<br>				<span class="hljs-comment">// 判断状态为成功，调用成功回调</span><br>				<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;fulfilled&quot;</span>) _common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, onResolved);<br>				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> === <span class="hljs-string">&quot;rejected&quot;</span>) _common.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, onRejected);<br>				<span class="hljs-keyword">else</span> &#123;<br>					<span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackFn</span>.<span class="hljs-title function_">push</span>(&#123;<br>						<span class="hljs-attr">onResolved</span>: _common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>, onResolved),<br>						<span class="hljs-attr">onRejected</span>: _common.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>, onRejected)<br>					&#125;)<br>				&#125;<br>			&#125;)<br>		&#125;<br>		<span class="hljs-keyword">catch</span>(onRejected)&#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">then</span>(<span class="hljs-literal">undefined</span>,onRejected);<br>		&#125;<br>	&#125;<br>	<span class="hljs-variable language_">window</span>.<span class="hljs-property">Promise</span> = <span class="hljs-title class_">Promise</span>;<br>&#125;)(<span class="hljs-variable language_">window</span>);<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-number">100</span>)<br>    &#125;,<span class="hljs-number">100</span>)<br>&#125;)<br><span class="hljs-keyword">const</span> p2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>        <span class="hljs-title function_">reject</span>(<span class="hljs-number">200</span>)<br>    &#125;,<span class="hljs-number">50</span>)<br>&#125;)<br><span class="hljs-keyword">const</span> p3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-number">300</span>)<br>    &#125;,<span class="hljs-number">200</span>)<br>&#125;)<br><span class="hljs-keyword">const</span> p4 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve,reject</span>)=&gt;</span>&#123;<br>    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span>&#123;<br>        <span class="hljs-title function_">resolve</span>(<span class="hljs-number">400</span>)<br>    &#125;,<span class="hljs-number">100</span>)<br>&#125;)<br><span class="hljs-comment">// race:返回的是Promise实例，谁先执行完就与谁的状态以及值相同。</span><br><span class="hljs-keyword">const</span> p = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([p1,p2,p3,p4]);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p);<br></code></pre></td></tr></table></figure>

<h1 id="Express-Web服务"><a href="#Express-Web服务" class="headerlink" title="Express(Web服务)"></a>Express(Web服务)</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://express.js.cn/">Express - Node.js Web 应用程序框架 - Express.js 框架</a></p>
</blockquote>
<h2 id="什么是Express"><a href="#什么是Express" class="headerlink" title="什么是Express"></a>什么是Express</h2><p><strong>Express</strong> 是一个基于 <strong>Node.js</strong> 的轻量级 Web 应用框架，用于构建 Web 服务和 API。</p>
<p>它提供了一个简单而灵活的方式来：</p>
<ul>
<li>处理 HTTP 请求和响应</li>
<li>定义路由规则</li>
<li>使用中间件进行功能扩展</li>
</ul>
<p>Node.js 负责运行 JavaScript 并处理底层 HTTP，而Express在http模块上封装一层API，使得Web服务和处理 HTTP 请求更加高效。</p>
<h3 id="【核心特点】"><a href="#【核心特点】" class="headerlink" title="【核心特点】"></a>【核心特点】</h3><ol>
<li><strong>轻量 &amp; 灵活</strong><ul>
<li>不像 Django、Rails 那样自带庞大功能，只提供核心 Web 处理能力</li>
<li>想要什么功能用中间件扩展即可</li>
</ul>
</li>
<li><strong>路由系统强大</strong><ul>
<li>方便定义不同 URL 对应的处理逻辑</li>
<li>支持 RESTful API 风格</li>
</ul>
</li>
<li><strong>中间件机制</strong><ul>
<li>核心思想：请求进来时可以经过一系列处理器（中间件），每个处理器做自己的事</li>
<li>比如日志记录、解析 JSON、权限校验、错误处理等</li>
</ul>
</li>
<li><strong>支持多种模板引擎</strong><ul>
<li>例如 EJS、Pug（原 Jade）、Handlebars 等</li>
</ul>
</li>
<li><strong>与 Node.js 原生 HTTP 完全兼容</strong><ul>
<li>底层还是 Node.js 的 <code>http</code> 模块</li>
</ul>
</li>
</ol>
<h2 id="Express-基础用法"><a href="#Express-基础用法" class="headerlink" title="Express 基础用法"></a>Express 基础用法</h2><p><strong>安装：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install express<br></code></pre></td></tr></table></figure>

<p><strong>最小示例：</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><br><span class="hljs-comment">// 定义一个 GET 路由</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Hello Express!&#x27;</span>);<br>&#125;);<br><br><span class="hljs-comment">// 启动服务器</span><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Server running on http://localhost:3000&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure>

<p>然后在浏览器就可以访问 <a target="_blank" rel="noopener" href="http://127.0.0.1:3000/">http://127.0.0.1:3000/</a></p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs crmsh"><span class="hljs-keyword">node</span> <span class="hljs-title">&lt;文件名&gt;</span><br><span class="hljs-title"># 或者</span><br><span class="hljs-title">nodemon</span> <span class="hljs-tag">&lt;文件名&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="【Express-的运行流程】"><a href="#【Express-的运行流程】" class="headerlink" title="【Express 的运行流程】"></a>【Express 的运行流程】</h3><ol>
<li><strong>客户端发送请求</strong>（浏览器、Postman、其他服务）</li>
<li><strong>Express 应用接收请求</strong></li>
<li><strong>依次执行匹配的中间件</strong></li>
<li><strong>路由匹配</strong></li>
<li><strong>执行对应的处理函数</strong></li>
<li><strong>返回响应给客户端</strong></li>
</ol>
<h2 id="Express-路由"><a href="#Express-路由" class="headerlink" title="Express 路由"></a><strong>Express</strong> <strong>路由</strong></h2><blockquote>
<p>官方定义： 路由确定了应用程序如何响应客户端对特定端点的请求</p>
</blockquote>
<h3 id="【路由的使用】"><a href="#【路由的使用】" class="headerlink" title="【路由的使用】"></a>【路由的使用】</h3><p>一个路由由 <strong>请求方法</strong>、<strong>路径</strong> 和 <strong>回调函数</strong> 三部分组成：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">app.&lt;method&gt;(path, callback)<br></code></pre></td></tr></table></figure>

<ul>
<li><strong>method</strong>：HTTP 方法（<code>get</code>、<code>post</code>、<code>all</code> 等）</li>
<li><strong>path</strong>：URL 路径</li>
<li><strong>callback</strong>：处理请求的函数 <code>(req, res) =&gt; &#123; ... &#125;</code></li>
</ul>
<p><strong>示例：</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 导入 express</span><br><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-comment">// 创建应用对象</span><br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><br><span class="hljs-comment">// GET 路由</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/home&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;网站首页&#x27;</span>);<br>&#125;);<br><br><span class="hljs-comment">// 首页路由</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;我才是真正的首页&#x27;</span>);<br>&#125;);<br><br><span class="hljs-comment">// POST 路由</span><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;登录成功&#x27;</span>);<br>&#125;);<br><br><span class="hljs-comment">// 匹配所有请求方法</span><br>app.<span class="hljs-title function_">all</span>(<span class="hljs-string">&#x27;/search&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;1 秒钟为您找到相关结果约 100,000,000 个&#x27;</span>);<br>&#125;);<br><br><span class="hljs-comment">// 启动服务</span><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;服务已经启动, 端口监听为 3000...&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure>

<h3 id="【获取请求参数】"><a href="#【获取请求参数】" class="headerlink" title="【获取请求参数】"></a>【获取请求参数】</h3><p>Express 提供了便捷的 API 获取请求报文中的数据，同时兼容原生 HTTP 获取方式。</p>
<p><strong>示例：</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/request&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// 原生 HTTP 获取方式</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">method</span>);       <span class="hljs-comment">// 请求方法</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">url</span>);          <span class="hljs-comment">// URL</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">httpVersion</span>);  <span class="hljs-comment">// HTTP 协议版本</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">headers</span>);      <span class="hljs-comment">// 请求头对象</span><br><br>  <span class="hljs-comment">// Express 独有方式</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">query</span>);        <span class="hljs-comment">// 查询字符串对象（重要）</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;host&#x27;</span>));  <span class="hljs-comment">// 获取指定请求头</span><br><br>  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;请求报文的获取&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>API</th>
<th>类型</th>
<th>说明</th>
<th>示例值</th>
</tr>
</thead>
<tbody><tr>
<td><strong>req.method</strong></td>
<td>属性</td>
<td>获取请求方法（大写）</td>
<td><code>&quot;GET&quot;</code></td>
</tr>
<tr>
<td><strong>req.url</strong></td>
<td>属性</td>
<td>获取请求路径和查询字符串（原始）</td>
<td><code>&quot;/user?id=1&quot;</code></td>
</tr>
<tr>
<td><strong>req.httpVersion</strong></td>
<td>属性</td>
<td>获取 HTTP 协议版本</td>
<td><code>&quot;1.1&quot;</code></td>
</tr>
<tr>
<td><strong>req.headers</strong></td>
<td>对象</td>
<td>获取所有请求头</td>
<td><code>&#123; host: &#39;localhost:3000&#39;, ... &#125;</code></td>
</tr>
<tr>
<td><strong>req.get(name)</strong></td>
<td>方法</td>
<td>获取指定请求头（不区分大小写）</td>
<td><code>req.get(&#39;Host&#39;)</code> → <code>&quot;localhost:3000&quot;</code></td>
</tr>
<tr>
<td><strong>req.query</strong></td>
<td>对象</td>
<td>获取查询字符串参数（URL <code>?</code> 之后的部分）</td>
<td><code>/search?key=abc</code> → <code>&#123; key: &quot;abc&quot; &#125;</code></td>
</tr>
<tr>
<td><strong>req.params</strong></td>
<td>对象</td>
<td>获取路由参数（路径中声明的 <code>:name</code>）</td>
<td><code>/user/:id</code> 访问 <code>/user/100</code> → <code>&#123; id: &quot;100&quot; &#125;</code></td>
</tr>
<tr>
<td><strong>req.body</strong></td>
<td>对象</td>
<td>获取请求体数据（需配合 <code>express.json()</code> 或 <code>express.urlencoded()</code> 中间件）</td>
<td><code>&#123; username: &quot;tom&quot;, password: &quot;123&quot; &#125;</code></td>
</tr>
<tr>
<td><strong>req.path</strong></td>
<td>属性</td>
<td>获取 URL 路径（不含查询字符串）</td>
<td><code>&quot;/user&quot;</code></td>
</tr>
<tr>
<td><strong>req.hostname</strong></td>
<td>属性</td>
<td>获取主机名（不包含端口）</td>
<td><code>&quot;localhost&quot;</code></td>
</tr>
<tr>
<td><strong>req.ip</strong></td>
<td>属性</td>
<td>获取客户端 IP 地址</td>
<td><code>&quot;127.0.0.1&quot;</code></td>
</tr>
<tr>
<td><strong>req.protocol</strong></td>
<td>属性</td>
<td>获取协议</td>
<td><code>&quot;http&quot;</code></td>
</tr>
<tr>
<td><strong>req.secure</strong></td>
<td>属性</td>
<td>判断是否为 HTTPS 请求</td>
<td><code>false</code></td>
</tr>
</tbody></table>
<h3 id="【获取路由参数】"><a href="#【获取路由参数】" class="headerlink" title="【获取路由参数】"></a>【获取路由参数】</h3><p>路由参数是 URL 路径中以冒号（<code>:</code>）声明的部分，用来传递数据。</p>
<p><strong>示例：</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/:id.html&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;商品详情, 商品 id 为 &#x27;</span> + req.<span class="hljs-property">params</span>.<span class="hljs-property">id</span>);<br>&#125;);<br></code></pre></td></tr></table></figure>

<h3 id="【响应设置】"><a href="#【响应设置】" class="headerlink" title="【响应设置】"></a>【响应设置】</h3><p>express 框架封装了一些 API 来方便给客户端响应数据，并且兼容原生 HTTP 模块的获取方式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 导入 express</span><br><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><br><span class="hljs-comment">// 1. 基本文本响应</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/text&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;这是一个普通的文本响应&#x27;</span>);<br>&#125;);<br><br><span class="hljs-comment">// 2. JSON 响应</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/json&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;张三&#x27;</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">18</span> &#125;);<br>&#125;);<br><br><span class="hljs-comment">// 3. 设置状态码 + 发送内容</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/status&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;页面未找到&#x27;</span>);<br>&#125;);<br><br><span class="hljs-comment">// 4. 设置响应头</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/header&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;Custom-Header&#x27;</span>, <span class="hljs-string">&#x27;HelloHeader&#x27;</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;已设置自定义响应头&#x27;</span>);<br>&#125;);<br><br><span class="hljs-comment">// 5. 链式调用（状态码 + 响应头 + 内容）</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/chain&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">201</span>)<br>     .<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;X-Powered-By&#x27;</span>, <span class="hljs-string">&#x27;Express&#x27;</span>)<br>     .<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;链式调用响应成功&#x27;</span>);<br>&#125;);<br><br><span class="hljs-comment">// 6. 重定向</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/redirect&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">redirect</span>(<span class="hljs-string">&#x27;https://www.baidu.com&#x27;</span>);<br>&#125;);<br><br><span class="hljs-comment">// 7. 文件下载</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/download&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">download</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;package.json&#x27;</span>)); <br>&#125;);<br><br><span class="hljs-comment">// 8. 发送文件内容</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/file&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">sendFile</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;home.html&#x27;</span>));<br>&#125;);<br><br><span class="hljs-comment">// 9. 自定义 404 响应（放在最后）</span><br>app.<span class="hljs-title function_">all</span>(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">404</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;&lt;h1&gt;404 Not Found&lt;/h1&gt;&#x27;</span>);<br>&#125;);<br><br><span class="hljs-comment">// 启动服务器</span><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;服务器已启动：http://localhost:3000&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>API</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>res.send()</code></td>
<td>发送文本 &#x2F; HTML &#x2F; Buffer &#x2F; JSON（自动识别类型）</td>
</tr>
<tr>
<td><code>res.json()</code></td>
<td>发送 JSON 数据</td>
</tr>
<tr>
<td><code>res.status(code)</code></td>
<td>设置 HTTP 状态码</td>
</tr>
<tr>
<td><code>res.set(header, value)</code></td>
<td>设置响应头</td>
</tr>
<tr>
<td><code>res.redirect(url)</code></td>
<td>重定向到新 URL</td>
</tr>
<tr>
<td><code>res.download(filePath)</code></td>
<td>提示客户端下载文件</td>
</tr>
<tr>
<td><code>res.sendFile(filePath)</code></td>
<td>直接返回文件内容</td>
</tr>
<tr>
<td><code>res.redirect(path)</code></td>
<td>路由重定向</td>
</tr>
</tbody></table>
<h2 id="Express-中间件"><a href="#Express-中间件" class="headerlink" title="Express 中间件"></a>Express 中间件</h2><h3 id="【什么是中间件？】"><a href="#【什么是中间件？】" class="headerlink" title="【什么是中间件？】"></a>【什么是中间件？】</h3><p><strong>中间件（Middleware）</strong> 是 Express 中处理请求和响应过程的函数。<br> 它本质上就是一个函数，可以：</p>
<ul>
<li>访问 <code>req</code>（请求对象）</li>
<li>访问 <code>res</code>（响应对象）</li>
<li>调用 <code>next()</code> 把控制权交给下一个中间件</li>
<li>结束请求-响应流程</li>
</ul>
<p><strong>基本格式</strong>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">middleware</span>(<span class="hljs-params">req, res, next</span>) &#123;<br>  <span class="hljs-comment">// 执行一些操作...</span><br>  <span class="hljs-title function_">next</span>(); <span class="hljs-comment">// 交给下一个中间件</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="【中间件分类】"><a href="#【中间件分类】" class="headerlink" title="【中间件分类】"></a>【中间件分类】</h3><table>
<thead>
<tr>
<th>类型</th>
<th>作用</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td><strong>应用级中间件</strong></td>
<td>绑定到 <code>app</code> 实例，处理所有或特定路由的请求</td>
<td>用 <code>app.use()</code> 或 <code>app.METHOD()</code> 定义</td>
</tr>
<tr>
<td><strong>路由级中间件</strong></td>
<td>绑定到 <code>express.Router()</code> 实例，只作用于该路由</td>
<td>用 <code>router.use()</code> 或 <code>router.METHOD()</code> 定义</td>
</tr>
<tr>
<td><strong>内置中间件</strong></td>
<td>Express 内置的功能（解析 JSON、静态资源等）</td>
<td>不需要额外安装</td>
</tr>
<tr>
<td><strong>第三方中间件</strong></td>
<td>由社区提供，增强功能</td>
<td>需要 <code>npm install</code> 安装</td>
</tr>
<tr>
<td><strong>错误处理中间件</strong></td>
<td>捕获和处理错误</td>
<td>格式特殊：有 <strong>4 个参数</strong> <code>(err, req, res, next)</code></td>
</tr>
</tbody></table>
<h3 id="【常见中间件用法】"><a href="#【常见中间件用法】" class="headerlink" title="【常见中间件用法】"></a>【常见中间件用法】</h3><h4 id="1-应用级中间件"><a href="#1-应用级中间件" class="headerlink" title="1.应用级中间件"></a>1.应用级中间件</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><br><span class="hljs-comment">// 全局中间件（所有请求都会经过）</span><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;全局中间件：&#x27;</span>, req.<span class="hljs-property">method</span>, req.<span class="hljs-property">url</span>);<br>  <span class="hljs-title function_">next</span>();<br>&#125;);<br><br><span class="hljs-comment">// 针对特定路由的中间件</span><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;/user&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;访问了 /user 路由&#x27;</span>);<br>  <span class="hljs-title function_">next</span>();<br>&#125;);<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;首页&#x27;</span>));<br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/user&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;用户中心&#x27;</span>));<br><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>);<br></code></pre></td></tr></table></figure>

<h4 id="2-路由级中间件"><a href="#2-路由级中间件" class="headerlink" title="2.路由级中间件"></a>2.路由级中间件</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> router = express.<span class="hljs-title class_">Router</span>();<br><br><span class="hljs-comment">// 路由专用中间件</span><br>router.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;进入路由模块&#x27;</span>);<br>  <span class="hljs-title function_">next</span>();<br>&#125;);<br><br>router.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/list&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;用户列表&#x27;</span>));<br>router.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/detail&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;用户详情&#x27;</span>));<br><br><span class="hljs-comment">// 挂载到 app</span><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;/user&#x27;</span>, router);<br></code></pre></td></tr></table></figure>

<ul>
<li>实际路由为<code>/user/list</code>和<code>/user/detail</code>，中间件也只以<code>/use</code>为根路由下的子路由生效。</li>
</ul>
<h4 id="3-内置中间件"><a href="#3-内置中间件" class="headerlink" title="3.内置中间件"></a>3.内置中间件</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 解析 JSON 请求体</span><br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>());<br><br><span class="hljs-comment">// 解析 URL-encoded 表单数据</span><br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">urlencoded</span>(&#123; <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> &#125;));<br><br><span class="hljs-comment">// 托管静态资源</span><br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(<span class="hljs-string">&#x27;public&#x27;</span>));<br></code></pre></td></tr></table></figure>

<ul>
<li><code>express.urlencoded()</code>：解析 URL-encoded 表单数据，没解析<code>res.body</code>返回为空。</li>
<li><code>express.static()</code>：托管静态资源。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//引入express框架</span><br><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-comment">//创建服务对象</span><br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><span class="hljs-comment">//静态资源中间件的设置，将当前文件夹下的public目录作为网站的根目录</span><br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(<span class="hljs-string">&#x27;./public&#x27;</span>)); <span class="hljs-comment">//当然这个目录中都是一些静态资源</span><br><span class="hljs-comment">//如果访问的内容经常变化，还是需要设置路由</span><br><span class="hljs-comment">//但是，在这里有一个问题，如果public目录下有index.html文件，单独也有index.html的路由，</span><br><span class="hljs-comment">//则谁书写在前，优先执行谁</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/index.html&#x27;</span>,<span class="hljs-function">(<span class="hljs-params">request,response</span>)=&gt;</span>&#123;<br>    respsonse.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;首页&#x27;</span>);<br>&#125;);<br><span class="hljs-comment">//监听端口</span><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>,<span class="hljs-function">()=&gt;</span>&#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;3000 端口启动....&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure>

<p>注意事项:</p>
<ol>
<li><code>index.html</code> 文件为默认打开的资源</li>
<li>如果静态资源与路由规则同时匹配，谁先匹配谁就响应</li>
<li>路由响应动态资源，静态资源中间件响应静态资源</li>
</ol>
<h4 id="4-第三方中间件"><a href="#4-第三方中间件" class="headerlink" title="4.第三方中间件"></a>4.第三方中间件</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> morgan = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;morgan&#x27;</span>); <span class="hljs-comment">// 日志中间件</span><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">morgan</span>(<span class="hljs-string">&#x27;dev&#x27;</span>));<br></code></pre></td></tr></table></figure>

<h4 id="5-错误处理中间件"><a href="#5-错误处理中间件" class="headerlink" title="5.错误处理中间件"></a>5.错误处理中间件</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js">app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">err, req, res, next</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;出错了：&#x27;</span>, err.<span class="hljs-property">message</span>);<br>  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;服务器错误&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure>

<blockquote>
<p>注意：必须放在所有路由之后，且有 <code>(err, req, res, next)</code> 四个参数。</p>
</blockquote>
<h3 id="【中间件执行顺序】"><a href="#【中间件执行顺序】" class="headerlink" title="【中间件执行顺序】"></a>【中间件执行顺序】</h3><ol>
<li>按定义顺序依次执行</li>
<li>同一路径匹配多个中间件时，需调用 <code>next()</code> 才会继续执行</li>
<li>如果某个中间件没有调用 <code>next()</code> 且没有结束响应，客户端会卡住</li>
<li><font color="#409eff"><code>res.send()</code>和<code>next()</code>不能同时使用。</font><ul>
<li><strong><code>res.send()</code><strong>直接</strong>结束响应</strong>，把数据发送给客户端,一旦调用，HTTP 响应就结束了，<strong>不能再发送数据或进入下一个中间件</strong></li>
<li>**<code>next()</code>**把控制权交给下一个匹配的中间件或路由处理函数，不会自动结束响应。</li>
</ul>
</li>
</ol>
<h3 id="【Router】"><a href="#【Router】" class="headerlink" title="【Router】"></a>【Router】</h3><p><strong>Express Router</strong> 是 Express 提供的<strong>路由模块化机制</strong>，用来把不同功能的路由拆分到单独文件，避免所有路由都堆在 <code>app.js</code> 里。</p>
<h4 id="创建Router"><a href="#创建Router" class="headerlink" title="创建Router"></a>创建Router</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// productRouter.js</span><br><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">const</span> router = express.<span class="hljs-title class_">Router</span>();<br><br><span class="hljs-comment">// 路由专属中间件</span><br>router.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;访问了商品路由：&#x27;</span>, req.<span class="hljs-property">method</span>, req.<span class="hljs-property">url</span>);<br>  <span class="hljs-title function_">next</span>();<br>&#125;);<br><br>router.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/list&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;商品列表&#x27;</span>);<br>&#125;);<br><br>router.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/detail/:id&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">`商品详情 ID：<span class="hljs-subst">$&#123;req.params.id&#125;</span>`</span>);<br>&#125;);<br><br><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = router;<br></code></pre></td></tr></table></figure>

<h4 id="在-app-js-中挂载"><a href="#在-app-js-中挂载" class="headerlink" title="在 app.js 中挂载"></a>在 app.js 中挂载</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// app.js</span><br><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><br><span class="hljs-comment">// 导入路由模块</span><br><span class="hljs-keyword">const</span> userRouter = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./userRouter&#x27;</span>);<br><br><span class="hljs-comment">// 挂载到 /user 前缀</span><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;/user&#x27;</span>, userRouter);<br><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;服务器已启动 3000&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure>

<h4 id="常见API"><a href="#常见API" class="headerlink" title="常见API"></a>常见API</h4><table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>router.use([path], middleware)</code></td>
<td>挂载中间件（可选路径前缀）</td>
</tr>
<tr>
<td><code>router.METHOD(path, handler)</code></td>
<td>定义路由（METHOD 如 <code>get</code>, <code>post</code> 等）</td>
</tr>
<tr>
<td><code>router.route(path)</code></td>
<td>链式定义同一路径的多个方法</td>
</tr>
<tr>
<td><code>module.exports = router</code></td>
<td>导出路由</td>
</tr>
</tbody></table>
<p><strong>链式写法示例</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js">router.<span class="hljs-title function_">route</span>(<span class="hljs-string">&#x27;/article&#x27;</span>)<br>  .<span class="hljs-title function_">get</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;获取文章&#x27;</span>))<br>  .<span class="hljs-title function_">post</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;新增文章&#x27;</span>))<br>  .<span class="hljs-title function_">put</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;更新文章&#x27;</span>));<br></code></pre></td></tr></table></figure>

<h4 id="多模块结构"><a href="#多模块结构" class="headerlink" title="多模块结构"></a>多模块结构</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js">project/<br>│── app.<span class="hljs-property">js</span><br>│── routes/<br>│    ├── user.<span class="hljs-property">js</span><br>│    ├── product.<span class="hljs-property">js</span><br>│    └── article.<span class="hljs-property">js</span><br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;/user&#x27;</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./routes/user&#x27;</span>));<br>app.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;/product&#x27;</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./routes/product&#x27;</span>));<br>app.<span class="hljs-title function_">use</span>(<span class="hljs-string">&#x27;/article&#x27;</span>, <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;./routes/article&#x27;</span>));<br><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Server running&#x27;</span>));<br></code></pre></td></tr></table></figure>

<h2 id="EJS模板"><a href="#EJS模板" class="headerlink" title="EJS模板"></a>EJS模板</h2><blockquote>
<p>官网: <strong><a target="_blank" rel="noopener" href="https://ejs.co/">https://ejs.co/</a></strong></p>
<p>中文站：<strong><a target="_blank" rel="noopener" href="https://ejs.bootcss.com/">https://ejs.bootcss.com/</a></strong></p>
</blockquote>
<p><strong>EJS (Embedded JavaScript templates)</strong> 是一个轻量级的 JavaScript 模板引擎，用来在 HTML 中嵌入 JavaScript 代码。<br> 它的作用：将 <strong>数据</strong> 和 <strong>模板</strong> 结合，生成最终 HTML</p>
<p>安装</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">npm install ejs<br></code></pre></td></tr></table></figure>

<h3 id="【Express-中使用-EJS】"><a href="#【Express-中使用-EJS】" class="headerlink" title="【Express 中使用 EJS】"></a>【Express 中使用 EJS】</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><br><span class="hljs-comment">// 1. 设置模板引擎</span><br>app.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;view engine&#x27;</span>, <span class="hljs-string">&#x27;ejs&#x27;</span>);<br><br><span class="hljs-comment">// 2. 设置模板文件夹（可选，默认 views 文件夹）</span><br>app.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;views&#x27;</span>, __dirname + <span class="hljs-string">&#x27;/views&#x27;</span>);<br><br><span class="hljs-comment">// 路由</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> user = &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Tom&#x27;</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">20</span> &#125;;<br>  <span class="hljs-comment">// 3. 渲染模板</span><br>  res.<span class="hljs-title function_">render</span>(<span class="hljs-string">&#x27;index&#x27;</span>, &#123; user &#125;);<br>&#125;);<br><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Server running&#x27;</span>));<br></code></pre></td></tr></table></figure>

<h3 id="【EJS-模板语法】"><a href="#【EJS-模板语法】" class="headerlink" title="【EJS 模板语法】"></a>【EJS 模板语法】</h3><p>假设 <code>views/index.ejs</code>：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs js">&lt;!<span class="hljs-variable constant_">DOCTYPE</span> html&gt;<br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>EJS 示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>欢迎 &lt;%= user.name %&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>年龄：&lt;%= user.age %&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml">  <span class="hljs-comment">&lt;!-- for 循环 --&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml">    &lt;% for(let i=1; i&lt;=3; i++)&#123; %&gt;</span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>项目 &lt;%= i %&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span><br><span class="language-xml">    &lt;% &#125; %&gt;</span><br><span class="language-xml">  <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span><br><span class="language-xml"></span><br><span class="language-xml">  <span class="hljs-comment">&lt;!-- if 判断 --&gt;</span></span><br><span class="language-xml">  &lt;% if(user.age &gt;= 18) &#123; %&gt;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>已成年<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">  &lt;% &#125; else &#123; %&gt;</span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>未成年<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span><br><span class="language-xml">  &lt;% &#125; %&gt;</span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span><br></code></pre></td></tr></table></figure>

<h3 id="【EJS-语法规则】"><a href="#【EJS-语法规则】" class="headerlink" title="【EJS 语法规则】"></a>【EJS 语法规则】</h3><table>
<thead>
<tr>
<th>语法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>&lt;%= 变量 %&gt;</code></td>
<td>输出转义后的内容（防 XSS）</td>
</tr>
<tr>
<td><code>&lt;%- 变量 %&gt;</code></td>
<td>输出原始 HTML（不转义）</td>
</tr>
<tr>
<td><code>&lt;% JS代码 %&gt;</code></td>
<td>执行 JavaScript 代码，不输出</td>
</tr>
<tr>
<td><code>&lt;% include(&#39;file&#39;) %&gt;</code></td>
<td>引入子模板</td>
</tr>
<tr>
<td><code>&lt;% for()&#123;&#125; %&gt;</code></td>
<td>循环</td>
</tr>
<tr>
<td><code>&lt;% if()&#123;&#125; %&gt;</code></td>
<td>条件判断</td>
</tr>
</tbody></table>
<h3 id="【独立渲染-EJS（不依赖-Express）】"><a href="#【独立渲染-EJS（不依赖-Express）】" class="headerlink" title="【独立渲染 EJS（不依赖 Express）】"></a>【独立渲染 EJS（不依赖 Express）】</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> ejs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;ejs&#x27;</span>);<br><br>ejs.<span class="hljs-title function_">renderFile</span>(<span class="hljs-string">&#x27;./views/index.ejs&#x27;</span>, &#123; <span class="hljs-attr">user</span>: &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Tom&#x27;</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">20</span> &#125; &#125;, <span class="hljs-function">(<span class="hljs-params">err, str</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(str); <span class="hljs-comment">// 输出 HTML</span><br>&#125;);<br></code></pre></td></tr></table></figure>

<h1 id="FS模块总结"><a href="#FS模块总结" class="headerlink" title="FS模块总结"></a>FS模块总结</h1><p><code>fs</code> (<strong>File System</strong>) 是 Node.js 内置的文件系统模块</p>
<ul>
<li>用于 <strong>文件读写</strong>、<strong>目录操作</strong>、<strong>文件状态查看</strong> 等</li>
<li>提供 <strong>同步</strong>（<code>xxxSync</code>）和 <strong>异步</strong>（回调&#x2F;Promise）两种 API</li>
<li>异步版本<strong>不会阻塞</strong>线程，性能更好</li>
</ul>
<p>导入方式：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;fs&#x27;</span>);<br></code></pre></td></tr></table></figure>

<h2 id="常用API总表"><a href="#常用API总表" class="headerlink" title="常用API总表"></a>常用API总表</h2><table>
<thead>
<tr>
<th>类别</th>
<th>异步方法</th>
<th>同步方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>读取文件</strong></td>
<td><code>fs.readFile(path, [options], callback)</code></td>
<td><code>fs.readFileSync(path, [options])</code></td>
<td>读取整个文件内容</td>
</tr>
<tr>
<td><strong>写入文件</strong></td>
<td><code>fs.writeFile(path, data, [options], callback)</code></td>
<td><code>fs.writeFileSync(...)</code></td>
<td>覆盖写入文件</td>
</tr>
<tr>
<td><strong>追加写入</strong></td>
<td><code>fs.appendFile(...)</code></td>
<td><code>fs.appendFileSync(...)</code></td>
<td>追加内容到文件末尾</td>
</tr>
<tr>
<td><strong>删除文件</strong></td>
<td><code>fs.unlink(...)</code></td>
<td><code>fs.unlinkSync(...)</code></td>
<td>删除文件</td>
</tr>
<tr>
<td><strong>重命名&#x2F;移动</strong></td>
<td><code>fs.rename(...)</code></td>
<td><code>fs.renameSync(...)</code></td>
<td>重命名文件或移动位置</td>
</tr>
<tr>
<td><strong>检测文件状态</strong></td>
<td><code>fs.stat(...)</code></td>
<td><code>fs.statSync(...)</code></td>
<td>查看文件&#x2F;目录信息</td>
</tr>
<tr>
<td><strong>判断存在</strong></td>
<td><code>fs.exists(path）</code></td>
<td><code>fs.existsSync(path)</code></td>
<td>判断路径是否存在</td>
</tr>
<tr>
<td><strong>创建目录</strong></td>
<td><code>fs.mkdir(...)</code></td>
<td><code>fs.mkdirSync(...)</code></td>
<td>创建文件夹</td>
</tr>
<tr>
<td><strong>读取目录</strong></td>
<td><code>fs.readdir(...)</code></td>
<td><code>fs.readdirSync(...)</code></td>
<td>获取目录内容</td>
</tr>
<tr>
<td><strong>删除目录</strong></td>
<td><code>fs.rmdir(...)</code></td>
<td><code>fs.rmdirSync(...)</code></td>
<td>删除文件夹（空）</td>
</tr>
<tr>
<td><strong>流式读取</strong></td>
<td><code>fs.createReadStream(path)</code></td>
<td>-</td>
<td>创建可读流</td>
</tr>
<tr>
<td><strong>流式写入</strong></td>
<td><code>fs.createWriteStream(path)</code></td>
<td>-</td>
<td>创建可写流</td>
</tr>
</tbody></table>
<h2 id="基本示例"><a href="#基本示例" class="headerlink" title="基本示例"></a>基本示例</h2><h3 id="【读取文件】"><a href="#【读取文件】" class="headerlink" title="【读取文件】"></a>【读取文件】</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js">fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">&#x27;./test.txt&#x27;</span>, <span class="hljs-string">&#x27;utf8&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;文件内容:&#x27;</span>, data);<br>&#125;);<br><br><span class="hljs-comment">// 同步</span><br><span class="hljs-keyword">const</span> data = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">&#x27;./test.txt&#x27;</span>, <span class="hljs-string">&#x27;utf8&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);<br></code></pre></td></tr></table></figure>

<h3 id="【写入-追加】"><a href="#【写入-追加】" class="headerlink" title="【写入&#x2F;追加】"></a>【写入&#x2F;追加】</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 覆盖写入</span><br>fs.<span class="hljs-title function_">writeFile</span>(<span class="hljs-string">&#x27;./test.txt&#x27;</span>, <span class="hljs-string">&#x27;Hello World&#x27;</span>, <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;写入成功&#x27;</span>);<br>&#125;);<br><br><span class="hljs-comment">// 追加写入</span><br>fs.<span class="hljs-title function_">appendFile</span>(<span class="hljs-string">&#x27;./test.txt&#x27;</span>, <span class="hljs-string">&#x27;\n追加内容&#x27;</span>, <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;<br>&#125;);<br></code></pre></td></tr></table></figure>

<h3 id="【删除-重命名】"><a href="#【删除-重命名】" class="headerlink" title="【删除&#x2F;重命名】"></a>【删除&#x2F;重命名】</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js">fs.<span class="hljs-title function_">unlink</span>(<span class="hljs-string">&#x27;./test.txt&#x27;</span>, <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;删除成功&#x27;</span>);<br>&#125;);<br><br>fs.<span class="hljs-title function_">rename</span>(<span class="hljs-string">&#x27;./old.txt&#x27;</span>, <span class="hljs-string">&#x27;./new.txt&#x27;</span>, <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;重命名成功&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure>

<h3 id="【目录操作】"><a href="#【目录操作】" class="headerlink" title="【目录操作】"></a>【目录操作】</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 创建目录</span><br>fs.<span class="hljs-title function_">mkdir</span>(<span class="hljs-string">&#x27;./demo&#x27;</span>, <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;目录创建成功&#x27;</span>);<br>&#125;);<br><br><span class="hljs-comment">// 读取目录</span><br>fs.<span class="hljs-title function_">readdir</span>(<span class="hljs-string">&#x27;./demo&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">err, files</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;目录内容:&#x27;</span>, files);<br>&#125;);<br><br><span class="hljs-comment">// 删除目录（空目录）</span><br>fs.<span class="hljs-title function_">rmdir</span>(<span class="hljs-string">&#x27;./demo&#x27;</span>, <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;目录删除成功&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure>

<h3 id="【文件状态】"><a href="#【文件状态】" class="headerlink" title="【文件状态】"></a>【文件状态】</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js">fs.<span class="hljs-title function_">stat</span>(<span class="hljs-string">&#x27;./test.txt&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">err, stats</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">throw</span> err;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(stats.<span class="hljs-title function_">isFile</span>()); <span class="hljs-comment">// true</span><br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(stats.<span class="hljs-title function_">isDirectory</span>()); <span class="hljs-comment">// false</span><br>&#125;);<br></code></pre></td></tr></table></figure>

<h3 id="【流式读写】"><a href="#【流式读写】" class="headerlink" title="【流式读写】"></a>【流式读写】</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> rs = fs.<span class="hljs-title function_">createReadStream</span>(<span class="hljs-string">&#x27;./input.txt&#x27;</span>);<br><span class="hljs-keyword">const</span> ws = fs.<span class="hljs-title function_">createWriteStream</span>(<span class="hljs-string">&#x27;./output.txt&#x27;</span>);<br><br>rs.<span class="hljs-title function_">pipe</span>(ws); <span class="hljs-comment">// 直接管道传输</span><br></code></pre></td></tr></table></figure>

<ul>
<li><code>createReadStream</code> 会分块读取文件，读到一块就触发数据事件</li>
<li><code>pipe</code> 方法自动把读到的数据传给写入流</li>
<li>这样不用把整个文件一次加载进内存，适合大文件处理</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//创建读取流对象</span><br><span class="hljs-keyword">let</span> rs = fs.<span class="hljs-title function_">createReadStream</span>(<span class="hljs-string">&#x27;./观书有感.txt&#x27;</span>);<br><span class="hljs-comment">//每次取出 64k 数据后执行一次 data 回调</span><br>rs.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;data&#x27;</span>, <span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data.<span class="hljs-property">length</span>);<br>&#125;);<br><span class="hljs-comment">//读取完毕后, 执行 end 回调</span><br>rs.<span class="hljs-title function_">on</span>(<span class="hljs-string">&#x27;end&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;读取完成&#x27;</span>)<br>&#125;)<br></code></pre></td></tr></table></figure>

<h2 id="同步-vs-异步"><a href="#同步-vs-异步" class="headerlink" title="同步 vs 异步"></a>同步 vs 异步</h2><ul>
<li><strong>同步</strong>：代码会阻塞等待文件操作完成</li>
<li><strong>异步</strong>：文件操作在后台进行，主线程可以继续执行其他任务</li>
<li>建议在高并发服务中<strong>优先使用异步</strong>版本</li>
</ul>
<h1 id="Buffer总结"><a href="#Buffer总结" class="headerlink" title="Buffer总结"></a>Buffer总结</h1><h2 id="Buffer是什么？"><a href="#Buffer是什么？" class="headerlink" title="Buffer是什么？"></a>Buffer是什么？</h2><ul>
<li>Buffer 是 Node.js 提供的 <strong>用于处理二进制数据的类数组对象</strong>。</li>
<li>它的出现解决了 JavaScript 语言本身不支持直接操作二进制数据的问题。</li>
<li>Buffer 常用于处理文件、网络通信等二进制数据流。</li>
</ul>
<h2 id="Buffer的创建"><a href="#Buffer的创建" class="headerlink" title="Buffer的创建"></a>Buffer的创建</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 创建一个长度为10的Buffer，内容未初始化（可能包含旧数据）</span><br><span class="hljs-keyword">const</span> buf1 = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">allocUnsafe</span>(<span class="hljs-number">10</span>);<br><br><span class="hljs-comment">// 创建一个长度为10的Buffer，内容全部初始化为0</span><br><span class="hljs-keyword">const</span> buf2 = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">alloc</span>(<span class="hljs-number">10</span>);<br><br><span class="hljs-comment">// 通过数组创建Buffer</span><br><span class="hljs-keyword">const</span> buf3 = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]);<br><br><span class="hljs-comment">// 通过字符串创建Buffer，默认utf8编码</span><br><span class="hljs-keyword">const</span> buf4 = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(<span class="hljs-string">&#x27;hello&#x27;</span>);<br><br><span class="hljs-comment">// 通过字符串创建Buffer，指定编码</span><br><span class="hljs-keyword">const</span> buf5 = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(<span class="hljs-string">&#x27;hello&#x27;</span>, <span class="hljs-string">&#x27;ascii&#x27;</span>);<br></code></pre></td></tr></table></figure>

<h2 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h2><table>
<thead>
<tr>
<th>操作</th>
<th>方法&#x2F;属性</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>获取长度</td>
<td><code>buf.length</code></td>
<td>Buffer字节长度</td>
<td><code>buf.length</code></td>
</tr>
<tr>
<td>写入字符串</td>
<td><code>buf.write(string, [offset], [length], [encoding])</code></td>
<td>写入内容</td>
<td><code>buf.write(&#39;abc&#39;)</code></td>
</tr>
<tr>
<td>读取字符串</td>
<td><code>buf.toString([encoding], [start], [end])</code></td>
<td>转为字符串</td>
<td><code>buf.toString(&#39;utf8&#39;, 0, 5)</code></td>
</tr>
<tr>
<td>合并 Buffer</td>
<td><code>Buffer.concat([buf1, buf2, ...])</code></td>
<td>合并多个Buffer</td>
<td><code>Buffer.concat([buf1, buf2])</code></td>
</tr>
<tr>
<td>拷贝数据</td>
<td><code>buf.copy(targetBuffer, [targetStart], [sourceStart], [sourceEnd])</code></td>
<td>复制内容</td>
<td><code>buf1.copy(buf2)</code></td>
</tr>
<tr>
<td>截取子Buffer</td>
<td><code>buf.slice(start, end)</code></td>
<td>获取Buffer子区间</td>
<td><code>buf.slice(0, 3)</code></td>
</tr>
</tbody></table>
<h2 id="Buffer-与字符串的转换"><a href="#Buffer-与字符串的转换" class="headerlink" title="Buffer 与字符串的转换"></a>Buffer 与字符串的转换</h2><ul>
<li><p>Buffer → 字符串</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">buf.<span class="hljs-title function_">toString</span>(<span class="hljs-string">&#x27;utf8&#x27;</span>);<br></code></pre></td></tr></table></figure>
</li>
<li><p>字符串 → Buffer</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(<span class="hljs-string">&#x27;字符串&#x27;</span>, <span class="hljs-string">&#x27;utf8&#x27;</span>);<br></code></pre></td></tr></table></figure></li>
</ul>
<p>编码支持</p>
<ul>
<li>支持多种编码格式：<code>utf8</code>（默认）、<code>ascii</code>、<code>base64</code>、<code>hex</code>、<code>latin1</code> 等。</li>
</ul>
<h2 id="示例：写入与读取"><a href="#示例：写入与读取" class="headerlink" title="示例：写入与读取"></a>示例：写入与读取</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> buf = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">alloc</span>(<span class="hljs-number">10</span>);<br>buf.<span class="hljs-title function_">write</span>(<span class="hljs-string">&#x27;hello&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(buf.<span class="hljs-title function_">toString</span>(<span class="hljs-string">&#x27;utf8&#x27;</span>, <span class="hljs-number">0</span>, <span class="hljs-number">5</span>)); <span class="hljs-comment">// 输出 hello</span><br></code></pre></td></tr></table></figure>

<ul>
<li>通过 <code>Buffer.alloc(10)</code> 申请 10 字节空间；</li>
<li>用 <code>write</code> 写入字符串到 Buffer；</li>
<li>用 <code>toString</code> 读取指定范围的字节转换成字符串。</li>
<li>这样你就可以把字符串转换成二进制存储，也能从二进制读取对应字符串。</li>
</ul>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ul>
<li>Buffer 大小固定，创建后不可动态扩容</li>
<li>使用 <code>Buffer.allocUnsafe</code> 可能包含旧数据，慎用</li>
<li>操作二进制数据时，注意编码和字节偏移</li>
</ul>
<h1 id="Path模块总结"><a href="#Path模块总结" class="headerlink" title="Path模块总结"></a>Path模块总结</h1><h2 id="Path模块简介"><a href="#Path模块简介" class="headerlink" title="Path模块简介"></a>Path模块简介</h2><ul>
<li><code>path</code> 是 Node.js 的核心模块，用于处理和转换文件路径。</li>
<li>解决不同操作系统（Windows、Linux、macOS）路径分隔符不同的问题。</li>
<li>提供了许多实用的方法来解析、拼接、格式化路径。</li>
</ul>
<h2 id="导入方式"><a href="#导入方式" class="headerlink" title="导入方式"></a>导入方式</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);<br></code></pre></td></tr></table></figure>

<h2 id="常用-API-及说明"><a href="#常用-API-及说明" class="headerlink" title="常用 API 及说明"></a>常用 API 及说明</h2><table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td><code>path.basename(path, [ext])</code></td>
<td>返回路径中的文件名部分，可去除指定扩展名</td>
<td><code>path.basename(&#39;/foo/bar/baz.txt&#39;) // &#39;baz.txt&#39;</code></td>
</tr>
<tr>
<td><code>path.dirname(path)</code></td>
<td>返回路径中的目录部分</td>
<td><code>path.dirname(&#39;/foo/bar/baz.txt&#39;) // &#39;/foo/bar&#39;</code></td>
</tr>
<tr>
<td><code>path.extname(path)</code></td>
<td>返回路径中的扩展名</td>
<td><code>path.extname(&#39;index.html&#39;) // &#39;.html&#39;</code></td>
</tr>
<tr>
<td><code>path.parse(path)</code></td>
<td>解析路径为对象，包含 root、dir、base、ext、name</td>
<td><code>path.parse(&#39;/foo/bar/baz.txt&#39;)</code> 返回 <code>&#123; root: &#39;/&#39;, dir: &#39;/foo/bar&#39;, base: &#39;baz.txt&#39;, ext: &#39;.txt&#39;, name: &#39;baz&#39; &#125;</code></td>
</tr>
<tr>
<td><code>path.format(pathObject)</code></td>
<td>把路径对象转换回路径字符串</td>
<td><code>path.format(&#123; root: &#39;/&#39;, dir: &#39;/foo/bar&#39;, base: &#39;baz.txt&#39; &#125;)</code> 返回 <code>/foo/bar/baz.txt</code></td>
</tr>
<tr>
<td><code>path.isAbsolute(path)</code></td>
<td>判断路径是否为绝对路径</td>
<td><code>path.isAbsolute(&#39;/foo/bar&#39;) // true</code></td>
</tr>
<tr>
<td><code>path.join([...paths])</code></td>
<td>拼接路径，自动处理分隔符</td>
<td><code>path.join(&#39;/foo&#39;, &#39;bar&#39;, &#39;baz&#39;) // &#39;/foo/bar/baz&#39;</code></td>
</tr>
<tr>
<td><code>path.resolve([...paths])</code></td>
<td>解析为绝对路径，基于当前工作目录</td>
<td><code>path.resolve(&#39;foo&#39;, &#39;/bar&#39;, &#39;baz&#39;)</code> 返回绝对路径</td>
</tr>
<tr>
<td><code>path.relative(from, to)</code></td>
<td>计算从 <code>from</code> 到 <code>to</code> 的相对路径</td>
<td><code>path.relative(&#39;/data/orandea/test/aaa&#39;, &#39;/data/orandea/impl/bbb&#39;)</code> 返回 <code>../../impl/bbb</code></td>
</tr>
<tr>
<td><code>path.sep</code></td>
<td>当前操作系统的路径分隔符</td>
<td><code>&#39;\\&#39;</code>（Windows）或 <code>&#39;/&#39;</code>（Linux&#x2F;macOS）</td>
</tr>
<tr>
<td><code>path.delimiter</code></td>
<td>当前操作系统的环境变量分隔符</td>
<td><code>&#39;;&#39;</code>（Windows）或 <code>&#39;:&#39;</code>（Linux&#x2F;macOS）</td>
</tr>
</tbody></table>
<ul>
<li><code>__dirname</code> 与 <code>require</code> 类似，都是 Node.js 环境中的全局变量。<code>__dirname</code> 保存着 当前文件所在目录的绝对路径 ，可以使用 <code>__dirname</code> 与文件名拼接成绝对路径</li>
</ul>
<h2 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs js">js复制编辑<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);<br><br><span class="hljs-keyword">const</span> filePath = <span class="hljs-string">&#x27;/foo/bar/baz.txt&#x27;</span>;<br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;文件名:&#x27;</span>, path.<span class="hljs-title function_">basename</span>(filePath)); <span class="hljs-comment">// baz.txt</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;目录名:&#x27;</span>, path.<span class="hljs-title function_">dirname</span>(filePath)); <span class="hljs-comment">// /foo/bar</span><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;扩展名:&#x27;</span>, path.<span class="hljs-title function_">extname</span>(filePath)); <span class="hljs-comment">// .txt</span><br><br><span class="hljs-keyword">const</span> parsed = path.<span class="hljs-title function_">parse</span>(filePath);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(parsed);<br><span class="hljs-comment">// &#123;</span><br><span class="hljs-comment">//   root: &#x27;/&#x27;,</span><br><span class="hljs-comment">//   dir: &#x27;/foo/bar&#x27;,</span><br><span class="hljs-comment">//   base: &#x27;baz.txt&#x27;,</span><br><span class="hljs-comment">//   ext: &#x27;.txt&#x27;,</span><br><span class="hljs-comment">//   name: &#x27;baz&#x27;</span><br><span class="hljs-comment">// &#125;</span><br><br><span class="hljs-keyword">const</span> joinedPath = path.<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;/foo&#x27;</span>, <span class="hljs-string">&#x27;bar&#x27;</span>, <span class="hljs-string">&#x27;baz&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;拼接路径:&#x27;</span>, joinedPath); <span class="hljs-comment">// /foo/bar/baz</span><br><br><span class="hljs-keyword">const</span> resolvedPath = path.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">&#x27;foo&#x27;</span>, <span class="hljs-string">&#x27;/bar&#x27;</span>, <span class="hljs-string">&#x27;baz&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;绝对路径:&#x27;</span>, resolvedPath); <span class="hljs-comment">// 取决于当前工作目录</span><br><br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;是否绝对路径:&#x27;</span>, path.<span class="hljs-title function_">isAbsolute</span>(filePath)); <span class="hljs-comment">// true</span><br><br><span class="hljs-keyword">const</span> relativePath = path.<span class="hljs-title function_">relative</span>(<span class="hljs-string">&#x27;/foo/bar&#x27;</span>, <span class="hljs-string">&#x27;/foo/baz/file.txt&#x27;</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;相对路径:&#x27;</span>, relativePath); <span class="hljs-comment">// ../../baz/file.txt</span><br></code></pre></td></tr></table></figure>

<h1 id="Mongodb数据库"><a href="#Mongodb数据库" class="headerlink" title="Mongodb数据库"></a>Mongodb数据库</h1><p>MongoDB 是一个基于 <strong>文档（Document）</strong> 的 NoSQL 数据库。它使用类似 JSON 的 BSON 格式存储数据，支持灵活的结构。</p>
<p>数据库就是管理数据的应用软件，对数据进行 增（c）、删（d）、改（u）、查（r）</p>
<h2 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h2><h3 id="【基础概念】"><a href="#【基础概念】" class="headerlink" title="【基础概念】"></a>【基础概念】</h3><ul>
<li><p><strong>数据库（Database）</strong><br>包含多个集合</p>
</li>
<li><p><strong>集合（Collection）</strong><br>类似于关系数据库的表，存储一组文档</p>
</li>
<li><p><strong>文档（Document）</strong><br>BSON 格式的数据结构，类似 JSON 对象<br>例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<br>  <span class="hljs-string">&quot;_id&quot;</span>: <span class="hljs-title class_">ObjectId</span>(<span class="hljs-string">&quot;...&quot;</span>),<br>  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Alice&quot;</span>,<br>  <span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">25</span>,<br>  <span class="hljs-string">&quot;skills&quot;</span>: [<span class="hljs-string">&quot;JavaScript&quot;</span>, <span class="hljs-string">&quot;MongoDB&quot;</span>]<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>字段（Field）</strong><br>文档中的键值对，可以嵌套、数组等</p>
</li>
</ul>
<h3 id="【MongoDB-和-关系数据库】"><a href="#【MongoDB-和-关系数据库】" class="headerlink" title="【MongoDB 和 关系数据库】"></a>【MongoDB 和 关系数据库】</h3><ol>
<li><strong>数据怎么存</strong>？</li>
</ol>
<ul>
<li><strong>MongoDB</strong>：像存 JSON（一种写数据的格式），灵活，字段不固定，能直接嵌套数组和对象。</li>
<li><strong>关系数据库</strong>：数据存表里，行和列固定，必须先定义好表结构。</li>
</ul>
<ol start="2">
<li><strong>怎么查数据</strong>？</li>
</ol>
<ul>
<li><strong>MongoDB</strong>：用 JSON 风格的语句查数据，比较像写对象。</li>
<li><strong>关系数据库</strong>：用 SQL 语句查数据，要写 <code>SELECT</code>、<code>JOIN</code> 等。</li>
</ul>
<ol start="3">
<li><strong>数据关系和事务</strong></li>
</ol>
<ul>
<li><strong>MongoDB</strong>：适合关系不复杂的数据，也支持事务，但不如关系数据库成熟。</li>
<li><strong>关系数据库</strong>：关系复杂（比如多个表之间关联），事务支持特别好，保证数据准确。</li>
</ul>
<ol start="4">
<li><strong>扩展和性能</strong></li>
</ol>
<ul>
<li><strong>MongoDB</strong>：很容易增加服务器横向扩展，适合海量数据和高并发。</li>
<li><strong>关系数据库</strong>：通常是往服务器加配置（纵向扩展），横向扩展比较难。</li>
</ul>
<p><strong>MongoDB 更灵活，适合大数据和变化快的应用；关系数据库更严谨，适合传统业务和复杂数据关联。</strong></p>
<h2 id="具体使用"><a href="#具体使用" class="headerlink" title="具体使用"></a>具体使用</h2><blockquote>
<p>参考文档： <a href="./mongodb.pdf">mongodb.pdf</a> </p>
</blockquote>
<h1 id="会话控制"><a href="#会话控制" class="headerlink" title="会话控制"></a>会话控制</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.yuque.com/cuggz/interview/browser">前端面试题之浏览器原理篇</a></p>
</blockquote>
<h2 id="会话概念"><a href="#会话概念" class="headerlink" title="会话概念"></a>会话概念</h2><p><strong>会话（Session）</strong>，在网络通信里，指的是<strong>客户端与服务器之间，从建立连接开始，到连接关闭为止的一段连续交互过程</strong>。有两层含义。</p>
<ul>
<li>底层通信会话：从TCP连接建立到TCP连接断开的通信过程。</li>
<li>应用层逻辑会话：用 Session ID 等机制，从用户首次登录创建Session ID到超时或者登出，Session ID过期属于同一个“会话”</li>
</ul>
<p><strong>会话的本质</strong></p>
<ul>
<li>是一段有<strong>起点</strong>和<strong>终点</strong>的、有状态的通信过程</li>
<li>用来维持用户和服务器之间的<strong>上下文</strong>（Context）</li>
<li>可以跨多次请求，让服务端“记住”客户端。</li>
</ul>
<p>HTTP 是一种无状态的协议，它没有办法区分多次的请求是否来自于同一个客户端， 无法区分用户，因此需要过程<code>会话控制</code>来解决该问题。</p>
<p>常见的会话控制技术有三种：</p>
<ul>
<li>cookie</li>
<li>session</li>
<li>token</li>
</ul>
<h2 id="会话控制技术"><a href="#会话控制技术" class="headerlink" title="会话控制技术"></a>会话控制技术</h2><h3 id="【Cookie-会话控制】"><a href="#【Cookie-会话控制】" class="headerlink" title="【Cookie 会话控制】"></a>【Cookie 会话控制】</h3><h4 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a><strong>原理</strong></h4><ul>
<li><strong>Cookie</strong> 是 <strong>浏览器端的一种存储机制</strong>，它本质上就是浏览器保存的一小段键值对数据。</li>
<li>浏览器会在后续请求中<strong>自动携带对应域名的 Cookie</strong> 发送给服务器。</li>
<li>服务器根据 Cookie 中的内容（比如用户 ID、Session ID）来识别用户。</li>
</ul>
<h4 id="实现流程"><a href="#实现流程" class="headerlink" title="实现流程"></a><strong>实现流程</strong></h4><ol>
<li><p><strong>第一次请求</strong></p>
<ul>
<li><p>客户端访问服务器，没有 Cookie</p>
</li>
<li><p>服务器响应中返回 <code>Set-Cookie</code> 头：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: userid=<span class="hljs-number">12345</span>; <span class="hljs-title class_">Expires</span>=<span class="hljs-title class_">Wed</span>, <span class="hljs-number">14</span> <span class="hljs-title class_">Aug</span> <span class="hljs-number">2025</span> <span class="hljs-number">12</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span> <span class="hljs-variable constant_">GMT</span>; <span class="hljs-title class_">Path</span>=/<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>浏览器存储 Cookie</strong>（内存或硬盘）</p>
</li>
<li><p><strong>后续请求自动附带 Cookie</strong></p>
<ul>
<li><p>浏览器向同域名发请求时，自动在请求头中加：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Cookie</span>: userid=<span class="hljs-number">12345</span><br></code></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><strong>服务器读取 Cookie 内容</strong>，执行逻辑</p>
</li>
</ol>
<p><strong>浏览器关闭时 Cookie “过期”的原理</strong></p>
<ul>
<li><strong>会话 Cookie</strong><ul>
<li>存在内存里（浏览器进程内存空间）</li>
<li>浏览器退出 → 进程销毁 → 内存释放 → Cookie 消失</li>
<li>下次启动浏览器，内存是空的，自然就“过期”了</li>
</ul>
</li>
<li><strong>持久 Cookie</strong><ul>
<li>存在硬盘文件</li>
<li>浏览器启动时会读取文件并加载还没过期的 Cookie</li>
<li>只有到 <code>Expires</code> &#x2F; <code>Max-Age</code> 到期，或用户手动删除时才会失效</li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">const</span> cookieParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;cookie-parser&#x27;</span>);<br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><br><span class="hljs-comment">// 启用 cookie 解析中间件</span><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">cookieParser</span>());<br><br><span class="hljs-comment">// 设置 Cookie</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/set-cookie&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// 不带时效性（会话 cookie，浏览器关闭即失效）</span><br>  res.<span class="hljs-title function_">cookie</span>(<span class="hljs-string">&#x27;username&#x27;</span>, <span class="hljs-string">&#x27;wangwu&#x27;</span>);<br>  <span class="hljs-comment">// 带时效性（持久 cookie）</span><br>  res.<span class="hljs-title function_">cookie</span>(<span class="hljs-string">&#x27;email&#x27;</span>, <span class="hljs-string">&#x27;23123456@qq.com&#x27;</span>, &#123; <span class="hljs-attr">maxAge</span>: <span class="hljs-number">5</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span> &#125;);<br>  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Cookie 已设置&#x27;</span>);<br>&#125;);<br><br><span class="hljs-comment">// 读取 Cookie</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/get-cookie&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(req.<span class="hljs-property">cookies</span>); <span class="hljs-comment">// &#123; username: &#x27;wangwu&#x27;, email: &#x27;...&#x27; &#125;</span><br>  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">`当前 Cookie: <span class="hljs-subst">$&#123;<span class="hljs-built_in">JSON</span>.stringify(req.cookies)&#125;</span>`</span>);<br>&#125;);<br><br><span class="hljs-comment">// 删除 Cookie</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/delete-cookie&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  res.<span class="hljs-title function_">clearCookie</span>(<span class="hljs-string">&#x27;username&#x27;</span>);<br>  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;Cookie 已删除&#x27;</span>);<br>&#125;);<br><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;服务已启动，端口 3000&#x27;</span>);<br>&#125;);<br><br></code></pre></td></tr></table></figure>

<h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a><strong>优点</strong></h4><ul>
<li>自动化：浏览器帮你存储和发送，开发方便</li>
<li>兼容性好：几乎所有浏览器支持</li>
<li>可以存储少量信息（4KB 左右）</li>
</ul>
<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a><strong>缺点</strong></h4><ul>
<li>容量小</li>
<li>每次请求都会带上 Cookie，增加流量</li>
<li>明文存储，容易被窃取（可配合 <code>Secure</code>、<code>HttpOnly</code>）</li>
<li>不适合存储敏感信息（应存 ID 而非用户密码）</li>
</ul>
<h3 id="【Session-会话控制】"><a href="#【Session-会话控制】" class="headerlink" title="【Session 会话控制】"></a>【Session 会话控制】</h3><h4 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h4><ul>
<li><strong>Session</strong> 是服务器端维护的会话状态信息。</li>
<li>客户端只存一个<strong>Session ID</strong>（通常在 Cookie 中），具体的会话数据保存在服务器内存、数据库或缓存中。</li>
<li>每次请求时，客户端带上 Session ID，服务器根据这个 ID 找到之前的会话数据。</li>
</ul>
<h4 id="实现流程-1"><a href="#实现流程-1" class="headerlink" title="实现流程"></a>实现流程</h4><ol>
<li><strong>第一次请求</strong><ul>
<li>客户端访问服务器，没有 Session ID</li>
<li>服务器生成一个唯一的 Session ID（比如 <code>abc123</code>）</li>
<li>在服务器端开辟存储空间，保存用户状态（如登录信息）</li>
<li>通过 <code>Set-Cookie</code> 把 Session ID 发给客户端</li>
</ul>
</li>
<li><strong>后续请求</strong><ul>
<li>浏览器带上 Cookie 中的 Session ID</li>
<li>服务器用这个 ID 找到对应会话数据</li>
</ul>
</li>
<li><strong>会话结束</strong><ul>
<li>Session 过期时间到 &#x2F; 用户登出 &#x2F; 服务器重启（如果没持久化）</li>
</ul>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-comment">// 1. 安装包：npm i express-session connect-mongo</span><br><span class="hljs-keyword">const</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express-session&#x27;</span>);<br><span class="hljs-keyword">const</span> <span class="hljs-title class_">MongoStore</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;connect-mongo&#x27;</span>);<br><br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br><br><span class="hljs-comment">// 2. 设置 session 中间件</span><br>app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">session</span>(&#123;<br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;sid&#x27;</span>,                 <span class="hljs-comment">// Cookie 名称，默认 connect.sid</span><br>  <span class="hljs-attr">secret</span>: <span class="hljs-string">&#x27;atguigu&#x27;</span>,           <span class="hljs-comment">// 签名，用于加密 session ID</span><br>  <span class="hljs-attr">saveUninitialized</span>: <span class="hljs-literal">false</span>,    <span class="hljs-comment">// 是否保存未初始化的 session</span><br>  <span class="hljs-attr">resave</span>: <span class="hljs-literal">true</span>,                <span class="hljs-comment">// 是否每次请求都重新保存 session</span><br>  <span class="hljs-attr">store</span>: <span class="hljs-title class_">MongoStore</span>.<span class="hljs-title function_">create</span>(&#123;   <span class="hljs-comment">// 存储到 MongoDB</span><br>    <span class="hljs-attr">mongoUrl</span>: <span class="hljs-string">&#x27;mongodb://127.0.0.1:27017/project&#x27;</span><br>  &#125;),<br>  <span class="hljs-attr">cookie</span>: &#123;<br>    <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,            <span class="hljs-comment">// 前端 JS 无法操作</span><br>    <span class="hljs-attr">maxAge</span>: <span class="hljs-number">1000</span> * <span class="hljs-number">300</span>         <span class="hljs-comment">// Session ID 过期时间（毫秒）</span><br>  &#125;<br>&#125;));<br><br><span class="hljs-comment">// 3. 创建 Session</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  req.<span class="hljs-property">session</span>.<span class="hljs-property">username</span> = <span class="hljs-string">&#x27;zhangsan&#x27;</span>;<br>  req.<span class="hljs-property">session</span>.<span class="hljs-property">email</span> = <span class="hljs-string">&#x27;zhangsan@qq.com&#x27;</span>;<br>  res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;登录成功，Session 已创建&#x27;</span>);<br>&#125;);<br><br><span class="hljs-comment">// 4. 获取 Session</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/home&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;session 信息:&#x27;</span>, req.<span class="hljs-property">session</span>);<br>  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">session</span>.<span class="hljs-property">username</span>) &#123;<br>    res.<span class="hljs-title function_">send</span>(<span class="hljs-string">`你好 <span class="hljs-subst">$&#123;req.session.username&#125;</span>`</span>);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;请登录或注册&#x27;</span>);<br>  &#125;<br>&#125;);<br><br><span class="hljs-comment">// 5. 销毁 Session</span><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/logout&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  req.<span class="hljs-property">session</span>.<span class="hljs-title function_">destroy</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>    res.<span class="hljs-title function_">send</span>(<span class="hljs-string">&#x27;成功退出&#x27;</span>);<br>  &#125;);<br>&#125;);<br><br><span class="hljs-comment">// 6. 启动服务</span><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;服务已启动，端口 3000 监听中...&#x27;</span>);<br>&#125;);<br></code></pre></td></tr></table></figure>

<h4 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h4><ul>
<li>安全性较高：敏感数据存在服务器，不暴露给客户端</li>
<li>容量大：不受 Cookie 4KB 限制</li>
<li>可以存复杂结构（对象、列表）</li>
</ul>
<h4 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h4><ul>
<li>占用服务器资源（内存、数据库）</li>
<li>多服务器环境需要 Session 共享（Redis、数据库同步）</li>
<li>默认依赖 Cookie 存 Session ID（禁用 Cookie 时要用 URL 重写）</li>
</ul>
<h3 id="【Token-会话控制】"><a href="#【Token-会话控制】" class="headerlink" title="【Token 会话控制】"></a>【Token 会话控制】</h3><h4 id="原理-3"><a href="#原理-3" class="headerlink" title="原理"></a>原理</h4><ul>
<li><strong>Token</strong> 是由服务器签发给客户端的加密字符串，通常包含用户信息和签名。</li>
<li>客户端持有 Token，后续请求时手动带上（通常放在 <code>Authorization</code> 头中）。</li>
<li>服务器<strong>不存储 Token 状态</strong>，而是通过解密&#x2F;验证签名来判断 Token 是否有效（JWT 就是这种无状态 Token 的典型实现）。</li>
<li>服务器验证 <strong>Token 签名</strong> 的核心原理，就是<strong>用同一密钥和相同算法重新生成签名，然后和 Token 里自带的签名比对</strong>，如果一致就说明 Token 没被篡改。</li>
<li><strong>Token 被截取</strong>，那么在它的有效期内，截取者就可以冒充你发起请求，从而导致<strong>权限丢失</strong>或<strong>数据泄露</strong>。</li>
</ul>
<h4 id="实现流程（JWT-为例）"><a href="#实现流程（JWT-为例）" class="headerlink" title="实现流程（JWT 为例）"></a>实现流程（JWT 为例）</h4><ol>
<li><p><strong>用户登录</strong></p>
<ul>
<li>客户端发送账号密码到服务器</li>
<li>服务器验证成功后，生成 Token（Base64 编码 + 签名）</li>
<li>返回 Token 给客户端</li>
</ul>
</li>
<li><p><strong>客户端存储 Token</strong></p>
<ul>
<li>存在 LocalStorage &#x2F; SessionStorage</li>
</ul>
</li>
<li><p><strong>后续请求</strong></p>
<ul>
<li><p>客户端在请求头加：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Authorization</span>: <span class="hljs-title class_">Bearer</span> &lt;token&gt;<br></code></pre></td></tr></table></figure>
</li>
<li><p>服务器验证签名和过期时间，直接解析出用户信息</p>
</li>
</ul>
</li>
<li><p><strong>过期或刷新</strong></p>
<ul>
<li>Token 一旦签发无法撤回（除非维护黑名单）</li>
<li>常配合 Refresh Token 实现续期</li>
</ul>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// jwt-demo.js</span><br><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;express&#x27;</span>);<br><span class="hljs-keyword">const</span> jwt = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;jsonwebtoken&#x27;</span>);<br><br><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br>app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>());<br><br><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SECRET_KEY</span> = <span class="hljs-string">&#x27;my_secret_key&#x27;</span>;<br><br>app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/login&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-comment">// 模拟用户验证</span><br>  <span class="hljs-keyword">const</span> user = &#123; <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">username</span>: <span class="hljs-string">&#x27;alice&#x27;</span> &#125;;<br>  <span class="hljs-keyword">const</span> token = jwt.<span class="hljs-title function_">sign</span>(user, <span class="hljs-variable constant_">SECRET_KEY</span>, &#123; <span class="hljs-attr">expiresIn</span>: <span class="hljs-string">&#x27;1m&#x27;</span> &#125;); <br>  <span class="hljs-comment">// 负载（Payload） 秘钥（Secret Key） 配置对象，过期时间 60 秒</span><br>  res.<span class="hljs-title function_">json</span>(&#123; token &#125;);<br>&#125;);<br><br>app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/profile&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> &#123;<br>  <span class="hljs-keyword">const</span> authHeader = req.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;authorization&#x27;</span>];<br>  <span class="hljs-keyword">if</span> (!authHeader) <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">sendStatus</span>(<span class="hljs-number">401</span>);<br><br>  <span class="hljs-keyword">const</span> token = authHeader.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27; &#x27;</span>)[<span class="hljs-number">1</span>];<br>  jwt.<span class="hljs-title function_">verify</span>(token, <span class="hljs-variable constant_">SECRET_KEY</span>, <span class="hljs-function">(<span class="hljs-params">err, user</span>) =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (err) <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">sendStatus</span>(<span class="hljs-number">403</span>);<br>    res.<span class="hljs-title function_">json</span>(&#123; <span class="hljs-attr">message</span>: <span class="hljs-string">`欢迎你，<span class="hljs-subst">$&#123;user.username&#125;</span>`</span> &#125;);<br>  &#125;);<br>&#125;);<br><br>app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3002</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;JWT 示例运行在 http://localhost:3002&#x27;</span>));<br><br></code></pre></td></tr></table></figure>

<h4 id="优点-2"><a href="#优点-2" class="headerlink" title="优点"></a>优点</h4><ul>
<li>无状态：服务器不存会话，易于扩展</li>
<li>跨平台：适合 Web、移动端、第三方 API</li>
<li>传输灵活：可放在 URL、Header、Cookie</li>
</ul>
<h4 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h4><ul>
<li>无法主动让 Token 失效（除非加黑名单）</li>
<li>Token 长度比 Session ID 大（增加流量）</li>
<li>安全性依赖加密与签名算法</li>
</ul>
<h2 id="两种网络攻击"><a href="#两种网络攻击" class="headerlink" title="两种网络攻击"></a>两种网络攻击</h2><h3 id="【CSRF-攻击（Cross-Site-Request-Forgery）】"><a href="#【CSRF-攻击（Cross-Site-Request-Forgery）】" class="headerlink" title="【CSRF 攻击（Cross-Site Request Forgery）】"></a>【CSRF 攻击（Cross-Site Request Forgery）】</h3><p><strong>概念</strong></p>
<ul>
<li>攻击者诱导已登录用户在浏览器中发送<strong>伪造请求</strong>到受信任网站，执行用户权限内的操作。</li>
<li>核心是利用用户已经登录的状态（Cookie、Session、Token）。</li>
</ul>
<p><strong>原理</strong></p>
<ol>
<li>用户登录网站 A，Cookie 已认证</li>
<li>用户访问攻击者网站 B</li>
<li>B 页面发起请求到 A（GET&#x2F;POST），浏览器会自动携带 A 的 Cookie</li>
<li>A 接收到请求，误以为是用户本人操作 → 执行敏感操作</li>
</ol>
<p><strong>举例</strong></p>
<ul>
<li>用户已登录银行网站，攻击页面发起：</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;https://bank.com/transfer?to=attacker&amp;amount=1000&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>浏览器携带银行 Cookie → 转账成功</li>
</ul>
<p><strong>防护方法</strong></p>
<ol>
<li><strong>CSRF Token</strong><ul>
<li>服务器生成随机 Token，绑定用户 Session</li>
<li>请求中必须携带 Token，服务器校验一致才执行操作</li>
</ul>
</li>
<li>验证 Referer&#x2F;Origin 请求头<ul>
<li>检查请求来源是否可信</li>
</ul>
</li>
<li>使用验证<ul>
<li>验证码</li>
<li>人机验证</li>
</ul>
</li>
</ol>
<h3 id="【XSS-攻击（Cross-Site-Scripting）】"><a href="#【XSS-攻击（Cross-Site-Scripting）】" class="headerlink" title="【XSS 攻击（Cross-Site Scripting）】"></a>【XSS 攻击（Cross-Site Scripting）】</h3><p><strong>概念</strong></p>
<ul>
<li>攻击者在网页中注入恶意脚本（通常是 JavaScript），当用户浏览网页时，脚本在用户浏览器执行。</li>
<li>目标：<strong>窃取用户信息、篡改页面、执行恶意操作</strong>。</li>
</ul>
<p><strong>分类</strong></p>
<ol>
<li><strong>存储型 XSS</strong><ul>
<li>恶意脚本存储在服务器数据库或文件中</li>
<li>用户访问页面时，脚本被加载执行</li>
<li>例：留言板、评论区注入 <code>&lt;script&gt;alert(1)&lt;/script&gt;</code></li>
</ul>
</li>
<li><strong>反射型 XSS</strong><ul>
<li>恶意脚本随 URL 或表单提交被反射回页面</li>
<li>用户点击链接就触发</li>
<li>例：<code>http://example.com/search?q=&lt;script&gt;alert(1)&lt;/script&gt;</code></li>
</ul>
</li>
<li><strong>DOM 型 XSS</strong><ul>
<li>恶意脚本只在浏览器端操作 DOM 执行</li>
<li>不经过服务器直接通过前端 JS 执行</li>
</ul>
</li>
</ol>
<p><strong>危害</strong></p>
<ul>
<li>窃取 Cookie、Token、Session 信息</li>
<li>劫持用户操作</li>
<li>页面篡改、钓鱼攻击</li>
</ul>
<p><strong>防护方法</strong></p>
<ul>
<li><p>对用户输入进行 <strong>HTML 转义</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-handlebars"><span class="language-xml"> -&gt; <span class="hljs-symbol">&amp;lt;</span>script<span class="hljs-symbol">&amp;gt;</span></span></span><br></code></pre></td></tr></table></figure></li>
</ul>
<h1 id="接口请求处理"><a href="#接口请求处理" class="headerlink" title="接口请求处理"></a>接口请求处理</h1><h2 id="RESTFul风格设计"><a href="#RESTFul风格设计" class="headerlink" title="RESTFul风格设计"></a>RESTFul风格设计</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://restfulapi.net/">https://restfulapi.net/</a></p>
</blockquote>
<h3 id="【接口设计】"><a href="#【接口设计】" class="headerlink" title="【接口设计】"></a>【接口设计】</h3><p>在Http协议传递过程中，URL可以选择param\json\path形式。**<font color="#FF774B">RestFul是一套HTTP协议的标准使用方案和风格，帮助用户完成设计：</font>**</p>
<ul>
<li>如何设计路径？</li>
<li>如何设计参数传递？</li>
<li>如何选择请求方式？</li>
</ul>
<ol>
<li><p><strong>接口设计</strong></p>
<table>
<thead>
<tr>
<th>功能</th>
<th>接口和请求方式</th>
<th>请求参数</th>
<th>返回值</th>
</tr>
</thead>
<tbody><tr>
<td>分页查询</td>
<td>GET  &#x2F;user</td>
<td>page&#x3D;1&amp;size&#x3D;10</td>
<td>{ 响应数据 }</td>
</tr>
<tr>
<td>用户添加</td>
<td>POST &#x2F;user</td>
<td>{ user 数据 }</td>
<td>{响应数据}</td>
</tr>
<tr>
<td>用户详情</td>
<td>GET &#x2F;user&#x2F;1</td>
<td>路径参数</td>
<td>{响应数据}</td>
</tr>
<tr>
<td>用户更新</td>
<td>PUT &#x2F;user</td>
<td>{ user 更新数据}</td>
<td>{响应数据}</td>
</tr>
<tr>
<td>用户删除</td>
<td>DELETE &#x2F;user&#x2F;1</td>
<td>路径参数</td>
<td>{响应数据}</td>
</tr>
<tr>
<td>条件模糊</td>
<td>GET &#x2F;user&#x2F;search</td>
<td>page&#x3D;1&amp;size&#x3D;10&amp;keywork&#x3D;关键字</td>
<td>{响应数据}</td>
</tr>
</tbody></table>
</li>
<li><p><strong>问题讨论</strong></p>
<p>为什么查询用户详情，就使用路径传递参数，多条件模糊查询，就使用请求参数传递？</p>
<p>误区：restful风格下，不是所有请求参数都是路径传递！可以使用其他方式传递！</p>
<p>在 RESTful API 的设计中，路径和请求参数和请求体都是用来向服务器传递信息的方式。</p>
<ul>
<li>对于查询用户详情，使用路径传递参数是因为这是一个单一资源的查询，即查询一条用户记录。使用路径参数可以明确指定所请求的资源，便于服务器定位并返回对应的资源，也符合 RESTful 风格的要求。</li>
<li>而对于多条件模糊查询，使用请求参数传递参数是因为这是一个资源集合的查询，即查询多条用户记录。使用请求参数可以通过组合不同参数来限制查询结果，路径参数的组合和排列可能会很多，不如使用请求参数更加灵活和简洁。<br>此外，还有一些通用的原则可以遵循：</li>
<li>路径参数应该用于指定资源的唯一标识或者 ID，而请求参数应该用于指定查询条件或者操作参数。</li>
<li>请求参数应该限制在 10 个以内，过多的请求参数可能导致接口难以维护和使用。</li>
<li>对于敏感信息，最好使用 POST 和请求体来传递参数。</li>
</ul>
</li>
<li><p>代码实现</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * projectName: com.atguigu.controller</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * description: 用户模块的控制器</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RequestMapping(&quot;user&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 模拟分页查询业务接口</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">queryPage</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(name = &quot;page&quot;,required = false,defaultValue = &quot;1&quot;)</span><span class="hljs-type">int</span> page,</span><br><span class="hljs-params">                            <span class="hljs-meta">@RequestParam(name = &quot;size&quot;,required = false,defaultValue = &quot;10&quot;)</span><span class="hljs-type">int</span> size)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;page = &quot;</span> + page + <span class="hljs-string">&quot;, size = &quot;</span> + size);<br>        System.out.println(<span class="hljs-string">&quot;分页查询业务!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&#123;&#x27;status&#x27;:&#x27;ok&#x27;&#125;&quot;</span>;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 模拟用户保存业务接口</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">saveUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;user = &quot;</span> + user);<br>        System.out.println(<span class="hljs-string">&quot;用户保存业务!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&#123;&#x27;status&#x27;:&#x27;ok&#x27;&#125;&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 模拟用户详情业务接口</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">detailUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Integer id)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;id = &quot;</span> + id);<br>        System.out.println(<span class="hljs-string">&quot;用户详情业务!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&#123;&#x27;status&#x27;:&#x27;ok&#x27;&#125;&quot;</span>;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 模拟用户更新业务接口</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PutMapping</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">updateUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;user = &quot;</span> + user);<br>        System.out.println(<span class="hljs-string">&quot;用户更新业务!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&#123;&#x27;status&#x27;:&#x27;ok&#x27;&#125;&quot;</span>;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 模拟条件分页查询业务接口</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;search&quot;)</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">queryPage</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(name = &quot;page&quot;,required = false,defaultValue = &quot;1&quot;)</span><span class="hljs-type">int</span> page,</span><br><span class="hljs-params">                            <span class="hljs-meta">@RequestParam(name = &quot;size&quot;,required = false,defaultValue = &quot;10&quot;)</span><span class="hljs-type">int</span> size,</span><br><span class="hljs-params">                            <span class="hljs-meta">@RequestParam(name = &quot;keyword&quot;,required= false)</span>String keyword)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;page = &quot;</span> + page + <span class="hljs-string">&quot;, size = &quot;</span> + size + <span class="hljs-string">&quot;, keyword = &quot;</span> + keyword);<br>        System.out.println(<span class="hljs-string">&quot;条件分页查询业务!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&#123;&#x27;status&#x27;:&#x27;ok&#x27;&#125;&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong><font color="#FF774B">GET和DELETE没有请求体，如果参数只有一个例如id，使用路径传递参数。如果参数有多个，使用param传参；POST和PUT有请求体，直接使用请求体传递json。</font></strong></p>
<h3 id="【响应代码规范】"><a href="#【响应代码规范】" class="headerlink" title="【响应代码规范】"></a>【响应代码规范】</h3><p>HTTP 定义了这些标准状态代码，可用于传达客户端请求的结果。状态代码分为五类。</p>
<ul>
<li><strong><a target="_blank" rel="noopener" href="https://restfulapi.net/http-status-codes/#1xx">1xx：信息性</a></strong> – 传达传输协议级信息。</li>
<li><strong><a target="_blank" rel="noopener" href="https://restfulapi.net/http-status-codes/#2xx">2xx：成功</a></strong> – 表示客户端的请求已成功接受。</li>
<li><strong><a target="_blank" rel="noopener" href="https://restfulapi.net/http-status-codes/#3xx">3xx：重定向</a></strong> – 表示客户端必须执行一些额外的作才能完成其请求。</li>
<li><strong><a target="_blank" rel="noopener" href="https://restfulapi.net/http-status-codes/#4xx">4xx：客户端错误</a></strong> – 此类错误状态代码将矛头指向客户端。</li>
<li><strong><a target="_blank" rel="noopener" href="https://restfulapi.net/http-status-codes/#5xx">5xx：服务器错误</a></strong> – 服务器对这些错误状态代码负责。</li>
</ul>
<h3 id="【Swagger】"><a href="#【Swagger】" class="headerlink" title="【Swagger】"></a>【Swagger】</h3><p>Swagger是一套基于 OpenAPI 规范（OAS）构建的开源工具，主要用于**<font color="#FF774B">生成、描述、调用和可视化RESTful风格的Web API</font>**。</p>
<h3 id="【Postman】"><a href="#【Postman】" class="headerlink" title="【Postman】"></a>【Postman】</h3><p>接口测试工具，可以模仿客户端向服务器发送接口请求，测试服务器接口的效果。</p>
<h2 id="AJAX"><a href="#AJAX" class="headerlink" title="AJAX"></a>AJAX</h2><h3 id="【什么是-AJAX】"><a href="#【什么是-AJAX】" class="headerlink" title="【什么是 AJAX】"></a>【什么是 AJAX】</h3><p>AJAX（Asynchronous JavaScript and XML）是一种在<strong>不重新加载整个页面</strong>的情况下，从服务器获取数据并更新网页部分内容的技术。它不是一种新的编程语言，而是一种利用现有技术组合的交互方式。核心技术包括 JavaScript、HTML DOM、CSS，以及用于异步数据传输的 <code>XMLHttpRequest</code> 或 <code>Fetch</code> API。</p>
<p>AJAX 的出现，使得网页在用户操作时可以做到<strong>局部刷新</strong>，提升用户体验。例如，搜索引擎的搜索建议、社交平台的动态加载、地图应用的平滑拖动等，都是 AJAX 的典型应用。</p>
<h3 id="【AJAX-的特点】"><a href="#【AJAX-的特点】" class="headerlink" title="【AJAX 的特点】"></a>【AJAX 的特点】</h3><ul>
<li>异步通信：无需刷新整个页面即可与服务器交换数据</li>
<li>提高用户体验：局部更新页面，减少延迟感</li>
<li>数据格式多样：不仅可以使用 XML，还可以使用 JSON、HTML、纯文本等</li>
<li>基于已有标准：HTML、CSS、JavaScript、DOM、XMLHttpRequest</li>
<li>与服务器交互更灵活：支持 GET、POST 等多种 HTTP 方法</li>
</ul>
<h3 id="【AJAX-的工作原理】"><a href="#【AJAX-的工作原理】" class="headerlink" title="【AJAX 的工作原理】"></a>【AJAX 的工作原理】</h3><ol>
<li>用户在浏览器上触发事件（如点击按钮）</li>
<li>JavaScript 创建 AJAX 请求对象（XMLHttpRequest 或 Fetch）</li>
<li>浏览器向服务器发送 HTTP 请求（异步，不阻塞页面）</li>
<li>服务器接收请求并返回数据（JSON、XML、HTML 等）</li>
<li>浏览器接收响应数据，并由 JavaScript 更新 DOM 内容</li>
<li>页面局部刷新，而不是整个重新加载</li>
</ol>
<p>数据交互过程可简化为：浏览器事件 → 发送请求 → 服务器响应 → 前端更新</p>
<h3 id="【AJAX-的实现方法】"><a href="#【AJAX-的实现方法】" class="headerlink" title="【AJAX 的实现方法】"></a>【AJAX 的实现方法】</h3><ul>
<li><strong>XMLHttpRequest</strong>：早期的 AJAX 核心实现方式，功能全面但语法相对繁琐</li>
<li><strong>Fetch API</strong>：现代浏览器原生提供的异步请求方式，基于 Promise，更加简洁</li>
<li><strong>Axios</strong>：第三方 HTTP 库，支持 Promise，功能丰富，兼容性好，支持请求&#x2F;响应拦截等高级特性</li>
</ul>
<h2 id="跨域问题"><a href="#跨域问题" class="headerlink" title="跨域问题"></a>跨域问题</h2><h3 id="【什么是跨域】"><a href="#【什么是跨域】" class="headerlink" title="【什么是跨域】"></a>【什么是跨域】</h3><p>跨域是指浏览器出于安全策略（同源策略，Same-Origin Policy）的限制，阻止网页向不同域名、协议或端口的服务器发送 AJAX 请求。</p>
<p>例如：</p>
<ul>
<li>页面地址：<a href="http://example.com/">http://example.com</a></li>
<li>请求地址：<a target="_blank" rel="noopener" href="http://api.example.com/">http://api.example.com</a><br>因为域名不同，会触发跨域限制。</li>
</ul>
<p>常见的跨域解决方法：</p>
<ul>
<li><strong>CORS（跨域资源共享）</strong>：服务器在响应头中设置 <code>Access-Control-Allow-Origin</code> 来允许特定来源访问</li>
<li><strong>JSONP</strong>：利用 <code>&lt;script&gt;</code> 标签不受同源策略限制的特性进行跨域（仅支持 GET 请求，已较少使用）</li>
<li><strong>服务器代理</strong>：通过服务器代理转发请求，前端请求同源服务器，由该服务器再访问目标接口</li>
<li><strong>WebSocket</strong>：双向通信协议，可绕过部分跨域限制</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.yuque.com/tianyu-coder/openshare/aksmvpbebgw7savk">跨域问题梳理</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1pT421k7yz/?spm_id_from=333.337.search-card.all.click&vd_source=ff414aaf189e3a685358d2a984fd4742">禹神：一小时彻底搞懂跨域&amp;解决方案_哔哩哔哩_bilibili</a></p>
</blockquote>
<p>跨域问题导致会话控制种的cookie和session都无法使用，因此目前最常用的会话控制都是token。</p>
<h3 id="【cookie跨域问题】"><a href="#【cookie跨域问题】" class="headerlink" title="【cookie跨域问题】"></a>【cookie跨域问题】</h3><ol>
<li>浏览器的同源策略限制</li>
</ol>
<ul>
<li><strong>同源策略（Same-Origin Policy）</strong> 要求：协议、域名、端口三者必须一致，Cookie 才会被浏览器自动携带给服务器。</li>
<li>如果前端页面是 <code>https://a.com</code>，而你请求的 API 是 <code>https://api.b.com</code>，即便两者都是你的服务，浏览器也<strong>不会</strong>自动把 <code>a.com</code> 的 Cookie 发给 <code>b.com</code>。</li>
</ul>
<ol start="2">
<li>Cookie 的作用域由 <code>Domain</code> 决定</li>
</ol>
<ul>
<li><p>服务器在响应头中设置 Cookie 时，可以指定 <code>Domain</code>，它定义了 Cookie 属于哪个域。</p>
</li>
<li><p>例如：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Set</span>-<span class="hljs-title class_">Cookie</span>: sessionId=abc123; <span class="hljs-title class_">Domain</span>=a.<span class="hljs-property">com</span>; <span class="hljs-title class_">Path</span>=/<br></code></pre></td></tr></table></figure>

<p>这样设置的 Cookie 只会发送给 <code>a.com</code> 及其子域（<code>sub.a.com</code>），<strong>不会</strong>被发送给 <code>b.com</code>。</p>
</li>
<li><p>Cookie 无法直接跨顶级域（如 <code>.com</code> 和 <code>.cn</code>），因为浏览器会拒绝这样的设置以防信息泄露。</p>
</li>
</ul>
<ol start="3">
<li><strong>安全策略（防止 CSRF）</strong></li>
</ol>
<ul>
<li><p>浏览器在跨域请求中默认 <strong>不发送 Cookie</strong>，除非你在 AJAX 请求中显式开启：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;https://api.b.com/data&#x27;</span>, &#123;<br>  <span class="hljs-attr">credentials</span>: <span class="hljs-string">&#x27;include&#x27;</span><br>&#125;);<br></code></pre></td></tr></table></figure>
</li>
<li><p>即便这样做，后端还必须在响应中添加 CORS 允许携带凭证：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title class_">Access</span>-<span class="hljs-title class_">Control</span>-<span class="hljs-title class_">Allow</span>-<span class="hljs-title class_">Credentials</span>: <span class="hljs-literal">true</span><br><span class="hljs-title class_">Access</span>-<span class="hljs-title class_">Control</span>-<span class="hljs-title class_">Allow</span>-<span class="hljs-title class_">Origin</span>: <span class="hljs-attr">https</span>:<span class="hljs-comment">//a.com</span><br></code></pre></td></tr></table></figure>
</li>
<li><p>这种额外的安全验证，就是为了防止第三方网站利用 Cookie 自动登录或冒充用户（CSRF 攻击）。</p>
</li>
</ul>
<h2 id="三种请求方法"><a href="#三种请求方法" class="headerlink" title="三种请求方法"></a>三种请求方法</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://www.yuque.com/cuggz/feplus/ouwmxw3uk0vdnz8p#jYHEA">Fetch、Axios、Ajax、XHR</a></p>
</blockquote>
<h3 id="XMLHttpRequest（XHR）"><a href="#XMLHttpRequest（XHR）" class="headerlink" title="XMLHttpRequest（XHR）"></a>XMLHttpRequest（XHR）</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();<br><br><span class="hljs-comment">// 配置请求</span><br>xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">&#x27;POST&#x27;</span>, <span class="hljs-string">&#x27;/api/user&#x27;</span>, <span class="hljs-literal">true</span>);<br><br><span class="hljs-comment">// 设置请求头</span><br>xhr.<span class="hljs-title function_">setRequestHeader</span>(<span class="hljs-string">&#x27;Content-Type&#x27;</span>, <span class="hljs-string">&#x27;application/json&#x27;</span>);<br><br><span class="hljs-comment">// 携带跨域凭据</span><br>xhr.<span class="hljs-property">withCredentials</span> = <span class="hljs-literal">true</span>;<br><br><span class="hljs-comment">// 上传进度</span><br>xhr.<span class="hljs-property">upload</span>.<span class="hljs-property">onprogress</span> = <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">lengthComputable</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`上传进度: <span class="hljs-subst">$&#123;(e.loaded / e.total * <span class="hljs-number">100</span>).toFixed(<span class="hljs-number">2</span>)&#125;</span>%`</span>);<br>  &#125;<br>&#125;;<br><br><span class="hljs-comment">// 下载进度</span><br>xhr.<span class="hljs-property">onprogress</span> = <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">lengthComputable</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`下载进度: <span class="hljs-subst">$&#123;(e.loaded / e.total * <span class="hljs-number">100</span>).toFixed(<span class="hljs-number">2</span>)&#125;</span>%`</span>);<br>  &#125;<br>&#125;;<br><br><span class="hljs-comment">// 响应类型</span><br>xhr.<span class="hljs-property">responseType</span> = <span class="hljs-string">&#x27;json&#x27;</span>;<br><br><span class="hljs-comment">// 超时设置</span><br>xhr.<span class="hljs-property">timeout</span> = <span class="hljs-number">5000</span>;<br>xhr.<span class="hljs-property">ontimeout</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;请求超时&#x27;</span>);<br><br><span class="hljs-comment">// 成功回调</span><br>xhr.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> &#123;<br>  <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span> &lt; <span class="hljs-number">300</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;响应数据:&#x27;</span>, xhr.<span class="hljs-property">response</span>);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;请求失败:&#x27;</span>, xhr.<span class="hljs-property">status</span>);<br>  &#125;<br>&#125;;<br><br><span class="hljs-comment">// 错误回调</span><br>xhr.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;网络错误&#x27;</span>);<br><br><span class="hljs-comment">// 发送数据</span><br>xhr.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(&#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Alice&#x27;</span> &#125;));<br></code></pre></td></tr></table></figure>

<h3 id="Fetch"><a href="#Fetch" class="headerlink" title="Fetch"></a>Fetch</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// GET 请求</span><br><span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/api/user&#x27;</span>)<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP 错误: <span class="hljs-subst">$&#123;res.status&#125;</span>`</span>);<br>    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>();<br>  &#125;)<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data))<br>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err));<br><br><span class="hljs-comment">// POST JSON 数据</span><br><span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/api/user&#x27;</span>, &#123;<br>  <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<br>  <span class="hljs-attr">headers</span>: &#123; <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span> &#125;,<br>  <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(&#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Alice&#x27;</span> &#125;)<br>&#125;);<br><br><span class="hljs-comment">// 携带跨域凭据</span><br><span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/api/data&#x27;</span>, &#123; <span class="hljs-attr">credentials</span>: <span class="hljs-string">&#x27;include&#x27;</span> &#125;);<br><br><span class="hljs-comment">// 取消请求（AbortController）</span><br><span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();<br><span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/api/longtask&#x27;</span>, &#123; <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> &#125;)<br>  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">&#x27;请求被取消:&#x27;</span>, err.<span class="hljs-property">name</span>));<br><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> controller.<span class="hljs-title function_">abort</span>(), <span class="hljs-number">3000</span>);<br><br><span class="hljs-comment">// 流式读取下载数据</span><br><span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;/bigfile&#x27;</span>)<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-property">body</span>.<span class="hljs-title function_">getReader</span>())<br>  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">reader</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">return</span> reader.<span class="hljs-title function_">read</span>().<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">process</span>(<span class="hljs-params">&#123; done, value &#125;</span>) &#123;<br>      <span class="hljs-keyword">if</span> (done) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;下载完成&#x27;</span>);<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;接收数据块大小:&#x27;</span>, value.<span class="hljs-property">length</span>);<br>      <span class="hljs-keyword">return</span> reader.<span class="hljs-title function_">read</span>().<span class="hljs-title function_">then</span>(process);<br>    &#125;);<br>  &#125;);<br></code></pre></td></tr></table></figure>

<h3 id="Axios"><a href="#Axios" class="headerlink" title="Axios"></a>Axios</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://axios.nodejs.cn/docs/intro">立即开始 | Axios 文档</a></p>
</blockquote>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// 创建实例</span><br><span class="hljs-keyword">const</span> api = axios.<span class="hljs-title function_">create</span>(&#123;<br>  <span class="hljs-attr">baseURL</span>: <span class="hljs-string">&#x27;/api&#x27;</span>,<br>  <span class="hljs-attr">timeout</span>: <span class="hljs-number">5000</span>,<br>  <span class="hljs-attr">withCredentials</span>: <span class="hljs-literal">true</span><br>&#125;);<br><br><span class="hljs-comment">// 请求拦截器</span><br>api.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function"><span class="hljs-params">config</span> =&gt;</span> &#123;<br>  config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">&#x27;Bearer token&#x27;</span>;<br>  <span class="hljs-keyword">return</span> config;<br>&#125;);<br><br><span class="hljs-comment">// 响应拦截器</span><br>api.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(<br>  <span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-property">data</span>,<br>  <span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(err)<br>);<br><br><span class="hljs-comment">// GET 请求</span><br>api.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/user&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data));<br><br><span class="hljs-comment">// POST 请求</span><br>api.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/user&#x27;</span>, &#123; <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;Alice&#x27;</span> &#125;);<br><br><span class="hljs-comment">// 上传文件并监听进度</span><br><span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();<br>formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">&#x27;file&#x27;</span>, fileInput.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>]);<br>api.<span class="hljs-title function_">post</span>(<span class="hljs-string">&#x27;/upload&#x27;</span>, formData, &#123;<br>  <span class="hljs-attr">onUploadProgress</span>: <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (e.<span class="hljs-property">total</span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`上传进度: <span class="hljs-subst">$&#123;(e.loaded / e.total * <span class="hljs-number">100</span>).toFixed(<span class="hljs-number">2</span>)&#125;</span>%`</span>);<br>    &#125;<br>  &#125;<br>&#125;);<br><br><span class="hljs-comment">// 下载文件并监听进度</span><br>api.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/download&#x27;</span>, &#123;<br>  <span class="hljs-attr">responseType</span>: <span class="hljs-string">&#x27;blob&#x27;</span>,<br>  <span class="hljs-attr">onDownloadProgress</span>: <span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> &#123;<br>    <span class="hljs-keyword">if</span> (e.<span class="hljs-property">total</span>) &#123;<br>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`下载进度: <span class="hljs-subst">$&#123;(e.loaded / e.total * <span class="hljs-number">100</span>).toFixed(<span class="hljs-number">2</span>)&#125;</span>%`</span>);<br>    &#125;<br>  &#125;<br>&#125;);<br><br><span class="hljs-comment">// 取消请求</span><br><span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();<br>api.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/longtask&#x27;</span>, &#123; <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> &#125;);<br>controller.<span class="hljs-title function_">abort</span>();<br></code></pre></td></tr></table></figure>

<h4 id="Axios-配置项-请求报文对应关系"><a href="#Axios-配置项-请求报文对应关系" class="headerlink" title="Axios 配置项 &amp; 请求报文对应关系"></a>Axios 配置项 &amp; 请求报文对应关系</h4><table>
<thead>
<tr>
<th>Axios 配置项</th>
<th>作用位置</th>
<th>最终在 HTTP 请求中的表现</th>
<th>Node.js (Express) 里 <code>req</code> 的对应字段</th>
</tr>
</thead>
<tbody><tr>
<td><code>url</code></td>
<td>请求行</td>
<td><code>POST /user HTTP/1.1</code></td>
<td><code>req.url</code>、<code>req.path</code>、<code>req.query</code></td>
</tr>
<tr>
<td><code>method</code></td>
<td>请求行</td>
<td><code>POST /user HTTP/1.1</code></td>
<td><code>req.method</code></td>
</tr>
<tr>
<td><code>baseURL</code>+<code>url</code></td>
<td>请求行</td>
<td><code>http://localhost:3000/user</code></td>
<td><code>req.hostname</code>、<code>req.originalUrl</code></td>
</tr>
<tr>
<td><code>params</code></td>
<td>URL 查询</td>
<td><code>/user?id=123&amp;type=admin</code></td>
<td><code>req.query</code></td>
</tr>
<tr>
<td><code>data</code></td>
<td>请求体</td>
<td>JSON、form-data、x-www-form-urlencoded</td>
<td><code>req.body</code>（需 <code>body-parser</code>&#x2F;<code>express.json()</code> 中间件）</td>
</tr>
<tr>
<td><code>headers</code></td>
<td>请求头</td>
<td><code>Content-Type: application/json</code></td>
<td><code>req.headers</code></td>
</tr>
<tr>
<td><code>timeout</code></td>
<td>Axios 内部</td>
<td>不影响 HTTP 报文</td>
<td>不存在于 <code>req</code>，是 Axios 客户端行为</td>
</tr>
<tr>
<td><code>withCredentials</code></td>
<td>请求头</td>
<td><code>Cookie: ...</code></td>
<td><code>req.headers.cookie</code>、<code>req.cookies</code>（需 cookie-parser）</td>
</tr>
<tr>
<td><code>auth</code></td>
<td>请求头</td>
<td><code>Authorization: Basic xxx</code></td>
<td><code>req.headers.authorization</code></td>
</tr>
<tr>
<td><code>responseType</code></td>
<td>响应处理</td>
<td>不影响请求，只影响客户端解析</td>
<td>和 <code>req</code> 无关，是 Axios 客户端行为</td>
</tr>
</tbody></table>
<h4 id="常用配置项"><a href="#常用配置项" class="headerlink" title="常用配置项"></a>常用配置项</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">const</span> config = &#123;<br>  <span class="hljs-comment">// 请求方法 (GET、POST、PUT、DELETE、PATCH...)</span><br>  <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;get&#x27;</span>,<br><br>  <span class="hljs-comment">// 请求 URL</span><br>  <span class="hljs-attr">url</span>: <span class="hljs-string">&#x27;/user&#x27;</span>,<br><br>  <span class="hljs-comment">// baseURL 会自动拼接在 url 前面</span><br>  <span class="hljs-attr">baseURL</span>: <span class="hljs-string">&#x27;https://api.example.com&#x27;</span>,<br><br>  <span class="hljs-comment">// 请求参数（拼接到 URL 上，GET 常用）</span><br>  <span class="hljs-attr">params</span>: &#123;<br>    <span class="hljs-attr">id</span>: <span class="hljs-number">123</span>,<br>    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;admin&#x27;</span><br>  &#125;,<br><br>  <span class="hljs-comment">// 请求体数据（POST/PUT 常用）</span><br>  <span class="hljs-attr">data</span>: &#123;<br>    <span class="hljs-attr">username</span>: <span class="hljs-string">&#x27;tom&#x27;</span>,<br>    <span class="hljs-attr">password</span>: <span class="hljs-string">&#x27;123456&#x27;</span><br>  &#125;,<br><br>  <span class="hljs-comment">// 请求头</span><br>  <span class="hljs-attr">headers</span>: &#123;<br>    <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span>,<br>    <span class="hljs-string">&#x27;Authorization&#x27;</span>: <span class="hljs-string">&#x27;Bearer token123&#x27;</span><br>  &#125;,<br><br>  <span class="hljs-comment">// 请求超时时间（ms）</span><br>  <span class="hljs-attr">timeout</span>: <span class="hljs-number">5000</span>,<br><br>  <span class="hljs-comment">// 跨域是否携带 Cookie</span><br>  <span class="hljs-attr">withCredentials</span>: <span class="hljs-literal">true</span>,<br><br>  <span class="hljs-comment">// 响应数据格式（默认 json，可选 text, blob, arraybuffer, stream 等）</span><br>  <span class="hljs-attr">responseType</span>: <span class="hljs-string">&#x27;json&#x27;</span>,<br><br>  <span class="hljs-comment">// 自定义状态码校验规则（默认 200–299 为成功）</span><br>  <span class="hljs-attr">validateStatus</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">status</span>) &#123;<br>    <span class="hljs-keyword">return</span> status &gt;= <span class="hljs-number">200</span> &amp;&amp; status &lt; <span class="hljs-number">400</span> <span class="hljs-comment">// 200~399 认为成功</span><br>  &#125;,<br><br>  <span class="hljs-comment">// 请求进度（上传/下载）</span><br>  <span class="hljs-attr">onUploadProgress</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">progressEvent</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;上传进度:&#x27;</span>, progressEvent.<span class="hljs-property">loaded</span> / progressEvent.<span class="hljs-property">total</span>)<br>  &#125;,<br>  <span class="hljs-attr">onDownloadProgress</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">progressEvent</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;下载进度:&#x27;</span>, progressEvent.<span class="hljs-property">loaded</span> / progressEvent.<span class="hljs-property">total</span>)<br>  &#125;,<br><br>  <span class="hljs-comment">// 取消请求</span><br>  <span class="hljs-attr">cancelToken</span>: <span class="hljs-keyword">new</span> axios.<span class="hljs-title class_">CancelToken</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">cancel</span>) &#123;<br>    <span class="hljs-comment">// 调用 cancel() 可取消请求</span><br>  &#125;)<br>&#125;<br><br><span class="hljs-comment">// 发起请求</span><br><span class="hljs-title function_">axios</span>(config).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> &#123;<br>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">data</span>)<br>&#125;)<br></code></pre></td></tr></table></figure>



<h3 id="功能对比表"><a href="#功能对比表" class="headerlink" title="功能对比表"></a>功能对比表</h3><table>
<thead>
<tr>
<th>功能</th>
<th>XHR</th>
<th>Fetch</th>
<th>Axios</th>
</tr>
</thead>
<tbody><tr>
<td>GET&#x2F;POST&#x2F;PUT&#x2F;DELETE 支持</td>
<td>✔</td>
<td>✔</td>
<td>✔</td>
</tr>
<tr>
<td>自定义请求头</td>
<td>✔</td>
<td>✔</td>
<td>✔</td>
</tr>
<tr>
<td>跨域携带 Cookie</td>
<td>✔（withCredentials）</td>
<td>✔（credentials）</td>
<td>✔（withCredentials）</td>
</tr>
<tr>
<td>上传进度监听</td>
<td>✔</td>
<td>✘</td>
<td>✔</td>
</tr>
<tr>
<td>下载进度监听</td>
<td>✔</td>
<td>流式读取</td>
<td>✔</td>
</tr>
<tr>
<td>超时设置</td>
<td>✔</td>
<td>✘（需手动）</td>
<td>✔</td>
</tr>
<tr>
<td>取消请求</td>
<td>✘</td>
<td>✔（AbortController）</td>
<td>✔</td>
</tr>
<tr>
<td>JSON 自动解析</td>
<td>✘（需手动）</td>
<td>✘（需手动）</td>
<td>✔</td>
</tr>
<tr>
<td>请求拦截器</td>
<td>✘</td>
<td>✘</td>
<td>✔</td>
</tr>
<tr>
<td>响应拦截器</td>
<td>✘</td>
<td>✘</td>
<td>✔</td>
</tr>
<tr>
<td>API 简洁度</td>
<td>较低</td>
<td>中等</td>
<td>高</td>
</tr>
<tr>
<td>兼容性</td>
<td>极佳（IE5+）</td>
<td>现代浏览器</td>
<td>现代浏览器 + Node</td>
</tr>
</tbody></table>
<h2 id="方法对比"><a href="#方法对比" class="headerlink" title="方法对比"></a>方法对比</h2><table>
<thead>
<tr>
<th>特性</th>
<th>XMLHttpRequest</th>
<th>Fetch</th>
<th>Axios</th>
</tr>
</thead>
<tbody><tr>
<td>语法简洁性</td>
<td>较繁琐，需要手动监听状态</td>
<td>简洁，基于 Promise</td>
<td>简洁，基于 Promise</td>
</tr>
<tr>
<td>兼容性</td>
<td>广泛支持（IE5+）</td>
<td>现代浏览器（需 polyfill 兼容 IE）</td>
<td>广泛支持（含 Node.js）</td>
</tr>
<tr>
<td>错误处理</td>
<td>需检查 readyState 和 status</td>
<td>需手动检查 response.ok</td>
<td>自动抛出 HTTP 错误</td>
</tr>
<tr>
<td>请求&#x2F;响应拦截</td>
<td>不支持</td>
<td>不支持（需手动封装）</td>
<td>支持</td>
</tr>
<tr>
<td>自动 JSON 解析</td>
<td>不支持（需手动 JSON.parse）</td>
<td>不支持（需调用 response.json）</td>
<td>支持</td>
</tr>
<tr>
<td>取消请求</td>
<td>复杂</td>
<td>支持 AbortController</td>
<td>原生支持 cancel token</td>
</tr>
<tr>
<td>上传进度</td>
<td>支持</td>
<td>不直接支持</td>
<td>支持（需配置）</td>
</tr>
</tbody></table>
<p>总结：</p>
<ul>
<li>对于简单项目：推荐使用 Fetch（现代浏览器环境）</li>
<li>对于需要兼容性、丰富功能的项目：推荐使用 Axios</li>
<li>在老旧浏览器环境且无库支持：只能使用 XMLHttpRequest</li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/NodeJS/" class="category-chain-item">NodeJS</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/NodeJS/" class="print-no-link">#NodeJS</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>NodeJS核心总结</div>
      <div>http://example.com/2025/12/17/NodeJS/NodeJS核心总结/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Xiang Chen</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年12月17日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/12/17/%E5%89%8D%E7%AB%AF%E9%9D%A2%E8%AF%95/4-Promise%E4%B8%8EJS%E5%BC%82%E6%AD%A5/" title="4.Promise与JS异步">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">4.Promise与JS异步</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/12/15/%E5%89%8D%E7%AB%AF%E9%9D%A2%E8%AF%95/3-JS%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E6%80%BB%E7%BB%93/" title="3.JS的数据类型总结">
                        <span class="hidden-mobile">3.JS的数据类型总结</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"xXfj7jVpB8fiyIpWQbXJP1Gj-gzGzoHsz","appKey":"RoFR6Po4mFIHocqHXZ42PUGO","path":"window.location.pathname","placeholder":"输入你的评论","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
